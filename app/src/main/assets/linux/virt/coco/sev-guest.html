<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>The Definitive SEV Guest API Documentation &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="TDX Guest API Documentation" href="tdx-guest.html" />
    <link rel="prev" title="ACRN CPUID bits" href="../acrn/cpuid.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.9.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../subsystem-apis.html#other-subsystems">Other subsystems</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cpu-freq/index.html">CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../fpga/index.html">FPGA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pcmcia/index.html">PCMCIA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../watchdog/index.html">Watchdog Support</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Virtualization Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hwmon/index.html">Hardware Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../accel/index.html">Compute Accelerators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../crypto/index.html">Crypto API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PCI/index.html">PCI Bus Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../peci/index.html">PECI Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../wmi/index.html">WMI Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tee/index.html">TEE Subsystem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/virt/coco/sev-guest.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="the-definitive-sev-guest-api-documentation">
<h1>The Definitive SEV Guest API Documentation<a class="headerlink" href="#the-definitive-sev-guest-api-documentation" title="Link to this heading">¶</a></h1>
<section id="general-description">
<h2>1. General description<a class="headerlink" href="#general-description" title="Link to this heading">¶</a></h2>
<p>The SEV API is a set of ioctls that are used by the guest or hypervisor
to get or set a certain aspect of the SEV virtual machine. The ioctls belong
to the following classes:</p>
<blockquote>
<div><ul class="simple">
<li><p>Hypervisor ioctls: These query and set global attributes which affect the
whole SEV firmware.  These ioctl are used by platform provisioning tools.</p></li>
<li><p>Guest ioctls: These query and set attributes of the SEV virtual machine.</p></li>
</ul>
</div></blockquote>
</section>
<section id="api-description">
<h2>2. API description<a class="headerlink" href="#api-description" title="Link to this heading">¶</a></h2>
<p>This section describes ioctls that is used for querying the SEV guest report
from the SEV firmware. For each ioctl, the following information is provided
along with a description:</p>
<blockquote>
<div><dl class="simple">
<dt>Technology:</dt><dd><p>which SEV technology provides this ioctl. SEV, SEV-ES, SEV-SNP or all.</p>
</dd>
<dt>Type:</dt><dd><p>hypervisor or guest. The ioctl can be used inside the guest or the
hypervisor.</p>
</dd>
<dt>Parameters:</dt><dd><p>what parameters are accepted by the ioctl.</p>
</dd>
<dt>Returns:</dt><dd><p>the return value.  General error numbers (-ENOMEM, -EINVAL)
are not detailed, but errors with specific meanings are.</p>
</dd>
</dl>
</div></blockquote>
<p>The guest ioctl should be issued on a file descriptor of the /dev/sev-guest
device.  The ioctl accepts struct snp_user_guest_request. The input and
output structure is specified through the req_data and resp_data field
respectively. If the ioctl fails to execute due to a firmware error, then
the fw_error code will be set, otherwise fw_error will be set to -1.</p>
<p>The firmware checks that the message sequence counter is one greater than
the guests message sequence counter. If guest driver fails to increment message
counter (e.g. counter overflow), then -EIO will be returned.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct snp_guest_request_ioctl {
        /* Message version number */
        __u32 msg_version;

        /* Request and response structure address */
        __u64 req_data;
        __u64 resp_data;

        /* bits[63:32]: VMM error code, bits[31:0] firmware error code (see psp-sev.h) */
        union {
                __u64 exitinfo2;
                struct {
                        __u32 fw_error;
                        __u32 vmm_error;
                };
        };
};
</pre></div>
</div>
<p>The host ioctls are issued to a file descriptor of the /dev/sev device.
The ioctl accepts the command ID/input structure documented below.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sev_issue_cmd {
        /* Command ID */
        __u32 cmd;

        /* Command request structure */
        __u64 data;

        /* Firmware error code on failure (see psp-sev.h) */
        __u32 error;
};
</pre></div>
</div>
<section id="snp-get-report">
<h3>2.1 SNP_GET_REPORT<a class="headerlink" href="#snp-get-report" title="Link to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology<span class="colon">:</span></dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><p>guest ioctl</p>
</dd>
<dt class="field-odd">Parameters (in)<span class="colon">:</span></dt>
<dd class="field-odd"><p>struct snp_report_req</p>
</dd>
<dt class="field-even">Returns (out)<span class="colon">:</span></dt>
<dd class="field-even"><p>struct snp_report_resp on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_GET_REPORT ioctl can be used to query the attestation report from the
SEV-SNP firmware. The ioctl uses the SNP_GUEST_REQUEST (MSG_REPORT_REQ) command
provided by the SEV-SNP firmware to query the attestation report.</p>
<p>On success, the snp_report_resp.data will contains the report. The report
contain the format described in the SEV-SNP specification. See the SEV-SNP
specification for further details.</p>
</section>
<section id="snp-get-derived-key">
<h3>2.2 SNP_GET_DERIVED_KEY<a class="headerlink" href="#snp-get-derived-key" title="Link to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology<span class="colon">:</span></dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><p>guest ioctl</p>
</dd>
<dt class="field-odd">Parameters (in)<span class="colon">:</span></dt>
<dd class="field-odd"><p>struct snp_derived_key_req</p>
</dd>
<dt class="field-even">Returns (out)<span class="colon">:</span></dt>
<dd class="field-even"><p>struct snp_derived_key_resp on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_GET_DERIVED_KEY ioctl can be used to get a key derive from a root key.
The derived key can be used by the guest for any purpose, such as sealing keys
or communicating with external entities.</p>
<p>The ioctl uses the SNP_GUEST_REQUEST (MSG_KEY_REQ) command provided by the
SEV-SNP firmware to derive the key. See SEV-SNP specification for further details
on the various fields passed in the key derivation request.</p>
<p>On success, the snp_derived_key_resp.data contains the derived key value. See
the SEV-SNP specification for further details.</p>
</section>
<section id="snp-get-ext-report">
<h3>2.3 SNP_GET_EXT_REPORT<a class="headerlink" href="#snp-get-ext-report" title="Link to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology<span class="colon">:</span></dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><p>guest ioctl</p>
</dd>
<dt class="field-odd">Parameters (in/out)<span class="colon">:</span></dt>
<dd class="field-odd"><p>struct snp_ext_report_req</p>
</dd>
<dt class="field-even">Returns (out)<span class="colon">:</span></dt>
<dd class="field-even"><p>struct snp_report_resp on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_GET_EXT_REPORT ioctl is similar to the SNP_GET_REPORT. The difference is
related to the additional certificate data that is returned with the report.
The certificate data returned is being provided by the hypervisor through the
SNP_SET_EXT_CONFIG.</p>
<p>The ioctl uses the SNP_GUEST_REQUEST (MSG_REPORT_REQ) command provided by the SEV-SNP
firmware to get the attestation report.</p>
<p>On success, the snp_ext_report_resp.data will contain the attestation report
and snp_ext_report_req.certs_address will contain the certificate blob. If the
length of the blob is smaller than expected then snp_ext_report_req.certs_len will
be updated with the expected value.</p>
<p>See GHCB specification for further detail on how to parse the certificate blob.</p>
</section>
<section id="snp-platform-status">
<h3>2.4 SNP_PLATFORM_STATUS<a class="headerlink" href="#snp-platform-status" title="Link to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology<span class="colon">:</span></dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><p>hypervisor ioctl cmd</p>
</dd>
<dt class="field-odd">Parameters (out)<span class="colon">:</span></dt>
<dd class="field-odd"><p>struct sev_user_data_snp_status</p>
</dd>
<dt class="field-even">Returns (out)<span class="colon">:</span></dt>
<dd class="field-even"><p>0 on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_PLATFORM_STATUS command is used to query the SNP platform status. The
status includes API major, minor version and more. See the SEV-SNP
specification for further details.</p>
</section>
<section id="snp-commit">
<h3>2.5 SNP_COMMIT<a class="headerlink" href="#snp-commit" title="Link to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology<span class="colon">:</span></dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><p>hypervisor ioctl cmd</p>
</dd>
<dt class="field-odd">Returns (out)<span class="colon">:</span></dt>
<dd class="field-odd"><p>0 on success, -negative on error</p>
</dd>
</dl>
<p>SNP_COMMIT is used to commit the currently installed firmware using the
SEV-SNP firmware SNP_COMMIT command. This prevents roll-back to a previously
committed firmware version. This will also update the reported TCB to match
that of the currently installed firmware.</p>
</section>
<section id="snp-set-config">
<h3>2.6 SNP_SET_CONFIG<a class="headerlink" href="#snp-set-config" title="Link to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology<span class="colon">:</span></dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><p>hypervisor ioctl cmd</p>
</dd>
<dt class="field-odd">Parameters (in)<span class="colon">:</span></dt>
<dd class="field-odd"><p>struct sev_user_data_snp_config</p>
</dd>
<dt class="field-even">Returns (out)<span class="colon">:</span></dt>
<dd class="field-even"><p>0 on success, -negative on error</p>
</dd>
</dl>
<p>SNP_SET_CONFIG is used to set the system-wide configuration such as
reported TCB version in the attestation report. The command is similar
to SNP_CONFIG command defined in the SEV-SNP spec. The current values of
the firmware parameters affected by this command can be queried via
SNP_PLATFORM_STATUS.</p>
</section>
</section>
<section id="sev-snp-cpuid-enforcement">
<h2>3. SEV-SNP CPUID Enforcement<a class="headerlink" href="#sev-snp-cpuid-enforcement" title="Link to this heading">¶</a></h2>
<p>SEV-SNP guests can access a special page that contains a table of CPUID values
that have been validated by the PSP as part of the SNP_LAUNCH_UPDATE firmware
command. It provides the following assurances regarding the validity of CPUID
values:</p>
<blockquote>
<div><ul class="simple">
<li><p>Its address is obtained via bootloader/firmware (via CC blob), and those
binaries will be measured as part of the SEV-SNP attestation report.</p></li>
<li><p>Its initial state will be encrypted/pvalidated, so attempts to modify
it during run-time will result in garbage being written, or #VC exceptions
being generated due to changes in validation state if the hypervisor tries
to swap the backing page.</p></li>
<li><p>Attempts to bypass PSP checks by the hypervisor by using a normal page, or
a non-CPUID encrypted page will change the measurement provided by the
SEV-SNP attestation report.</p></li>
<li><p>The CPUID page contents are <em>not</em> measured, but attempts to modify the
expected contents of a CPUID page as part of guest initialization will be
gated by the PSP CPUID enforcement policy checks performed on the page
during SNP_LAUNCH_UPDATE, and noticeable later if the guest owner
implements their own checks of the CPUID values.</p></li>
</ul>
</div></blockquote>
<p>It is important to note that this last assurance is only useful if the kernel
has taken care to make use of the SEV-SNP CPUID throughout all stages of boot.
Otherwise, guest owner attestation provides no assurance that the kernel wasn’t
fed incorrect values at some point during boot.</p>
<section id="reference">
<h3>Reference<a class="headerlink" href="#reference" title="Link to this heading">¶</a></h3>
<p>SEV-SNP and GHCB specification: developer.amd.com/sev</p>
<p>The driver is based on SEV-SNP firmware spec 0.9 and GHCB spec version 2.0.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/virt/coco/sev-guest.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>