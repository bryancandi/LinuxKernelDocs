
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Multifunction Composite Gadget &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Linux USB Printer Gadget Driver" href="gadget_printer.html" />
    <link rel="prev" title="Linux USB HID gadget driver" href="gadget_hid.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.5.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">A guide to the Kernel Development Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver implementer's API guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">Kernel subsystem documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../subsystem-apis.html#storage-interfaces">Storage interfaces</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cdrom/index.html">CD-ROM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scsi/index.html">SCSI Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l3"><a class="reference internal" href="../driver-api/index.html">Driver implementer's API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../locking/index.html">Locking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cpu-freq/index.html">CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fpga/index.html">FPGA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pcmcia/index.html">PCMCIA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../timers/index.html">Timers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../watchdog/index.html">Watchdog Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../virt/index.html">Virtualization Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hwmon/index.html">Hardware Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../accel/index.html">Compute Accelerators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../crypto/index.html">Crypto API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mm/index.html">Memory Management Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">USB support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PCI/index.html">PCI Bus Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scheduler/index.html">Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../peci/index.html">PECI Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../wmi/index.html">WMI Subsystem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking in the kernel</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Linux kernel licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">Kernel Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user's and administrator's guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">The kernel build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">User-space tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  sbar.scrollTop = currents[currents.length - 1].offsetTop;
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/usb/gadget_multi.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="multifunction-composite-gadget">
<h1>Multifunction Composite Gadget<a class="headerlink" href="#multifunction-composite-gadget" title="Permalink to this heading">¶</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>The Multifunction Composite Gadget (or g_multi) is a composite gadget
that makes extensive use of the composite framework to provide
a... multifunction gadget.</p>
<p>In its standard configuration it provides a single USB configuration
with RNDIS[1] (that is Ethernet), USB CDC[2] ACM (that is serial) and
USB Mass Storage functions.</p>
<p>A CDC ECM (Ethernet) function may be turned on via a Kconfig option
and RNDIS can be turned off.  If they are both enabled the gadget will
have two configurations -- one with RNDIS and another with CDC ECM[3].</p>
<p>Please note that if you use non-standard configuration (that is enable
CDC ECM) you may need to change vendor and/or product ID.</p>
</section>
<section id="host-drivers">
<h2>Host drivers<a class="headerlink" href="#host-drivers" title="Permalink to this heading">¶</a></h2>
<p>To make use of the gadget one needs to make it work on host side --
without that there's no hope of achieving anything with the gadget.
As one might expect, things one need to do very from system to system.</p>
<section id="linux-host-drivers">
<h3>Linux host drivers<a class="headerlink" href="#linux-host-drivers" title="Permalink to this heading">¶</a></h3>
<p>Since the gadget uses standard composite framework and appears as such
to Linux host it does not need any additional drivers on Linux host
side.  All the functions are handled by respective drivers developed
for them.</p>
<p>This is also true for two configuration set-up with RNDIS
configuration being the first one.  Linux host will use the second
configuration with CDC ECM which should work better under Linux.</p>
</section>
<section id="windows-host-drivers">
<h3>Windows host drivers<a class="headerlink" href="#windows-host-drivers" title="Permalink to this heading">¶</a></h3>
<p>For the gadget to work under Windows two conditions have to be met:</p>
<section id="detecting-as-composite-gadget">
<h4>Detecting as composite gadget<a class="headerlink" href="#detecting-as-composite-gadget" title="Permalink to this heading">¶</a></h4>
<p>First of all, Windows need to detect the gadget as an USB composite
gadget which on its own have some conditions[4].  If they are met,
Windows lets USB Generic Parent Driver[5] handle the device which then
tries to match drivers for each individual interface (sort of, don't
get into too many details).</p>
<p>The good news is: you do not have to worry about most of the
conditions!</p>
<p>The only thing to worry is that the gadget has to have a single
configuration so a dual RNDIS and CDC ECM gadget won't work unless you
create a proper INF -- and of course, if you do submit it!</p>
</section>
<section id="installing-drivers-for-each-function">
<h4>Installing drivers for each function<a class="headerlink" href="#installing-drivers-for-each-function" title="Permalink to this heading">¶</a></h4>
<p>The other, trickier thing is making Windows install drivers for each
individual function.</p>
<p>For mass storage it is trivial since Windows detect it's an interface
implementing USB Mass Storage class and selects appropriate driver.</p>
<p>Things are harder with RDNIS and CDC ACM.</p>
<section id="rndis">
<h5>RNDIS<a class="headerlink" href="#rndis" title="Permalink to this heading">¶</a></h5>
<p>To make Windows select RNDIS drivers for the first function in the
gadget, one needs to use the [[<a class="reference external" href="file:linux.inf">file:linux.inf</a>]] file provided with this
document.  It &quot;attaches&quot; Window's RNDIS driver to the first interface
of the gadget.</p>
<p>Please note, that while testing we encountered some issues[6] when
RNDIS was not the first interface.  You do not need to worry abut it
unless you are trying to develop your own gadget in which case watch
out for this bug.</p>
</section>
<section id="cdc-acm">
<h5>CDC ACM<a class="headerlink" href="#cdc-acm" title="Permalink to this heading">¶</a></h5>
<p>Similarly, [[<a class="reference external" href="file:linux-cdc-acm.inf">file:linux-cdc-acm.inf</a>]] is provided for CDC ACM.</p>
</section>
<section id="customising-the-gadget">
<h5>Customising the gadget<a class="headerlink" href="#customising-the-gadget" title="Permalink to this heading">¶</a></h5>
<p>If you intend to hack the g_multi gadget be advised that rearranging
functions will obviously change interface numbers for each of the
functionality.  As an effect provided INFs won't work since they have
interface numbers hard-coded in them (it's not hard to change those
though[7]).</p>
<p>This also means, that after experimenting with g_multi and changing
provided functions one should change gadget's vendor and/or product ID
so there will be no collision with other customised gadgets or the
original gadget.</p>
<p>Failing to comply may cause brain damage after wondering for hours why
things don't work as intended before realising Windows have cached
some drivers information (changing USB port may sometimes help plus
you might try using USBDeview[8] to remove the phantom device).</p>
</section>
<section id="inf-testing">
<h5>INF testing<a class="headerlink" href="#inf-testing" title="Permalink to this heading">¶</a></h5>
<p>Provided INF files have been tested on Windows XP SP3, Windows Vista
and Windows 7, all 32-bit versions.  It should work on 64-bit versions
as well.  It most likely won't work on Windows prior to Windows XP
SP2.</p>
</section>
</section>
</section>
<section id="other-systems">
<h3>Other systems<a class="headerlink" href="#other-systems" title="Permalink to this heading">¶</a></h3>
<p>At this moment, drivers for any other systems have not been tested.
Knowing how MacOS is based on BSD and BSD is an Open Source it is
believed that it should (read: &quot;I have no idea whether it will&quot;) work
out-of-the-box.</p>
<p>For more exotic systems I have even less to say...</p>
<p>Any testing and drivers <em>are</em> <em>welcome</em>!</p>
</section>
</section>
<section id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Permalink to this heading">¶</a></h2>
<p>This document has been written by Michal Nazarewicz
([[<a class="reference external" href="mailto:mina86&#37;&#52;&#48;mina86&#46;com">mailto:mina86<span>&#64;</span>mina86<span>&#46;</span>com</a>]]).  INF files have been hacked with
support of Marek Szyprowski ([[<a class="reference external" href="mailto:m&#46;szyprowski&#37;&#52;&#48;samsung&#46;com">mailto:m<span>&#46;</span>szyprowski<span>&#64;</span>samsung<span>&#46;</span>com</a>]]) and
Xiaofan Chen ([[<a class="reference external" href="mailto:xiaofanc&#37;&#52;&#48;gmail&#46;com">mailto:xiaofanc<span>&#64;</span>gmail<span>&#46;</span>com</a>]]) basing on the MS RNDIS
template[9], Microchip's CDC ACM INF file and David Brownell's
([[<a class="reference external" href="mailto:dbrownell&#37;&#52;&#48;users&#46;sourceforge&#46;net">mailto:dbrownell<span>&#64;</span>users<span>&#46;</span>sourceforge<span>&#46;</span>net</a>]]) original INF files.</p>
</section>
<section id="footnotes">
<h2>Footnotes<a class="headerlink" href="#footnotes" title="Permalink to this heading">¶</a></h2>
<p>[1] Remote Network Driver Interface Specification,
[[<a class="reference external" href="https://msdn.microsoft.com/en-us/library/ee484414.aspx">https://msdn.microsoft.com/en-us/library/ee484414.aspx</a>]].</p>
<p>[2] Communications Device Class Abstract Control Model, spec for this
and other USB classes can be found at
[[<a class="reference external" href="http://www.usb.org/developers/devclass_docs/">http://www.usb.org/developers/devclass_docs/</a>]].</p>
<p>[3] CDC Ethernet Control Model.</p>
<p>[4] [[<a class="reference external" href="https://msdn.microsoft.com/en-us/library/ff537109(v=VS.85).aspx">https://msdn.microsoft.com/en-us/library/ff537109(v=VS.85).aspx</a>]]</p>
<p>[5] [[<a class="reference external" href="https://msdn.microsoft.com/en-us/library/ff539234(v=VS.85).aspx">https://msdn.microsoft.com/en-us/library/ff539234(v=VS.85).aspx</a>]]</p>
<p>[6] To put it in some other nice words, Windows failed to respond to
any user input.</p>
<p>[7] You may find [[<a class="reference external" href="http://www.cygnal.org/ubb/Forum9/HTML/001050.html">http://www.cygnal.org/ubb/Forum9/HTML/001050.html</a>]]
useful.</p>
<p>[8] <a class="reference external" href="https://www.nirsoft.net/utils/usb_devices_view.html">https://www.nirsoft.net/utils/usb_devices_view.html</a></p>
<p>[9] [[<a class="reference external" href="https://msdn.microsoft.com/en-us/library/ff570620.aspx">https://msdn.microsoft.com/en-us/library/ff570620.aspx</a>]]</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/usb/gadget_multi.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>