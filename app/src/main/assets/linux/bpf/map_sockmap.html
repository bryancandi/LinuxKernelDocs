
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>BPF_MAP_TYPE_SOCKMAP and BPF_MAP_TYPE_SOCKHASH &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BPF_MAP_TYPE_XSKMAP" href="map_xskmap.html" />
    <link rel="prev" title="BPF_MAP_TYPE_SK_STORAGE" href="map_sk_storage.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.5.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">A guide to the Kernel Development Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver implementer's API guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">Kernel subsystem documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../subsystem-apis.html#storage-interfaces">Storage interfaces</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cdrom/index.html">CD-ROM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scsi/index.html">SCSI Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l3"><a class="reference internal" href="../driver-api/index.html">Driver implementer's API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../locking/index.html">Locking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cpu-freq/index.html">CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fpga/index.html">FPGA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pcmcia/index.html">PCMCIA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../timers/index.html">Timers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../watchdog/index.html">Watchdog Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../virt/index.html">Virtualization Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hwmon/index.html">Hardware Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../accel/index.html">Compute Accelerators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../crypto/index.html">Crypto API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mm/index.html">Memory Management Documentation</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">BPF Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PCI/index.html">PCI Bus Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scheduler/index.html">Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../peci/index.html">PECI Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../wmi/index.html">WMI Subsystem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking in the kernel</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Linux kernel licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">Kernel Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user's and administrator's guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">The kernel build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">User-space tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  sbar.scrollTop = currents[currents.length - 1].offsetTop;
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/bpf/map_sockmap.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="bpf-map-type-sockmap-and-bpf-map-type-sockhash">
<h1>BPF_MAP_TYPE_SOCKMAP and BPF_MAP_TYPE_SOCKHASH<a class="headerlink" href="#bpf-map-type-sockmap-and-bpf-map-type-sockhash" title="Permalink to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKMAP</span></code> was introduced in kernel version 4.14</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKHASH</span></code> was introduced in kernel version 4.18</p></li>
</ul>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKMAP</span></code> and <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKHASH</span></code> maps can be used to
redirect skbs between sockets or to apply policy at the socket level based on
the result of a BPF (verdict) program with the help of the BPF helpers
<code class="docutils literal notranslate"><span class="pre">bpf_sk_redirect_map()</span></code>, <code class="docutils literal notranslate"><span class="pre">bpf_sk_redirect_hash()</span></code>,
<code class="docutils literal notranslate"><span class="pre">bpf_msg_redirect_map()</span></code> and <code class="docutils literal notranslate"><span class="pre">bpf_msg_redirect_hash()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKMAP</span></code> is backed by an array that uses an integer key as the
index to look up a reference to a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sock</span></code>. The map values are socket
descriptors. Similarly, <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKHASH</span></code> is a hash backed BPF map that
holds references to sockets via their socket descriptors.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The value type is either __u32 or __u64; the latter (__u64) is to support
returning socket cookies to userspace. Returning the <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sock</span> <span class="pre">*</span></code> that
the map holds to user-space is neither safe nor useful.</p>
</div>
<p>These maps may have BPF programs attached to them, specifically a parser program
and a verdict program. The parser program determines how much data has been
parsed and therefore how much data needs to be queued to come to a verdict. The
verdict program is essentially the redirect program and can return a verdict
of <code class="docutils literal notranslate"><span class="pre">__SK_DROP</span></code>, <code class="docutils literal notranslate"><span class="pre">__SK_PASS</span></code>, or <code class="docutils literal notranslate"><span class="pre">__SK_REDIRECT</span></code>.</p>
<p>When a socket is inserted into one of these maps, its socket callbacks are
replaced and a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sk_psock</span></code> is attached to it. Additionally, this
<code class="docutils literal notranslate"><span class="pre">sk_psock</span></code> inherits the programs that are attached to the map.</p>
<p>A sock object may be in multiple maps, but can only inherit a single
parse or verdict program. If adding a sock object to a map would result
in having multiple parser programs the update will return an EBUSY error.</p>
<p>The supported programs to attach to these maps are:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_psock_progs</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_prog</span><span class="w"> </span><span class="o">*</span><span class="n">msg_parser</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_prog</span><span class="w"> </span><span class="o">*</span><span class="n">stream_parser</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_prog</span><span class="w"> </span><span class="o">*</span><span class="n">stream_verdict</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_prog</span><span class="w"> </span><span class="o">*</span><span class="n">skb_verdict</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Users are not allowed to attach <code class="docutils literal notranslate"><span class="pre">stream_verdict</span></code> and <code class="docutils literal notranslate"><span class="pre">skb_verdict</span></code>
programs to the same map.</p>
</div>
<p>The attach types for the map programs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">msg_parser</span></code> program - <code class="docutils literal notranslate"><span class="pre">BPF_SK_MSG_VERDICT</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stream_parser</span></code> program - <code class="docutils literal notranslate"><span class="pre">BPF_SK_SKB_STREAM_PARSER</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stream_verdict</span></code> program - <code class="docutils literal notranslate"><span class="pre">BPF_SK_SKB_STREAM_VERDICT</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">skb_verdict</span></code> program - <code class="docutils literal notranslate"><span class="pre">BPF_SK_SKB_VERDICT</span></code>.</p></li>
</ul>
<p>There are additional helpers available to use with the parser and verdict
programs: <code class="docutils literal notranslate"><span class="pre">bpf_msg_apply_bytes()</span></code> and <code class="docutils literal notranslate"><span class="pre">bpf_msg_cork_bytes()</span></code>. With
<code class="docutils literal notranslate"><span class="pre">bpf_msg_apply_bytes()</span></code> BPF programs can tell the infrastructure how many
bytes the given verdict should apply to. The helper <code class="docutils literal notranslate"><span class="pre">bpf_msg_cork_bytes()</span></code>
handles a different case where a BPF program cannot reach a verdict on a msg
until it receives more bytes AND the program doesn't want to forward the packet
until it is known to be good.</p>
<p>Finally, the helpers <code class="docutils literal notranslate"><span class="pre">bpf_msg_pull_data()</span></code> and <code class="docutils literal notranslate"><span class="pre">bpf_msg_push_data()</span></code> are
available to <code class="docutils literal notranslate"><span class="pre">BPF_PROG_TYPE_SK_MSG</span></code> BPF programs to pull in data and set the
start and end pointers to given values or to add metadata to the <code class="docutils literal notranslate"><span class="pre">struct</span>
<span class="pre">sk_msg_buff</span> <span class="pre">*msg</span></code>.</p>
<p>All these helpers will be described in more detail below.</p>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<section id="kernel-bpf">
<h3>Kernel BPF<a class="headerlink" href="#kernel-bpf" title="Permalink to this heading">¶</a></h3>
<section id="bpf-msg-redirect-map">
<h4>bpf_msg_redirect_map()<a class="headerlink" href="#bpf-msg-redirect-map" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_msg_redirect_map</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_msg_buff</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<p>This helper is used in programs implementing policies at the socket level. If
the message <code class="docutils literal notranslate"><span class="pre">msg</span></code> is allowed to pass (i.e., if the verdict BPF program
returns <code class="docutils literal notranslate"><span class="pre">SK_PASS</span></code>), redirect it to the socket referenced by <code class="docutils literal notranslate"><span class="pre">map</span></code> (of type
<code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKMAP</span></code>) at index <code class="docutils literal notranslate"><span class="pre">key</span></code>. Both ingress and egress interfaces
can be used for redirection. The <code class="docutils literal notranslate"><span class="pre">BPF_F_INGRESS</span></code> value in <code class="docutils literal notranslate"><span class="pre">flags</span></code> is used
to select the ingress path otherwise the egress path is selected. This is the
only flag supported for now.</p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">SK_PASS</span></code> on success, or <code class="docutils literal notranslate"><span class="pre">SK_DROP</span></code> on error.</p>
</section>
<section id="bpf-sk-redirect-map">
<h4>bpf_sk_redirect_map()<a class="headerlink" href="#bpf-sk-redirect-map" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_sk_redirect_map</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<p>Redirect the packet to the socket referenced by <code class="docutils literal notranslate"><span class="pre">map</span></code> (of type
<code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKMAP</span></code>) at index <code class="docutils literal notranslate"><span class="pre">key</span></code>. Both ingress and egress interfaces
can be used for redirection. The <code class="docutils literal notranslate"><span class="pre">BPF_F_INGRESS</span></code> value in <code class="docutils literal notranslate"><span class="pre">flags</span></code> is used
to select the ingress path otherwise the egress path is selected. This is the
only flag supported for now.</p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">SK_PASS</span></code> on success, or <code class="docutils literal notranslate"><span class="pre">SK_DROP</span></code> on error.</p>
</section>
<section id="bpf-map-lookup-elem">
<h4>bpf_map_lookup_elem()<a class="headerlink" href="#bpf-map-lookup-elem" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>socket entries of type <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sock</span> <span class="pre">*</span></code> can be retrieved using the
<code class="docutils literal notranslate"><span class="pre">bpf_map_lookup_elem()</span></code> helper.</p>
</section>
<section id="bpf-sock-map-update">
<h4>bpf_sock_map_update()<a class="headerlink" href="#bpf-sock-map-update" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_sock_map_update</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_sock_ops</span><span class="w"> </span><span class="o">*</span><span class="n">skops</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<p>Add an entry to, or update a <code class="docutils literal notranslate"><span class="pre">map</span></code> referencing sockets. The <code class="docutils literal notranslate"><span class="pre">skops</span></code> is used
as a new value for the entry associated to <code class="docutils literal notranslate"><span class="pre">key</span></code>. The <code class="docutils literal notranslate"><span class="pre">flags</span></code> argument can
be one of the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_ANY</span></code>: Create a new element or update an existing element.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_NOEXIST</span></code>: Create a new element only if it did not exist.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_EXIST</span></code>: Update an existing element.</p></li>
</ul>
<p>If the <code class="docutils literal notranslate"><span class="pre">map</span></code> has BPF programs (parser and verdict), those will be inherited
by the socket being added. If the socket is already attached to BPF programs,
this results in an error.</p>
<p>Returns 0 on success, or a negative error in case of failure.</p>
</section>
<section id="bpf-sock-hash-update">
<h4>bpf_sock_hash_update()<a class="headerlink" href="#bpf-sock-hash-update" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_sock_hash_update</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_sock_ops</span><span class="w"> </span><span class="o">*</span><span class="n">skops</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<p>Add an entry to, or update a sockhash <code class="docutils literal notranslate"><span class="pre">map</span></code> referencing sockets. The <code class="docutils literal notranslate"><span class="pre">skops</span></code>
is used as a new value for the entry associated to <code class="docutils literal notranslate"><span class="pre">key</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">flags</span></code> argument can be one of the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_ANY</span></code>: Create a new element or update an existing element.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_NOEXIST</span></code>: Create a new element only if it did not exist.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_EXIST</span></code>: Update an existing element.</p></li>
</ul>
<p>If the <code class="docutils literal notranslate"><span class="pre">map</span></code> has BPF programs (parser and verdict), those will be inherited
by the socket being added. If the socket is already attached to BPF programs,
this results in an error.</p>
<p>Returns 0 on success, or a negative error in case of failure.</p>
</section>
<section id="bpf-msg-redirect-hash">
<h4>bpf_msg_redirect_hash()<a class="headerlink" href="#bpf-msg-redirect-hash" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_msg_redirect_hash</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_msg_buff</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<p>This helper is used in programs implementing policies at the socket level. If
the message <code class="docutils literal notranslate"><span class="pre">msg</span></code> is allowed to pass (i.e., if the verdict BPF program returns
<code class="docutils literal notranslate"><span class="pre">SK_PASS</span></code>), redirect it to the socket referenced by <code class="docutils literal notranslate"><span class="pre">map</span></code> (of type
<code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKHASH</span></code>) using hash <code class="docutils literal notranslate"><span class="pre">key</span></code>. Both ingress and egress
interfaces can be used for redirection. The <code class="docutils literal notranslate"><span class="pre">BPF_F_INGRESS</span></code> value in
<code class="docutils literal notranslate"><span class="pre">flags</span></code> is used to select the ingress path otherwise the egress path is
selected. This is the only flag supported for now.</p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">SK_PASS</span></code> on success, or <code class="docutils literal notranslate"><span class="pre">SK_DROP</span></code> on error.</p>
</section>
<section id="bpf-sk-redirect-hash">
<h4>bpf_sk_redirect_hash()<a class="headerlink" href="#bpf-sk-redirect-hash" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_sk_redirect_hash</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<p>This helper is used in programs implementing policies at the skb socket level.
If the sk_buff <code class="docutils literal notranslate"><span class="pre">skb</span></code> is allowed to pass (i.e., if the verdict BPF program
returns <code class="docutils literal notranslate"><span class="pre">SK_PASS</span></code>), redirect it to the socket referenced by <code class="docutils literal notranslate"><span class="pre">map</span></code> (of type
<code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_SOCKHASH</span></code>) using hash <code class="docutils literal notranslate"><span class="pre">key</span></code>. Both ingress and egress
interfaces can be used for redirection. The <code class="docutils literal notranslate"><span class="pre">BPF_F_INGRESS</span></code> value in
<code class="docutils literal notranslate"><span class="pre">flags</span></code> is used to select the ingress path otherwise the egress path is
selected. This is the only flag supported for now.</p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">SK_PASS</span></code> on success, or <code class="docutils literal notranslate"><span class="pre">SK_DROP</span></code> on error.</p>
</section>
<section id="bpf-msg-apply-bytes">
<h4>bpf_msg_apply_bytes()<a class="headerlink" href="#bpf-msg-apply-bytes" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_msg_apply_bytes</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_msg_buff</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span>
</pre></div>
</div>
<p>For socket policies, apply the verdict of the BPF program to the next (number
of <code class="docutils literal notranslate"><span class="pre">bytes</span></code>) of message <code class="docutils literal notranslate"><span class="pre">msg</span></code>. For example, this helper can be used in the
following cases:</p>
<ul class="simple">
<li><p>A single <code class="docutils literal notranslate"><span class="pre">sendmsg()</span></code> or <code class="docutils literal notranslate"><span class="pre">sendfile()</span></code> system call contains multiple
logical messages that the BPF program is supposed to read and for which it
should apply a verdict.</p></li>
<li><p>A BPF program only cares to read the first <code class="docutils literal notranslate"><span class="pre">bytes</span></code> of a <code class="docutils literal notranslate"><span class="pre">msg</span></code>. If the
message has a large payload, then setting up and calling the BPF program
repeatedly for all bytes, even though the verdict is already known, would
create unnecessary overhead.</p></li>
</ul>
<p>Returns 0</p>
</section>
<section id="bpf-msg-cork-bytes">
<h4>bpf_msg_cork_bytes()<a class="headerlink" href="#bpf-msg-cork-bytes" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_msg_cork_bytes</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_msg_buff</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span>
</pre></div>
</div>
<p>For socket policies, prevent the execution of the verdict BPF program for
message <code class="docutils literal notranslate"><span class="pre">msg</span></code> until the number of <code class="docutils literal notranslate"><span class="pre">bytes</span></code> have been accumulated.</p>
<p>This can be used when one needs a specific number of bytes before a verdict can
be assigned, even if the data spans multiple <code class="docutils literal notranslate"><span class="pre">sendmsg()</span></code> or <code class="docutils literal notranslate"><span class="pre">sendfile()</span></code>
calls.</p>
<p>Returns 0</p>
</section>
<section id="bpf-msg-pull-data">
<h4>bpf_msg_pull_data()<a class="headerlink" href="#bpf-msg-pull-data" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_msg_pull_data</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sk_msg_buff</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<p>For socket policies, pull in non-linear data from user space for <code class="docutils literal notranslate"><span class="pre">msg</span></code> and set
pointers <code class="docutils literal notranslate"><span class="pre">msg-&gt;data</span></code> and <code class="docutils literal notranslate"><span class="pre">msg-&gt;data_end</span></code> to <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">end</span></code> bytes
offsets into <code class="docutils literal notranslate"><span class="pre">msg</span></code>, respectively.</p>
<p>If a program of type <code class="docutils literal notranslate"><span class="pre">BPF_PROG_TYPE_SK_MSG</span></code> is run on a <code class="docutils literal notranslate"><span class="pre">msg</span></code> it can only
parse data that the (<code class="docutils literal notranslate"><span class="pre">data</span></code>, <code class="docutils literal notranslate"><span class="pre">data_end</span></code>) pointers have already consumed.
For <code class="docutils literal notranslate"><span class="pre">sendmsg()</span></code> hooks this is likely the first scatterlist element. But for
calls relying on MSG_SPLICE_PAGES (e.g., <code class="docutils literal notranslate"><span class="pre">sendfile()</span></code>) this will be the
range (<strong>0</strong>, <strong>0</strong>) because the data is shared with user space and by default
the objective is to avoid allowing user space to modify data while (or after)
BPF verdict is being decided. This helper can be used to pull in data and to
set the start and end pointers to given values. Data will be copied if
necessary (i.e., if data was not linear and if start and end pointers do not
point to the same chunk).</p>
<p>A call to this helper is susceptible to change the underlying packet buffer.
Therefore, at load time, all checks on pointers previously done by the verifier
are invalidated and must be performed again, if the helper is used in
combination with direct packet access.</p>
<p>All values for <code class="docutils literal notranslate"><span class="pre">flags</span></code> are reserved for future usage, and must be left at
zero.</p>
<p>Returns 0 on success, or a negative error in case of failure.</p>
</section>
<section id="id1">
<h4>bpf_map_lookup_elem()<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>Look up a socket entry in the sockmap or sockhash map.</p>
<p>Returns the socket entry associated to <code class="docutils literal notranslate"><span class="pre">key</span></code>, or NULL if no entry was found.</p>
</section>
<section id="bpf-map-update-elem">
<h4>bpf_map_update_elem()<a class="headerlink" href="#bpf-map-update-elem" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<p>Add or update a socket entry in a sockmap or sockhash.</p>
<p>The flags argument can be one of the following:</p>
<ul class="simple">
<li><p>BPF_ANY: Create a new element or update an existing element.</p></li>
<li><p>BPF_NOEXIST: Create a new element only if it did not exist.</p></li>
<li><p>BPF_EXIST: Update an existing element.</p></li>
</ul>
<p>Returns 0 on success, or a negative error in case of failure.</p>
</section>
<section id="bpf-map-delete-elem">
<h4>bpf_map_delete_elem()<a class="headerlink" href="#bpf-map-delete-elem" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_map_delete_elem</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>Delete a socket entry from a sockmap or a sockhash.</p>
<p>Returns 0 on success, or a negative error in case of failure.</p>
</section>
</section>
<section id="user-space">
<h3>User space<a class="headerlink" href="#user-space" title="Permalink to this heading">¶</a></h3>
<section id="id2">
<h4>bpf_map_update_elem()<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span>
</pre></div>
</div>
<p>Sockmap entries can be added or updated using the <code class="docutils literal notranslate"><span class="pre">bpf_map_update_elem()</span></code>
function. The <code class="docutils literal notranslate"><span class="pre">key</span></code> parameter is the index value of the sockmap array. And the
<code class="docutils literal notranslate"><span class="pre">value</span></code> parameter is the FD value of that socket.</p>
<p>Under the hood, the sockmap update function uses the socket FD value to
retrieve the associated socket and its attached psock.</p>
<p>The flags argument can be one of the following:</p>
<ul class="simple">
<li><p>BPF_ANY: Create a new element or update an existing element.</p></li>
<li><p>BPF_NOEXIST: Create a new element only if it did not exist.</p></li>
<li><p>BPF_EXIST: Update an existing element.</p></li>
</ul>
</section>
<section id="id3">
<h4>bpf_map_lookup_elem()<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Sockmap entries can be retrieved using the <code class="docutils literal notranslate"><span class="pre">bpf_map_lookup_elem()</span></code> function.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The entry returned is a socket cookie rather than a socket itself.</p>
</div>
</section>
<section id="id4">
<h4>bpf_map_delete_elem()<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">bpf_map_delete_elem</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>Sockmap entries can be deleted using the <code class="docutils literal notranslate"><span class="pre">bpf_map_delete_elem()</span></code>
function.</p>
<p>Returns 0 on success, or negative error in case of failure.</p>
</section>
</section>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h2>
<section id="id5">
<h3>Kernel BPF<a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h3>
<p>Several examples of the use of sockmap APIs can be found in:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/bpf/progs/test_sockmap_kern.h">tools/testing/selftests/bpf/progs/test_sockmap_kern.h</a></p></li>
<li><p><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/bpf/progs/sockmap_parse_prog.c">tools/testing/selftests/bpf/progs/sockmap_parse_prog.c</a></p></li>
<li><p><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/bpf/progs/sockmap_verdict_prog.c">tools/testing/selftests/bpf/progs/sockmap_verdict_prog.c</a></p></li>
<li><p><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/bpf/progs/test_sockmap_listen.c">tools/testing/selftests/bpf/progs/test_sockmap_listen.c</a></p></li>
<li><p><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/bpf/progs/test_sockmap_update.c">tools/testing/selftests/bpf/progs/test_sockmap_update.c</a></p></li>
</ul>
<p>The following code snippet shows how to declare a sockmap.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_SOCKMAP</span><span class="p">);</span>
<span class="w">        </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span>
<span class="w">        </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u64</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">sock_map_rx</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The following code snippet shows a sample parser program.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;sk_skb/stream_parser&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">bpf_prog_parser</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">__sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following code snippet shows a simple verdict program that interacts with a
sockmap to redirect traffic to another socket based on the local port.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;sk_skb/stream_verdict&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">bpf_prog_verdict</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">__sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="n">lport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
<span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lport</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">bpf_sk_redirect_map</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sock_map_rx</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SK_PASS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following code snippet shows how to declare a sockhash map.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">socket_key</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="n">src_ip</span><span class="p">;</span>
<span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="n">dst_ip</span><span class="p">;</span>
<span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="n">src_port</span><span class="p">;</span>
<span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="n">dst_port</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_SOCKHASH</span><span class="p">);</span>
<span class="w">        </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket_key</span><span class="p">);</span>
<span class="w">        </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u64</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">sock_hash_rx</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The following code snippet shows a simple verdict program that interacts with a
sockhash to redirect traffic to another socket based on a hash of some of the
skb parameters.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">extract_socket_key</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">__sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket_key</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="n">key</span><span class="o">-&gt;</span><span class="n">src_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">remote_ip4</span><span class="p">;</span>
<span class="w">        </span><span class="n">key</span><span class="o">-&gt;</span><span class="n">dst_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">local_ip4</span><span class="p">;</span>
<span class="w">        </span><span class="n">key</span><span class="o">-&gt;</span><span class="n">src_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">remote_port</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">        </span><span class="n">key</span><span class="o">-&gt;</span><span class="n">dst_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_htonl</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">&quot;sk_skb/stream_verdict&quot;</span><span class="p">)</span>
<span class="kt">int</span><span class="w"> </span><span class="n">bpf_prog_verdict</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">__sk_buff</span><span class="w"> </span><span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">socket_key</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>

<span class="w">        </span><span class="n">extract_socket_key</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bpf_sk_redirect_hash</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sock_hash_rx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>User space<a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<p>Several examples of the use of sockmap APIs can be found in:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/bpf/prog_tests/sockmap_basic.c">tools/testing/selftests/bpf/prog_tests/sockmap_basic.c</a></p></li>
<li><p><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/bpf/test_sockmap.c">tools/testing/selftests/bpf/test_sockmap.c</a></p></li>
<li><p><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests/bpf/test_maps.c">tools/testing/selftests/bpf/test_maps.c</a></p></li>
</ul>
<p>The following code sample shows how to create a sockmap, attach a parser and
verdict program, as well as add a socket entry.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">create_sample_sockmap</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">parse_prog_fd</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">verdict_prog_fd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="w">        </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_create</span><span class="p">(</span><span class="n">BPF_MAP_TYPE_SOCKMAP</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">map</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to create sockmap: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_prog_attach</span><span class="p">(</span><span class="n">parse_prog_fd</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_SK_SKB_STREAM_PARSER</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">){</span>
<span class="w">                </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to attach_parser_prog_to_map: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_prog_attach</span><span class="p">(</span><span class="n">verdict_prog_fd</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_SK_SKB_STREAM_VERDICT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">){</span>
<span class="w">                </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to attach_verdict_prog_to_map: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_NOEXIST</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to update sockmap: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="nl">out</span><span class="p">:</span>
<span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/jrfastab/linux-kernel-xdp/commit/c89fd73cb9d2d7f3c716c3e00836f07b1aeb261f">https://github.com/jrfastab/linux-kernel-xdp/commit/c89fd73cb9d2d7f3c716c3e00836f07b1aeb261f</a></p></li>
<li><p><a class="reference external" href="https://lwn.net/Articles/731133/">https://lwn.net/Articles/731133/</a></p></li>
<li><p><a class="reference external" href="http://vger.kernel.org/lpc_net2018_talks/ktls_bpf_paper.pdf">http://vger.kernel.org/lpc_net2018_talks/ktls_bpf_paper.pdf</a></p></li>
<li><p><a class="reference external" href="https://lwn.net/Articles/748628/">https://lwn.net/Articles/748628/</a></p></li>
<li><p><a class="reference external" href="https://lore.kernel.org/bpf/20200218171023.844439-7-jakub&#64;cloudflare.com/">https://lore.kernel.org/bpf/20200218171023.844439-7-jakub&#64;cloudflare.com/</a></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/bpf/map_sockmap.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>