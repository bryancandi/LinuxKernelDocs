<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IAA Compression Accelerator Crypto Driver &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="DMAEngine documentation" href="../../dmaengine/index.html" />
    <link rel="prev" title="IAA (Intel Analytics Accelerator)" href="index.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.10.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Driver APIs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../index.html#general-information-for-driver-authors">General information for driver authors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#useful-support-libraries">Useful support libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#bus-level-documentation">Bus-level documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html#subsystem-specific-apis">Subsystem-specific APIs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../80211/index.html">Linux 802.11 Driver Developer’s Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../acpi/index.html">ACPI Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../backlight/lp855x-driver.html">Kernel driver lp855x</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../clk.html">The Common Clk Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../console.html">Console Drivers</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Crypto Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dmaengine/index.html">DMAEngine documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dpll.html">The Linux kernel dpll subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../edac.html">Error Detection And Correction (EDAC) Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../firmware/index.html">Linux Firmware API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../fpga/index.html">FPGA Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../frame-buffer.html">Frame Buffer Library</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../aperture.html">Managing Ownership of the Framebuffer Aperture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../generic-counter.html">Generic Counter Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../gpio/index.html">General Purpose Input/Output (GPIO)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hsi.html">High Speed Synchronous Serial Interface (HSI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hte/index.html">The Linux Hardware Timestamping Engine (HTE)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../i2c.html">I<sup>2</sup>C and SMBus Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../infiniband.html">InfiniBand and Remote DMA (RDMA) Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../input.html">Input Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../interconnect.html">Generic System Interconnect Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ipmb.html">IPMB Driver for a Satellite MC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ipmi.html">The Linux IPMI Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../libata.html">libATA Developer’s Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mailbox.html">The Common Mailbox Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../md/index.html">RAID</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../media/index.html">Media subsystem kernel internal API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mei/index.html">Intel(R) Management Engine Interface (Intel(R) MEI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../memory-devices/index.html">Memory Controller drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../message-based.html">Message-based devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../misc_devices.html">Miscellaneous Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../miscellaneous.html">Parallel Port Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../miscellaneous.html#x50-uart-driver">16x50 UART Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../miscellaneous.html#pulse-width-modulation-pwm">Pulse-Width Modulation (PWM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mmc/index.html">MMC/SD/SDIO card support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mtd/index.html">Memory Technology Device (MTD)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mtdnand.html">MTD NAND Driver Programming Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../nfc/index.html">Near Field Communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ntb.html">NTB Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../nvdimm/index.html">Non-Volatile Memory Device (NVDIMM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../nvmem.html">NVMEM Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../parport-lowlevel.html">PARPORT interface documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../phy/index.html">Generic PHY Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pin-control.html">PINCTRL (PIN CONTROL) subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pldmfw/index.html">PLDM Firmware Flash Update Library</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pldmfw/index.html#overview-of-the-pldmfw-library">Overview of the <code class="docutils literal notranslate"><span class="pre">pldmfw</span></code> library</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pps.html">PPS - Pulse Per Second</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ptp.html">PTP hardware clock infrastructure for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pwm.html">Pulse Width Modulation (PWM) interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../regulator.html">Voltage and current regulator API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reset.html">Reset controller API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rfkill.html">rfkill - RF kill switch support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../s390-drivers.html">Writing s390 channel device drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../scsi.html">SCSI Interfaces Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../serial/index.html">Support for Serial devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sm501.html">SM501 Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../soundwire/index.html">SoundWire Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spi.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../surface_aggregator/index.html">Surface System Aggregator Module (SSAM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../switchtec.html">Linux Switchtec Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sync_file.html">Sync File API Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../target.html">target and iSCSI Interfaces Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tee.html">TEE (Trusted Execution Environment) driver API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../thermal/index.html">Thermal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tty/index.html">TTY</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../wbrf.html">WBRF - Wifi Band RFI Mitigations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../wmi.html">WMI Driver API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../xilinx/index.html">Xilinx FPGA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../zorro.html">Writing Device Drivers for Zorro Devices</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/driver-api/crypto/iaa/iaa-crypto.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="iaa-compression-accelerator-crypto-driver">
<h1>IAA Compression Accelerator Crypto Driver<a class="headerlink" href="#iaa-compression-accelerator-crypto-driver" title="Link to this heading">¶</a></h1>
<p>Tom Zanussi &lt;<a class="reference external" href="mailto:tom&#46;zanussi&#37;&#52;&#48;linux&#46;intel&#46;com">tom<span>&#46;</span>zanussi<span>&#64;</span>linux<span>&#46;</span>intel<span>&#46;</span>com</a>&gt;</p>
<p>The IAA crypto driver supports compression/decompression compatible
with the DEFLATE compression standard described in RFC 1951, which is
the compression/decompression algorithm exported by this module.</p>
<p>The IAA hardware spec can be found here:</p>
<blockquote>
<div><p><a class="reference external" href="https://cdrdv2.intel.com/v1/dl/getContent/721858">https://cdrdv2.intel.com/v1/dl/getContent/721858</a></p>
</div></blockquote>
<p>The iaa_crypto driver is designed to work as a layer underneath
higher-level compression devices such as zswap.</p>
<p>Users can select IAA compress/decompress acceleration by specifying
one of the supported IAA compression algorithms in whatever facility
allows compression algorithms to be selected.</p>
<p>For example, a zswap device can select the IAA ‘fixed’ mode
represented by selecting the ‘deflate-iaa’ crypto compression
algorithm:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo deflate-iaa &gt; /sys/module/zswap/parameters/compressor
</pre></div>
</div>
<p>This will tell zswap to use the IAA ‘fixed’ compression mode for all
compresses and decompresses.</p>
<p>Currently, there is only one compression modes available, ‘fixed’
mode.</p>
<p>The ‘fixed’ compression mode implements the compression scheme
specified by RFC 1951 and is given the crypto algorithm name
‘deflate-iaa’.  (Because the IAA hardware has a 4k history-window
limitation, only buffers &lt;= 4k, or that have been compressed using a
&lt;= 4k history window, are technically compliant with the deflate spec,
which allows for a window of up to 32k.  Because of this limitation,
the IAA fixed mode deflate algorithm is given its own algorithm name
rather than simply ‘deflate’).</p>
<section id="config-options-and-other-setup">
<h2>Config options and other setup<a class="headerlink" href="#config-options-and-other-setup" title="Link to this heading">¶</a></h2>
<p>The IAA crypto driver is available via menuconfig using the following
path:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Cryptographic API -&gt; Hardware crypto devices -&gt; Support for Intel(R) IAA Compression Accelerator
</pre></div>
</div>
<p>In the configuration file the option called CONFIG_CRYPTO_DEV_IAA_CRYPTO.</p>
<p>The IAA crypto driver also supports statistics, which are available
via menuconfig using the following path:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Cryptographic API -&gt; Hardware crypto devices -&gt; Support for Intel(R) IAA Compression -&gt; Enable Intel(R) IAA Compression Accelerator Statistics
</pre></div>
</div>
<p>In the configuration file the option called CONFIG_CRYPTO_DEV_IAA_CRYPTO_STATS.</p>
<p>The following config options should also be enabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_IRQ_REMAP=y
CONFIG_INTEL_IOMMU=y
CONFIG_INTEL_IOMMU_SVM=y
CONFIG_PCI_ATS=y
CONFIG_PCI_PRI=y
CONFIG_PCI_PASID=y
CONFIG_INTEL_IDXD=m
CONFIG_INTEL_IDXD_SVM=y
</pre></div>
</div>
<p>IAA is one of the first Intel accelerator IPs that can work in
conjunction with the Intel IOMMU.  There are multiple modes that exist
for testing. Based on IOMMU configuration, there are 3 modes:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- Scalable
- Legacy
- No IOMMU
</pre></div>
</div>
<section id="scalable-mode">
<h3>Scalable mode<a class="headerlink" href="#scalable-mode" title="Link to this heading">¶</a></h3>
<p>Scalable mode supports Shared Virtual Memory (SVM or SVA). It is
entered when using the kernel boot commandline:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>intel_iommu=on,sm_on
</pre></div>
</div>
<p>with VT-d turned on in BIOS.</p>
<p>With scalable mode, both shared and dedicated workqueues are available
for use.</p>
<p>For scalable mode, the following BIOS settings should be enabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Socket Configuration &gt; IIO Configuration &gt; Intel VT for Directed I/O (VT-d) &gt; Intel VT for Directed I/O

Socket Configuration &gt; IIO Configuration &gt; PCIe ENQCMD &gt; ENQCMDS
</pre></div>
</div>
</section>
<section id="legacy-mode">
<h3>Legacy mode<a class="headerlink" href="#legacy-mode" title="Link to this heading">¶</a></h3>
<p>Legacy mode is entered when using the kernel boot commandline:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>intel_iommu=off
</pre></div>
</div>
<p>or VT-d is not turned on in BIOS.</p>
<p>If you have booted into Linux and not sure if VT-d is on, do a “dmesg
| grep -i dmar”. If you don’t see a number of DMAR devices enumerated,
most likely VT-d is not on.</p>
<p>With legacy mode, only dedicated workqueues are available for use.</p>
</section>
<section id="no-iommu-mode">
<h3>No IOMMU mode<a class="headerlink" href="#no-iommu-mode" title="Link to this heading">¶</a></h3>
<p>No IOMMU mode is entered when using the kernel boot commandline:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>iommu=off.
</pre></div>
</div>
<p>With no IOMMU mode, only dedicated workqueues are available for use.</p>
</section>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<section id="accel-config">
<h3>accel-config<a class="headerlink" href="#accel-config" title="Link to this heading">¶</a></h3>
<p>When loaded, the iaa_crypto driver automatically creates a default
configuration and enables it, and assigns default driver attributes.
If a different configuration or set of driver attributes is required,
the user must first disable the IAA devices and workqueues, reset the
configuration, and then re-register the deflate-iaa algorithm with the
crypto subsystem by removing and reinserting the iaa_crypto module.</p>
<p>The <a class="reference internal" href="#iaa-disable-script"><span class="std std-ref">IAA disable script</span></a> in the ‘Use Cases’
section below can be used to disable the default configuration.</p>
<p>See <a class="reference internal" href="#iaa-default-config"><span class="std std-ref">IAA Default Configuration</span></a> below for details of the default
configuration.</p>
<p>More likely than not, however, and because of the complexity and
configurability of the accelerator devices, the user will want to
configure the device and manually enable the desired devices and
workqueues.</p>
<p>The userspace tool to help doing that is called accel-config.  Using
accel-config to configure device or loading a previously saved config
is highly recommended.  The device can be controlled via sysfs
directly but comes with the warning that you should do this ONLY if
you know exactly what you are doing.  The following sections will not
cover the sysfs interface but assumes you will be using accel-config.</p>
<p>The <a class="reference internal" href="#iaa-sysfs-config"><span class="std std-ref">IAA sysfs config interface</span></a> section in the appendix below can be
consulted for the sysfs interface details if interested.</p>
<p>The accel-config tool along with instructions for building it can be
found here:</p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/intel/idxd-config/#readme">https://github.com/intel/idxd-config/#readme</a></p>
</div></blockquote>
</section>
<section id="typical-usage">
<h3>Typical usage<a class="headerlink" href="#typical-usage" title="Link to this heading">¶</a></h3>
<p>In order for the iaa_crypto module to actually do any
compression/decompression work on behalf of a facility, one or more
IAA workqueues need to be bound to the iaa_crypto driver.</p>
<p>For instance, here’s an example of configuring an IAA workqueue and
binding it to the iaa_crypto driver (note that device names are
specified as ‘iax’ rather than ‘iaa’ - this is because upstream still
has the old ‘iax’ device naming in place)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># configure wq1.0

accel-config config-wq --group-id=0 --mode=dedicated --type=kernel --priority=10 --name=&quot;iaa_crypto&quot; --driver-name=&quot;crypto&quot; iax1/wq1.0

accel-config config-engine iax1/engine1.0 --group-id=0

# enable IAA device iax1

accel-config enable-device iax1

# enable wq1.0 on IAX device iax1

accel-config enable-wq iax1/wq1.0
</pre></div>
</div>
<p>Whenever a new workqueue is bound to or unbound from the iaa_crypto
driver, the available workqueues are ‘rebalanced’ such that work
submitted from a particular CPU is given to the most appropriate
workqueue available.  Current best practice is to configure and bind
at least one workqueue for each IAA device, but as long as there is at
least one workqueue configured and bound to any IAA device in the
system, the iaa_crypto driver will work, albeit most likely not as
efficiently.</p>
<p>The IAA crypto algorigthms is operational and compression and
decompression operations are fully enabled following the successful
binding of the first IAA workqueue to the iaa_crypto driver.</p>
<p>Similarly, the IAA crypto algorithm is not operational and compression
and decompression operations are disabled following the unbinding of
the last IAA worqueue to the iaa_crypto driver.</p>
<p>As a result, the IAA crypto algorithms and thus the IAA hardware are
only available when one or more workques are bound to the iaa_crypto
driver.</p>
<p>When there are no IAA workqueues bound to the driver, the IAA crypto
algorithms can be unregistered by removing the module.</p>
</section>
<section id="driver-attributes">
<h3>Driver attributes<a class="headerlink" href="#driver-attributes" title="Link to this heading">¶</a></h3>
<p>There are a couple user-configurable driver attributes that can be
used to configure various modes of operation.  They’re listed below,
along with their default values.  To set any of these attributes, echo
the appropriate values to the attribute file located under
/sys/bus/dsa/drivers/crypto/</p>
<p>The attribute settings at the time the IAA algorithms are registered
are captured in each algorithm’s crypto_ctx and used for all compresses
and decompresses when using that algorithm.</p>
<p>The available attributes are:</p>
<blockquote>
<div><ul>
<li><p>verify_compress</p>
<p>Toggle compression verification.  If set, each compress will be
internally decompressed and the contents verified, returning error
codes if unsuccessful.  This can be toggled with 0/1:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo 0 &gt; /sys/bus/dsa/drivers/crypto/verify_compress
</pre></div>
</div>
<p>The default setting is ‘1’ - verify all compresses.</p>
</li>
<li><p>sync_mode</p>
<p>Select mode to be used to wait for completion of each compresses
and decompress operation.</p>
<p>The crypto async interface support implemented by iaa_crypto
provides an implementation that satisfies the interface but does
so in a synchronous manner - it fills and submits the IDXD
descriptor and then loops around waiting for it to complete before
returning.  This isn’t a problem at the moment, since all existing
callers (e.g. zswap) wrap any asynchronous callees in a
synchronous wrapper anyway.</p>
<p>The iaa_crypto driver does however provide true asynchronous
support for callers that can make use of it.  In this mode, it
fills and submits the IDXD descriptor, then returns immediately
with -EINPROGRESS.  The caller can then either poll for completion
itself, which requires specific code in the caller which currently
nothing in the upstream kernel implements, or go to sleep and wait
for an interrupt signaling completion.  This latter mode is
supported by current users in the kernel such as zswap via
synchronous wrappers.  Although it is supported this mode is
significantly slower than the synchronous mode that does the
polling in the iaa_crypto driver previously mentioned.</p>
<p>This mode can be enabled by writing ‘async_irq’ to the sync_mode
iaa_crypto driver attribute:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo async_irq &gt; /sys/bus/dsa/drivers/crypto/sync_mode
</pre></div>
</div>
<p>Async mode without interrupts (caller must poll) can be enabled by
writing ‘async’ to it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo async &gt; /sys/bus/dsa/drivers/crypto/sync_mode
</pre></div>
</div>
<p>The mode that does the polling in the iaa_crypto driver can be
enabled by writing ‘sync’ to it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo sync &gt; /sys/bus/dsa/drivers/crypto/sync_mode
</pre></div>
</div>
<p>The default mode is ‘sync’.</p>
</li>
</ul>
</div></blockquote>
</section>
<section id="iaa-default-configuration">
<span id="iaa-default-config"></span><h3>IAA Default Configuration<a class="headerlink" href="#iaa-default-configuration" title="Link to this heading">¶</a></h3>
<p>When the iaa_crypto driver is loaded, each IAA device has a single
work queue configured for it, with the following attributes:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mode              &quot;dedicated&quot;
threshold         0
size              Total WQ Size from WQCAP
priority          10
type              IDXD_WQT_KERNEL
group             0
name              &quot;iaa_crypto&quot;
driver_name       &quot;crypto&quot;
</pre></div>
</div>
<p>The devices and workqueues are also enabled and therefore the driver
is ready to be used without any additional configuration.</p>
<p>The default driver attributes in effect when the driver is loaded are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sync_mode         &quot;sync&quot;
verify_compress   1
</pre></div>
</div>
<p>In order to change either the device/work queue or driver attributes,
the enabled devices and workqueues must first be disabled.  In order
to have the new configuration applied to the deflate-iaa crypto
algorithm, it needs to be re-registered by removing and reinserting
the iaa_crypto module.  The <a class="reference internal" href="#iaa-disable-script"><span class="std std-ref">IAA disable script</span></a> in the ‘Use
Cases’ section below can be used to disable the default configuration.</p>
</section>
</section>
<section id="statistics">
<h2>Statistics<a class="headerlink" href="#statistics" title="Link to this heading">¶</a></h2>
<p>If the optional debugfs statistics support is enabled, the IAA crypto
driver will generate statistics which can be accessed in debugfs at:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ls -al /sys/kernel/debug/iaa-crypto/
total 0
drwxr-xr-x  2 root root 0 Mar  3 07:55 .
drwx------ 53 root root 0 Mar  3 07:55 ..
-rw-r--r--  1 root root 0 Mar  3 07:55 global_stats
-rw-r--r--  1 root root 0 Mar  3 07:55 stats_reset
-rw-r--r--  1 root root 0 Mar  3 07:55 wq_stats
</pre></div>
</div>
<p>The global_stats file shows a set of global statistics collected since
the driver has been loaded or reset:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cat global_stats
global stats:
  total_comp_calls: 4300
  total_decomp_calls: 4164
  total_sw_decomp_calls: 0
  total_comp_bytes_out: 5993989
  total_decomp_bytes_in: 5993989
  total_completion_einval_errors: 0
  total_completion_timeout_errors: 0
  total_completion_comp_buf_overflow_errors: 136
</pre></div>
</div>
<p>The wq_stats file shows per-wq stats, a set for each iaa device and wq
in addition to some global stats:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cat wq_stats
iaa device:
  id: 1
  n_wqs: 1
  comp_calls: 0
  comp_bytes: 0
  decomp_calls: 0
  decomp_bytes: 0
  wqs:
    name: iaa_crypto
    comp_calls: 0
    comp_bytes: 0
    decomp_calls: 0
    decomp_bytes: 0

iaa device:
  id: 3
  n_wqs: 1
  comp_calls: 0
  comp_bytes: 0
  decomp_calls: 0
  decomp_bytes: 0
  wqs:
    name: iaa_crypto
    comp_calls: 0
    comp_bytes: 0
    decomp_calls: 0
    decomp_bytes: 0

iaa device:
  id: 5
  n_wqs: 1
  comp_calls: 1360
  comp_bytes: 1999776
  decomp_calls: 0
  decomp_bytes: 0
  wqs:
    name: iaa_crypto
    comp_calls: 1360
    comp_bytes: 1999776
    decomp_calls: 0
    decomp_bytes: 0

iaa device:
  id: 7
  n_wqs: 1
  comp_calls: 2940
  comp_bytes: 3994213
  decomp_calls: 4164
  decomp_bytes: 5993989
  wqs:
    name: iaa_crypto
    comp_calls: 2940
    comp_bytes: 3994213
    decomp_calls: 4164
    decomp_bytes: 5993989
  ...
</pre></div>
</div>
<p>Writing to ‘stats_reset’ resets all the stats, including the
per-device and per-wq stats:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo 1 &gt; stats_reset
# cat wq_stats
  global stats:
  total_comp_calls: 0
  total_decomp_calls: 0
  total_comp_bytes_out: 0
  total_decomp_bytes_in: 0
  total_completion_einval_errors: 0
  total_completion_timeout_errors: 0
  total_completion_comp_buf_overflow_errors: 0
  ...
</pre></div>
</div>
</section>
<section id="use-cases">
<h2>Use cases<a class="headerlink" href="#use-cases" title="Link to this heading">¶</a></h2>
<section id="simple-zswap-test">
<h3>Simple zswap test<a class="headerlink" href="#simple-zswap-test" title="Link to this heading">¶</a></h3>
<p>For this example, the kernel should be configured according to the
dedicated mode options described above, and zswap should be enabled as
well:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_ZSWAP=y
</pre></div>
</div>
<p>This is a simple test that uses iaa_compress as the compressor for a
swap (zswap) device.  It sets up the zswap device and then uses the
memory_memadvise program listed below to forcibly swap out and in a
specified number of pages, demonstrating both compress and decompress.</p>
<p>The zswap test expects the work queues for each IAA device on the
system to be configured properly as a kernel workqueue with a
workqueue driver_name of “crypto”.</p>
<p>The first step is to make sure the iaa_crypto module is loaded:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>modprobe iaa_crypto
</pre></div>
</div>
<p>If the IAA devices and workqueues haven’t previously been disabled and
reconfigured, then the default configuration should be in place and no
further IAA configuration is necessary.  See <a class="reference internal" href="#iaa-default-config"><span class="std std-ref">IAA Default Configuration</span></a>
below for details of the default configuration.</p>
<p>If the default configuration is in place, you should see the iaa
devices and wq0s enabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cat /sys/bus/dsa/devices/iax1/state
enabled
# cat /sys/bus/dsa/devices/iax1/wq1.0/state
enabled
</pre></div>
</div>
<p>To demonstrate that the following steps work as expected, these
commands can be used to enable debug output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo -n &#39;module iaa_crypto +p&#39; &gt; /sys/kernel/debug/dynamic_debug/control
# echo -n &#39;module idxd +p&#39; &gt; /sys/kernel/debug/dynamic_debug/control
</pre></div>
</div>
<p>Use the following commands to enable zswap:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo 0 &gt; /sys/module/zswap/parameters/enabled
# echo 50 &gt; /sys/module/zswap/parameters/max_pool_percent
# echo deflate-iaa &gt; /sys/module/zswap/parameters/compressor
# echo zsmalloc &gt; /sys/module/zswap/parameters/zpool
# echo 1 &gt; /sys/module/zswap/parameters/enabled
# echo 100 &gt; /proc/sys/vm/swappiness
# echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
# echo 1 &gt; /proc/sys/vm/overcommit_memory
</pre></div>
</div>
<p>Now you can now run the zswap workload you want to measure. For
example, using the memory_memadvise code below, the following command
will swap in and out 100 pages:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./memory_madvise 100

Allocating 100 pages to swap in/out
Swapping out 100 pages
Swapping in 100 pages
Swapped out and in 100 pages
</pre></div>
</div>
<p>You should see something like the following in the dmesg output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[  404.202972] idxd 0000:e7:02.0: iaa_comp_acompress: dma_map_sg, src_addr 223925c000, nr_sgs 1, req-&gt;src 00000000ee7cb5e6, req-&gt;slen 4096, sg_dma_len(sg) 4096
[  404.202973] idxd 0000:e7:02.0: iaa_comp_acompress: dma_map_sg, dst_addr 21dadf8000, nr_sgs 1, req-&gt;dst 000000008d6acea8, req-&gt;dlen 4096, sg_dma_len(sg) 8192
[  404.202975] idxd 0000:e7:02.0: iaa_compress: desc-&gt;src1_addr 223925c000, desc-&gt;src1_size 4096, desc-&gt;dst_addr 21dadf8000, desc-&gt;max_dst_size 4096, desc-&gt;src2_addr 2203543000, desc-&gt;src2_size 1568
[  404.202981] idxd 0000:e7:02.0: iaa_compress_verify: (verify) desc-&gt;src1_addr 21dadf8000, desc-&gt;src1_size 228, desc-&gt;dst_addr 223925c000, desc-&gt;max_dst_size 4096, desc-&gt;src2_addr 0, desc-&gt;src2_size 0
...
</pre></div>
</div>
<p>Now that basic functionality has been demonstrated, the defaults can
be erased and replaced with a different configuration.  To do that,
first disable zswap:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo lzo &gt; /sys/module/zswap/parameters/compressor
# swapoff -a
# echo 0 &gt; /sys/module/zswap/parameters/accept_threshold_percent
# echo 0 &gt; /sys/module/zswap/parameters/max_pool_percent
# echo 0 &gt; /sys/module/zswap/parameters/enabled
# echo 0 &gt; /sys/module/zswap/parameters/enabled
</pre></div>
</div>
<p>Then run the <a class="reference internal" href="#iaa-disable-script"><span class="std std-ref">IAA disable script</span></a> in the ‘Use Cases’ section
below to disable the default configuration.</p>
<p>Finally turn swap back on:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># swapon -a
</pre></div>
</div>
<p>Following all that the IAA device(s) can now be re-configured and
enabled as desired for further testing.  Below is one example.</p>
<p>The zswap test expects the work queues for each IAA device on the
system to be configured properly as a kernel workqueue with a
workqueue driver_name of “crypto”.</p>
<p>The below script automatically does that:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

echo &quot;IAA devices:&quot;
lspci -d:0cfe
echo &quot;# IAA devices:&quot;
lspci -d:0cfe | wc -l

#
# count iaa instances
#
iaa_dev_id=&quot;0cfe&quot;
num_iaa=$(lspci -d:${iaa_dev_id} | wc -l)
echo &quot;Found ${num_iaa} IAA instances&quot;

#
# disable iaa wqs and devices
#
echo &quot;Disable IAA&quot;

for ((i = 1; i &lt; ${num_iaa} * 2; i += 2)); do
    echo disable wq iax${i}/wq${i}.0
    accel-config disable-wq iax${i}/wq${i}.0
    echo disable iaa iax${i}
    accel-config disable-device iax${i}
done

echo &quot;End Disable IAA&quot;

echo &quot;Reload iaa_crypto module&quot;

rmmod iaa_crypto
modprobe iaa_crypto

echo &quot;End Reload iaa_crypto module&quot;

#
# configure iaa wqs and devices
#
echo &quot;Configure IAA&quot;
for ((i = 1; i &lt; ${num_iaa} * 2; i += 2)); do
    accel-config config-wq --group-id=0 --mode=dedicated --wq-size=128 --priority=10 --type=kernel --name=&quot;iaa_crypto&quot; --driver-name=&quot;crypto&quot; iax${i}/wq${i}.0
    accel-config config-engine iax${i}/engine${i}.0 --group-id=0
done

echo &quot;End Configure IAA&quot;

#
# enable iaa wqs and devices
#
echo &quot;Enable IAA&quot;

for ((i = 1; i &lt; ${num_iaa} * 2; i += 2)); do
    echo enable iaa iax${i}
    accel-config enable-device iax${i}
    echo enable wq iax${i}/wq${i}.0
    accel-config enable-wq iax${i}/wq${i}.0
done

echo &quot;End Enable IAA&quot;
</pre></div>
</div>
<p>When the workqueues are bound to the iaa_crypto driver, you should
see something similar to the following in dmesg output if you’ve
enabled debug output (echo -n ‘module iaa_crypto +p’ &gt;
/sys/kernel/debug/dynamic_debug/control):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[   60.752344] idxd 0000:f6:02.0: add_iaa_wq: added wq 000000004068d14d to iaa 00000000c9585ba2, n_wq 1
[   60.752346] iaa_crypto: rebalance_wq_table: nr_nodes=2, nr_cpus 160, nr_iaa 8, cpus_per_iaa 20
[   60.752347] iaa_crypto: rebalance_wq_table: iaa=0
[   60.752349] idxd 0000:6a:02.0: request_iaa_wq: getting wq from iaa_device 0000000042d7bc52 (0)
[   60.752350] idxd 0000:6a:02.0: request_iaa_wq: returning unused wq 00000000c8bb4452 (0) from iaa device 0000000042d7bc52 (0)
[   60.752352] iaa_crypto: rebalance_wq_table: assigned wq for cpu=0, node=0 = wq 00000000c8bb4452
[   60.752354] iaa_crypto: rebalance_wq_table: iaa=0
[   60.752355] idxd 0000:6a:02.0: request_iaa_wq: getting wq from iaa_device 0000000042d7bc52 (0)
[   60.752356] idxd 0000:6a:02.0: request_iaa_wq: returning unused wq 00000000c8bb4452 (0) from iaa device 0000000042d7bc52 (0)
[   60.752358] iaa_crypto: rebalance_wq_table: assigned wq for cpu=1, node=0 = wq 00000000c8bb4452
[   60.752359] iaa_crypto: rebalance_wq_table: iaa=0
[   60.752360] idxd 0000:6a:02.0: request_iaa_wq: getting wq from iaa_device 0000000042d7bc52 (0)
[   60.752361] idxd 0000:6a:02.0: request_iaa_wq: returning unused wq 00000000c8bb4452 (0) from iaa device 0000000042d7bc52 (0)
[   60.752362] iaa_crypto: rebalance_wq_table: assigned wq for cpu=2, node=0 = wq 00000000c8bb4452
[   60.752364] iaa_crypto: rebalance_wq_table: iaa=0
.
.
.
</pre></div>
</div>
<p>Once the workqueues and devices have been enabled, the IAA crypto
algorithms are enabled and available.  When the IAA crypto algorithms
have been successfully enabled, you should see the following dmesg
output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[   64.893759] iaa_crypto: iaa_crypto_enable: iaa_crypto now ENABLED
</pre></div>
</div>
<p>Now run the following zswap-specific setup commands to have zswap use
the ‘fixed’ compression mode:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo 0 &gt; /sys/module/zswap/parameters/enabled
echo 50 &gt; /sys/module/zswap/parameters/max_pool_percent
echo deflate-iaa &gt; /sys/module/zswap/parameters/compressor
echo zsmalloc &gt; /sys/module/zswap/parameters/zpool
echo 1 &gt; /sys/module/zswap/parameters/enabled

echo 100 &gt; /proc/sys/vm/swappiness
echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
echo 1 &gt; /proc/sys/vm/overcommit_memory
</pre></div>
</div>
<p>Finally, you can now run the zswap workload you want to measure. For
example, using the code below, the following command will swap in and
out 100 pages:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./memory_madvise 100

Allocating 100 pages to swap in/out
Swapping out 100 pages
Swapping in 100 pages
Swapped out and in 100 pages
</pre></div>
</div>
<p>You should see something like the following in the dmesg output if
you’ve enabled debug output (echo -n ‘module iaa_crypto +p’ &gt;
/sys/kernel/debug/dynamic_debug/control):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[  404.202972] idxd 0000:e7:02.0: iaa_comp_acompress: dma_map_sg, src_addr 223925c000, nr_sgs 1, req-&gt;src 00000000ee7cb5e6, req-&gt;slen 4096, sg_dma_len(sg) 4096
[  404.202973] idxd 0000:e7:02.0: iaa_comp_acompress: dma_map_sg, dst_addr 21dadf8000, nr_sgs 1, req-&gt;dst 000000008d6acea8, req-&gt;dlen 4096, sg_dma_len(sg) 8192
[  404.202975] idxd 0000:e7:02.0: iaa_compress: desc-&gt;src1_addr 223925c000, desc-&gt;src1_size 4096, desc-&gt;dst_addr 21dadf8000, desc-&gt;max_dst_size 4096, desc-&gt;src2_addr 2203543000, desc-&gt;src2_size 1568
[  404.202981] idxd 0000:e7:02.0: iaa_compress_verify: (verify) desc-&gt;src1_addr 21dadf8000, desc-&gt;src1_size 228, desc-&gt;dst_addr 223925c000, desc-&gt;max_dst_size 4096, desc-&gt;src2_addr 0, desc-&gt;src2_size 0
[  409.203227] idxd 0000:e7:02.0: iaa_comp_adecompress: dma_map_sg, src_addr 21ddd8b100, nr_sgs 1, req-&gt;src 0000000084adab64, req-&gt;slen 228, sg_dma_len(sg) 228
[  409.203235] idxd 0000:e7:02.0: iaa_comp_adecompress: dma_map_sg, dst_addr 21ee3dc000, nr_sgs 1, req-&gt;dst 000000004e2990d0, req-&gt;dlen 4096, sg_dma_len(sg) 4096
[  409.203239] idxd 0000:e7:02.0: iaa_decompress: desc-&gt;src1_addr 21ddd8b100, desc-&gt;src1_size 228, desc-&gt;dst_addr 21ee3dc000, desc-&gt;max_dst_size 4096, desc-&gt;src2_addr 0, desc-&gt;src2_size 0
[  409.203254] idxd 0000:e7:02.0: iaa_comp_adecompress: dma_map_sg, src_addr 21ddd8b100, nr_sgs 1, req-&gt;src 0000000084adab64, req-&gt;slen 228, sg_dma_len(sg) 228
[  409.203256] idxd 0000:e7:02.0: iaa_comp_adecompress: dma_map_sg, dst_addr 21f1551000, nr_sgs 1, req-&gt;dst 000000004e2990d0, req-&gt;dlen 4096, sg_dma_len(sg) 4096
[  409.203257] idxd 0000:e7:02.0: iaa_decompress: desc-&gt;src1_addr 21ddd8b100, desc-&gt;src1_size 228, desc-&gt;dst_addr 21f1551000, desc-&gt;max_dst_size 4096, desc-&gt;src2_addr 0, desc-&gt;src2_size 0
</pre></div>
</div>
<p>In order to unregister the IAA crypto algorithms, and register new
ones using different parameters, any users of the current algorithm
should be stopped and the IAA workqueues and devices disabled.</p>
<p>In the case of zswap, remove the IAA crypto algorithm as the
compressor and turn off swap (to remove all references to
iaa_crypto):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo lzo &gt; /sys/module/zswap/parameters/compressor
swapoff -a

echo 0 &gt; /sys/module/zswap/parameters/accept_threshold_percent
echo 0 &gt; /sys/module/zswap/parameters/max_pool_percent
echo 0 &gt; /sys/module/zswap/parameters/enabled
</pre></div>
</div>
<p>Once zswap is disabled and no longer using iaa_crypto, the IAA wqs and
devices can be disabled.</p>
</section>
<section id="iaa-disable-script">
<span id="id1"></span><h3>IAA disable script<a class="headerlink" href="#iaa-disable-script" title="Link to this heading">¶</a></h3>
<p>The below script automatically does that:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

echo &quot;IAA devices:&quot;
lspci -d:0cfe
echo &quot;# IAA devices:&quot;
lspci -d:0cfe | wc -l

#
# count iaa instances
#
iaa_dev_id=&quot;0cfe&quot;
num_iaa=$(lspci -d:${iaa_dev_id} | wc -l)
echo &quot;Found ${num_iaa} IAA instances&quot;

#
# disable iaa wqs and devices
#
echo &quot;Disable IAA&quot;

for ((i = 1; i &lt; ${num_iaa} * 2; i += 2)); do
    echo disable wq iax${i}/wq${i}.0
    accel-config disable-wq iax${i}/wq${i}.0
    echo disable iaa iax${i}
    accel-config disable-device iax${i}
done

echo &quot;End Disable IAA&quot;
</pre></div>
</div>
<p>Finally, at this point the iaa_crypto module can be removed, which
will unregister the current IAA crypto algorithms:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rmmod iaa_crypto
</pre></div>
</div>
<p>memory_madvise.c (gcc -o memory_memadvise memory_madvise.c):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;linux/mman.h&gt;

#ifndef MADV_PAGEOUT
#define MADV_PAGEOUT    21      /* force pages out immediately */
#endif

#define PG_SZ           4096

int main(int argc, char **argv)
{
      int i, nr_pages = 1;
      int64_t *dump_ptr;
      char *addr, *a;
      int loop = 1;

      if (argc &gt; 1)
              nr_pages = atoi(argv[1]);

      printf(&quot;Allocating %d pages to swap in/out\n&quot;, nr_pages);

      /* allocate pages */
      addr = mmap(NULL, nr_pages * PG_SZ, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0);
      *addr = 1;

      /* initialize data in page to all &#39;*&#39; chars */
      memset(addr, &#39;*&#39;, nr_pages * PG_SZ);

       printf(&quot;Swapping out %d pages\n&quot;, nr_pages);

      /* Tell kernel to swap it out */
      madvise(addr, nr_pages * PG_SZ, MADV_PAGEOUT);

      while (loop &gt; 0) {
              /* Wait for swap out to finish */
              sleep(5);

              a = addr;

              printf(&quot;Swapping in %d pages\n&quot;, nr_pages);

              /* Access the page ... this will swap it back in again */
              for (i = 0; i &lt; nr_pages; i++) {
                      if (a[0] != &#39;*&#39;) {
                              printf(&quot;Bad data from decompress!!!!!\n&quot;);

                              dump_ptr = (int64_t *)a;
                               for (int j = 0; j &lt; 100; j++) {
                                      printf(&quot;  page %d data: %#llx\n&quot;, i, *dump_ptr);
                                      dump_ptr++;
                              }
                      }

                      a += PG_SZ;
              }

              loop --;
      }

     printf(&quot;Swapped out and in %d pages\n&quot;, nr_pages);
</pre></div>
</div>
</section>
</section>
<section id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="Link to this heading">¶</a></h2>
<section id="iaa-sysfs-config-interface">
<span id="iaa-sysfs-config"></span><h3>IAA sysfs config interface<a class="headerlink" href="#iaa-sysfs-config-interface" title="Link to this heading">¶</a></h3>
<p>Below is a description of the IAA sysfs interface, which as mentioned
in the main document, should only be used if you know exactly what you
are doing.  Even then, there’s no compelling reason to use it directly
since accel-config can do everything the sysfs interface can and in
fact accel-config is based on it under the covers.</p>
<p>The ‘IAA config path’ is /sys/bus/dsa/devices and contains
subdirectories representing each IAA device, workqueue, engine, and
group.  Note that in the sysfs interface, the IAA devices are actually
named using iax e.g. iax1, iax3, etc. (Note that IAA devices are the
odd-numbered devices; the even-numbered devices are DSA devices and
can be ignored for IAA).</p>
<p>The ‘IAA device bind path’ is /sys/bus/dsa/drivers/idxd/bind and is
the file that is written to enable an IAA device.</p>
<p>The ‘IAA workqueue bind path’ is /sys/bus/dsa/drivers/crypto/bind and
is the file that is written to enable an IAA workqueue.</p>
<p>Similarly /sys/bus/dsa/drivers/idxd/unbind and
/sys/bus/dsa/drivers/crypto/unbind are used to disable IAA devices and
workqueues.</p>
<p>The basic sequence of commands needed to set up the IAA devices and
workqueues is:</p>
<dl>
<dt>For each device::</dt><dd><ol class="arabic">
<li><p>Disable any workqueues enabled on the device.  For example to
disable workques 0 and 1 on IAA device 3:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo wq3.0 &gt; /sys/bus/dsa/drivers/crypto/unbind
# echo wq3.1 &gt; /sys/bus/dsa/drivers/crypto/unbind
</pre></div>
</div>
</li>
<li><p>Disable the device. For example to disable IAA device 3:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo iax3 &gt; /sys/bus/dsa/drivers/idxd/unbind
</pre></div>
</div>
</li>
<li><p>configure the desired workqueues.  For example, to configure
workqueue 3 on IAA device 3:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo dedicated &gt; /sys/bus/dsa/devices/iax3/wq3.3/mode
# echo 128 &gt; /sys/bus/dsa/devices/iax3/wq3.3/size
# echo 0 &gt; /sys/bus/dsa/devices/iax3/wq3.3/group_id
# echo 10 &gt; /sys/bus/dsa/devices/iax3/wq3.3/priority
# echo &quot;kernel&quot; &gt; /sys/bus/dsa/devices/iax3/wq3.3/type
# echo &quot;iaa_crypto&quot; &gt; /sys/bus/dsa/devices/iax3/wq3.3/name
# echo &quot;crypto&quot; &gt; /sys/bus/dsa/devices/iax3/wq3.3/driver_name
</pre></div>
</div>
</li>
<li><p>Enable the device. For example to enable IAA device 3:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo iax3 &gt; /sys/bus/dsa/drivers/idxd/bind
</pre></div>
</div>
</li>
<li><p>Enable the desired workqueues on the device.  For example to
enable workques 0 and 1 on IAA device 3:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo wq3.0 &gt; /sys/bus/dsa/drivers/crypto/bind
# echo wq3.1 &gt; /sys/bus/dsa/drivers/crypto/bind
</pre></div>
</div>
</li>
</ol>
</dd>
</dl>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/driver-api/crypto/iaa/iaa-crypto.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>