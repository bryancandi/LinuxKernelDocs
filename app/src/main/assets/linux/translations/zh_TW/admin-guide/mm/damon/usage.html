<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>詳細用法 &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="基於DAMON的回收" href="reclaim.html" />
    <link rel="prev" title="入門指南" href="start.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.13.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../index.html">Translations</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../zh_CN/index.html">中文翻译</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../index.html">繁體中文翻譯</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#linux">與Linux 內核社區一起工作</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#api">內部API文檔</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id2">開發工具和流程</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../../index.html#id3">面向用戶的文檔</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id5">固件相關文檔</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id6">體系結構文檔</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id7">其他文檔</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id8">術語表</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id9">索引和表格</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../it_IT/index.html">La documentazione del kernel Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../ko_KR/index.html">한국어 번역</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../ja_JP/index.html">日本語訳</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../sp_SP/index.html">Traducción al español</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../index.html#disclaimer">Disclaimer</a></li>
</ul>
</li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../../_sources/translations/zh_TW/admin-guide/mm/damon/usage.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->



<div class="language-selection">
Chinese (Traditional)

<ul>

<li><a href="../../../../../admin-guide/mm/damon/usage.html">English</a></li>

<li><a href="../../../../zh_CN/admin-guide/mm/damon/usage.html">Chinese (Simplified)</a></li>

</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>此文件的目的是爲讓中文讀者更容易閱讀和理解，而不是作爲一個分支。因此，
如果您對此文件有任何意見或改動，請先嘗試更新原始英文文件。如果要更改或
修正某處翻譯文件，請將意見或補丁發送給維護者（聯繫方式見下）。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果您發現本文檔與原始文件有任何不同或者有翻譯問題，請聯繫該文件的譯者，
或者發送電子郵件給胡皓文以獲取幫助：&lt;<a class="reference external" href="mailto:2023002089&#37;&#52;&#48;link&#46;tyut&#46;edu&#46;cn">2023002089<span>&#64;</span>link<span>&#46;</span>tyut<span>&#46;</span>edu<span>&#46;</span>cn</a>&gt;。</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Original<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html"><span class="doc">Detailed Usages</span></a></p>
</dd>
<dt class="field-even">翻譯<span class="colon">:</span></dt>
<dd class="field-even"><p>司延騰 Yanteng Si &lt;<a class="reference external" href="mailto:siyanteng&#37;&#52;&#48;loongson&#46;cn">siyanteng<span>&#64;</span>loongson<span>&#46;</span>cn</a>&gt;</p>
</dd>
<dt class="field-odd">校譯<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<section id="id1">
<h1>詳細用法<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p>DAMON 爲不同的用戶提供了下面這些接口。</p>
<ul class="simple">
<li><p><em>DAMON用戶空間工具。</em>
<a class="reference external" href="https://github.com/damonitor/damo">這</a> 爲有這特權的人， 如系統管理員，希望有一個剛好
可以工作的人性化界面。
使用它，用戶可以以人性化的方式使用DAMON的主要功能。不過，它可能不會爲特殊情況進行高度調整。
它同時支持虛擬和物理地址空間的監測。更多細節，請參考它的 <a class="reference external" href="https://github.com/damonitor/damo/blob/next/USAGE.md">使用文檔</a>。</p></li>
<li><p><em>sysfs接口。</em>
<a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#sysfs-interface"><span class="std std-ref">這</span></a> 是爲那些希望更高級的使用DAMON的特權用戶空間程序員準備的。
使用它，用戶可以通過讀取和寫入特殊的sysfs文件來使用DAMON的主要功能。因此，你可以編寫和使
用你個性化的DAMON sysfs包裝程序，代替你讀/寫sysfs文件。  <a class="reference external" href="https://github.com/damonitor/damo">DAMON用戶空間工具</a> 就是這種程序的一個例子  它同時支持虛擬和物理地址
空間的監測。注意，這個界面只提供簡單的監測結果 <a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#damos-stats"><span class="std std-ref">統計</span></a>。對於詳細的監測
結果，DAMON提供了一個:ref:<cite>跟蹤點 &lt;tracepoint&gt;</cite>。</p></li>
<li><p><em>debugfs interface.</em>
<a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#debugfs-interface"><span class="std std-ref">這</span></a> 幾乎與:ref:<cite>sysfs interface &lt;sysfs_interface&gt;</cite> 接
口相同。這將在下一個LTS內核發佈後被移除，所以用戶應該轉移到
<a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#sysfs-interface"><span class="std std-ref">sysfs interface</span></a>。</p></li>
<li><p><em>內核空間編程接口。</em>
<a class="reference internal" href="../../../../../mm/damon/api.html"><span class="doc">這</span></a> 這是爲內核空間程序員準備的。使用它，用戶可以通過爲你編寫內
核空間的DAMON應用程序，最靈活有效地利用DAMON的每一個功能。你甚至可以爲各種地址空間擴展DAMON。
詳細情況請參考接口 <a class="reference internal" href="../../../../../mm/damon/api.html"><span class="doc">文件</span></a>。</p></li>
</ul>
<section id="sysfs">
<h2>sysfs接口<a class="headerlink" href="#sysfs" title="Link to this heading">¶</a></h2>
<p>DAMON的sysfs接口是在定義 <code class="docutils literal notranslate"><span class="pre">CONFIG_DAMON_SYSFS</span></code> 時建立的。它在其sysfs目錄下創建多
個目錄和文件， <code class="docutils literal notranslate"><span class="pre">&lt;sysfs&gt;/kernel/mm/damon/</span></code> 。你可以通過對該目錄下的文件進行寫入和
讀取來控制DAMON。</p>
<p>對於一個簡短的例子，用戶可以監測一個給定工作負載的虛擬地址空間，如下所示:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd /sys/kernel/mm/damon/admin/
# echo 1 &gt; kdamonds/nr_kdamonds &amp;&amp; echo 1 &gt; kdamonds/0/contexts/nr_contexts
# echo vaddr &gt; kdamonds/0/contexts/0/operations
# echo 1 &gt; kdamonds/0/contexts/0/targets/nr_targets
# echo $(pidof &lt;workload&gt;) &gt; kdamonds/0/contexts/0/targets/0/pid_target
# echo on &gt; kdamonds/0/state
</pre></div>
</div>
<section id="id4">
<h3>文件層次結構<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<p>DAMON sysfs接口的文件層次結構如下圖所示。在下圖中，父子關係用縮進表示，每個目錄有
<code class="docutils literal notranslate"><span class="pre">/</span></code> 後綴，每個目錄中的文件用逗號（”,”）分開。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/sys/kernel/mm/damon/admin
│ kdamonds/nr_kdamonds
│ │ 0/state,pid
│ │ │ contexts/nr_contexts
│ │ │ │ 0/operations
│ │ │ │ │ monitoring_attrs/
│ │ │ │ │ │ intervals/sample_us,aggr_us,update_us
│ │ │ │ │ │ nr_regions/min,max
│ │ │ │ │ targets/nr_targets
│ │ │ │ │ │ 0/pid_target
│ │ │ │ │ │ │ regions/nr_regions
│ │ │ │ │ │ │ │ 0/start,end
│ │ │ │ │ │ │ │ ...
│ │ │ │ │ │ ...
│ │ │ │ │ schemes/nr_schemes
│ │ │ │ │ │ 0/action
│ │ │ │ │ │ │ access_pattern/
│ │ │ │ │ │ │ │ sz/min,max
│ │ │ │ │ │ │ │ nr_accesses/min,max
│ │ │ │ │ │ │ │ age/min,max
│ │ │ │ │ │ │ quotas/ms,bytes,reset_interval_ms
│ │ │ │ │ │ │ │ weights/sz_permil,nr_accesses_permil,age_permil
│ │ │ │ │ │ │ watermarks/metric,interval_us,high,mid,low
│ │ │ │ │ │ │ stats/nr_tried,sz_tried,nr_applied,sz_applied,qt_exceeds
│ │ │ │ │ │ │ tried_regions/
│ │ │ │ │ │ │ │ 0/start,end,nr_accesses,age
│ │ │ │ │ │ │ │ ...
│ │ │ │ │ │ ...
│ │ │ │ ...
│ │ ...
</pre></div>
</div>
</section>
<section id="id5">
<h3>根<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p>DAMON sysfs接口的根是 <code class="docutils literal notranslate"><span class="pre">&lt;sysfs&gt;/kernel/mm/damon/</span></code> ，它有一個名爲 <code class="docutils literal notranslate"><span class="pre">admin</span></code> 的
目錄。該目錄包含特權用戶空間程序控制DAMON的文件。擁有根權限的用戶空間工具或deamons可以
使用這個目錄。</p>
</section>
<section id="kdamonds">
<h3>kdamonds/<a class="headerlink" href="#kdamonds" title="Link to this heading">¶</a></h3>
<p>與監測相關的信息包括請求規格和結果被稱爲DAMON上下文。DAMON用一個叫做kdamond的內核線程
執行每個上下文，多個kdamonds可以並行運行。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">admin</span></code> 目錄下，有一個目錄，即``kdamonds``，它有控制kdamonds的文件存在。在開始
時，這個目錄只有一個文件，<code class="docutils literal notranslate"><span class="pre">nr_kdamonds</span></code>。向該文件寫入一個數字（<code class="docutils literal notranslate"><span class="pre">N</span></code>），就會創建名爲
<code class="docutils literal notranslate"><span class="pre">0</span></code> 到 <code class="docutils literal notranslate"><span class="pre">N-1</span></code> 的子目錄數量。每個目錄代表每個kdamond。</p>
</section>
<section id="kdamonds-n">
<h3>kdamonds/&lt;N&gt;/<a class="headerlink" href="#kdamonds-n" title="Link to this heading">¶</a></h3>
<p>在每個kdamond目錄中，存在兩個文件（<code class="docutils literal notranslate"><span class="pre">state</span></code> 和 <code class="docutils literal notranslate"><span class="pre">pid</span></code> ）和一個目錄( <code class="docutils literal notranslate"><span class="pre">contexts</span></code> )。</p>
<p>讀取 <code class="docutils literal notranslate"><span class="pre">state</span></code> 時，如果kdamond當前正在運行，則返回 <code class="docutils literal notranslate"><span class="pre">on</span></code> ，如果沒有運行則返回 <code class="docutils literal notranslate"><span class="pre">off</span></code> 。
寫入 <code class="docutils literal notranslate"><span class="pre">on</span></code> 或 <code class="docutils literal notranslate"><span class="pre">off</span></code> 使kdamond處於狀態。向 <code class="docutils literal notranslate"><span class="pre">state</span></code> 文件寫 <code class="docutils literal notranslate"><span class="pre">update_schemes_stats</span></code> ，
更新kdamond的每個基於DAMON的操作方案的統計文件的內容。關於統計信息的細節，請參考
<a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#sysfs-schemes-stats"><span class="std std-ref">stats section</span></a>. 將 <code class="docutils literal notranslate"><span class="pre">update_schemes_tried_regions</span></code> 寫到
<code class="docutils literal notranslate"><span class="pre">state</span></code> 文件，爲kdamond的每個基於DAMON的操作方案，更新基於DAMON的操作方案動作的嘗試區域目錄。
將`clear_schemes_tried_regions`寫入`state`文件，清除kdamond的每個基於DAMON的操作方案的動作
嘗試區域目錄。 關於基於DAMON的操作方案動作嘗試區域目錄的細節，請參考:ref:tried_regions 部分
&lt;sysfs_schemes_tried_regions&gt;`。</p>
<p>如果狀態爲 <code class="docutils literal notranslate"><span class="pre">on</span></code>，讀取 <code class="docutils literal notranslate"><span class="pre">pid</span></code> 顯示kdamond線程的pid。</p>
<p><code class="docutils literal notranslate"><span class="pre">contexts</span></code> 目錄包含控制這個kdamond要執行的監測上下文的文件。</p>
</section>
<section id="kdamonds-n-contexts">
<h3>kdamonds/&lt;N&gt;/contexts/<a class="headerlink" href="#kdamonds-n-contexts" title="Link to this heading">¶</a></h3>
<p>在開始時，這個目錄只有一個文件，即 <code class="docutils literal notranslate"><span class="pre">nr_contexts</span></code> 。向該文件寫入一個數字( <code class="docutils literal notranslate"><span class="pre">N</span></code> )，就會創
建名爲``0`` 到 <code class="docutils literal notranslate"><span class="pre">N-1</span></code> 的子目錄數量。每個目錄代表每個監測背景。目前，每個kdamond只支持
一個上下文，所以只有 <code class="docutils literal notranslate"><span class="pre">0</span></code> 或 <code class="docutils literal notranslate"><span class="pre">1</span></code> 可以被寫入文件。</p>
</section>
<section id="contexts-n">
<h3>contexts/&lt;N&gt;/<a class="headerlink" href="#contexts-n" title="Link to this heading">¶</a></h3>
<p>在每個上下文目錄中，存在一個文件(<code class="docutils literal notranslate"><span class="pre">operations</span></code>)和三個目錄(<code class="docutils literal notranslate"><span class="pre">monitoring_attrs</span></code>,
<code class="docutils literal notranslate"><span class="pre">targets</span></code>, 和 <code class="docutils literal notranslate"><span class="pre">schemes</span></code>)。</p>
<p>DAMON支持多種類型的監測操作，包括對虛擬地址空間和物理地址空間的監測。你可以通過向文件
中寫入以下關鍵詞之一，並從文件中讀取，來設置和獲取DAMON將爲上下文使用何種類型的監測操作。</p>
<blockquote>
<div><ul class="simple">
<li><p>vaddr: 監測特定進程的虛擬地址空間</p></li>
<li><p>paddr: 監視系統的物理地址空間</p></li>
</ul>
</div></blockquote>
</section>
<section id="contexts-n-monitoring-attrs">
<h3>contexts/&lt;N&gt;/monitoring_attrs/<a class="headerlink" href="#contexts-n-monitoring-attrs" title="Link to this heading">¶</a></h3>
<p>用於指定監測屬性的文件，包括所需的監測質量和效率，都在 <code class="docutils literal notranslate"><span class="pre">monitoring_attrs</span></code> 目錄中。
具體來說，這個目錄下有兩個目錄，即 <code class="docutils literal notranslate"><span class="pre">intervals</span></code> 和 <code class="docutils literal notranslate"><span class="pre">nr_regions</span></code> 。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">intervals</span></code> 目錄下，存在DAMON的採樣間隔(<code class="docutils literal notranslate"><span class="pre">sample_us</span></code>)、聚集間隔(<code class="docutils literal notranslate"><span class="pre">aggr_us</span></code>)
和更新間隔(<code class="docutils literal notranslate"><span class="pre">update_us</span></code>)三個文件。你可以通過寫入和讀出這些文件來設置和獲取微秒級的值。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">nr_regions</span></code> 目錄下，有兩個文件分別用於DAMON監測區域的下限和上限（<code class="docutils literal notranslate"><span class="pre">min</span></code> 和 <code class="docutils literal notranslate"><span class="pre">max</span></code> ），
這兩個文件控制着監測的開銷。你可以通過向這些文件的寫入和讀出來設置和獲取這些值。</p>
<p>關於間隔和監測區域範圍的更多細節，請參考設計文件 (<a class="reference internal" href="../../../../../mm/damon/design.html"><span class="doc">Design</span></a>)。</p>
</section>
<section id="contexts-n-targets">
<h3>contexts/&lt;N&gt;/targets/<a class="headerlink" href="#contexts-n-targets" title="Link to this heading">¶</a></h3>
<p>在開始時，這個目錄只有一個文件 <code class="docutils literal notranslate"><span class="pre">nr_targets</span></code> 。向該文件寫入一個數字(<code class="docutils literal notranslate"><span class="pre">N</span></code>)，就可以創建
名爲 <code class="docutils literal notranslate"><span class="pre">0</span></code> 到 <code class="docutils literal notranslate"><span class="pre">N-1</span></code> 的子目錄的數量。每個目錄代表每個監測目標。</p>
</section>
<section id="targets-n">
<h3>targets/&lt;N&gt;/<a class="headerlink" href="#targets-n" title="Link to this heading">¶</a></h3>
<p>在每個目標目錄中，存在一個文件(<code class="docutils literal notranslate"><span class="pre">pid_target</span></code>)和一個目錄(<code class="docutils literal notranslate"><span class="pre">regions</span></code>)。</p>
<p>如果你把 <code class="docutils literal notranslate"><span class="pre">vaddr</span></code> 寫到 <code class="docutils literal notranslate"><span class="pre">contexts/&lt;N&gt;/operations</span></code> 中，每個目標應該是一個進程。你
可以通過將進程的pid寫到 <code class="docutils literal notranslate"><span class="pre">pid_target</span></code> 文件中來指定DAMON的進程。</p>
</section>
<section id="targets-n-regions">
<h3>targets/&lt;N&gt;/regions<a class="headerlink" href="#targets-n-regions" title="Link to this heading">¶</a></h3>
<p>當使用 <code class="docutils literal notranslate"><span class="pre">vaddr</span></code> 監測操作集時（ <code class="docutils literal notranslate"><span class="pre">vaddr</span></code> 被寫入 <code class="docutils literal notranslate"><span class="pre">contexts/&lt;N&gt;/operations</span></code> 文
件），DAMON自動設置和更新監測目標區域，這樣就可以覆蓋目標進程的整個內存映射。然而，用戶可
能希望將初始監測區域設置爲特定的地址範圍。</p>
<p>相反，當使用 <code class="docutils literal notranslate"><span class="pre">paddr</span></code> 監測操作集時，DAMON不會自動設置和更新監測目標區域（ <code class="docutils literal notranslate"><span class="pre">paddr</span></code>
被寫入 <code class="docutils literal notranslate"><span class="pre">contexts/&lt;N&gt;/operations</span></code> 中）。因此，在這種情況下，用戶應該自己設置監測目標
區域。</p>
<p>在這種情況下，用戶可以按照自己的意願明確設置初始監測目標區域，將適當的值寫入該目錄下的文件。</p>
<p>開始時，這個目錄只有一個文件， <code class="docutils literal notranslate"><span class="pre">nr_regions</span></code> 。向該文件寫入一個數字(<code class="docutils literal notranslate"><span class="pre">N</span></code>)，就可以創
建名爲 <code class="docutils literal notranslate"><span class="pre">0</span></code> 到  <code class="docutils literal notranslate"><span class="pre">N-1</span></code> 的子目錄。每個目錄代表每個初始監測目標區域。</p>
</section>
<section id="regions-n">
<h3>regions/&lt;N&gt;/<a class="headerlink" href="#regions-n" title="Link to this heading">¶</a></h3>
<p>在每個區域目錄中，你會發現兩個文件（ <code class="docutils literal notranslate"><span class="pre">start</span></code>  和  <code class="docutils literal notranslate"><span class="pre">end</span></code> ）。你可以通過向文件寫入
和從文件中讀出，分別設置和獲得初始監測目標區域的起始和結束地址。</p>
<p>每個區域不應該與其他區域重疊。 目錄“N”的“結束”應等於或小於目錄“N+1”的“開始”。</p>
</section>
<section id="contexts-n-schemes">
<h3>contexts/&lt;N&gt;/schemes/<a class="headerlink" href="#contexts-n-schemes" title="Link to this heading">¶</a></h3>
<p>對於一版的基於DAMON的數據訪問感知的內存管理優化，用戶通常希望系統對特定訪問模式的內存區
域應用內存管理操作。DAMON從用戶那裏接收這種形式化的操作方案，並將這些方案應用於目標內存
區域。用戶可以通過讀取和寫入這個目錄下的文件來獲得和設置這些方案。</p>
<p>在開始時，這個目錄只有一個文件，<code class="docutils literal notranslate"><span class="pre">nr_schemes</span></code>。向該文件寫入一個數字(<code class="docutils literal notranslate"><span class="pre">N</span></code>)，就可以
創建名爲``0``到``N-1``的子目錄的數量。每個目錄代表每個基於DAMON的操作方案。</p>
</section>
<section id="schemes-n">
<h3>schemes/&lt;N&gt;/<a class="headerlink" href="#schemes-n" title="Link to this heading">¶</a></h3>
<p>在每個方案目錄中，存在五個目錄(<code class="docutils literal notranslate"><span class="pre">access_pattern</span></code>、<code class="docutils literal notranslate"><span class="pre">quotas</span></code>、<code class="docutils literal notranslate"><span class="pre">watermarks</span></code>、
<code class="docutils literal notranslate"><span class="pre">stats</span></code> 和 <code class="docutils literal notranslate"><span class="pre">tried_regions</span></code>)和一個文件(<code class="docutils literal notranslate"><span class="pre">action</span></code>)。</p>
<p><code class="docutils literal notranslate"><span class="pre">action</span></code> 文件用於設置和獲取你想應用於具有特定訪問模式的內存區域的動作。可以寫入文件
和從文件中讀取的關鍵詞及其含義如下。</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">willneed</span></code>: 對有 <code class="docutils literal notranslate"><span class="pre">MADV_WILLNEED</span></code> 的區域調用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cold</span></code>: 對具有 <code class="docutils literal notranslate"><span class="pre">MADV_COLD</span></code> 的區域調用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pageout</span></code>: 爲具有 <code class="docutils literal notranslate"><span class="pre">MADV_PAGEOUT</span></code> 的區域調用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hugepage</span></code>: 爲帶有 <code class="docutils literal notranslate"><span class="pre">MADV_HUGEPAGE</span></code> 的區域調用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nohugepage</span></code>: 爲帶有 <code class="docutils literal notranslate"><span class="pre">MADV_NOHUGEPAGE</span></code> 的區域調用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lru_prio</span></code>: 在其LRU列表上對區域進行優先排序。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lru_deprio</span></code>: 對區域的LRU列表進行降低優先處理。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stat</span></code>: 什麼都不做，只計算統計數據</p></li>
</ul>
</div></blockquote>
</section>
<section id="schemes-n-access-pattern">
<h3>schemes/&lt;N&gt;/access_pattern/<a class="headerlink" href="#schemes-n-access-pattern" title="Link to this heading">¶</a></h3>
<p>每個基於DAMON的操作方案的目標訪問模式由三個範圍構成，包括以字節爲單位的區域大小、每個
聚合區間的監測訪問次數和區域年齡的聚合區間數。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">access_pattern</span></code> 目錄下，存在三個目錄（ <code class="docutils literal notranslate"><span class="pre">sz</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code>, 和 <code class="docutils literal notranslate"><span class="pre">age</span></code> ），
每個目錄有兩個文件（<code class="docutils literal notranslate"><span class="pre">min</span></code> 和 <code class="docutils literal notranslate"><span class="pre">max</span></code> ）。你可以通過向  <code class="docutils literal notranslate"><span class="pre">sz</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code>, 和
<code class="docutils literal notranslate"><span class="pre">age</span></code>  目錄下的 <code class="docutils literal notranslate"><span class="pre">min</span></code> 和 <code class="docutils literal notranslate"><span class="pre">max</span></code> 文件分別寫入和讀取來設置和獲取給定方案的訪問模式。</p>
</section>
<section id="schemes-n-quotas">
<h3>schemes/&lt;N&gt;/quotas/<a class="headerlink" href="#schemes-n-quotas" title="Link to this heading">¶</a></h3>
<p>每個 <code class="docutils literal notranslate"><span class="pre">動作</span></code> 的最佳 <code class="docutils literal notranslate"><span class="pre">目標訪問模式</span></code> 取決於工作負載，所以不容易找到。更糟糕的是，將某些動作
的方案設置得過於激進會造成嚴重的開銷。爲了避免這種開銷，用戶可以爲每個方案限制時間和大小配額。
具體來說，用戶可以要求DAMON儘量只使用特定的時間（<code class="docutils literal notranslate"><span class="pre">時間配額</span></code>）來應用動作，並且在給定的時間間
隔（<code class="docutils literal notranslate"><span class="pre">重置間隔</span></code>）內，只對具有目標訪問模式的內存區域應用動作，而不使用特定數量（<code class="docutils literal notranslate"><span class="pre">大小配額</span></code>）。</p>
<p>當預計超過配額限制時，DAMON會根據 <code class="docutils literal notranslate"><span class="pre">目標訪問模式</span></code> 的大小、訪問頻率和年齡，對找到的內存區域
進行優先排序。爲了進行個性化的優先排序，用戶可以爲這三個屬性設置權重。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">quotas</span></code> 目錄下，存在三個文件（<code class="docutils literal notranslate"><span class="pre">ms</span></code>, <code class="docutils literal notranslate"><span class="pre">bytes</span></code>, <code class="docutils literal notranslate"><span class="pre">reset_interval_ms</span></code>）和一個
目錄(<code class="docutils literal notranslate"><span class="pre">weights</span></code>)，其中有三個文件(<code class="docutils literal notranslate"><span class="pre">sz_permil</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_accesses_permil</span></code>, 和
<code class="docutils literal notranslate"><span class="pre">age_permil</span></code>)。</p>
<p>你可以設置以毫秒爲單位的 <code class="docutils literal notranslate"><span class="pre">時間配額</span></code> ，以字節爲單位的 <code class="docutils literal notranslate"><span class="pre">大小配額</span></code> ，以及以毫秒爲單位的 <code class="docutils literal notranslate"><span class="pre">重</span>
<span class="pre">置間隔</span></code> ，分別向這三個文件寫入數值。你還可以通過向 <code class="docutils literal notranslate"><span class="pre">weights</span></code> 目錄下的三個文件寫入數值來設
置大小、訪問頻率和年齡的優先權，單位爲千分之一。</p>
</section>
<section id="schemes-n-watermarks">
<h3>schemes/&lt;N&gt;/watermarks/<a class="headerlink" href="#schemes-n-watermarks" title="Link to this heading">¶</a></h3>
<p>爲了便於根據系統狀態激活和停用每個方案，DAMON提供了一個稱爲水位的功能。該功能接收五個值，稱爲
<code class="docutils literal notranslate"><span class="pre">度量</span></code> 、<code class="docutils literal notranslate"><span class="pre">間隔</span></code> 、<code class="docutils literal notranslate"><span class="pre">高</span></code> 、<code class="docutils literal notranslate"><span class="pre">中</span></code> 、<code class="docutils literal notranslate"><span class="pre">低</span></code> 。<code class="docutils literal notranslate"><span class="pre">度量值</span></code> 是指可以測量的系統度量值，如
自由內存比率。如果系統的度量值 <code class="docutils literal notranslate"><span class="pre">高</span></code> 於memoent的高值或 <code class="docutils literal notranslate"><span class="pre">低</span></code> 於低值，則該方案被停用。如果
該值低於 <code class="docutils literal notranslate"><span class="pre">中</span></code> ，則該方案被激活。</p>
<p>在水位目錄下，存在五個文件(<code class="docutils literal notranslate"><span class="pre">metric</span></code>, <code class="docutils literal notranslate"><span class="pre">interval_us</span></code>,``high``, <code class="docutils literal notranslate"><span class="pre">mid</span></code>, and <code class="docutils literal notranslate"><span class="pre">low</span></code>)
用於設置每個值。你可以通過向這些文件的寫入來分別設置和獲取這五個值。</p>
<p>可以寫入 <code class="docutils literal notranslate"><span class="pre">metric</span></code> 文件的關鍵詞和含義如下。</p>
<blockquote>
<div><ul class="simple">
<li><p>none: 忽略水位</p></li>
<li><p>free_mem_rate: 系統的自由內存率（千分比）。</p></li>
</ul>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">interval</span></code> 應以微秒爲單位寫入。</p>
</section>
<section id="schemes-n-stats">
<h3>schemes/&lt;N&gt;/stats/<a class="headerlink" href="#schemes-n-stats" title="Link to this heading">¶</a></h3>
<p>DAMON統計每個方案被嘗試應用的區域的總數量和字節數，每個方案被成功應用的區域的兩個數字，以及
超過配額限制的總數量。這些統計數據可用於在線分析或調整方案。</p>
<p>可以通過讀取 <code class="docutils literal notranslate"><span class="pre">stats</span></code> 目錄下的文件(<code class="docutils literal notranslate"><span class="pre">nr_tried</span></code>, <code class="docutils literal notranslate"><span class="pre">sz_tried</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_applied</span></code>,
<code class="docutils literal notranslate"><span class="pre">sz_applied</span></code>, 和 <code class="docutils literal notranslate"><span class="pre">qt_exceeds</span></code>)）分別檢索這些統計數據。這些文件不是實時更新的，所以
你應該要求DAMON sysfs接口通過在相關的 <code class="docutils literal notranslate"><span class="pre">kdamonds/&lt;N&gt;/state</span></code> 文件中寫入一個特殊的關鍵字
<code class="docutils literal notranslate"><span class="pre">update_schemes_stats</span></code> 來更新統計信息的文件內容。</p>
</section>
<section id="schemes-n-tried-regions">
<h3>schemes/&lt;N&gt;/tried_regions/<a class="headerlink" href="#schemes-n-tried-regions" title="Link to this heading">¶</a></h3>
<p>當一個特殊的關鍵字 <code class="docutils literal notranslate"><span class="pre">update_schemes_tried_regions</span></code> 被寫入相關的 <code class="docutils literal notranslate"><span class="pre">kdamonds/&lt;N&gt;/state</span></code>
文件時，DAMON會在這個目錄下創建從 <code class="docutils literal notranslate"><span class="pre">0</span></code> 開始命名的整數目錄。每個目錄包含的文件暴露了關於每個
內存區域的詳細信息，在下一個 <a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#sysfs-monitoring-attrs"><span class="std std-ref">聚集區間</span></a>，相應的方案的 <code class="docutils literal notranslate"><span class="pre">動作</span></code>
已經嘗試在這個目錄下應用。這些信息包括地址範圍、<code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code> 以及區域的 <code class="docutils literal notranslate"><span class="pre">年齡</span></code> 。</p>
<p>當另一個特殊的關鍵字 <code class="docutils literal notranslate"><span class="pre">clear_schemes_tried_regions</span></code> 被寫入相關的 <code class="docutils literal notranslate"><span class="pre">kdamonds/&lt;N&gt;/state</span></code>
文件時，這些目錄將被刪除。</p>
</section>
<section id="tried-regions-n">
<h3>tried_regions/&lt;N&gt;/<a class="headerlink" href="#tried-regions-n" title="Link to this heading">¶</a></h3>
<p>在每個區域目錄中，你會發現四個文件(<code class="docutils literal notranslate"><span class="pre">start</span></code>, <code class="docutils literal notranslate"><span class="pre">end</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code>, and <code class="docutils literal notranslate"><span class="pre">age</span></code>)。
讀取這些文件將顯示相應的基於DAMON的操作方案 <code class="docutils literal notranslate"><span class="pre">動作</span></code> 試圖應用的區域的開始和結束地址、<code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code>
和 <code class="docutils literal notranslate"><span class="pre">年齡</span></code> 。</p>
<section id="id6">
<h4>用例<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h4>
<p>下面的命令應用了一個方案：”如果一個大小爲[4KiB, 8KiB]的內存區域在[10, 20]的聚合時間間隔內
顯示出每一個聚合時間間隔[0, 5]的訪問量，請分頁該區域。對於分頁，每秒最多隻能使用10ms，而且每
秒分頁不能超過1GiB。在這一限制下，首先分頁出具有較長年齡的內存區域。另外，每5秒鐘檢查一次系統
的可用內存率，當可用內存率低於50%時開始監測和分頁，但如果可用內存率大於60%，或低於30%，則停
止監測。“</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;sysfs&gt;/kernel/mm/damon/admin
# # populate directories
# echo 1 &gt; kdamonds/nr_kdamonds; echo 1 &gt; kdamonds/0/contexts/nr_contexts;
# echo 1 &gt; kdamonds/0/contexts/0/schemes/nr_schemes
# cd kdamonds/0/contexts/0/schemes/0
# # set the basic access pattern and the action
# echo 4096 &gt; access_pattern/sz/min
# echo 8192 &gt; access_pattern/sz/max
# echo 0 &gt; access_pattern/nr_accesses/min
# echo 5 &gt; access_pattern/nr_accesses/max
# echo 10 &gt; access_pattern/age/min
# echo 20 &gt; access_pattern/age/max
# echo pageout &gt; action
# # set quotas
# echo 10 &gt; quotas/ms
# echo $((1024*1024*1024)) &gt; quotas/bytes
# echo 1000 &gt; quotas/reset_interval_ms
# # set watermark
# echo free_mem_rate &gt; watermarks/metric
# echo 5000000 &gt; watermarks/interval_us
# echo 600 &gt; watermarks/high
# echo 500 &gt; watermarks/mid
# echo 300 &gt; watermarks/low
</pre></div>
</div>
<p>請注意，我們強烈建議使用用戶空間的工具，如 <a class="reference external" href="https://github.com/damonitor/damo">damo</a> ，
而不是像上面那樣手動讀寫文件。以上只是一個例子。</p>
</section>
</section>
</section>
<section id="debugfs">
<h2>debugfs接口<a class="headerlink" href="#debugfs" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>DAMON debugfs接口將在下一個LTS內核發佈後被移除，所以用戶應該轉移到
<a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#sysfs-interface"><span class="std std-ref">sysfs接口</span></a>。</p>
</div>
<p>DAMON導出了八個文件, <code class="docutils literal notranslate"><span class="pre">attrs</span></code>, <code class="docutils literal notranslate"><span class="pre">target_ids</span></code>, <code class="docutils literal notranslate"><span class="pre">init_regions</span></code>,
<code class="docutils literal notranslate"><span class="pre">schemes</span></code>, <code class="docutils literal notranslate"><span class="pre">monitor_on_DEPRECATED</span></code>, <code class="docutils literal notranslate"><span class="pre">kdamond_pid</span></code>, <code class="docutils literal notranslate"><span class="pre">mk_contexts</span></code> 和
<code class="docutils literal notranslate"><span class="pre">rm_contexts</span></code> under its debugfs directory, <code class="docutils literal notranslate"><span class="pre">&lt;debugfs&gt;/damon/</span></code>.</p>
<section id="id7">
<h3>屬性<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h3>
<p>用戶可以通過讀取和寫入 <code class="docutils literal notranslate"><span class="pre">attrs</span></code> 文件獲得和設置 <code class="docutils literal notranslate"><span class="pre">採樣間隔</span></code> 、 <code class="docutils literal notranslate"><span class="pre">聚集間隔</span></code> 、 <code class="docutils literal notranslate"><span class="pre">更新間隔</span></code>
以及監測目標區域的最小/最大數量。要詳細瞭解監測屬性，請參考 <cite>:doc:/mm/damon/design</cite> 。例如，
下面的命令將這些值設置爲5ms、100ms、1000ms、10和1000，然後再次檢查:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;debugfs&gt;/damon
# echo 5000 100000 1000000 10 1000 &gt; attrs
# cat attrs
5000 100000 1000000 10 1000
</pre></div>
</div>
</section>
<section id="id">
<h3>目標ID<a class="headerlink" href="#id" title="Link to this heading">¶</a></h3>
<p>一些類型的地址空間支持多個監測目標。例如，虛擬內存地址空間的監測可以有多個進程作爲監測目標。用戶
可以通過寫入目標的相關id值來設置目標，並通過讀取 <code class="docutils literal notranslate"><span class="pre">target_ids</span></code> 文件來獲得當前目標的id。在監
測虛擬地址空間的情況下，這些值應該是監測目標進程的pid。例如，下面的命令將pid爲42和4242的進程設
爲監測目標，並再次檢查:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;debugfs&gt;/damon
# echo 42 4242 &gt; target_ids
# cat target_ids
42 4242
</pre></div>
</div>
<p>用戶還可以通過在文件中寫入一個特殊的關鍵字 “paddrn” 來監測系統的物理內存地址空間。因爲物理地
址空間監測不支持多個目標，讀取文件會顯示一個假值，即 <code class="docutils literal notranslate"><span class="pre">42</span></code> ，如下圖所示:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;debugfs&gt;/damon
# echo paddr &gt; target_ids
# cat target_ids
42
</pre></div>
</div>
<p>請注意，設置目標ID並不啓動監測。</p>
</section>
<section id="id8">
<h3>初始監測目標區域<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h3>
<p>在虛擬地址空間監測的情況下，DAMON自動設置和更新監測的目標區域，這樣就可以覆蓋目標進程的整個
內存映射。然而，用戶可能希望將監測區域限制在特定的地址範圍內，如堆、棧或特定的文件映射區域。
或者，一些用戶可以知道他們工作負載的初始訪問模式，因此希望爲“自適應區域調整”設置最佳初始區域。</p>
<p>相比之下，DAMON在物理內存監測的情況下不會自動設置和更新監測目標區域。因此，用戶應該自己設置
監測目標區域。</p>
<p>在這種情況下，用戶可以通過在 <code class="docutils literal notranslate"><span class="pre">init_regions</span></code> 文件中寫入適當的值，明確地設置他們想要的初
始監測目標區域。輸入應該是一個由三個整數組成的隊列，用空格隔開，代表一個區域的形式如下:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;target idx&gt; &lt;start address&gt; &lt;end address&gt;
</pre></div>
</div>
<p>目標idx應該是 <code class="docutils literal notranslate"><span class="pre">target_ids</span></code> 文件中目標的索引，從 <code class="docutils literal notranslate"><span class="pre">0</span></code> 開始，區域應該按照地址順序傳遞。
例如，下面的命令將設置幾個地址範圍， <code class="docutils literal notranslate"><span class="pre">1-100</span></code> 和 <code class="docutils literal notranslate"><span class="pre">100-200</span></code> 作爲pid 42的初始監測目標
區域，這是 <code class="docutils literal notranslate"><span class="pre">target_ids</span></code> 中的第一個（索引 <code class="docutils literal notranslate"><span class="pre">0</span></code> ），另外幾個地址範圍， <code class="docutils literal notranslate"><span class="pre">20-40</span></code> 和
<code class="docutils literal notranslate"><span class="pre">50-100</span></code> 作爲pid 4242的地址，這是 <code class="docutils literal notranslate"><span class="pre">target_ids</span></code> 中的第二個（索引 <code class="docutils literal notranslate"><span class="pre">1</span></code> ）:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;debugfs&gt;/damon
# cat target_ids
42 4242
# echo &quot;0   1       100 \
        0   100     200 \
        1   20      40  \
        1   50      100&quot; &gt; init_regions
</pre></div>
</div>
<p>請注意，這只是設置了初始的監測目標區域。在虛擬內存監測的情況下，DAMON會在一個 <code class="docutils literal notranslate"><span class="pre">更新間隔</span></code>
後自動更新區域的邊界。因此，在這種情況下，如果用戶不希望更新的話，應該把 <code class="docutils literal notranslate"><span class="pre">更新間隔</span></code> 設
置得足夠大。</p>
</section>
<section id="id9">
<h3>方案<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h3>
<p>對於通常的基於DAMON的數據訪問感知的內存管理優化，用戶只是希望系統對特定訪問模式的內存區域應用內
存管理操作。DAMON從用戶那裏接收這種形式化的操作方案，並將這些方案應用到目標進程中。</p>
<p>用戶可以通過讀取和寫入 <code class="docutils literal notranslate"><span class="pre">scheme</span></code> debugfs文件來獲得和設置這些方案。讀取該文件還可以顯示每個
方案的統計數據。在文件中，每一個方案都應該在每一行中以下列形式表示出來:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;target access pattern&gt; &lt;action&gt; &lt;quota&gt; &lt;watermarks&gt;
</pre></div>
</div>
<p>你可以通過簡單地在文件中寫入一個空字符串來禁用方案。</p>
<section id="id10">
<h4>目標訪問模式<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">&lt;目標訪問模式&gt;</span></code> 是由三個範圍構成的，形式如下:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>min-size max-size min-acc max-acc min-age max-age
</pre></div>
</div>
<p>具體來說，區域大小的字節數（ <cite>min-size</cite> 和 <cite>max-size</cite> ），訪問頻率的每聚合區間的監測訪問次
數（ <cite>min-acc</cite> 和 <cite>max-acc</cite> ），區域年齡的聚合區間數（ <cite>min-age</cite> 和 <cite>max-age</cite> ）都被指定。
請注意，這些範圍是封閉區間。</p>
</section>
<section id="id11">
<h4>動作<a class="headerlink" href="#id11" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">&lt;action&gt;</span></code> 是一個預定義的內存管理動作的整數，DAMON將應用於具有目標訪問模式的區域。支持
的數字和它們的含義如下:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- 0: Call ``madvise()`` for the region with ``MADV_WILLNEED``
- 1: Call ``madvise()`` for the region with ``MADV_COLD``
- 2: Call ``madvise()`` for the region with ``MADV_PAGEOUT``
- 3: Call ``madvise()`` for the region with ``MADV_HUGEPAGE``
- 4: Call ``madvise()`` for the region with ``MADV_NOHUGEPAGE``
- 5: Do nothing but count the statistics
</pre></div>
</div>
</section>
<section id="id12">
<h4>配額<a class="headerlink" href="#id12" title="Link to this heading">¶</a></h4>
<p>每個 <code class="docutils literal notranslate"><span class="pre">動作</span></code> 的最佳 <code class="docutils literal notranslate"><span class="pre">目標訪問模式</span></code> 取決於工作負載，所以不容易找到。更糟糕的是，將某個
動作的方案設置得過於激進會導致嚴重的開銷。爲了避免這種開銷，用戶可以通過下面表格中的 <code class="docutils literal notranslate"><span class="pre">&lt;quota&gt;</span></code>
來限制方案的時間和大小配額:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;ms&gt; &lt;sz&gt; &lt;reset interval&gt; &lt;priority weights&gt;
</pre></div>
</div>
<p>這使得DAMON在 <code class="docutils literal notranslate"><span class="pre">&lt;reset</span> <span class="pre">interval&gt;</span></code> 毫秒內，儘量只用 <code class="docutils literal notranslate"><span class="pre">&lt;ms&gt;</span></code> 毫秒的時間對 <code class="docutils literal notranslate"><span class="pre">目標訪</span>
<span class="pre">問模式</span></code> 的內存區域應用動作，並在 <code class="docutils literal notranslate"><span class="pre">&lt;reset</span> <span class="pre">interval&gt;</span></code> 內只對最多&lt;sz&gt;字節的內存區域應
用動作。將 <code class="docutils literal notranslate"><span class="pre">&lt;ms&gt;</span></code> 和 <code class="docutils literal notranslate"><span class="pre">&lt;sz&gt;</span></code> 都設置爲零，可以禁用配額限制。</p>
<p>當預計超過配額限制時，DAMON會根據 <code class="docutils literal notranslate"><span class="pre">目標訪問模式</span></code> 的大小、訪問頻率和年齡，對發現的內存
區域進行優先排序。爲了實現個性化的優先級，用戶可以在 <code class="docutils literal notranslate"><span class="pre">&lt;優先級權重&gt;</span></code> 中設置這三個屬性的
權重，具體形式如下:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;size weight&gt; &lt;access frequency weight&gt; &lt;age weight&gt;
</pre></div>
</div>
</section>
<section id="id13">
<h4>水位<a class="headerlink" href="#id13" title="Link to this heading">¶</a></h4>
<p>有些方案需要根據系統特定指標的當前值來運行，如自由內存比率。對於這種情況，用戶可以爲該條
件指定水位。:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;metric&gt; &lt;check interval&gt; &lt;high mark&gt; &lt;middle mark&gt; &lt;low mark&gt;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&lt;metric&gt;</span></code> 是一個預定義的整數，用於要檢查的度量。支持的數字和它們的含義如下。</p>
<blockquote>
<div><ul class="simple">
<li><p>0: 忽視水位</p></li>
<li><p>1: 系統空閒內存率 (千分比)</p></li>
</ul>
</div></blockquote>
<p>每隔 <code class="docutils literal notranslate"><span class="pre">&lt;檢查間隔&gt;</span></code> 微秒檢查一次公制的值。</p>
<p>如果該值高於 <code class="docutils literal notranslate"><span class="pre">&lt;高標&gt;</span></code> 或低於 <code class="docutils literal notranslate"><span class="pre">&lt;低標&gt;</span></code> ，該方案被停用。如果該值低於 <code class="docutils literal notranslate"><span class="pre">&lt;中標&gt;</span></code> ，
該方案將被激活。</p>
</section>
<section id="id14">
<h4>統計數據<a class="headerlink" href="#id14" title="Link to this heading">¶</a></h4>
<p>它還統計每個方案被嘗試應用的區域的總數量和字節數，每個方案被成功應用的區域的兩個數量，以
及超過配額限制的總數量。這些統計數據可用於在線分析或調整方案。</p>
<p>統計數據可以通過讀取方案文件來顯示。讀取該文件將顯示你在每一行中輸入的每個 <code class="docutils literal notranslate"><span class="pre">方案</span></code> ，
統計的五個數字將被加在每一行的末尾。</p>
</section>
<section id="id15">
<h4>例子<a class="headerlink" href="#id15" title="Link to this heading">¶</a></h4>
<p>下面的命令應用了一個方案：”如果一個大小爲[4KiB, 8KiB]的內存區域在[10, 20]的聚合時間
間隔內顯示出每一個聚合時間間隔[0, 5]的訪問量，請分頁出該區域。對於分頁，每秒最多隻能使
用10ms，而且每秒分頁不能超過1GiB。在這一限制下，首先分頁出具有較長年齡的內存區域。另外，
每5秒鐘檢查一次系統的可用內存率，當可用內存率低於50%時開始監測和分頁，但如果可用內存率
大於60%，或低於30%，則停止監測“:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;debugfs&gt;/damon
# scheme=&quot;4096 8192  0 5    10 20    2&quot;  # target access pattern and action
# scheme+=&quot; 10 $((1024*1024*1024)) 1000&quot; # quotas
# scheme+=&quot; 0 0 100&quot;                     # prioritization weights
# scheme+=&quot; 1 5000000 600 500 300&quot;       # watermarks
# echo &quot;$scheme&quot; &gt; schemes
</pre></div>
</div>
</section>
</section>
<section id="id16">
<h3>開關<a class="headerlink" href="#id16" title="Link to this heading">¶</a></h3>
<p>除非你明確地啓動監測，否則如上所述的文件設置不會產生效果。你可以通過寫入和讀取 <code class="docutils literal notranslate"><span class="pre">monitor_on_DEPRECATED</span></code>
文件來啓動、停止和檢查監測的當前狀態。寫入 <code class="docutils literal notranslate"><span class="pre">on</span></code> 該文件可以啓動對有屬性的目標的監測。寫入
<code class="docutils literal notranslate"><span class="pre">off</span></code> 該文件則停止這些目標。如果每個目標進程被終止，DAMON也會停止。下面的示例命令開啓、關
閉和檢查DAMON的狀態:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;debugfs&gt;/damon
# echo on &gt; monitor_on_DEPRECATED
# echo off &gt; monitor_on_DEPRECATED
# cat monitor_on_DEPRECATED
off
</pre></div>
</div>
<p>請注意，當監測開啓時，你不能寫到上述的debugfs文件。如果你在DAMON運行時寫到這些文件，將會返
回一個錯誤代碼，如 <code class="docutils literal notranslate"><span class="pre">-EBUSY</span></code> 。</p>
</section>
<section id="pid">
<h3>監測線程PID<a class="headerlink" href="#pid" title="Link to this heading">¶</a></h3>
<p>DAMON通過一個叫做kdamond的內核線程來進行請求監測。你可以通過讀取 <code class="docutils literal notranslate"><span class="pre">kdamond_pid</span></code> 文件獲
得該線程的 <code class="docutils literal notranslate"><span class="pre">pid</span></code> 。當監測被 <code class="docutils literal notranslate"><span class="pre">關閉</span></code> 時，讀取該文件不會返回任何信息:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;debugfs&gt;/damon
# cat monitor_on_DEPRECATED
off
# cat kdamond_pid
none
# echo on &gt; monitor_on_DEPRECATED
# cat kdamond_pid
18594
</pre></div>
</div>
</section>
<section id="id17">
<h3>使用多個監測線程<a class="headerlink" href="#id17" title="Link to this heading">¶</a></h3>
<p>每個監測上下文都會創建一個 <code class="docutils literal notranslate"><span class="pre">kdamond</span></code> 線程。你可以使用 <code class="docutils literal notranslate"><span class="pre">mk_contexts</span></code> 和 <code class="docutils literal notranslate"><span class="pre">rm_contexts</span></code>
文件爲多個 <code class="docutils literal notranslate"><span class="pre">kdamond</span></code> 需要的用例創建和刪除監測上下文。</p>
<p>將新上下文的名稱寫入 <code class="docutils literal notranslate"><span class="pre">mk_contexts</span></code> 文件，在 <code class="docutils literal notranslate"><span class="pre">DAMON</span> <span class="pre">debugfs</span></code> 目錄上創建一個該名稱的目錄。
該目錄將有該上下文的 <code class="docutils literal notranslate"><span class="pre">DAMON</span> <span class="pre">debugfs</span></code> 文件:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;debugfs&gt;/damon
# ls foo
# ls: cannot access &#39;foo&#39;: No such file or directory
# echo foo &gt; mk_contexts
# ls foo
# attrs  init_regions  kdamond_pid  schemes  target_ids
</pre></div>
</div>
<p>如果不再需要上下文，你可以通過把上下文的名字放到 <code class="docutils literal notranslate"><span class="pre">rm_contexts</span></code> 文件中來刪除它和相應的目錄:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo foo &gt; rm_contexts
# ls foo
# ls: cannot access &#39;foo&#39;: No such file or directory
</pre></div>
</div>
<p>注意， <code class="docutils literal notranslate"><span class="pre">mk_contexts</span></code> 、 <code class="docutils literal notranslate"><span class="pre">rm_contexts</span></code> 和 <code class="docutils literal notranslate"><span class="pre">monitor_on_DEPRECATED</span></code> 文件只在根目錄下。</p>
</section>
</section>
<section id="id18">
<h2>監測結果的監測點<a class="headerlink" href="#id18" title="Link to this heading">¶</a></h2>
<p>DAMON通過一個tracepoint <code class="docutils literal notranslate"><span class="pre">damon:damon_aggregated</span></code> 提供監測結果.  當監測開啓時，你可
以記錄追蹤點事件，並使用追蹤點支持工具如perf顯示結果。比如說:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo on &gt; monitor_on_DEPRECATED
# perf record -e damon:damon_aggregated &amp;
# sleep 5
# kill 9 $(pidof perf)
# echo off &gt; monitor_on_DEPRECATED
# perf script
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../../../_sources/translations/zh_TW/admin-guide/mm/damon/usage.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>