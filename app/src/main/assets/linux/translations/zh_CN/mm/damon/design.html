
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>设计 &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="API参考" href="api.html" />
    <link rel="prev" title="常见问题" href="faq.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.7.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../process/development-process.html">A guide to the Kernel Development Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../process/submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../driver-api/index.html">Driver implementer's API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../subsystem-apis.html">Kernel subsystem documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../locking/index.html">Locking in the kernel</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../process/license-rules.html">Linux kernel licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev-tools/testing-overview.html">Kernel Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../livepatch/index.html">Kernel Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../admin-guide/index.html">The Linux kernel user's and administrator's guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kbuild/index.html">The kernel build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/index.html">User-space tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../arch/index.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../staging/index.html">Unsorted Documentation</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Translations</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">中文翻译</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../index.html#linux">与Linux 内核社区一起工作</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../index.html#api">内部API文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#id2">开发工具和流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#id3">面向用户的文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#id5">固件相关文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#id6">体系结构文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#id7">其他文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#id8">术语表</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#id9">索引和表格</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../zh_TW/index.html">繁體中文翻譯</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../it_IT/index.html">La documentazione del kernel Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ko_KR/index.html">한국어 번역</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ja_JP/index.html">日本語訳</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../sp_SP/index.html">Traducción al español</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../index.html#disclaimer">Disclaimer</a></li>
</ul>
</li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  sbar.scrollTop = currents[currents.length - 1].offsetTop;
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/translations/zh_CN/mm/damon/design.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="id1">
<h1>设计<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h1>
<section id="id2">
<h2>可配置的层<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<p>DAMON提供了数据访问监控功能，同时使其准确性和开销可控。基本的访问监控需要依赖于目标地址空间
并为之优化的基元。另一方面，作为DAMON的核心，准确性和开销的权衡机制是在纯逻辑空间中。DAMON
将这两部分分离在不同的层中，并定义了它的接口，以允许各种低层次的基元实现与核心逻辑的配置。</p>
<p>由于这种分离的设计和可配置的接口，用户可以通过配置核心逻辑和适当的低级基元实现来扩展DAMON的
任何地址空间。如果没有提供合适的，用户可以自己实现基元。</p>
<p>例如，物理内存、虚拟内存、交换空间、那些特定的进程、NUMA节点、文件和支持的内存设备将被支持。
另外，如果某些架构或设备支持特殊的优化访问检查基元，这些基元将很容易被配置。</p>
</section>
<section id="id3">
<h2>特定地址空间基元的参考实现<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h2>
<p>基本访问监测的低级基元被定义为两部分。:</p>
<ol class="arabic simple">
<li><p>确定地址空间的监测目标地址范围</p></li>
<li><p>目标空间中特定地址范围的访问检查。</p></li>
</ol>
<p>DAMON目前为物理和虚拟地址空间提供了基元的实现。下面两个小节描述了这些工作的方式。</p>
<section id="vma">
<h3>基于VMA的目标地址范围构造<a class="headerlink" href="#vma" title="Permalink to this heading">¶</a></h3>
<p>这仅仅是针对虚拟地址空间基元的实现。对于物理地址空间，只是要求用户手动设置监控目标地址范围。</p>
<p>在进程的超级巨大的虚拟地址空间中，只有小部分被映射到物理内存并被访问。因此，跟踪未映射的地
址区域只是一种浪费。然而，由于DAMON可以使用自适应区域调整机制来处理一定程度的噪声，所以严
格来说，跟踪每一个映射并不是必须的，但在某些情况下甚至会产生很高的开销。也就是说，监测目标
内部过于巨大的未映射区域应该被移除，以不占用自适应机制的时间。</p>
<p>出于这个原因，这个实现将复杂的映射转换为三个不同的区域，覆盖地址空间的每个映射区域。这三个
区域之间的两个空隙是给定地址空间中两个最大的未映射区域。这两个最大的未映射区域是堆和最上面
的mmap()区域之间的间隙，以及在大多数情况下最下面的mmap()区域和堆之间的间隙。因为这些间隙
在通常的地址空间中是异常巨大的，排除这些间隙就足以做出合理的权衡。下面详细说明了这一点:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;heap&gt;
&lt;BIG UNMAPPED REGION 1&gt;
&lt;uppermost mmap()-ed region&gt;
(small mmap()-ed regions and munmap()-ed regions)
&lt;lowermost mmap()-ed region&gt;
&lt;BIG UNMAPPED REGION 2&gt;
&lt;stack&gt;
</pre></div>
</div>
</section>
<section id="pte">
<h3>基于PTE访问位的访问检查<a class="headerlink" href="#pte" title="Permalink to this heading">¶</a></h3>
<p>物理和虚拟地址空间的实现都使用PTE Accessed-bit进行基本访问检查。唯一的区别在于从地址中
找到相关的PTE访问位的方式。虚拟地址的实现是为该地址的目标任务查找页表，而物理地址的实现则
是查找与该地址有映射关系的每一个页表。通过这种方式，实现者找到并清除下一个采样目标地址的位，
并检查该位是否在一个采样周期后再次设置。这可能会干扰其他使用访问位的内核子系统，即空闲页跟
踪和回收逻辑。为了避免这种干扰，DAMON使其与空闲页面跟踪相互排斥，并使用 <code class="docutils literal notranslate"><span class="pre">PG_idle</span></code> 和
<code class="docutils literal notranslate"><span class="pre">PG_young</span></code> 页面标志来解决与回收逻辑的冲突，就像空闲页面跟踪那样。</p>
</section>
</section>
<section id="id4">
<h2>独立于地址空间的核心机制<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h2>
<p>下面四个部分分别描述了DAMON的核心机制和五个监测属性，即 <code class="docutils literal notranslate"><span class="pre">采样间隔</span></code> 、 <code class="docutils literal notranslate"><span class="pre">聚集间隔</span></code> 、
<code class="docutils literal notranslate"><span class="pre">更新间隔</span></code> 、 <code class="docutils literal notranslate"><span class="pre">最小区域数</span></code> 和 <code class="docutils literal notranslate"><span class="pre">最大区域数</span></code> 。</p>
<section id="id5">
<h3>访问频率监测<a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h3>
<p>DAMON的输出显示了在给定的时间内哪些页面的访问频率是多少。访问频率的分辨率是通过设置
<code class="docutils literal notranslate"><span class="pre">采样间隔</span></code> 和 <code class="docutils literal notranslate"><span class="pre">聚集间隔</span></code> 来控制的。详细地说，DAMON检查每个 <code class="docutils literal notranslate"><span class="pre">采样间隔</span></code> 对每
个页面的访问，并将结果汇总。换句话说，计算每个页面的访问次数。在每个 <code class="docutils literal notranslate"><span class="pre">聚合间隔</span></code> 过
去后，DAMON调用先前由用户注册的回调函数，以便用户可以阅读聚合的结果，然后再清除这些结
果。这可以用以下简单的伪代码来描述:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>while monitoring_on:
    for page in monitoring_target:
        if accessed(page):
            nr_accesses[page] += 1
    if time() % aggregation_interval == 0:
        for callback in user_registered_callbacks:
            callback(monitoring_target, nr_accesses)
        for page in monitoring_target:
            nr_accesses[page] = 0
    sleep(sampling interval)
</pre></div>
</div>
<p>这种机制的监测开销将随着目标工作负载规模的增长而任意增加。</p>
</section>
<section id="id6">
<h3>基于区域的抽样调查<a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<p>为了避免开销的无限制增加，DAMON将假定具有相同访问频率的相邻页面归入一个区域。只要保持
这个假设（一个区域内的页面具有相同的访问频率），该区域内就只需要检查一个页面。因此，对
于每个 <code class="docutils literal notranslate"><span class="pre">采样间隔</span></code> ，DAMON在每个区域中随机挑选一个页面，等待一个 <code class="docutils literal notranslate"><span class="pre">采样间隔</span></code> ，检
查该页面是否同时被访问，如果被访问则增加该区域的访问频率。因此，监测开销是可以通过设置
区域的数量来控制的。DAMON允许用户设置最小和最大的区域数量来进行权衡。</p>
<p>然而，如果假设没有得到保证，这个方案就不能保持输出的质量。</p>
</section>
<section id="id7">
<h3>适应性区域调整<a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h3>
<p>即使最初的监测目标区域被很好地构建以满足假设（同一区域内的页面具有相似的访问频率），数
据访问模式也会被动态地改变。这将导致监测质量下降。为了尽可能地保持假设，DAMON根据每个
区域的访问频率自适应地进行合并和拆分。</p>
<p>对于每个 <code class="docutils literal notranslate"><span class="pre">聚集区间</span></code> ，它比较相邻区域的访问频率，如果频率差异较小，就合并这些区域。
然后，在它报告并清除每个区域的聚合接入频率后，如果区域总数不超过用户指定的最大区域数，
它将每个区域拆分为两个或三个区域。</p>
<p>通过这种方式，DAMON提供了其最佳的质量和最小的开销，同时保持了用户为其权衡设定的界限。</p>
</section>
<section id="id8">
<h3>动态目标空间更新处理<a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h3>
<p>监测目标地址范围可以动态改变。例如，虚拟内存可以动态地被映射和解映射。物理内存可以被
热插拔。</p>
<p>由于在某些情况下变化可能相当频繁，DAMON允许监控操作检查动态变化，包括内存映射变化，
并仅在用户指定的时间间隔（ <code class="docutils literal notranslate"><span class="pre">更新间隔</span></code> ）中的每个时间段，将其应用于监控操作相关的
数据结构，如抽象的监控目标内存区。</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../../_sources/translations/zh_CN/mm/damon/design.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>