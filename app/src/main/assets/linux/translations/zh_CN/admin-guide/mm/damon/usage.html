<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>详细用法 &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="基于DAMON的回收" href="reclaim.html" />
    <link rel="prev" title="入门指南" href="start.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.14.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../index.html">Translations</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../../index.html">中文翻译</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#linux">与Linux 内核社区一起工作</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#api">内部API文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id2">开发工具和流程</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../../index.html#id3">面向用户的文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id5">固件相关文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id6">体系结构文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id7">其他文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id8">术语表</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../index.html#id9">索引和表格</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../zh_TW/index.html">繁體中文翻譯</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../it_IT/index.html">La documentazione del kernel Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../ko_KR/index.html">한국어 번역</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../ja_JP/index.html">日本語訳</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../sp_SP/index.html">Traducción al español</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../index.html#disclaimer">Disclaimer</a></li>
</ul>
</li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../../_sources/translations/zh_CN/admin-guide/mm/damon/usage.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->



<div class="language-selection">
Chinese (Simplified)

<ul>

<li><a href="../../../../../admin-guide/mm/damon/usage.html">English</a></li>

<li><a href="../../../../zh_TW/admin-guide/mm/damon/usage.html">Chinese (Traditional)</a></li>

</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>此文件的目的是为让中文读者更容易阅读和理解，而不是作为一个分支。 因此，
如果您对此文件有任何意见或更新，请先尝试更新原始英文文件。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果您发现本文档与原始文件有任何不同或者有翻译问题，请联系该文件的译者，
或者请求时奎亮的帮助：&lt;<a class="reference external" href="mailto:alexs&#37;&#52;&#48;kernel&#46;org">alexs<span>&#64;</span>kernel<span>&#46;</span>org</a>&gt;。</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Original<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html"><span class="doc">Detailed Usages</span></a></p>
</dd>
<dt class="field-even">翻译<span class="colon">:</span></dt>
<dd class="field-even"><p>司延腾 Yanteng Si &lt;<a class="reference external" href="mailto:siyanteng&#37;&#52;&#48;loongson&#46;cn">siyanteng<span>&#64;</span>loongson<span>&#46;</span>cn</a>&gt;</p>
</dd>
<dt class="field-odd">校译<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<section id="id1">
<h1>详细用法<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p>DAMON 为不同的用户提供了下面这些接口。</p>
<ul class="simple">
<li><p><em>DAMON用户空间工具。</em>
<a class="reference external" href="https://github.com/damonitor/damo">这</a> 为有这特权的人， 如系统管理员，希望有一个刚好
可以工作的人性化界面。
使用它，用户可以以人性化的方式使用DAMON的主要功能。不过，它可能不会为特殊情况进行高度调整。
它同时支持虚拟和物理地址空间的监测。更多细节，请参考它的 <a class="reference external" href="https://github.com/damonitor/damo/blob/next/USAGE.md">使用文档</a>。</p></li>
<li><p><em>sysfs接口。</em>
<a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#sysfs-interface"><span class="std std-ref">这</span></a> 是为那些希望更高级的使用DAMON的特权用户空间程序员准备的。
使用它，用户可以通过读取和写入特殊的sysfs文件来使用DAMON的主要功能。因此，你可以编写和使
用你个性化的DAMON sysfs包装程序，代替你读/写sysfs文件。  <a class="reference external" href="https://github.com/damonitor/damo">DAMON用户空间工具</a> 就是这种程序的一个例子  它同时支持虚拟和物理地址
空间的监测。</p></li>
<li><p><em>内核空间编程接口。</em>
<a class="reference internal" href="../../../../../mm/damon/api.html"><span class="doc">这</span></a> 这是为内核空间程序员准备的。使用它，用户可以通过为你编写内
核空间的DAMON应用程序，最灵活有效地利用DAMON的每一个功能。你甚至可以为各种地址空间扩展DAMON。
详细情况请参考接口 <a class="reference internal" href="../../../../../mm/damon/api.html"><span class="doc">文件</span></a>。</p></li>
</ul>
<section id="sysfs">
<h2>sysfs接口<a class="headerlink" href="#sysfs" title="Link to this heading">¶</a></h2>
<p>DAMON的sysfs接口是在定义 <code class="docutils literal notranslate"><span class="pre">CONFIG_DAMON_SYSFS</span></code> 时建立的。它在其sysfs目录下创建多
个目录和文件， <code class="docutils literal notranslate"><span class="pre">&lt;sysfs&gt;/kernel/mm/damon/</span></code> 。你可以通过对该目录下的文件进行写入和
读取来控制DAMON。</p>
<p>对于一个简短的例子，用户可以监测一个给定工作负载的虚拟地址空间，如下所示:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd /sys/kernel/mm/damon/admin/
# echo 1 &gt; kdamonds/nr_kdamonds &amp;&amp; echo 1 &gt; kdamonds/0/contexts/nr_contexts
# echo vaddr &gt; kdamonds/0/contexts/0/operations
# echo 1 &gt; kdamonds/0/contexts/0/targets/nr_targets
# echo $(pidof &lt;workload&gt;) &gt; kdamonds/0/contexts/0/targets/0/pid_target
# echo on &gt; kdamonds/0/state
</pre></div>
</div>
<section id="id4">
<h3>文件层次结构<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<p>DAMON sysfs接口的文件层次结构如下图所示。在下图中，父子关系用缩进表示，每个目录有
<code class="docutils literal notranslate"><span class="pre">/</span></code> 后缀，每个目录中的文件用逗号（”,”）分开。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/sys/kernel/mm/damon/admin
│ kdamonds/nr_kdamonds
│ │ 0/state,pid
│ │ │ contexts/nr_contexts
│ │ │ │ 0/operations
│ │ │ │ │ monitoring_attrs/
│ │ │ │ │ │ intervals/sample_us,aggr_us,update_us
│ │ │ │ │ │ nr_regions/min,max
│ │ │ │ │ targets/nr_targets
│ │ │ │ │ │ 0/pid_target
│ │ │ │ │ │ │ regions/nr_regions
│ │ │ │ │ │ │ │ 0/start,end
│ │ │ │ │ │ │ │ ...
│ │ │ │ │ │ ...
│ │ │ │ │ schemes/nr_schemes
│ │ │ │ │ │ 0/action
│ │ │ │ │ │ │ access_pattern/
│ │ │ │ │ │ │ │ sz/min,max
│ │ │ │ │ │ │ │ nr_accesses/min,max
│ │ │ │ │ │ │ │ age/min,max
│ │ │ │ │ │ │ quotas/ms,bytes,reset_interval_ms
│ │ │ │ │ │ │ │ weights/sz_permil,nr_accesses_permil,age_permil
│ │ │ │ │ │ │ watermarks/metric,interval_us,high,mid,low
│ │ │ │ │ │ │ stats/nr_tried,sz_tried,nr_applied,sz_applied,qt_exceeds
│ │ │ │ │ │ │ tried_regions/
│ │ │ │ │ │ │ │ 0/start,end,nr_accesses,age
│ │ │ │ │ │ │ │ ...
│ │ │ │ │ │ ...
│ │ │ │ ...
│ │ ...
</pre></div>
</div>
</section>
<section id="id5">
<h3>根<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p>DAMON sysfs接口的根是 <code class="docutils literal notranslate"><span class="pre">&lt;sysfs&gt;/kernel/mm/damon/</span></code> ，它有一个名为 <code class="docutils literal notranslate"><span class="pre">admin</span></code> 的
目录。该目录包含特权用户空间程序控制DAMON的文件。拥有根权限的用户空间工具或deamons可以
使用这个目录。</p>
</section>
<section id="kdamonds">
<h3>kdamonds/<a class="headerlink" href="#kdamonds" title="Link to this heading">¶</a></h3>
<p>与监测相关的信息包括请求规格和结果被称为DAMON上下文。DAMON用一个叫做kdamond的内核线程
执行每个上下文，多个kdamonds可以并行运行。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">admin</span></code> 目录下，有一个目录，即``kdamonds``，它有控制kdamonds的文件存在。在开始
时，这个目录只有一个文件，<code class="docutils literal notranslate"><span class="pre">nr_kdamonds</span></code>。向该文件写入一个数字（<code class="docutils literal notranslate"><span class="pre">N</span></code>），就会创建名为
<code class="docutils literal notranslate"><span class="pre">0</span></code> 到 <code class="docutils literal notranslate"><span class="pre">N-1</span></code> 的子目录数量。每个目录代表每个kdamond。</p>
</section>
<section id="kdamonds-n">
<h3>kdamonds/&lt;N&gt;/<a class="headerlink" href="#kdamonds-n" title="Link to this heading">¶</a></h3>
<p>在每个kdamond目录中，存在两个文件（<code class="docutils literal notranslate"><span class="pre">state</span></code> 和 <code class="docutils literal notranslate"><span class="pre">pid</span></code> ）和一个目录( <code class="docutils literal notranslate"><span class="pre">contexts</span></code> )。</p>
<p>读取 <code class="docutils literal notranslate"><span class="pre">state</span></code> 时，如果kdamond当前正在运行，则返回 <code class="docutils literal notranslate"><span class="pre">on</span></code> ，如果没有运行则返回 <code class="docutils literal notranslate"><span class="pre">off</span></code> 。
写入 <code class="docutils literal notranslate"><span class="pre">on</span></code> 或 <code class="docutils literal notranslate"><span class="pre">off</span></code> 使kdamond处于状态。向 <code class="docutils literal notranslate"><span class="pre">state</span></code> 文件写 <code class="docutils literal notranslate"><span class="pre">update_schemes_stats</span></code> ，
更新kdamond的每个基于DAMON的操作方案的统计文件的内容。关于统计信息的细节，请参考
<a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#sysfs-schemes-stats"><span class="std std-ref">stats section</span></a>. 将 <code class="docutils literal notranslate"><span class="pre">update_schemes_tried_regions</span></code> 写到
<code class="docutils literal notranslate"><span class="pre">state</span></code> 文件，为kdamond的每个基于DAMON的操作方案，更新基于DAMON的操作方案动作的尝试区域目录。
将`clear_schemes_tried_regions`写入`state`文件，清除kdamond的每个基于DAMON的操作方案的动作
尝试区域目录。 关于基于DAMON的操作方案动作尝试区域目录的细节，请参考:ref:tried_regions 部分
&lt;sysfs_schemes_tried_regions&gt;`。</p>
<p>如果状态为 <code class="docutils literal notranslate"><span class="pre">on</span></code>，读取 <code class="docutils literal notranslate"><span class="pre">pid</span></code> 显示kdamond线程的pid。</p>
<p><code class="docutils literal notranslate"><span class="pre">contexts</span></code> 目录包含控制这个kdamond要执行的监测上下文的文件。</p>
</section>
<section id="kdamonds-n-contexts">
<h3>kdamonds/&lt;N&gt;/contexts/<a class="headerlink" href="#kdamonds-n-contexts" title="Link to this heading">¶</a></h3>
<p>在开始时，这个目录只有一个文件，即 <code class="docutils literal notranslate"><span class="pre">nr_contexts</span></code> 。向该文件写入一个数字( <code class="docutils literal notranslate"><span class="pre">N</span></code> )，就会创
建名为``0`` 到 <code class="docutils literal notranslate"><span class="pre">N-1</span></code> 的子目录数量。每个目录代表每个监测背景。目前，每个kdamond只支持
一个上下文，所以只有 <code class="docutils literal notranslate"><span class="pre">0</span></code> 或 <code class="docutils literal notranslate"><span class="pre">1</span></code> 可以被写入文件。</p>
</section>
<section id="contexts-n">
<h3>contexts/&lt;N&gt;/<a class="headerlink" href="#contexts-n" title="Link to this heading">¶</a></h3>
<p>在每个上下文目录中，存在一个文件(<code class="docutils literal notranslate"><span class="pre">operations</span></code>)和三个目录(<code class="docutils literal notranslate"><span class="pre">monitoring_attrs</span></code>,
<code class="docutils literal notranslate"><span class="pre">targets</span></code>, 和 <code class="docutils literal notranslate"><span class="pre">schemes</span></code>)。</p>
<p>DAMON支持多种类型的监测操作，包括对虚拟地址空间和物理地址空间的监测。你可以通过向文件
中写入以下关键词之一，并从文件中读取，来设置和获取DAMON将为上下文使用何种类型的监测操作。</p>
<blockquote>
<div><ul class="simple">
<li><p>vaddr: 监测特定进程的虚拟地址空间</p></li>
<li><p>paddr: 监视系统的物理地址空间</p></li>
</ul>
</div></blockquote>
</section>
<section id="contexts-n-monitoring-attrs">
<h3>contexts/&lt;N&gt;/monitoring_attrs/<a class="headerlink" href="#contexts-n-monitoring-attrs" title="Link to this heading">¶</a></h3>
<p>用于指定监测属性的文件，包括所需的监测质量和效率，都在 <code class="docutils literal notranslate"><span class="pre">monitoring_attrs</span></code> 目录中。
具体来说，这个目录下有两个目录，即 <code class="docutils literal notranslate"><span class="pre">intervals</span></code> 和 <code class="docutils literal notranslate"><span class="pre">nr_regions</span></code> 。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">intervals</span></code> 目录下，存在DAMON的采样间隔(<code class="docutils literal notranslate"><span class="pre">sample_us</span></code>)、聚集间隔(<code class="docutils literal notranslate"><span class="pre">aggr_us</span></code>)
和更新间隔(<code class="docutils literal notranslate"><span class="pre">update_us</span></code>)三个文件。你可以通过写入和读出这些文件来设置和获取微秒级的值。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">nr_regions</span></code> 目录下，有两个文件分别用于DAMON监测区域的下限和上限（<code class="docutils literal notranslate"><span class="pre">min</span></code> 和 <code class="docutils literal notranslate"><span class="pre">max</span></code> ），
这两个文件控制着监测的开销。你可以通过向这些文件的写入和读出来设置和获取这些值。</p>
<p>关于间隔和监测区域范围的更多细节，请参考设计文件 (<a class="reference internal" href="../../../../../mm/damon/design.html"><span class="doc">Design</span></a>)。</p>
</section>
<section id="contexts-n-targets">
<h3>contexts/&lt;N&gt;/targets/<a class="headerlink" href="#contexts-n-targets" title="Link to this heading">¶</a></h3>
<p>在开始时，这个目录只有一个文件 <code class="docutils literal notranslate"><span class="pre">nr_targets</span></code> 。向该文件写入一个数字(<code class="docutils literal notranslate"><span class="pre">N</span></code>)，就可以创建
名为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 到 <code class="docutils literal notranslate"><span class="pre">N-1</span></code> 的子目录的数量。每个目录代表每个监测目标。</p>
</section>
<section id="targets-n">
<h3>targets/&lt;N&gt;/<a class="headerlink" href="#targets-n" title="Link to this heading">¶</a></h3>
<p>在每个目标目录中，存在一个文件(<code class="docutils literal notranslate"><span class="pre">pid_target</span></code>)和一个目录(<code class="docutils literal notranslate"><span class="pre">regions</span></code>)。</p>
<p>如果你把 <code class="docutils literal notranslate"><span class="pre">vaddr</span></code> 写到 <code class="docutils literal notranslate"><span class="pre">contexts/&lt;N&gt;/operations</span></code> 中，每个目标应该是一个进程。你
可以通过将进程的pid写到 <code class="docutils literal notranslate"><span class="pre">pid_target</span></code> 文件中来指定DAMON的进程。</p>
</section>
<section id="targets-n-regions">
<h3>targets/&lt;N&gt;/regions<a class="headerlink" href="#targets-n-regions" title="Link to this heading">¶</a></h3>
<p>当使用 <code class="docutils literal notranslate"><span class="pre">vaddr</span></code> 监测操作集时（ <code class="docutils literal notranslate"><span class="pre">vaddr</span></code> 被写入 <code class="docutils literal notranslate"><span class="pre">contexts/&lt;N&gt;/operations</span></code> 文
件），DAMON自动设置和更新监测目标区域，这样就可以覆盖目标进程的整个内存映射。然而，用户可
能希望将初始监测区域设置为特定的地址范围。</p>
<p>相反，当使用 <code class="docutils literal notranslate"><span class="pre">paddr</span></code> 监测操作集时，DAMON不会自动设置和更新监测目标区域（ <code class="docutils literal notranslate"><span class="pre">paddr</span></code>
被写入 <code class="docutils literal notranslate"><span class="pre">contexts/&lt;N&gt;/operations</span></code> 中）。因此，在这种情况下，用户应该自己设置监测目标
区域。</p>
<p>在这种情况下，用户可以按照自己的意愿明确设置初始监测目标区域，将适当的值写入该目录下的文件。</p>
<p>开始时，这个目录只有一个文件， <code class="docutils literal notranslate"><span class="pre">nr_regions</span></code> 。向该文件写入一个数字(<code class="docutils literal notranslate"><span class="pre">N</span></code>)，就可以创
建名为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 到  <code class="docutils literal notranslate"><span class="pre">N-1</span></code> 的子目录。每个目录代表每个初始监测目标区域。</p>
</section>
<section id="regions-n">
<h3>regions/&lt;N&gt;/<a class="headerlink" href="#regions-n" title="Link to this heading">¶</a></h3>
<p>在每个区域目录中，你会发现两个文件（ <code class="docutils literal notranslate"><span class="pre">start</span></code>  和  <code class="docutils literal notranslate"><span class="pre">end</span></code> ）。你可以通过向文件写入
和从文件中读出，分别设置和获得初始监测目标区域的起始和结束地址。</p>
<p>每个区域不应该与其他区域重叠。 目录“N”的“结束”应等于或小于目录“N+1”的“开始”。</p>
</section>
<section id="contexts-n-schemes">
<h3>contexts/&lt;N&gt;/schemes/<a class="headerlink" href="#contexts-n-schemes" title="Link to this heading">¶</a></h3>
<p>对于一版的基于DAMON的数据访问感知的内存管理优化，用户通常希望系统对特定访问模式的内存区
域应用内存管理操作。DAMON从用户那里接收这种形式化的操作方案，并将这些方案应用于目标内存
区域。用户可以通过读取和写入这个目录下的文件来获得和设置这些方案。</p>
<p>在开始时，这个目录只有一个文件，<code class="docutils literal notranslate"><span class="pre">nr_schemes</span></code>。向该文件写入一个数字(<code class="docutils literal notranslate"><span class="pre">N</span></code>)，就可以
创建名为``0``到``N-1``的子目录的数量。每个目录代表每个基于DAMON的操作方案。</p>
</section>
<section id="schemes-n">
<h3>schemes/&lt;N&gt;/<a class="headerlink" href="#schemes-n" title="Link to this heading">¶</a></h3>
<p>在每个方案目录中，存在五个目录(<code class="docutils literal notranslate"><span class="pre">access_pattern</span></code>、<code class="docutils literal notranslate"><span class="pre">quotas</span></code>、<code class="docutils literal notranslate"><span class="pre">watermarks</span></code>、
<code class="docutils literal notranslate"><span class="pre">stats</span></code> 和 <code class="docutils literal notranslate"><span class="pre">tried_regions</span></code>)和一个文件(<code class="docutils literal notranslate"><span class="pre">action</span></code>)。</p>
<p><code class="docutils literal notranslate"><span class="pre">action</span></code> 文件用于设置和获取你想应用于具有特定访问模式的内存区域的动作。可以写入文件
和从文件中读取的关键词及其含义如下。</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">willneed</span></code>: 对有 <code class="docutils literal notranslate"><span class="pre">MADV_WILLNEED</span></code> 的区域调用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cold</span></code>: 对具有 <code class="docutils literal notranslate"><span class="pre">MADV_COLD</span></code> 的区域调用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pageout</span></code>: 为具有 <code class="docutils literal notranslate"><span class="pre">MADV_PAGEOUT</span></code> 的区域调用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hugepage</span></code>: 为带有 <code class="docutils literal notranslate"><span class="pre">MADV_HUGEPAGE</span></code> 的区域调用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nohugepage</span></code>: 为带有 <code class="docutils literal notranslate"><span class="pre">MADV_NOHUGEPAGE</span></code> 的区域调用 <code class="docutils literal notranslate"><span class="pre">madvise()</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lru_prio</span></code>: 在其LRU列表上对区域进行优先排序。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lru_deprio</span></code>: 对区域的LRU列表进行降低优先处理。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stat</span></code>: 什么都不做，只计算统计数据</p></li>
</ul>
</div></blockquote>
</section>
<section id="schemes-n-access-pattern">
<h3>schemes/&lt;N&gt;/access_pattern/<a class="headerlink" href="#schemes-n-access-pattern" title="Link to this heading">¶</a></h3>
<p>每个基于DAMON的操作方案的目标访问模式由三个范围构成，包括以字节为单位的区域大小、每个
聚合区间的监测访问次数和区域年龄的聚合区间数。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">access_pattern</span></code> 目录下，存在三个目录（ <code class="docutils literal notranslate"><span class="pre">sz</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code>, 和 <code class="docutils literal notranslate"><span class="pre">age</span></code> ），
每个目录有两个文件（<code class="docutils literal notranslate"><span class="pre">min</span></code> 和 <code class="docutils literal notranslate"><span class="pre">max</span></code> ）。你可以通过向  <code class="docutils literal notranslate"><span class="pre">sz</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code>, 和
<code class="docutils literal notranslate"><span class="pre">age</span></code>  目录下的 <code class="docutils literal notranslate"><span class="pre">min</span></code> 和 <code class="docutils literal notranslate"><span class="pre">max</span></code> 文件分别写入和读取来设置和获取给定方案的访问模式。</p>
</section>
<section id="schemes-n-quotas">
<h3>schemes/&lt;N&gt;/quotas/<a class="headerlink" href="#schemes-n-quotas" title="Link to this heading">¶</a></h3>
<p>每个 <code class="docutils literal notranslate"><span class="pre">动作</span></code> 的最佳 <code class="docutils literal notranslate"><span class="pre">目标访问模式</span></code> 取决于工作负载，所以不容易找到。更糟糕的是，将某些动作
的方案设置得过于激进会造成严重的开销。为了避免这种开销，用户可以为每个方案限制时间和大小配额。
具体来说，用户可以要求DAMON尽量只使用特定的时间（<code class="docutils literal notranslate"><span class="pre">时间配额</span></code>）来应用动作，并且在给定的时间间
隔（<code class="docutils literal notranslate"><span class="pre">重置间隔</span></code>）内，只对具有目标访问模式的内存区域应用动作，而不使用特定数量（<code class="docutils literal notranslate"><span class="pre">大小配额</span></code>）。</p>
<p>当预计超过配额限制时，DAMON会根据 <code class="docutils literal notranslate"><span class="pre">目标访问模式</span></code> 的大小、访问频率和年龄，对找到的内存区域
进行优先排序。为了进行个性化的优先排序，用户可以为这三个属性设置权重。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">quotas</span></code> 目录下，存在三个文件（<code class="docutils literal notranslate"><span class="pre">ms</span></code>, <code class="docutils literal notranslate"><span class="pre">bytes</span></code>, <code class="docutils literal notranslate"><span class="pre">reset_interval_ms</span></code>）和一个
目录(<code class="docutils literal notranslate"><span class="pre">weights</span></code>)，其中有三个文件(<code class="docutils literal notranslate"><span class="pre">sz_permil</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_accesses_permil</span></code>, 和
<code class="docutils literal notranslate"><span class="pre">age_permil</span></code>)。</p>
<p>你可以设置以毫秒为单位的 <code class="docutils literal notranslate"><span class="pre">时间配额</span></code> ，以字节为单位的 <code class="docutils literal notranslate"><span class="pre">大小配额</span></code> ，以及以毫秒为单位的 <code class="docutils literal notranslate"><span class="pre">重</span>
<span class="pre">置间隔</span></code> ，分别向这三个文件写入数值。你还可以通过向 <code class="docutils literal notranslate"><span class="pre">weights</span></code> 目录下的三个文件写入数值来设
置大小、访问频率和年龄的优先权，单位为千分之一。</p>
</section>
<section id="schemes-n-watermarks">
<h3>schemes/&lt;N&gt;/watermarks/<a class="headerlink" href="#schemes-n-watermarks" title="Link to this heading">¶</a></h3>
<p>为了便于根据系统状态激活和停用每个方案，DAMON提供了一个称为水位的功能。该功能接收五个值，称为
<code class="docutils literal notranslate"><span class="pre">度量</span></code> 、<code class="docutils literal notranslate"><span class="pre">间隔</span></code> 、<code class="docutils literal notranslate"><span class="pre">高</span></code> 、<code class="docutils literal notranslate"><span class="pre">中</span></code> 、<code class="docutils literal notranslate"><span class="pre">低</span></code> 。<code class="docutils literal notranslate"><span class="pre">度量值</span></code> 是指可以测量的系统度量值，如
自由内存比率。如果系统的度量值 <code class="docutils literal notranslate"><span class="pre">高</span></code> 于memoent的高值或 <code class="docutils literal notranslate"><span class="pre">低</span></code> 于低值，则该方案被停用。如果
该值低于 <code class="docutils literal notranslate"><span class="pre">中</span></code> ，则该方案被激活。</p>
<p>在水位目录下，存在五个文件(<code class="docutils literal notranslate"><span class="pre">metric</span></code>, <code class="docutils literal notranslate"><span class="pre">interval_us</span></code>,``high``, <code class="docutils literal notranslate"><span class="pre">mid</span></code>, and <code class="docutils literal notranslate"><span class="pre">low</span></code>)
用于设置每个值。你可以通过向这些文件的写入来分别设置和获取这五个值。</p>
<p>可以写入 <code class="docutils literal notranslate"><span class="pre">metric</span></code> 文件的关键词和含义如下。</p>
<blockquote>
<div><ul class="simple">
<li><p>none: 忽略水位</p></li>
<li><p>free_mem_rate: 系统的自由内存率（千分比）。</p></li>
</ul>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">interval</span></code> 应以微秒为单位写入。</p>
</section>
<section id="schemes-n-stats">
<h3>schemes/&lt;N&gt;/stats/<a class="headerlink" href="#schemes-n-stats" title="Link to this heading">¶</a></h3>
<p>DAMON统计每个方案被尝试应用的区域的总数量和字节数，每个方案被成功应用的区域的两个数字，以及
超过配额限制的总数量。这些统计数据可用于在线分析或调整方案。</p>
<p>可以通过读取 <code class="docutils literal notranslate"><span class="pre">stats</span></code> 目录下的文件(<code class="docutils literal notranslate"><span class="pre">nr_tried</span></code>, <code class="docutils literal notranslate"><span class="pre">sz_tried</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_applied</span></code>,
<code class="docutils literal notranslate"><span class="pre">sz_applied</span></code>, 和 <code class="docutils literal notranslate"><span class="pre">qt_exceeds</span></code>)）分别检索这些统计数据。这些文件不是实时更新的，所以
你应该要求DAMON sysfs接口通过在相关的 <code class="docutils literal notranslate"><span class="pre">kdamonds/&lt;N&gt;/state</span></code> 文件中写入一个特殊的关键字
<code class="docutils literal notranslate"><span class="pre">update_schemes_stats</span></code> 来更新统计信息的文件内容。</p>
</section>
<section id="schemes-n-tried-regions">
<h3>schemes/&lt;N&gt;/tried_regions/<a class="headerlink" href="#schemes-n-tried-regions" title="Link to this heading">¶</a></h3>
<p>当一个特殊的关键字 <code class="docutils literal notranslate"><span class="pre">update_schemes_tried_regions</span></code> 被写入相关的 <code class="docutils literal notranslate"><span class="pre">kdamonds/&lt;N&gt;/state</span></code>
文件时，DAMON会在这个目录下创建从 <code class="docutils literal notranslate"><span class="pre">0</span></code> 开始命名的整数目录。每个目录包含的文件暴露了关于每个
内存区域的详细信息，在下一个 <a class="reference internal" href="../../../../../admin-guide/mm/damon/usage.html#sysfs-monitoring-attrs"><span class="std std-ref">聚集区间</span></a>，相应的方案的 <code class="docutils literal notranslate"><span class="pre">动作</span></code>
已经尝试在这个目录下应用。这些信息包括地址范围、<code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code> 以及区域的 <code class="docutils literal notranslate"><span class="pre">年龄</span></code> 。</p>
<p>当另一个特殊的关键字 <code class="docutils literal notranslate"><span class="pre">clear_schemes_tried_regions</span></code> 被写入相关的 <code class="docutils literal notranslate"><span class="pre">kdamonds/&lt;N&gt;/state</span></code>
文件时，这些目录将被删除。</p>
</section>
<section id="tried-regions-n">
<h3>tried_regions/&lt;N&gt;/<a class="headerlink" href="#tried-regions-n" title="Link to this heading">¶</a></h3>
<p>在每个区域目录中，你会发现四个文件(<code class="docutils literal notranslate"><span class="pre">start</span></code>, <code class="docutils literal notranslate"><span class="pre">end</span></code>, <code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code>, and <code class="docutils literal notranslate"><span class="pre">age</span></code>)。
读取这些文件将显示相应的基于DAMON的操作方案 <code class="docutils literal notranslate"><span class="pre">动作</span></code> 试图应用的区域的开始和结束地址、<code class="docutils literal notranslate"><span class="pre">nr_accesses</span></code>
和 <code class="docutils literal notranslate"><span class="pre">年龄</span></code> 。</p>
<section id="id6">
<h4>用例<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h4>
<p>下面的命令应用了一个方案：”如果一个大小为[4KiB, 8KiB]的内存区域在[10, 20]的聚合时间间隔内
显示出每一个聚合时间间隔[0, 5]的访问量，请分页该区域。对于分页，每秒最多只能使用10ms，而且每
秒分页不能超过1GiB。在这一限制下，首先分页出具有较长年龄的内存区域。另外，每5秒钟检查一次系统
的可用内存率，当可用内存率低于50%时开始监测和分页，但如果可用内存率大于60%，或低于30%，则停
止监测。“</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cd &lt;sysfs&gt;/kernel/mm/damon/admin
# # populate directories
# echo 1 &gt; kdamonds/nr_kdamonds; echo 1 &gt; kdamonds/0/contexts/nr_contexts;
# echo 1 &gt; kdamonds/0/contexts/0/schemes/nr_schemes
# cd kdamonds/0/contexts/0/schemes/0
# # set the basic access pattern and the action
# echo 4096 &gt; access_pattern/sz/min
# echo 8192 &gt; access_pattern/sz/max
# echo 0 &gt; access_pattern/nr_accesses/min
# echo 5 &gt; access_pattern/nr_accesses/max
# echo 10 &gt; access_pattern/age/min
# echo 20 &gt; access_pattern/age/max
# echo pageout &gt; action
# # set quotas
# echo 10 &gt; quotas/ms
# echo $((1024*1024*1024)) &gt; quotas/bytes
# echo 1000 &gt; quotas/reset_interval_ms
# # set watermark
# echo free_mem_rate &gt; watermarks/metric
# echo 5000000 &gt; watermarks/interval_us
# echo 600 &gt; watermarks/high
# echo 500 &gt; watermarks/mid
# echo 300 &gt; watermarks/low
</pre></div>
</div>
<p>请注意，我们强烈建议使用用户空间的工具，如 <a class="reference external" href="https://github.com/damonitor/damo">damo</a> ，
而不是像上面那样手动读写文件。以上只是一个例子。</p>
</section>
</section>
</section>
<section id="id7">
<h2>监测结果的监测点<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h2>
<p>DAMON通过一个tracepoint <code class="docutils literal notranslate"><span class="pre">damon:damon_aggregated</span></code> 提供监测结果.  当监测开启时，你可
以记录追踪点事件，并使用追踪点支持工具如perf显示结果。比如说:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo on &gt; monitor_on_DEPRECATED
# perf record -e damon:damon_aggregated &amp;
# sleep 5
# kill 9 $(pidof perf)
# echo off &gt; monitor_on_DEPRECATED
# perf script
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../../../_sources/translations/zh_CN/admin-guide/mm/damon/usage.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>