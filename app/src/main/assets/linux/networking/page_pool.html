
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Page Pool API &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="PHY Abstraction Layer" href="phy.html" />
    <link rel="prev" title="NET_FAILOVER" href="net_failover.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.6.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">A guide to the Kernel Development Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver implementer's API guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">Kernel subsystem documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../subsystem-apis.html#networking-interfaces">Networking interfaces</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking in the kernel</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Linux kernel licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">Kernel Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user's and administrator's guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">The kernel build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">User-space tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  sbar.scrollTop = currents[currents.length - 1].offsetTop;
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/networking/page_pool.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="page-pool-api">
<h1>Page Pool API<a class="headerlink" href="#page-pool-api" title="Permalink to this heading">¶</a></h1>
<p>The page_pool allocator is optimized for the XDP mode that
uses one frame per-page, but it can fallback on the
regular page allocator APIs.</p>
<p>Basic use involves replacing <a class="reference internal" href="../core-api/mm-api.html#c.alloc_pages" title="alloc_pages"><code class="xref c c-func docutils literal notranslate"><span class="pre">alloc_pages()</span></code></a> calls with the
page_pool_alloc_pages() call.  Drivers should use
<a class="reference internal" href="#c.page_pool_dev_alloc_pages" title="page_pool_dev_alloc_pages"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_dev_alloc_pages()</span></code></a> replacing dev_alloc_pages().</p>
<p>The API keeps track of in-flight pages, in order to let API users know
when it is safe to free a page_pool object.  Thus, API users
must call <a class="reference internal" href="#c.page_pool_put_page" title="page_pool_put_page"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_put_page()</span></code></a> to free the page, or attach
the page to a page_pool-aware object like skbs marked with
skb_mark_for_recycle().</p>
<p>API users must call <a class="reference internal" href="#c.page_pool_put_page" title="page_pool_put_page"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_put_page()</span></code></a> once on a page, as it
will either recycle the page, or in case of refcnt &gt; 1, it will
release the DMA mapping and in-flight state accounting.</p>
<section id="architecture-overview">
<h2>Architecture overview<a class="headerlink" href="#architecture-overview" title="Permalink to this heading">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+------------------+
|       Driver     |
+------------------+
        ^
        |
        |
        |
        v
+--------------------------------------------+
|                request memory              |
+--------------------------------------------+
    ^                                  ^
    |                                  |
    | Pool empty                       | Pool has entries
    |                                  |
    v                                  v
+-----------------------+     +------------------------+
| alloc (and map) pages |     |  get page from cache   |
+-----------------------+     +------------------------+
                                ^                    ^
                                |                    |
                                | cache available    | No entries, refill
                                |                    | from ptr-ring
                                |                    |
                                v                    v
                      +-----------------+     +------------------+
                      |   Fast cache    |     |  ptr-ring cache  |
                      +-----------------+     +------------------+
</pre></div>
</div>
</section>
<section id="api-interface">
<h2>API interface<a class="headerlink" href="#api-interface" title="Permalink to this heading">¶</a></h2>
<p>The number of pools created <strong>must</strong> match the number of hardware queues
unless hardware restrictions make that impossible. This would otherwise beat the
purpose of page pool, which is allocate pages fast from cache without locking.
This lockless guarantee naturally comes from running under a NAPI softirq.
The protection doesn't strictly have to be NAPI, any guarantee that allocating
a page will cause no race conditions is enough.</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.page_pool_create">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page_pool</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_create</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.page_pool_params" title="page_pool_params"><span class="n"><span class="pre">page_pool_params</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">params</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.page_pool_create" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>create a page pool.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">page_pool_params</span> <span class="pre">*params</span></code></dt><dd><p>parameters, see <a class="reference internal" href="#c.page_pool_params" title="page_pool_params"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool_params</span></code></a></p>
</dd>
</dl>
</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.page_pool_params">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_params</span></span></span><a class="headerlink" href="#c.page_pool_params" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>page pool parameters</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct page_pool_params {
    unsigned int    flags;
    unsigned int    order;
    unsigned int    pool_size;
    int nid;
    struct device   *dev;
    struct napi_struct *napi;
    enum dma_data_direction dma_dir;
    unsigned int    max_len;
    unsigned int    offset;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">flags</span></code></dt><dd><p>PP_FLAG_DMA_MAP, PP_FLAG_DMA_SYNC_DEV, PP_FLAG_PAGE_FRAG</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">order</span></code></dt><dd><p>2^order pages on allocation</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pool_size</span></code></dt><dd><p>size of the ptr_ring</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">nid</span></code></dt><dd><p>NUMA node id to allocate from pages from</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>device, for DMA pre-mapping purposes</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">napi</span></code></dt><dd><p>NAPI which is the sole consumer of pages, otherwise NULL</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dma_dir</span></code></dt><dd><p>DMA mapping direction</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">max_len</span></code></dt><dd><p>max DMA sync memory size for PP_FLAG_DMA_SYNC_DEV</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">offset</span></code></dt><dd><p>DMA sync address offset for PP_FLAG_DMA_SYNC_DEV</p>
</dd>
</dl>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.page_pool_dev_alloc_pages">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_dev_alloc_pages</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page_pool</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">pool</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.page_pool_dev_alloc_pages" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>allocate a page.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool</span> <span class="pre">*pool</span></code></dt><dd><p>pool from which to allocate</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Get a page from the page allocator or page_pool caches.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.page_pool_get_dma_dir">
<span class="k"><span class="pre">enum</span></span><span class="w"> </span><span class="n"><span class="pre">dma_data_direction</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_get_dma_dir</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page_pool</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">pool</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.page_pool_get_dma_dir" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Retrieve the stored DMA direction.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool</span> <span class="pre">*pool</span></code></dt><dd><p>pool from which page was allocated</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Get the stored dma direction. A driver might decide to store this locally
and avoid the extra cache line from page_pool to determine the direction.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.page_pool_put_page">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_put_page</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page_pool</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">pool</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.page_pool_put_page" title="page"><span class="n"><span class="pre">page</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">page</span></span>, <span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">dma_sync_size</span></span>, <span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="n"><span class="pre">allow_direct</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.page_pool_put_page" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>release a reference to a page pool page</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool</span> <span class="pre">*pool</span></code></dt><dd><p>pool from which page was allocated</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span> <span class="pre">*page</span></code></dt><dd><p>page to release a reference on</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">dma_sync_size</span></code></dt><dd><p>how much of the page may have been touched by the device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">allow_direct</span></code></dt><dd><p>released by the consumer, allow lockless caching</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>The outcome of this depends on the page refcnt. If the driver bumps
the refcnt &gt; 1 this will unmap the page. If the page refcnt is 1
the allocator owns the page and will try to recycle it in one of the pool
caches. If PP_FLAG_DMA_SYNC_DEV is set, the page will be synced for_device
using dma_sync_single_range_for_device().</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.page_pool_put_full_page">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_put_full_page</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page_pool</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">pool</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.page_pool_put_full_page" title="page"><span class="n"><span class="pre">page</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">page</span></span>, <span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="n"><span class="pre">allow_direct</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.page_pool_put_full_page" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>release a reference on a page pool page</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool</span> <span class="pre">*pool</span></code></dt><dd><p>pool from which page was allocated</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span> <span class="pre">*page</span></code></dt><dd><p>page to release a reference on</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">allow_direct</span></code></dt><dd><p>released by the consumer, allow lockless caching</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Similar to <a class="reference internal" href="#c.page_pool_put_page" title="page_pool_put_page"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_put_page()</span></code></a>, but will DMA sync the entire memory area
as configured in <a class="reference internal" href="#c.page_pool_params" title="page_pool_params"><code class="xref c c-type docutils literal notranslate"><span class="pre">page_pool_params.max_len</span></code></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.page_pool_recycle_direct">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_recycle_direct</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page_pool</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">pool</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.page_pool_recycle_direct" title="page"><span class="n"><span class="pre">page</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">page</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.page_pool_recycle_direct" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>release a reference on a page pool page</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool</span> <span class="pre">*pool</span></code></dt><dd><p>pool from which page was allocated</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span> <span class="pre">*page</span></code></dt><dd><p>page to release a reference on</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Similar to <a class="reference internal" href="#c.page_pool_put_full_page" title="page_pool_put_full_page"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_put_full_page()</span></code></a> but caller must guarantee safe context
(e.g NAPI), since it will recycle the page directly into the pool fast cache.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.page_pool_get_dma_addr">
<span class="n"><span class="pre">dma_addr_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_get_dma_addr</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.page_pool_get_dma_addr" title="page"><span class="n"><span class="pre">page</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">page</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.page_pool_get_dma_addr" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Retrieve the stored DMA address.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span> <span class="pre">*page</span></code></dt><dd><p>page allocated from a page pool</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Fetch the DMA address of the page. The page pool to which the page belongs
must had been created with PP_FLAG_DMA_MAP.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.page_pool_get_stats">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_get_stats</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page_pool</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">pool</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.page_pool_stats" title="page_pool_stats"><span class="n"><span class="pre">page_pool_stats</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">stats</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.page_pool_get_stats" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>fetch page pool stats</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool</span> <span class="pre">*pool</span></code></dt><dd><p>pool from which page was allocated</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool_stats</span> <span class="pre">*stats</span></code></dt><dd><p><a class="reference internal" href="#c.page_pool_stats" title="page_pool_stats"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool_stats</span></code></a> to fill in</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Retrieve statistics about the page_pool. This API is only available
if the kernel has been configured with <code class="docutils literal notranslate"><span class="pre">CONFIG_PAGE_POOL_STATS=y</span></code>.
A pointer to a caller allocated <a class="reference internal" href="#c.page_pool_stats" title="page_pool_stats"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool_stats</span></code></a> structure
is passed to this API which is filled in. The caller can then report
those stats to the user (perhaps via ethtool, debugfs, etc.).</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.page_pool_put_page_bulk">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_put_page_bulk</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">page_pool</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">pool</span></span>, <span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">data</span></span>, <span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">count</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.page_pool_put_page_bulk" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>release references on multiple pages</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool</span> <span class="pre">*pool</span></code></dt><dd><p>pool from which pages were allocated</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">**data</span></code></dt><dd><p>array holding page pointers</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">count</span></code></dt><dd><p>number of pages in <strong>data</strong></p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Tries to refill a number of pages into the ptr_ring cache holding ptr_ring
producer lock. If the ptr_ring is full, <a class="reference internal" href="#c.page_pool_put_page_bulk" title="page_pool_put_page_bulk"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_put_page_bulk()</span></code></a>
will release leftover pages to the page allocator.
<a class="reference internal" href="#c.page_pool_put_page_bulk" title="page_pool_put_page_bulk"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_put_page_bulk()</span></code></a> is suitable to be run inside the driver NAPI tx
completion loop for the XDP_REDIRECT use case.</p>
<p>Please note the caller must not use data area after running
<a class="reference internal" href="#c.page_pool_put_page_bulk" title="page_pool_put_page_bulk"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_put_page_bulk()</span></code></a>, as this function overwrites it.</p>
</div>
<section id="dma-sync">
<h3>DMA sync<a class="headerlink" href="#dma-sync" title="Permalink to this heading">¶</a></h3>
<p>Driver is always responsible for syncing the pages for the CPU.
Drivers may choose to take care of syncing for the device as well
or set the <code class="docutils literal notranslate"><span class="pre">PP_FLAG_DMA_SYNC_DEV</span></code> flag to request that pages
allocated from the page pool are already synced for the device.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">PP_FLAG_DMA_SYNC_DEV</span></code> is set, the driver must inform the core what portion
of the buffer has to be synced. This allows the core to avoid syncing the entire
page when the drivers knows that the device only accessed a portion of the page.</p>
<p>Most drivers will reserve headroom in front of the frame. This part
of the buffer is not touched by the device, so to avoid syncing
it drivers can set the <code class="docutils literal notranslate"><span class="pre">offset</span></code> field in <a class="reference internal" href="#c.page_pool_params" title="page_pool_params"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool_params</span></code></a>
appropriately.</p>
<p>For pages recycled on the XDP xmit and skb paths the page pool will
use the <code class="docutils literal notranslate"><span class="pre">max_len</span></code> member of <a class="reference internal" href="#c.page_pool_params" title="page_pool_params"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool_params</span></code></a> to decide how
much of the page needs to be synced (starting at <code class="docutils literal notranslate"><span class="pre">offset</span></code>).
When directly freeing pages in the driver (<a class="reference internal" href="#c.page_pool_put_page" title="page_pool_put_page"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_put_page()</span></code></a>)
the <code class="docutils literal notranslate"><span class="pre">dma_sync_size</span></code> argument specifies how much of the buffer needs
to be synced.</p>
<p>If in doubt set <code class="docutils literal notranslate"><span class="pre">offset</span></code> to 0, <code class="docutils literal notranslate"><span class="pre">max_len</span></code> to <code class="docutils literal notranslate"><span class="pre">PAGE_SIZE</span></code> and
pass -1 as <code class="docutils literal notranslate"><span class="pre">dma_sync_size</span></code>. That combination of arguments is always
correct.</p>
<p>Note that the syncing parameters are for the entire page.
This is important to remember when using fragments (<code class="docutils literal notranslate"><span class="pre">PP_FLAG_PAGE_FRAG</span></code>),
where allocated buffers may be smaller than a full page.
Unless the driver author really understands page pool internals
it's recommended to always use <code class="docutils literal notranslate"><span class="pre">offset</span> <span class="pre">=</span> <span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">max_len</span> <span class="pre">=</span> <span class="pre">PAGE_SIZE</span></code>
with fragmented page pools.</p>
</section>
<section id="stats-api-and-structures">
<h3>Stats API and structures<a class="headerlink" href="#stats-api-and-structures" title="Permalink to this heading">¶</a></h3>
<p>If the kernel is configured with <code class="docutils literal notranslate"><span class="pre">CONFIG_PAGE_POOL_STATS=y</span></code>, the API
<a class="reference internal" href="#c.page_pool_get_stats" title="page_pool_get_stats"><code class="xref c c-func docutils literal notranslate"><span class="pre">page_pool_get_stats()</span></code></a> and structures described below are available.
It takes a  pointer to a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool</span></code> and a pointer to a <a class="reference internal" href="#c.page_pool_stats" title="page_pool_stats"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span>
<span class="pre">page_pool_stats</span></code></a> allocated by the caller.</p>
<p>The API will fill in the provided <a class="reference internal" href="#c.page_pool_stats" title="page_pool_stats"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool_stats</span></code></a> with
statistics about the page_pool.</p>
<dl class="c struct">
<dt class="sig sig-object c" id="c.page_pool_alloc_stats">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_alloc_stats</span></span></span><a class="headerlink" href="#c.page_pool_alloc_stats" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>allocation statistics</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct page_pool_alloc_stats {
    u64 fast;
    u64 slow;
    u64 slow_high_order;
    u64 empty;
    u64 refill;
    u64 waive;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">fast</span></code></dt><dd><p>successful fast path allocations</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">slow</span></code></dt><dd><p>slow path order-0 allocations</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">slow_high_order</span></code></dt><dd><p>slow path high order allocations</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">empty</span></code></dt><dd><p>ptr ring is empty, so a slow path allocation was forced</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">refill</span></code></dt><dd><p>an allocation which triggered a refill of the cache</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">waive</span></code></dt><dd><p>pages obtained from the ptr ring that cannot be added to
the cache due to a NUMA mismatch</p>
</dd>
</dl>
</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.page_pool_recycle_stats">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_recycle_stats</span></span></span><a class="headerlink" href="#c.page_pool_recycle_stats" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>recycling (freeing) statistics</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct page_pool_recycle_stats {
    u64 cached;
    u64 cache_full;
    u64 ring;
    u64 ring_full;
    u64 released_refcnt;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">cached</span></code></dt><dd><p>recycling placed page in the page pool cache</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cache_full</span></code></dt><dd><p>page pool cache was full</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ring</span></code></dt><dd><p>page placed into the ptr ring</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ring_full</span></code></dt><dd><p>page released from page pool because the ptr ring was full</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">released_refcnt</span></code></dt><dd><p>page released (and not recycled) because refcnt &gt; 1</p>
</dd>
</dl>
</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.page_pool_stats">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">page_pool_stats</span></span></span><a class="headerlink" href="#c.page_pool_stats" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>combined page pool use statistics</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct page_pool_stats {
    struct page_pool_alloc_stats alloc_stats;
    struct page_pool_recycle_stats recycle_stats;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">alloc_stats</span></code></dt><dd><p>see <a class="reference internal" href="#c.page_pool_alloc_stats" title="page_pool_alloc_stats"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool_alloc_stats</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">recycle_stats</span></code></dt><dd><p>see <a class="reference internal" href="#c.page_pool_recycle_stats" title="page_pool_recycle_stats"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page_pool_recycle_stats</span></code></a></p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>Wrapper struct for combining page pool stats with different storage
requirements.</p>
</section>
</section>
<section id="coding-examples">
<h2>Coding examples<a class="headerlink" href="#coding-examples" title="Permalink to this heading">¶</a></h2>
<section id="registration">
<h3>Registration<a class="headerlink" href="#registration" title="Permalink to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Page pool registration */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">page_pool_params</span><span class="w"> </span><span class="n">pp_params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">xdp_rxq_info</span><span class="w"> </span><span class="n">xdp_rxq</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>

<span class="n">pp_params</span><span class="p">.</span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="cm">/* internal DMA mapping in page_pool */</span>
<span class="n">pp_params</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PP_FLAG_DMA_MAP</span><span class="p">;</span>
<span class="n">pp_params</span><span class="p">.</span><span class="n">pool_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DESC_NUM</span><span class="p">;</span>
<span class="n">pp_params</span><span class="p">.</span><span class="n">nid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NUMA_NO_NODE</span><span class="p">;</span>
<span class="n">pp_params</span><span class="p">.</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="n">pp_params</span><span class="p">.</span><span class="n">napi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">napi</span><span class="p">;</span><span class="w"> </span><span class="cm">/* only if locking is tied to NAPI */</span>
<span class="n">pp_params</span><span class="p">.</span><span class="n">dma_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xdp_prog</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DMA_BIDIRECTIONAL</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
<span class="n">page_pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page_pool_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pp_params</span><span class="p">);</span>

<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xdp_rxq_info_reg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xdp_rxq</span><span class="p">,</span><span class="w"> </span><span class="n">ndev</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">err_out</span><span class="p">;</span>

<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xdp_rxq_info_reg_mem_model</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xdp_rxq</span><span class="p">,</span><span class="w"> </span><span class="n">MEM_TYPE_PAGE_POOL</span><span class="p">,</span><span class="w"> </span><span class="n">page_pool</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">err_out</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="napi-poller">
<h3>NAPI poller<a class="headerlink" href="#napi-poller" title="Permalink to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* NAPI Rx poller */</span>
<span class="k">enum</span><span class="w"> </span><span class="n">dma_data_direction</span><span class="w"> </span><span class="n">dma_dir</span><span class="p">;</span>

<span class="n">dma_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page_pool_get_dma_dir</span><span class="p">(</span><span class="n">dring</span><span class="o">-&gt;</span><span class="n">page_pool</span><span class="p">);</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">budget</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">some</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">        </span><span class="n">page_pool_recycle_direct</span><span class="p">(</span><span class="n">page_pool</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">packet_is_xdp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">XDP_DROP</span><span class="o">:</span>
<span class="w">            </span><span class="n">page_pool_recycle_direct</span><span class="p">(</span><span class="n">page_pool</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">(</span><span class="n">packet_is_skb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">skb_mark_for_recycle</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="w">        </span><span class="n">new_page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page_pool_dev_alloc_pages</span><span class="p">(</span><span class="n">page_pool</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="stats">
<h3>Stats<a class="headerlink" href="#stats" title="Permalink to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifdef CONFIG_PAGE_POOL_STATS</span>
<span class="cm">/* retrieve stats */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">page_pool_stats</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">page_pool_get_stats</span><span class="p">(</span><span class="n">page_pool</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stats</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* perhaps the driver reports statistics with ethool */</span>
<span class="w">        </span><span class="n">ethtool_print_allocation_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">.</span><span class="n">alloc_stats</span><span class="p">);</span>
<span class="w">        </span><span class="n">ethtool_print_recycle_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">.</span><span class="n">recycle_stats</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="driver-unload">
<h3>Driver unload<a class="headerlink" href="#driver-unload" title="Permalink to this heading">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Driver unload */</span>
<span class="n">page_pool_put_full_page</span><span class="p">(</span><span class="n">page_pool</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="n">xdp_rxq_info_unreg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xdp_rxq</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/networking/page_pool.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>