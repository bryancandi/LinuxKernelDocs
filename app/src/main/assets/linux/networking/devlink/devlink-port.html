<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Devlink Port &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=3918102e" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Devlink Region" href="devlink-region.html" />
    <link rel="prev" title="Devlink Params" href="devlink-params.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.12.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../subsystem-apis.html#networking-interfaces">Networking interfaces</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/networking/devlink/devlink-port.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="devlink-port">
<span id="id1"></span><h1>Devlink Port<a class="headerlink" href="#devlink-port" title="Link to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">devlink-port</span></code> is a port that exists on the device. It has a logically
separate ingress/egress point of the device. A devlink port can be any one
of many flavours. A devlink port flavour along with port attributes
describe what a port represents.</p>
<p>A device driver that intends to publish a devlink port sets the
devlink port attributes and registers the devlink port.</p>
<p>Devlink port flavours are described below.</p>
<table class="docutils align-default" id="id2">
<caption><span class="caption-text">List of devlink port flavours</span><a class="headerlink" href="#id2" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 26.8%" />
<col style="width: 73.2%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Flavour</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_FLAVOUR_PHYSICAL</span></code></p></td>
<td><p>Any kind of physical port. This can be an eswitch physical port or any
other physical port on the device.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_FLAVOUR_DSA</span></code></p></td>
<td><p>This indicates a DSA interconnect port.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_FLAVOUR_CPU</span></code></p></td>
<td><p>This indicates a CPU port applicable only to DSA.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_FLAVOUR_PCI_PF</span></code></p></td>
<td><p>This indicates an eswitch port representing a port of PCI
physical function (PF).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_FLAVOUR_PCI_VF</span></code></p></td>
<td><p>This indicates an eswitch port representing a port of PCI
virtual function (VF).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_FLAVOUR_PCI_SF</span></code></p></td>
<td><p>This indicates an eswitch port representing a port of PCI
subfunction (SF).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_FLAVOUR_VIRTUAL</span></code></p></td>
<td><p>This indicates a virtual port for the PCI virtual function.</p></td>
</tr>
</tbody>
</table>
<p>Devlink port can have a different type based on the link layer described below.</p>
<table class="docutils align-default" id="id3">
<caption><span class="caption-text">List of devlink port types</span><a class="headerlink" href="#id3" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 20.4%" />
<col style="width: 79.6%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Type</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_TYPE_ETH</span></code></p></td>
<td><p>Driver should set this port type when a link layer of the port is
Ethernet.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_TYPE_IB</span></code></p></td>
<td><p>Driver should set this port type when a link layer of the port is
InfiniBand.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_PORT_TYPE_AUTO</span></code></p></td>
<td><p>This type is indicated by the user when driver should detect the port
type automatically.</p></td>
</tr>
</tbody>
</table>
<section id="pci-controllers">
<h2>PCI controllers<a class="headerlink" href="#pci-controllers" title="Link to this heading">¶</a></h2>
<p>In most cases a PCI device has only one controller. A controller consists of
potentially multiple physical, virtual functions and subfunctions. A function
consists of one or more ports. This port is represented by the devlink eswitch
port.</p>
<p>A PCI device connected to multiple CPUs or multiple PCI root complexes or a
SmartNIC, however, may have multiple controllers. For a device with multiple
controllers, each controller is distinguished by a unique controller number.
An eswitch is on the PCI device which supports ports of multiple controllers.</p>
<p>An example view of a system with two controllers:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>             ---------------------------------------------------------
             |                                                       |
             |           --------- ---------         ------- ------- |
-----------  |           | vf(s) | | sf(s) |         |vf(s)| |sf(s)| |
| server  |  | -------   ----/---- ---/----- ------- ---/--- ---/--- |
| pci rc  |=== | pf0 |______/________/       | pf1 |___/_______/     |
| connect |  | -------                       -------                 |
-----------  |     | controller_num=1 (no eswitch)                   |
             ------|--------------------------------------------------
             (internal wire)
                   |
             ---------------------------------------------------------
             | devlink eswitch ports and reps                        |
             | ----------------------------------------------------- |
             | |ctrl-0 | ctrl-0 | ctrl-0 | ctrl-0 | ctrl-0 |ctrl-0 | |
             | |pf0    | pf0vfN | pf0sfN | pf1    | pf1vfN |pf1sfN | |
             | ----------------------------------------------------- |
             | |ctrl-1 | ctrl-1 | ctrl-1 | ctrl-1 | ctrl-1 |ctrl-1 | |
             | |pf0    | pf0vfN | pf0sfN | pf1    | pf1vfN |pf1sfN | |
             | ----------------------------------------------------- |
             |                                                       |
             |                                                       |
-----------  |           --------- ---------         ------- ------- |
| smartNIC|  |           | vf(s) | | sf(s) |         |vf(s)| |sf(s)| |
| pci rc  |==| -------   ----/---- ---/----- ------- ---/--- ---/--- |
| connect |  | | pf0 |______/________/       | pf1 |___/_______/     |
-----------  | -------                       -------                 |
             |                                                       |
             |  local controller_num=0 (eswitch)                     |
             ---------------------------------------------------------
</pre></div>
</div>
<p>In the above example, the external controller (identified by controller number = 1)
doesn’t have the eswitch. Local controller (identified by controller number = 0)
has the eswitch. The Devlink instance on the local controller has eswitch
devlink ports for both the controllers.</p>
<section id="function-configuration">
<h3>Function configuration<a class="headerlink" href="#function-configuration" title="Link to this heading">¶</a></h3>
<p>Users can configure one or more function attributes before enumerating the PCI
function. Usually it means, user should configure function attribute
before a bus specific device for the function is created. However, when
SRIOV is enabled, virtual function devices are created on the PCI bus.
Hence, function attribute should be configured before binding virtual
function device to the driver. For subfunctions, this means user should
configure port function attribute before activating the port function.</p>
<p>A user may set the hardware address of the function using
<cite>devlink port function set hw_addr</cite> command. For Ethernet port function
this means a MAC address.</p>
<p>Users may also set the RoCE capability of the function using
<cite>devlink port function set roce</cite> command.</p>
<p>Users may also set the function as migratable using
<cite>devlink port function set migratable</cite> command.</p>
<p>Users may also set the IPsec crypto capability of the function using
<cite>devlink port function set ipsec_crypto</cite> command.</p>
<p>Users may also set the IPsec packet capability of the function using
<cite>devlink port function set ipsec_packet</cite> command.</p>
<p>Users may also set the maximum IO event queues of the function
using <cite>devlink port function set max_io_eqs</cite> command.</p>
</section>
<section id="function-attributes">
<h3>Function attributes<a class="headerlink" href="#function-attributes" title="Link to this heading">¶</a></h3>
</section>
</section>
<section id="mac-address-setup">
<h2>MAC address setup<a class="headerlink" href="#mac-address-setup" title="Link to this heading">¶</a></h2>
<p>The configured MAC address of the PCI VF/SF will be used by netdevice and rdma
device created for the PCI VF/SF.</p>
<ul>
<li><p>Get the MAC address of the VF identified by its unique devlink port index:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
  function:
    hw_addr 00:00:00:00:00:00
</pre></div>
</div>
</li>
<li><p>Set the MAC address of the VF identified by its unique devlink port index:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port function set pci/0000:06:00.0/2 hw_addr 00:11:22:33:44:55

$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
  function:
    hw_addr 00:11:22:33:44:55
</pre></div>
</div>
</li>
<li><p>Get the MAC address of the SF identified by its unique devlink port index:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port show pci/0000:06:00.0/32768
pci/0000:06:00.0/32768: type eth netdev enp6s0pf0sf88 flavour pcisf pfnum 0 sfnum 88
  function:
    hw_addr 00:00:00:00:00:00
</pre></div>
</div>
</li>
<li><p>Set the MAC address of the SF identified by its unique devlink port index:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port function set pci/0000:06:00.0/32768 hw_addr 00:00:00:00:88:88

$ devlink port show pci/0000:06:00.0/32768
pci/0000:06:00.0/32768: type eth netdev enp6s0pf0sf88 flavour pcisf pfnum 0 sfnum 88
  function:
    hw_addr 00:00:00:00:88:88
</pre></div>
</div>
</li>
</ul>
</section>
<section id="roce-capability-setup">
<h2>RoCE capability setup<a class="headerlink" href="#roce-capability-setup" title="Link to this heading">¶</a></h2>
<p>Not all PCI VFs/SFs require RoCE capability.</p>
<p>When RoCE capability is disabled, it saves system memory per PCI VF/SF.</p>
<p>When user disables RoCE capability for a VF/SF, user application cannot send or
receive any RoCE packets through this VF/SF and RoCE GID table for this PCI
will be empty.</p>
<p>When RoCE capability is disabled in the device using port function attribute,
VF/SF driver cannot override it.</p>
<ul>
<li><p>Get RoCE capability of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 roce enable
</pre></div>
</div>
</li>
<li><p>Set RoCE capability of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port function set pci/0000:06:00.0/2 roce disable

$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 roce disable
</pre></div>
</div>
</li>
</ul>
</section>
<section id="migratable-capability-setup">
<h2>migratable capability setup<a class="headerlink" href="#migratable-capability-setup" title="Link to this heading">¶</a></h2>
<p>Live migration is the process of transferring a live virtual machine
from one physical host to another without disrupting its normal
operation.</p>
<p>User who want PCI VFs to be able to perform live migration need to
explicitly enable the VF migratable capability.</p>
<p>When user enables migratable capability for a VF, and the HV binds the VF to VFIO driver
with migration support, the user can migrate the VM with this VF from one HV to a
different one.</p>
<p>However, when migratable capability is enable, device will disable features which cannot
be migrated. Thus migratable cap can impose limitations on a VF so let the user decide.</p>
<p>Example of LM with migratable function configuration:
- Get migratable capability of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 migratable disable
</pre></div>
</div>
<ul>
<li><p>Set migratable capability of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port function set pci/0000:06:00.0/2 migratable enable

$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 migratable enable
</pre></div>
</div>
</li>
<li><p>Bind VF to VFIO driver with migration support:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo &lt;pci_id&gt; &gt; /sys/bus/pci/devices/0000:08:00.0/driver/unbind
$ echo mlx5_vfio_pci &gt; /sys/bus/pci/devices/0000:08:00.0/driver_override
$ echo &lt;pci_id&gt; &gt; /sys/bus/pci/devices/0000:08:00.0/driver/bind
</pre></div>
</div>
</li>
</ul>
<p>Attach VF to the VM.
Start the VM.
Perform live migration.</p>
</section>
<section id="ipsec-crypto-capability-setup">
<h2>IPsec crypto capability setup<a class="headerlink" href="#ipsec-crypto-capability-setup" title="Link to this heading">¶</a></h2>
<p>When user enables IPsec crypto capability for a VF, user application can offload
XFRM state crypto operation (Encrypt/Decrypt) to this VF.</p>
<p>When IPsec crypto capability is disabled (default) for a VF, the XFRM state is
processed in software by the kernel.</p>
<ul>
<li><p>Get IPsec crypto capability of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 ipsec_crypto disabled
</pre></div>
</div>
</li>
<li><p>Set IPsec crypto capability of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port function set pci/0000:06:00.0/2 ipsec_crypto enable

$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 ipsec_crypto enabled
</pre></div>
</div>
</li>
</ul>
</section>
<section id="ipsec-packet-capability-setup">
<h2>IPsec packet capability setup<a class="headerlink" href="#ipsec-packet-capability-setup" title="Link to this heading">¶</a></h2>
<p>When user enables IPsec packet capability for a VF, user application can offload
XFRM state and policy crypto operation (Encrypt/Decrypt) to this VF, as well as
IPsec encapsulation.</p>
<p>When IPsec packet capability is disabled (default) for a VF, the XFRM state and
policy is processed in software by the kernel.</p>
<ul>
<li><p>Get IPsec packet capability of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 ipsec_packet disabled
</pre></div>
</div>
</li>
<li><p>Set IPsec packet capability of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port function set pci/0000:06:00.0/2 ipsec_packet enable

$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 ipsec_packet enabled
</pre></div>
</div>
</li>
</ul>
</section>
<section id="maximum-io-events-queues-setup">
<h2>Maximum IO events queues setup<a class="headerlink" href="#maximum-io-events-queues-setup" title="Link to this heading">¶</a></h2>
<p>When user sets maximum number of IO event queues for a SF or
a VF, such function driver is limited to consume only enforced
number of IO event queues.</p>
<p>IO event queues deliver events related to IO queues, including network
device transmit and receive queues (txq and rxq) and RDMA Queue Pairs (QPs).
For example, the number of netdevice channels and RDMA device completion
vectors are derived from the function’s IO event queues. Usually, the number
of interrupt vectors consumed by the driver is limited by the number of IO
event queues per device, as each of the IO event queues is connected to an
interrupt vector.</p>
<ul>
<li><p>Get maximum IO event queues of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 ipsec_packet disabled max_io_eqs 10
</pre></div>
</div>
</li>
<li><p>Set maximum IO event queues of the VF device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink port function set pci/0000:06:00.0/2 max_io_eqs 32

$ devlink port show pci/0000:06:00.0/2
pci/0000:06:00.0/2: type eth netdev enp6s0pf0vf1 flavour pcivf pfnum 0 vfnum 1
    function:
        hw_addr 00:00:00:00:00:00 ipsec_packet disabled max_io_eqs 32
</pre></div>
</div>
</li>
</ul>
<section id="subfunction">
<h3>Subfunction<a class="headerlink" href="#subfunction" title="Link to this heading">¶</a></h3>
<p>Subfunction is a lightweight function that has a parent PCI function on which
it is deployed. Subfunction is created and deployed in unit of 1. Unlike
SRIOV VFs, a subfunction doesn’t require its own PCI virtual function.
A subfunction communicates with the hardware through the parent PCI function.</p>
<p>To use a subfunction, 3 steps setup sequence is followed:</p>
<ol class="arabic simple">
<li><p>create - create a subfunction;</p></li>
<li><p>configure - configure subfunction attributes;</p></li>
<li><p>deploy - deploy the subfunction;</p></li>
</ol>
<p>Subfunction management is done using devlink port user interface.
User performs setup on the subfunction management device.</p>
</section>
</section>
<section id="create">
<h2>(1) Create<a class="headerlink" href="#create" title="Link to this heading">¶</a></h2>
<p>A subfunction is created using a devlink port interface. A user adds the
subfunction by adding a devlink port of subfunction flavour. The devlink
kernel code calls down to subfunction management driver (devlink ops) and asks
it to create a subfunction devlink port. Driver then instantiates the
subfunction port and any associated objects such as health reporters and
representor netdevice.</p>
</section>
<section id="configure">
<h2>(2) Configure<a class="headerlink" href="#configure" title="Link to this heading">¶</a></h2>
<p>A subfunction devlink port is created but it is not active yet. That means the
entities are created on devlink side, the e-switch port representor is created,
but the subfunction device itself is not created. A user might use e-switch port
representor to do settings, putting it into bridge, adding TC rules, etc. A user
might as well configure the hardware address (such as MAC address) of the
subfunction while subfunction is inactive.</p>
</section>
<section id="deploy">
<h2>(3) Deploy<a class="headerlink" href="#deploy" title="Link to this heading">¶</a></h2>
<p>Once a subfunction is configured, user must activate it to use it. Upon
activation, subfunction management driver asks the subfunction management
device to instantiate the subfunction device on particular PCI function.
A subfunction device is created on the <a class="reference internal" href="../../driver-api/auxiliary_bus.html#auxiliary-bus"><span class="std std-ref">Documentation/driver-api/auxiliary_bus.rst</span></a>.
At this point a matching subfunction driver binds to the subfunction’s auxiliary device.</p>
<section id="rate-object-management">
<h3>Rate object management<a class="headerlink" href="#rate-object-management" title="Link to this heading">¶</a></h3>
<p>Devlink provides API to manage tx rates of single devlink port or a group.
This is done through rate objects, which can be one of the two types:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">leaf</span></code></dt><dd><p>Represents a single devlink port; created/destroyed by the driver. Since leaf
have 1to1 mapping to its devlink port, in user space it is referred as
<code class="docutils literal notranslate"><span class="pre">pci/&lt;bus_addr&gt;/&lt;port_index&gt;</span></code>;</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">node</span></code></dt><dd><p>Represents a group of rate objects (leafs and/or nodes); created/deleted by
request from the userspace; initially empty (no rate objects added). In
userspace it is referred as <code class="docutils literal notranslate"><span class="pre">pci/&lt;bus_addr&gt;/&lt;node_name&gt;</span></code>, where
<code class="docutils literal notranslate"><span class="pre">node_name</span></code> can be any identifier, except decimal number, to avoid
collisions with leafs.</p>
</dd>
</dl>
<p>API allows to configure following rate object’s parameters:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">tx_share</span></code></dt><dd><p>Minimum TX rate value shared among all other rate objects, or rate objects
that parts of the parent group, if it is a part of the same group.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx_max</span></code></dt><dd><p>Maximum TX rate value.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx_priority</span></code></dt><dd><p>Allows for usage of strict priority arbiter among siblings. This
arbitration scheme attempts to schedule nodes based on their priority
as long as the nodes remain within their bandwidth limit. The higher the
priority the higher the probability that the node will get selected for
scheduling.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx_weight</span></code></dt><dd><p>Allows for usage of Weighted Fair Queuing arbitration scheme among
siblings. This arbitration scheme can be used simultaneously with the
strict priority. As a node is configured with a higher rate it gets more
BW relative to its siblings. Values are relative like a percentage
points, they basically tell how much BW should node take relative to
its siblings.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">parent</span></code></dt><dd><p>Parent node name. Parent node rate limits are considered as additional limits
to all node children limits. <code class="docutils literal notranslate"><span class="pre">tx_max</span></code> is an upper limit for children.
<code class="docutils literal notranslate"><span class="pre">tx_share</span></code> is a total bandwidth distributed among children.</p>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">tx_priority</span></code> and <code class="docutils literal notranslate"><span class="pre">tx_weight</span></code> can be used simultaneously. In that case
nodes with the same priority form a WFQ subgroup in the sibling group
and arbitration among them is based on assigned weights.</p>
<p>Arbitration flow from the high level:</p>
<ol class="arabic simple">
<li><p>Choose a node, or group of nodes with the highest priority that stays
within the BW limit and are not blocked. Use <code class="docutils literal notranslate"><span class="pre">tx_priority</span></code> as a
parameter for this arbitration.</p></li>
<li><p>If group of nodes have the same priority perform WFQ arbitration on
that subgroup. Use <code class="docutils literal notranslate"><span class="pre">tx_weight</span></code> as a parameter for this arbitration.</p></li>
<li><p>Select the winner node, and continue arbitration flow among its children,
until leaf node is reached, and the winner is established.</p></li>
<li><p>If all the nodes from the highest priority sub-group are satisfied, or
overused their assigned BW, move to the lower priority nodes.</p></li>
</ol>
<p>Driver implementations are allowed to support both or either rate object types
and setting methods of their parameters. Additionally driver implementation
may export nodes/leafs and their child-parent relationships.</p>
</section>
<section id="terms-and-definitions">
<h3>Terms and Definitions<a class="headerlink" href="#terms-and-definitions" title="Link to this heading">¶</a></h3>
<table class="docutils align-default" id="id4">
<caption><span class="caption-text">Terms and Definitions</span><a class="headerlink" href="#id4" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 19.6%" />
<col style="width: 80.4%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Term</p></td>
<td><p>Definitions</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PCI</span> <span class="pre">device</span></code></p></td>
<td><p>A physical PCI device having one or more PCI buses consists of one or
more PCI controllers.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">PCI</span> <span class="pre">controller</span></code></p></td>
<td><p>A controller consists of potentially multiple physical functions,
virtual functions and subfunctions.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Port</span> <span class="pre">function</span></code></p></td>
<td><p>An object to manage the function of a port.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Subfunction</span></code></p></td>
<td><p>A lightweight function that has parent PCI function on which it is
deployed.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Subfunction</span> <span class="pre">device</span></code></p></td>
<td><p>A bus device of the subfunction, usually on a auxiliary bus.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Subfunction</span> <span class="pre">driver</span></code></p></td>
<td><p>A device driver for the subfunction auxiliary device.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Subfunction</span> <span class="pre">management</span> <span class="pre">device</span></code></p></td>
<td><p>A PCI physical function that supports subfunction management.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Subfunction</span> <span class="pre">management</span> <span class="pre">driver</span></code></p></td>
<td><p>A device driver for PCI physical function that supports
subfunction management using devlink port interface.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Subfunction</span> <span class="pre">host</span> <span class="pre">driver</span></code></p></td>
<td><p>A device driver for PCI physical function that hosts subfunction
devices. In most cases it is same as subfunction management driver. When
subfunction is used on external controller, subfunction management and
host drivers are different.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/networking/devlink/devlink-port.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>