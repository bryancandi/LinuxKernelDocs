<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Protected Execution Facility &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=3918102e" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Virtual Accelerator Switchboard (VAS) userspace API" href="vas-api.html" />
    <link rel="prev" title="Transactional Memory support" href="transactional_memory.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo of The Linux Kernel"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.12.0</p>







<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">CPU architectures</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../arc/index.html">ARC architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../loongarch/index.html">LoongArch Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">powerpc</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="associativity.html">NUMA resource associativity</a></li>
<li class="toctree-l3"><a class="reference internal" href="booting.html">DeviceTree Booting</a></li>
<li class="toctree-l3"><a class="reference internal" href="bootwrapper.html">The PowerPC boot wrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpu_families.html">CPU Families</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpu_features.html">CPU Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="cxl.html">Coherent Accelerator Interface (CXL)</a></li>
<li class="toctree-l3"><a class="reference internal" href="cxlflash.html">Coherent Accelerator (CXL) Flash</a></li>
<li class="toctree-l3"><a class="reference internal" href="dawr-power9.html">DAWR issues on POWER9</a></li>
<li class="toctree-l3"><a class="reference internal" href="dexcr.html">DEXCR (Dynamic Execution Control Register)</a></li>
<li class="toctree-l3"><a class="reference internal" href="dscr.html">DSCR (Data Stream Control Register)</a></li>
<li class="toctree-l3"><a class="reference internal" href="eeh-pci-error-recovery.html">PCI Bus EEH Error Recovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="elf_hwcaps.html">POWERPC ELF HWCAPs</a></li>
<li class="toctree-l3"><a class="reference internal" href="elfnote.html">ELF Note PowerPC Namespace</a></li>
<li class="toctree-l3"><a class="reference internal" href="firmware-assisted-dump.html">Firmware-Assisted Dump</a></li>
<li class="toctree-l3"><a class="reference internal" href="hvcs.html">HVCS IBM “Hypervisor Virtual Console Server” Installation Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="imc.html">IMC (In-Memory Collection Counters)</a></li>
<li class="toctree-l3"><a class="reference internal" href="isa-versions.html">CPU to ISA Version Mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="kaslr-booke32.html">KASLR for Freescale BookE32</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpc52xx.html">Linux 2.6.x on MPC52xx family</a></li>
<li class="toctree-l3"><a class="reference internal" href="kvm-nested.html">Nested KVM on POWER</a></li>
<li class="toctree-l3"><a class="reference internal" href="papr_hcalls.html">Hypercall Op-codes (hcalls)</a></li>
<li class="toctree-l3"><a class="reference internal" href="pci_iov_resource_on_powernv.html">PCI Express I/O Virtualization Resource on Powerenv</a></li>
<li class="toctree-l3"><a class="reference internal" href="pmu-ebb.html">PMU Event Based Branches</a></li>
<li class="toctree-l3"><a class="reference internal" href="ptrace.html">Ptrace</a></li>
<li class="toctree-l3"><a class="reference internal" href="qe_firmware.html">Freescale QUICC Engine Firmware Uploading</a></li>
<li class="toctree-l3"><a class="reference internal" href="syscall64-abi.html">Power Architecture 64-bit Linux system call ABI</a></li>
<li class="toctree-l3"><a class="reference internal" href="transactional_memory.html">Transactional Memory support</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Protected Execution Facility</a></li>
<li class="toctree-l3"><a class="reference internal" href="vas-api.html">Virtual Accelerator Switchboard (VAS) userspace API</a></li>
<li class="toctree-l3"><a class="reference internal" href="vcpudispatch_stats.html">VCPU Dispatch Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="vmemmap_dedup.html">Device DAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="features.html">Feature status on powerpc architecture</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/arch/powerpc/ultravisor.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="protected-execution-facility">
<span id="ultravisor"></span><h1><a class="toc-backref" href="#id65" role="doc-backlink">Protected Execution Facility</a><a class="headerlink" href="#protected-execution-facility" title="Link to this heading">¶</a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#protected-execution-facility" id="id65">Protected Execution Facility</a></p>
<ul>
<li><p><a class="reference internal" href="#introduction" id="id66">Introduction</a></p>
<ul>
<li><p><a class="reference internal" href="#hardware" id="id67">Hardware</a></p></li>
<li><p><a class="reference internal" href="#software-microcode" id="id68">Software/Microcode</a></p></li>
<li><p><a class="reference internal" href="#terminology" id="id69">Terminology</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ultravisor-calls-api" id="id70">Ultravisor calls API</a></p>
<ul>
<li><p><a class="reference internal" href="#ultracalls-used-by-hypervisor" id="id71">Ultracalls used by Hypervisor</a></p></li>
<li><p><a class="reference internal" href="#ultracalls-used-by-svm" id="id72">Ultracalls used by SVM</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#hypervisor-calls-api" id="id73">Hypervisor Calls API</a></p>
<ul>
<li><p><a class="reference internal" href="#hypervisor-calls-to-support-ultravisor" id="id74">Hypervisor calls to support Ultravisor</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#references" id="id75">References</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id66" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<blockquote>
<div><p>Protected Execution Facility (PEF) is an architectural change for
POWER 9 that enables Secure Virtual Machines (SVMs). DD2.3 chips
(PVR=0x004e1203) or greater will be PEF-capable. A new ISA release
will include the PEF RFC02487 changes.</p>
<p>When enabled, PEF adds a new higher privileged mode, called Ultravisor
mode, to POWER architecture. Along with the new mode there is new
firmware called the Protected Execution Ultravisor (or Ultravisor
for short). Ultravisor mode is the highest privileged mode in POWER
architecture.</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Privilege States</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Problem</p></td>
</tr>
<tr class="row-odd"><td><p>Supervisor</p></td>
</tr>
<tr class="row-even"><td><p>Hypervisor</p></td>
</tr>
<tr class="row-odd"><td><p>Ultravisor</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>PEF protects SVMs from the hypervisor, privileged users, and other
VMs in the system. SVMs are protected while at rest and can only be
executed by an authorized machine. All virtual machines utilize
hypervisor services. The Ultravisor filters calls between the SVMs
and the hypervisor to assure that information does not accidentally
leak. All hypercalls except H_RANDOM are reflected to the hypervisor.
H_RANDOM is not reflected to prevent the hypervisor from influencing
random values in the SVM.</p>
<p>To support this there is a refactoring of the ownership of resources
in the CPU. Some of the resources which were previously hypervisor
privileged are now ultravisor privileged.</p>
</div></blockquote>
<section id="hardware">
<h3><a class="toc-backref" href="#id67" role="doc-backlink">Hardware</a><a class="headerlink" href="#hardware" title="Link to this heading">¶</a></h3>
<blockquote>
<div><p>The hardware changes include the following:</p>
<ul>
<li><p>There is a new bit in the MSR that determines whether the current
process is running in secure mode, MSR(S) bit 41. MSR(S)=1, process
is in secure mode, MSR(s)=0 process is in normal mode.</p></li>
<li><p>The MSR(S) bit can only be set by the Ultravisor.</p></li>
<li><p>HRFID cannot be used to set the MSR(S) bit. If the hypervisor needs
to return to a SVM it must use an ultracall. It can determine if
the VM it is returning to is secure.</p></li>
<li><p>There is a new Ultravisor privileged register, SMFCTRL, which has an
enable/disable bit SMFCTRL(E).</p></li>
<li><p>The privilege of a process is now determined by three MSR bits,
MSR(S, HV, PR). In each of the tables below the modes are listed
from least privilege to highest privilege. The higher privilege
modes can access all the resources of the lower privilege modes.</p>
<p><strong>Secure Mode MSR Settings</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>S</p></th>
<th class="head"><p>HV</p></th>
<th class="head"><p>PR</p></th>
<th class="head"><p>Privilege</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
<td><p>Problem</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>Privileged(OS)</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>1</p></td>
<td><p>0</p></td>
<td><p>Ultravisor</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
<td><p>Reserved</p></td>
</tr>
</tbody>
</table>
<p><strong>Normal Mode MSR Settings</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>S</p></th>
<th class="head"><p>HV</p></th>
<th class="head"><p>PR</p></th>
<th class="head"><p>Privilege</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
<td><p>Problem</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>Privileged(OS)</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>0</p></td>
<td><p>Hypervisor</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
<td><p>Problem (Host)</p></td>
</tr>
</tbody>
</table>
</li>
<li><p>Memory is partitioned into secure and normal memory. Only processes
that are running in secure mode can access secure memory.</p></li>
<li><p>The hardware does not allow anything that is not running secure to
access secure memory. This means that the Hypervisor cannot access
the memory of the SVM without using an ultracall (asking the
Ultravisor). The Ultravisor will only allow the hypervisor to see
the SVM memory encrypted.</p></li>
<li><p>I/O systems are not allowed to directly address secure memory. This
limits the SVMs to virtual I/O only.</p></li>
<li><p>The architecture allows the SVM to share pages of memory with the
hypervisor that are not protected with encryption. However, this
sharing must be initiated by the SVM.</p></li>
<li><p>When a process is running in secure mode all hypercalls
(syscall lev=1) go to the Ultravisor.</p></li>
<li><p>When a process is in secure mode all interrupts go to the
Ultravisor.</p></li>
<li><p>The following resources have become Ultravisor privileged and
require an Ultravisor interface to manipulate:</p>
<ul class="simple">
<li><p>Processor configurations registers (SCOMs).</p></li>
<li><p>Stop state information.</p></li>
<li><p>The debug registers CIABR, DAWR, and DAWRX when SMFCTRL(D) is set.
If SMFCTRL(D) is not set they do not work in secure mode. When set,
reading and writing requires an Ultravisor call, otherwise that
will cause a Hypervisor Emulation Assistance interrupt.</p></li>
<li><p>PTCR and partition table entries (partition table is in secure
memory). An attempt to write to PTCR will cause a Hypervisor
Emulation Assistance interrupt.</p></li>
<li><p>LDBAR (LD Base Address Register) and IMC (In-Memory Collection)
non-architected registers. An attempt to write to them will cause a
Hypervisor Emulation Assistance interrupt.</p></li>
<li><p>Paging for an SVM, sharing of memory with Hypervisor for an SVM.
(Including Virtual Processor Area (VPA) and virtual I/O).</p></li>
</ul>
</li>
</ul>
</div></blockquote>
</section>
<section id="software-microcode">
<h3><a class="toc-backref" href="#id68" role="doc-backlink">Software/Microcode</a><a class="headerlink" href="#software-microcode" title="Link to this heading">¶</a></h3>
<blockquote>
<div><p>The software changes include:</p>
<ul class="simple">
<li><p>SVMs are created from normal VM using (open source) tooling supplied
by IBM.</p></li>
<li><p>All SVMs start as normal VMs and utilize an ultracall, UV_ESM
(Enter Secure Mode), to make the transition.</p></li>
<li><p>When the UV_ESM ultracall is made the Ultravisor copies the VM into
secure memory, decrypts the verification information, and checks the
integrity of the SVM. If the integrity check passes the Ultravisor
passes control in secure mode.</p></li>
<li><p>The verification information includes the pass phrase for the
encrypted disk associated with the SVM. This pass phrase is given
to the SVM when requested.</p></li>
<li><p>The Ultravisor is not involved in protecting the encrypted disk of
the SVM while at rest.</p></li>
<li><p>For external interrupts the Ultravisor saves the state of the SVM,
and reflects the interrupt to the hypervisor for processing.
For hypercalls, the Ultravisor inserts neutral state into all
registers not needed for the hypercall then reflects the call to
the hypervisor for processing. The H_RANDOM hypercall is performed
by the Ultravisor and not reflected.</p></li>
<li><p>For virtual I/O to work bounce buffering must be done.</p></li>
<li><p>The Ultravisor uses AES (IAPM) for protection of SVM memory. IAPM
is a mode of AES that provides integrity and secrecy concurrently.</p></li>
<li><p>The movement of data between normal and secure pages is coordinated
with the Ultravisor by a new HMM plug-in in the Hypervisor.</p></li>
</ul>
<p>The Ultravisor offers new services to the hypervisor and SVMs. These
are accessed through ultracalls.</p>
</div></blockquote>
</section>
<section id="terminology">
<h3><a class="toc-backref" href="#id69" role="doc-backlink">Terminology</a><a class="headerlink" href="#terminology" title="Link to this heading">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>Hypercalls: special system calls used to request services from
Hypervisor.</p></li>
<li><p>Normal memory: Memory that is accessible to Hypervisor.</p></li>
<li><p>Normal page: Page backed by normal memory and available to
Hypervisor.</p></li>
<li><p>Shared page: A page backed by normal memory and available to both
the Hypervisor/QEMU and the SVM (i.e page has mappings in SVM and
Hypervisor/QEMU).</p></li>
<li><p>Secure memory: Memory that is accessible only to Ultravisor and
SVMs.</p></li>
<li><p>Secure page: Page backed by secure memory and only available to
Ultravisor and SVM.</p></li>
<li><p>SVM: Secure Virtual Machine.</p></li>
<li><p>Ultracalls: special system calls used to request services from
Ultravisor.</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="ultravisor-calls-api">
<h2><a class="toc-backref" href="#id70" role="doc-backlink">Ultravisor calls API</a><a class="headerlink" href="#ultravisor-calls-api" title="Link to this heading">¶</a></h2>
<blockquote>
<div><p>This section describes Ultravisor calls (ultracalls) needed to
support Secure Virtual Machines (SVM)s and Paravirtualized KVM. The
ultracalls allow the SVMs and Hypervisor to request services from the
Ultravisor such as accessing a register or memory region that can only
be accessed when running in Ultravisor-privileged mode.</p>
<p>The specific service needed from an ultracall is specified in register
R3 (the first parameter to the ultracall). Other parameters to the
ultracall, if any, are specified in registers R4 through R12.</p>
<p>Return value of all ultracalls is in register R3. Other output values
from the ultracall, if any, are returned in registers R4 through R12.
The only exception to this register usage is the <code class="docutils literal notranslate"><span class="pre">UV_RETURN</span></code>
ultracall described below.</p>
<p>Each ultracall returns specific error codes, applicable in the context
of the ultracall. However, like with the PowerPC Architecture Platform
Reference (PAPR), if no specific error code is defined for a
particular situation, then the ultracall will fallback to an erroneous
parameter-position based code. i.e U_PARAMETER, U_P2, U_P3 etc
depending on the ultracall parameter that may have caused the error.</p>
<p>Some ultracalls involve transferring a page of data between Ultravisor
and Hypervisor.  Secure pages that are transferred from secure memory
to normal memory may be encrypted using dynamically generated keys.
When the secure pages are transferred back to secure memory, they may
be decrypted using the same dynamically generated keys. Generation and
management of these keys will be covered in a separate document.</p>
<p>For now this only covers ultracalls currently implemented and being
used by Hypervisor and SVMs but others can be added here when it
makes sense.</p>
<p>The full specification for all hypercalls/ultracalls will eventually
be made available in the public/OpenPower version of the PAPR
specification.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If PEF is not enabled, the ultracalls will be redirected to the
Hypervisor which must handle/fail the calls.</p>
</div>
</div></blockquote>
<section id="ultracalls-used-by-hypervisor">
<h3><a class="toc-backref" href="#id71" role="doc-backlink">Ultracalls used by Hypervisor</a><a class="headerlink" href="#ultracalls-used-by-hypervisor" title="Link to this heading">¶</a></h3>
<blockquote>
<div><p>This section describes the virtual memory management ultracalls used
by the Hypervisor to manage SVMs.</p>
</div></blockquote>
<section id="uv-page-out">
<h4>UV_PAGE_OUT<a class="headerlink" href="#uv-page-out" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Encrypt and move the contents of a page from secure memory to normal
memory.</p>
</div></blockquote>
<section id="syntax">
<h5>Syntax<a class="headerlink" href="#syntax" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_PAGE_OUT</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">lpid</span><span class="p">,</span><span class="w">          </span><span class="cm">/* LPAR ID */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">dest_ra</span><span class="p">,</span><span class="w">       </span><span class="cm">/* real address of destination page */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">src_gpa</span><span class="p">,</span><span class="w">       </span><span class="cm">/* source guest-physical-address */</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w">  </span><span class="n">flags</span><span class="p">,</span><span class="w">         </span><span class="cm">/* flags */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w">         </span><span class="cm">/* page size order */</span>
</pre></div>
</div>
</section>
<section id="return-values">
<h5>Return values<a class="headerlink" href="#return-values" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</p></li>
<li><p>U_P2          if <code class="docutils literal notranslate"><span class="pre">dest_ra</span></code> is invalid.</p></li>
<li><p>U_P3          if the <code class="docutils literal notranslate"><span class="pre">src_gpa</span></code> address is invalid.</p></li>
<li><p>U_P4          if any bit in the <code class="docutils literal notranslate"><span class="pre">flags</span></code> is unrecognized</p></li>
<li><p>U_P5          if the <code class="docutils literal notranslate"><span class="pre">order</span></code> parameter is unsupported.</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
<li><p>U_BUSY        if page cannot be currently paged-out.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="description">
<h5>Description<a class="headerlink" href="#description" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Encrypt the contents of a secure-page and make it available to
Hypervisor in a normal page.</p>
<p>By default, the source page is unmapped from the SVM’s partition-
scoped page table. But the Hypervisor can provide a hint to the
Ultravisor to retain the page mapping by setting the <code class="docutils literal notranslate"><span class="pre">UV_SNAPSHOT</span></code>
flag in <code class="docutils literal notranslate"><span class="pre">flags</span></code> parameter.</p>
<p>If the source page is already a shared page the call returns
U_SUCCESS, without doing anything.</p>
</div></blockquote>
</section>
<section id="use-cases">
<h5>Use cases<a class="headerlink" href="#use-cases" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>QEMU attempts to access an address belonging to the SVM but the
page frame for that address is not mapped into QEMU’s address
space. In this case, the Hypervisor will allocate a page frame,
map it into QEMU’s address space and issue the <code class="docutils literal notranslate"><span class="pre">UV_PAGE_OUT</span></code>
call to retrieve the encrypted contents of the page.</p></li>
<li><p>When Ultravisor runs low on secure memory and it needs to page-out
an LRU page. In this case, Ultravisor will issue the
<code class="docutils literal notranslate"><span class="pre">H_SVM_PAGE_OUT</span></code> hypercall to the Hypervisor. The Hypervisor will
then allocate a normal page and issue the <code class="docutils literal notranslate"><span class="pre">UV_PAGE_OUT</span></code> ultracall
and the Ultravisor will encrypt and move the contents of the secure
page into the normal page.</p></li>
<li><p>When Hypervisor accesses SVM data, the Hypervisor requests the
Ultravisor to transfer the corresponding page into a insecure page,
which the Hypervisor can access. The data in the normal page will
be encrypted though.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-page-in">
<h4>UV_PAGE_IN<a class="headerlink" href="#uv-page-in" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Move the contents of a page from normal memory to secure memory.</p>
</div></blockquote>
<section id="id1">
<h5>Syntax<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_PAGE_IN</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">lpid</span><span class="p">,</span><span class="w">          </span><span class="cm">/* the LPAR ID */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">src_ra</span><span class="p">,</span><span class="w">        </span><span class="cm">/* source real address of page */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">dest_gpa</span><span class="p">,</span><span class="w">      </span><span class="cm">/* destination guest physical address */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w">         </span><span class="cm">/* flags */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w">         </span><span class="cm">/* page size order */</span>
</pre></div>
</div>
</section>
<section id="id2">
<h5>Return values<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_BUSY        if page cannot be currently paged-in.</p></li>
<li><p>U_FUNCTION    if functionality is not supported</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</p></li>
<li><p>U_P2          if <code class="docutils literal notranslate"><span class="pre">src_ra</span></code> is invalid.</p></li>
<li><p>U_P3          if the <code class="docutils literal notranslate"><span class="pre">dest_gpa</span></code> address is invalid.</p></li>
<li><p>U_P4          if any bit in the <code class="docutils literal notranslate"><span class="pre">flags</span></code> is unrecognized</p></li>
<li><p>U_P5          if the <code class="docutils literal notranslate"><span class="pre">order</span></code> parameter is unsupported.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id3">
<h5>Description<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Move the contents of the page identified by <code class="docutils literal notranslate"><span class="pre">src_ra</span></code> from normal
memory to secure memory and map it to the guest physical address
<code class="docutils literal notranslate"><span class="pre">dest_gpa</span></code>.</p>
<p>If <cite>dest_gpa</cite> refers to a shared address, map the page into the
partition-scoped page-table of the SVM.  If <cite>dest_gpa</cite> is not shared,
copy the contents of the page into the corresponding secure page.
Depending on the context, decrypt the page before being copied.</p>
<p>The caller provides the attributes of the page through the <code class="docutils literal notranslate"><span class="pre">flags</span></code>
parameter. Valid values for <code class="docutils literal notranslate"><span class="pre">flags</span></code> are:</p>
<blockquote>
<div><ul class="simple">
<li><p>CACHE_INHIBITED</p></li>
<li><p>CACHE_ENABLED</p></li>
<li><p>WRITE_PROTECTION</p></li>
</ul>
</div></blockquote>
<p>The Hypervisor must pin the page in memory before making
<code class="docutils literal notranslate"><span class="pre">UV_PAGE_IN</span></code> ultracall.</p>
</div></blockquote>
</section>
<section id="id4">
<h5>Use cases<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>When a normal VM switches to secure mode, all its pages residing
in normal memory, are moved into secure memory.</p></li>
<li><p>When an SVM requests to share a page with Hypervisor the Hypervisor
allocates a page and informs the Ultravisor.</p></li>
<li><p>When an SVM accesses a secure page that has been paged-out,
Ultravisor invokes the Hypervisor to locate the page. After
locating the page, the Hypervisor uses UV_PAGE_IN to make the
page available to Ultravisor.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-page-inval">
<h4>UV_PAGE_INVAL<a class="headerlink" href="#uv-page-inval" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Invalidate the Ultravisor mapping of a page.</p>
</div></blockquote>
<section id="id5">
<h5>Syntax<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_PAGE_INVAL</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">lpid</span><span class="p">,</span><span class="w">          </span><span class="cm">/* the LPAR ID */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">guest_pa</span><span class="p">,</span><span class="w">      </span><span class="cm">/* destination guest-physical-address */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w">         </span><span class="cm">/* page size order */</span>
</pre></div>
</div>
</section>
<section id="id6">
<h5>Return values<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</p></li>
<li><dl class="simple">
<dt>U_P2          if <code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> is invalid (or corresponds to a secure</dt><dd><p>page mapping).</p>
</dd>
</dl>
</li>
<li><p>U_P3          if the <code class="docutils literal notranslate"><span class="pre">order</span></code> is invalid.</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
<li><p>U_BUSY        if page cannot be currently invalidated.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id7">
<h5>Description<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>This ultracall informs Ultravisor that the page mapping in Hypervisor
corresponding to the given guest physical address has been invalidated
and that the Ultravisor should not access the page. If the specified
<code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> corresponds to a secure page, Ultravisor will ignore the
attempt to invalidate the page and return U_P2.</p>
</div></blockquote>
</section>
<section id="id8">
<h5>Use cases<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>When a shared page is unmapped from the QEMU’s page table, possibly
because it is paged-out to disk, Ultravisor needs to know that the
page should not be accessed from its side too.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-write-pate">
<h4>UV_WRITE_PATE<a class="headerlink" href="#uv-write-pate" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Validate and write the partition table entry (PATE) for a given
partition.</p>
</div></blockquote>
<section id="id9">
<h5>Syntax<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_WRITE_PATE</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">lpid</span><span class="p">,</span><span class="w">          </span><span class="cm">/* the LPAR ID */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">dw0</span><span class="w">            </span><span class="cm">/* the first double word to write */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">dw1</span><span class="p">)</span><span class="w">           </span><span class="cm">/* the second double word to write */</span>
</pre></div>
</div>
</section>
<section id="id10">
<h5>Return values<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_BUSY        if PATE cannot be currently written to.</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</p></li>
<li><p>U_P2          if <code class="docutils literal notranslate"><span class="pre">dw0</span></code> is invalid.</p></li>
<li><p>U_P3          if the <code class="docutils literal notranslate"><span class="pre">dw1</span></code> address is invalid.</p></li>
<li><dl class="simple">
<dt>U_PERMISSION  if the Hypervisor is attempting to change the PATE</dt><dd><p>of a secure virtual machine or if called from a
context other than Hypervisor.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id11">
<h5>Description<a class="headerlink" href="#id11" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Validate and write a LPID and its partition-table-entry for the given
LPID.  If the LPID is already allocated and initialized, this call
results in changing the partition table entry.</p>
</div></blockquote>
</section>
<section id="id12">
<h5>Use cases<a class="headerlink" href="#id12" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>The Partition table resides in Secure memory and its entries,
called PATE (Partition Table Entries), point to the partition-
scoped page tables for the Hypervisor as well as each of the
virtual machines (both secure and normal). The Hypervisor
operates in partition 0 and its partition-scoped page tables
reside in normal memory.</p></li>
<li><p>This ultracall allows the Hypervisor to register the partition-
scoped and process-scoped page table entries for the Hypervisor
and other partitions (virtual machines) with the Ultravisor.</p></li>
<li><p>If the value of the PATE for an existing partition (VM) changes,
the TLB cache for the partition is flushed.</p></li>
<li><p>The Hypervisor is responsible for allocating LPID. The LPID and
its PATE entry are registered together.  The Hypervisor manages
the PATE entries for a normal VM and can change the PATE entry
anytime. Ultravisor manages the PATE entries for an SVM and
Hypervisor is not allowed to modify them.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-return">
<h4>UV_RETURN<a class="headerlink" href="#uv-return" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Return control from the Hypervisor back to the Ultravisor after
processing an hypercall or interrupt that was forwarded (aka
<em>reflected</em>) to the Hypervisor.</p>
</div></blockquote>
<section id="id13">
<h5>Syntax<a class="headerlink" href="#id13" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_RETURN</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id14">
<h5>Return values<a class="headerlink" href="#id14" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>This call never returns to Hypervisor on success.  It returns
U_INVALID if ultracall is not made from a Hypervisor context.</p>
</div></blockquote>
</section>
<section id="id15">
<h5>Description<a class="headerlink" href="#id15" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>When an SVM makes an hypercall or incurs some other exception, the
Ultravisor usually forwards (aka <em>reflects</em>) the exceptions to the
Hypervisor.  After processing the exception, Hypervisor uses the
<code class="docutils literal notranslate"><span class="pre">UV_RETURN</span></code> ultracall to return control back to the SVM.</p>
<p>The expected register state on entry to this ultracall is:</p>
<ul class="simple">
<li><p>Non-volatile registers are restored to their original values.</p></li>
<li><p>If returning from an hypercall, register R0 contains the return
value (<strong>unlike other ultracalls</strong>) and, registers R4 through R12
contain any output values of the hypercall.</p></li>
<li><p>R3 contains the ultracall number, i.e UV_RETURN.</p></li>
<li><p>If returning with a synthesized interrupt, R2 contains the
synthesized interrupt number.</p></li>
</ul>
</div></blockquote>
</section>
<section id="id16">
<h5>Use cases<a class="headerlink" href="#id16" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>Ultravisor relies on the Hypervisor to provide several services to
the SVM such as processing hypercall and other exceptions. After
processing the exception, Hypervisor uses UV_RETURN to return
control back to the Ultravisor.</p></li>
<li><p>Hypervisor has to use this ultracall to return control to the SVM.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-register-mem-slot">
<h4>UV_REGISTER_MEM_SLOT<a class="headerlink" href="#uv-register-mem-slot" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Register an SVM address-range with specified properties.</p>
</div></blockquote>
<section id="id17">
<h5>Syntax<a class="headerlink" href="#id17" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_REGISTER_MEM_SLOT</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">lpid</span><span class="p">,</span><span class="w">          </span><span class="cm">/* LPAR ID of the SVM */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">start_gpa</span><span class="p">,</span><span class="w">     </span><span class="cm">/* start guest physical address */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w">          </span><span class="cm">/* size of address range in bytes */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">flags</span><span class="w">          </span><span class="cm">/* reserved for future expansion */</span>
<span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">slotid</span><span class="p">)</span><span class="w">        </span><span class="cm">/* slot identifier */</span>
</pre></div>
</div>
</section>
<section id="id18">
<h5>Return values<a class="headerlink" href="#id18" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</p></li>
<li><p>U_P2          if <code class="docutils literal notranslate"><span class="pre">start_gpa</span></code> is invalid.</p></li>
<li><p>U_P3          if <code class="docutils literal notranslate"><span class="pre">size</span></code> is invalid.</p></li>
<li><p>U_P4          if any bit in the <code class="docutils literal notranslate"><span class="pre">flags</span></code> is unrecognized.</p></li>
<li><p>U_P5          if the <code class="docutils literal notranslate"><span class="pre">slotid</span></code> parameter is unsupported.</p></li>
<li><p>U_PERMISSION  if called from context other than Hypervisor.</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id19">
<h5>Description<a class="headerlink" href="#id19" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Register a memory range for an SVM.  The memory range starts at the
guest physical address <code class="docutils literal notranslate"><span class="pre">start_gpa</span></code> and is <code class="docutils literal notranslate"><span class="pre">size</span></code> bytes long.</p>
</div></blockquote>
</section>
<section id="id20">
<h5>Use cases<a class="headerlink" href="#id20" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>When a virtual machine goes secure, all the memory slots managed by
the Hypervisor move into secure memory. The Hypervisor iterates
through each of memory slots, and registers the slot with
Ultravisor.  Hypervisor may discard some slots such as those used
for firmware (SLOF).</p></li>
<li><p>When new memory is hot-plugged, a new memory slot gets registered.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-unregister-mem-slot">
<h4>UV_UNREGISTER_MEM_SLOT<a class="headerlink" href="#uv-unregister-mem-slot" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Unregister an SVM address-range that was previously registered using
UV_REGISTER_MEM_SLOT.</p>
</div></blockquote>
<section id="id21">
<h5>Syntax<a class="headerlink" href="#id21" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_UNREGISTER_MEM_SLOT</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">lpid</span><span class="p">,</span><span class="w">          </span><span class="cm">/* LPAR ID of the SVM */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">slotid</span><span class="p">)</span><span class="w">        </span><span class="cm">/* reservation slotid */</span>
</pre></div>
</div>
</section>
<section id="id22">
<h5>Return values<a class="headerlink" href="#id22" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</p></li>
<li><p>U_P2          if <code class="docutils literal notranslate"><span class="pre">slotid</span></code> is invalid.</p></li>
<li><p>U_PERMISSION  if called from context other than Hypervisor.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id23">
<h5>Description<a class="headerlink" href="#id23" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Release the memory slot identified by <code class="docutils literal notranslate"><span class="pre">slotid</span></code> and free any
resources allocated towards the reservation.</p>
</div></blockquote>
</section>
<section id="id24">
<h5>Use cases<a class="headerlink" href="#id24" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>Memory hot-remove.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-svm-terminate">
<h4>UV_SVM_TERMINATE<a class="headerlink" href="#uv-svm-terminate" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Terminate an SVM and release its resources.</p>
</div></blockquote>
<section id="id25">
<h5>Syntax<a class="headerlink" href="#id25" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_SVM_TERMINATE</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">lpid</span><span class="p">,</span><span class="w">          </span><span class="cm">/* LPAR ID of the SVM */</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id26">
<h5>Return values<a class="headerlink" href="#id26" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">lpid</span></code> is invalid.</p></li>
<li><p>U_INVALID     if VM is not secure.</p></li>
<li><p>U_PERMISSION  if not called from a Hypervisor context.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id27">
<h5>Description<a class="headerlink" href="#id27" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Terminate an SVM and release all its resources.</p>
</div></blockquote>
</section>
<section id="id28">
<h5>Use cases<a class="headerlink" href="#id28" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>Called by Hypervisor when terminating an SVM.</p></li>
</ol>
</div></blockquote>
</section>
</section>
</section>
<section id="ultracalls-used-by-svm">
<h3><a class="toc-backref" href="#id72" role="doc-backlink">Ultracalls used by SVM</a><a class="headerlink" href="#ultracalls-used-by-svm" title="Link to this heading">¶</a></h3>
<section id="uv-share-page">
<h4>UV_SHARE_PAGE<a class="headerlink" href="#uv-share-page" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Share a set of guest physical pages with the Hypervisor.</p>
</div></blockquote>
<section id="id29">
<h5>Syntax<a class="headerlink" href="#id29" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_SHARE_PAGE</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">gfn</span><span class="p">,</span><span class="w">   </span><span class="cm">/* guest page frame number */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">num</span><span class="p">)</span><span class="w">   </span><span class="cm">/* number of pages of size PAGE_SIZE */</span>
</pre></div>
</div>
</section>
<section id="id30">
<h5>Return values<a class="headerlink" href="#id30" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
<li><p>U_INVALID     if the VM is not secure.</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">gfn</span></code> is invalid.</p></li>
<li><p>U_P2          if <code class="docutils literal notranslate"><span class="pre">num</span></code> is invalid.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id31">
<h5>Description<a class="headerlink" href="#id31" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Share the <code class="docutils literal notranslate"><span class="pre">num</span></code> pages starting at guest physical frame number <code class="docutils literal notranslate"><span class="pre">gfn</span></code>
with the Hypervisor. Assume page size is PAGE_SIZE bytes. Zero the
pages before returning.</p>
<p>If the address is already backed by a secure page, unmap the page and
back it with an insecure page, with the help of the Hypervisor. If it
is not backed by any page yet, mark the PTE as insecure and back it
with an insecure page when the address is accessed. If it is already
backed by an insecure page, zero the page and return.</p>
</div></blockquote>
</section>
<section id="id32">
<h5>Use cases<a class="headerlink" href="#id32" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>The Hypervisor cannot access the SVM pages since they are backed by
secure pages. Hence an SVM must explicitly request Ultravisor for
pages it can share with Hypervisor.</p></li>
<li><p>Shared pages are needed to support virtio and Virtual Processor Area
(VPA) in SVMs.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-unshare-page">
<h4>UV_UNSHARE_PAGE<a class="headerlink" href="#uv-unshare-page" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Restore a shared SVM page to its initial state.</p>
</div></blockquote>
<section id="id33">
<h5>Syntax<a class="headerlink" href="#id33" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_UNSHARE_PAGE</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">gfn</span><span class="p">,</span><span class="w">   </span><span class="cm">/* guest page frame number */</span>
<span class="w">        </span><span class="n">uint73</span><span class="w"> </span><span class="n">num</span><span class="p">)</span><span class="w">     </span><span class="cm">/* number of pages of size PAGE_SIZE*/</span>
</pre></div>
</div>
</section>
<section id="id34">
<h5>Return values<a class="headerlink" href="#id34" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
<li><p>U_INVALID     if VM is not secure.</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">gfn</span></code> is invalid.</p></li>
<li><p>U_P2          if <code class="docutils literal notranslate"><span class="pre">num</span></code> is invalid.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id35">
<h5>Description<a class="headerlink" href="#id35" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Stop sharing <code class="docutils literal notranslate"><span class="pre">num</span></code> pages starting at <code class="docutils literal notranslate"><span class="pre">gfn</span></code> with the Hypervisor.
Assume that the page size is PAGE_SIZE. Zero the pages before
returning.</p>
<p>If the address is already backed by an insecure page, unmap the page
and back it with a secure page. Inform the Hypervisor to release
reference to its shared page. If the address is not backed by a page
yet, mark the PTE as secure and back it with a secure page when that
address is accessed. If it is already backed by an secure page zero
the page and return.</p>
</div></blockquote>
</section>
<section id="id36">
<h5>Use cases<a class="headerlink" href="#id36" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>The SVM may decide to unshare a page from the Hypervisor.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-unshare-all-pages">
<h4>UV_UNSHARE_ALL_PAGES<a class="headerlink" href="#uv-unshare-all-pages" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Unshare all pages the SVM has shared with Hypervisor.</p>
</div></blockquote>
<section id="id37">
<h5>Syntax<a class="headerlink" href="#id37" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_UNSHARE_ALL_PAGES</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id38">
<h5>Return values<a class="headerlink" href="#id38" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success.</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
<li><p>U_INVAL       if VM is not secure.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id39">
<h5>Description<a class="headerlink" href="#id39" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Unshare all shared pages from the Hypervisor. All unshared pages are
zeroed on return. Only pages explicitly shared by the SVM with the
Hypervisor (using UV_SHARE_PAGE ultracall) are unshared. Ultravisor
may internally share some pages with the Hypervisor without explicit
request from the SVM.  These pages will not be unshared by this
ultracall.</p>
</div></blockquote>
</section>
<section id="id40">
<h5>Use cases<a class="headerlink" href="#id40" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>This call is needed when <code class="docutils literal notranslate"><span class="pre">kexec</span></code> is used to boot a different
kernel. It may also be needed during SVM reset.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="uv-esm">
<h4>UV_ESM<a class="headerlink" href="#uv-esm" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Secure the virtual machine (<em>enter secure mode</em>).</p>
</div></blockquote>
<section id="id41">
<h5>Syntax<a class="headerlink" href="#id41" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ultracall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">UV_ESM</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">esm_blob_addr</span><span class="p">,</span><span class="w"> </span><span class="cm">/* location of the ESM blob */</span>
<span class="w">        </span><span class="n">unint64_t</span><span class="w"> </span><span class="n">fdt</span><span class="p">)</span><span class="w">          </span><span class="cm">/* Flattened device tree */</span>
</pre></div>
</div>
</section>
<section id="id42">
<h5>Return values<a class="headerlink" href="#id42" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>U_SUCCESS     on success (including if VM is already secure).</p></li>
<li><p>U_FUNCTION    if functionality is not supported.</p></li>
<li><p>U_INVALID     if VM is not secure.</p></li>
<li><p>U_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">esm_blob_addr</span></code> is invalid.</p></li>
<li><p>U_P2          if <code class="docutils literal notranslate"><span class="pre">fdt</span></code> is invalid.</p></li>
<li><p>U_PERMISSION  if any integrity checks fail.</p></li>
<li><p>U_RETRY       insufficient memory to create SVM.</p></li>
<li><p>U_NO_KEY      symmetric key unavailable.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id43">
<h5>Description<a class="headerlink" href="#id43" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Secure the virtual machine. On successful completion, return
control to the virtual machine at the address specified in the
ESM blob.</p>
</div></blockquote>
</section>
<section id="id44">
<h5>Use cases<a class="headerlink" href="#id44" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>A normal virtual machine can choose to switch to a secure mode.</p></li>
</ol>
</div></blockquote>
</section>
</section>
</section>
</section>
<section id="hypervisor-calls-api">
<h2><a class="toc-backref" href="#id73" role="doc-backlink">Hypervisor Calls API</a><a class="headerlink" href="#hypervisor-calls-api" title="Link to this heading">¶</a></h2>
<blockquote>
<div><p>This document describes the Hypervisor calls (hypercalls) that are
needed to support the Ultravisor. Hypercalls are services provided by
the Hypervisor to virtual machines and Ultravisor.</p>
<p>Register usage for these hypercalls is identical to that of the other
hypercalls defined in the Power Architecture Platform Reference (PAPR)
document.  i.e on input, register R3 identifies the specific service
that is being requested and registers R4 through R11 contain
additional parameters to the hypercall, if any. On output, register
R3 contains the return value and registers R4 through R9 contain any
other output values from the hypercall.</p>
<p>This document only covers hypercalls currently implemented/planned
for Ultravisor usage but others can be added here when it makes sense.</p>
<p>The full specification for all hypercalls/ultracalls will eventually
be made available in the public/OpenPower version of the PAPR
specification.</p>
</div></blockquote>
<section id="hypervisor-calls-to-support-ultravisor">
<h3><a class="toc-backref" href="#id74" role="doc-backlink">Hypervisor calls to support Ultravisor</a><a class="headerlink" href="#hypervisor-calls-to-support-ultravisor" title="Link to this heading">¶</a></h3>
<blockquote>
<div><p>Following are the set of hypercalls needed to support Ultravisor.</p>
</div></blockquote>
<section id="h-svm-init-start">
<h4>H_SVM_INIT_START<a class="headerlink" href="#h-svm-init-start" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Begin the process of converting a normal virtual machine into an SVM.</p>
</div></blockquote>
<section id="id45">
<h5>Syntax<a class="headerlink" href="#id45" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">hypercall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">H_SVM_INIT_START</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id46">
<h5>Return values<a class="headerlink" href="#id46" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>H_SUCCESS      on success.</p></li>
<li><p>H_STATE        if the VM is not in a position to switch to secure.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id47">
<h5>Description<a class="headerlink" href="#id47" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Initiate the process of securing a virtual machine. This involves
coordinating with the Ultravisor, using ultracalls, to allocate
resources in the Ultravisor for the new SVM, transferring the VM’s
pages from normal to secure memory etc. When the process is
completed, Ultravisor issues the H_SVM_INIT_DONE hypercall.</p>
</div></blockquote>
</section>
<section id="id48">
<h5>Use cases<a class="headerlink" href="#id48" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>Ultravisor uses this hypercall to inform Hypervisor that a VM
has initiated the process of switching to secure mode.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="h-svm-init-done">
<h4>H_SVM_INIT_DONE<a class="headerlink" href="#h-svm-init-done" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Complete the process of securing an SVM.</p>
</div></blockquote>
<section id="id49">
<h5>Syntax<a class="headerlink" href="#id49" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">hypercall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">H_SVM_INIT_DONE</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id50">
<h5>Return values<a class="headerlink" href="#id50" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>H_SUCCESS             on success.</p></li>
<li><dl class="simple">
<dt>H_UNSUPPORTED         if called from the wrong context (e.g.</dt><dd><p>from an SVM or before an H_SVM_INIT_START
hypercall).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>H_STATE               if the hypervisor could not successfully</dt><dd><p>transition the VM to Secure VM.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id51">
<h5>Description<a class="headerlink" href="#id51" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Complete the process of securing a virtual machine. This call must
be made after a prior call to <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_START</span></code> hypercall.</p>
</div></blockquote>
</section>
<section id="id52">
<h5>Use cases<a class="headerlink" href="#id52" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>On successfully securing a virtual machine, the Ultravisor informs
Hypervisor about it. Hypervisor can use this call to finish setting
up its internal state for this virtual machine.</p>
</div></blockquote>
</section>
</section>
<section id="h-svm-init-abort">
<h4>H_SVM_INIT_ABORT<a class="headerlink" href="#h-svm-init-abort" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Abort the process of securing an SVM.</p>
</div></blockquote>
<section id="id53">
<h5>Syntax<a class="headerlink" href="#id53" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">hypercall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">H_SVM_INIT_ABORT</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id54">
<h5>Return values<a class="headerlink" href="#id54" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>H_PARAMETER           on successfully cleaning up the state,</dt><dd><p>Hypervisor will return this value to the
<strong>guest</strong>, to indicate that the underlying
UV_ESM ultracall failed.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>H_STATE               if called after a VM has gone secure (i.e</dt><dd><p>H_SVM_INIT_DONE hypercall was successful).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>H_UNSUPPORTED         if called from a wrong context (e.g. from a</dt><dd><p>normal VM).</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id55">
<h5>Description<a class="headerlink" href="#id55" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Abort the process of securing a virtual machine. This call must
be made after a prior call to <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_START</span></code> hypercall and
before a call to <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_DONE</span></code>.</p>
<p>On entry into this hypercall the non-volatile GPRs and FPRs are
expected to contain the values they had at the time the VM issued
the UV_ESM ultracall. Further <code class="docutils literal notranslate"><span class="pre">SRR0</span></code> is expected to contain the
address of the instruction after the <code class="docutils literal notranslate"><span class="pre">UV_ESM</span></code> ultracall and <code class="docutils literal notranslate"><span class="pre">SRR1</span></code>
the MSR value with which to return to the VM.</p>
<p>This hypercall will cleanup any partial state that was established for
the VM since the prior <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_START</span></code> hypercall, including paging
out pages that were paged-into secure memory, and issue the
<code class="docutils literal notranslate"><span class="pre">UV_SVM_TERMINATE</span></code> ultracall to terminate the VM.</p>
<p>After the partial state is cleaned up, control returns to the VM
(<strong>not Ultravisor</strong>), at the address specified in <code class="docutils literal notranslate"><span class="pre">SRR0</span></code> with the
MSR values set to the value in <code class="docutils literal notranslate"><span class="pre">SRR1</span></code>.</p>
</div></blockquote>
</section>
<section id="id56">
<h5>Use cases<a class="headerlink" href="#id56" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>If after a successful call to <code class="docutils literal notranslate"><span class="pre">H_SVM_INIT_START</span></code>, the Ultravisor
encounters an error while securing a virtual machine, either due
to lack of resources or because the VM’s security information could
not be validated, Ultravisor informs the Hypervisor about it.
Hypervisor should use this call to clean up any internal state for
this virtual machine and return to the VM.</p>
</div></blockquote>
</section>
</section>
<section id="h-svm-page-in">
<h4>H_SVM_PAGE_IN<a class="headerlink" href="#h-svm-page-in" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Move the contents of a page from normal memory to secure memory.</p>
</div></blockquote>
<section id="id57">
<h5>Syntax<a class="headerlink" href="#id57" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">hypercall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">H_SVM_PAGE_IN</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">guest_pa</span><span class="p">,</span><span class="w">      </span><span class="cm">/* guest-physical-address */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w">         </span><span class="cm">/* flags */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w">         </span><span class="cm">/* page size order */</span>
</pre></div>
</div>
</section>
<section id="id58">
<h5>Return values<a class="headerlink" href="#id58" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>H_SUCCESS     on success.</p></li>
<li><p>H_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> is invalid.</p></li>
<li><p>H_P2          if <code class="docutils literal notranslate"><span class="pre">flags</span></code> is invalid.</p></li>
<li><p>H_P3          if <code class="docutils literal notranslate"><span class="pre">order</span></code> of page is invalid.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id59">
<h5>Description<a class="headerlink" href="#id59" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Retrieve the content of the page, belonging to the VM at the specified
guest physical address.</p>
<p>Only valid value(s) in <code class="docutils literal notranslate"><span class="pre">flags</span></code> are:</p>
<blockquote>
<div><ul class="simple">
<li><p>H_PAGE_IN_SHARED which indicates that the page is to be shared
with the Ultravisor.</p></li>
<li><p>H_PAGE_IN_NONSHARED indicates that the UV is not anymore
interested in the page. Applicable if the page is a shared page.</p></li>
</ul>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">order</span></code> parameter must correspond to the configured page size.</p>
</div></blockquote>
</section>
<section id="id60">
<h5>Use cases<a class="headerlink" href="#id60" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>When a normal VM becomes a secure VM (using the UV_ESM ultracall),
the Ultravisor uses this hypercall to move contents of each page of
the VM from normal memory to secure memory.</p></li>
<li><p>Ultravisor uses this hypercall to ask Hypervisor to provide a page
in normal memory that can be shared between the SVM and Hypervisor.</p></li>
<li><p>Ultravisor uses this hypercall to page-in a paged-out page. This
can happen when the SVM touches a paged-out page.</p></li>
<li><p>If SVM wants to disable sharing of pages with Hypervisor, it can
inform Ultravisor to do so. Ultravisor will then use this hypercall
and inform Hypervisor that it has released access to the normal
page.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="h-svm-page-out">
<h4>H_SVM_PAGE_OUT<a class="headerlink" href="#h-svm-page-out" title="Link to this heading">¶</a></h4>
<blockquote>
<div><p>Move the contents of the page to normal memory.</p>
</div></blockquote>
<section id="id61">
<h5>Syntax<a class="headerlink" href="#id61" title="Link to this heading">¶</a></h5>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">hypercall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">H_SVM_PAGE_OUT</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">guest_pa</span><span class="p">,</span><span class="w">      </span><span class="cm">/* guest-physical-address */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w">         </span><span class="cm">/* flags (currently none) */</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w">         </span><span class="cm">/* page size order */</span>
</pre></div>
</div>
</section>
<section id="id62">
<h5>Return values<a class="headerlink" href="#id62" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>One of the following values:</p>
<blockquote>
<div><ul class="simple">
<li><p>H_SUCCESS     on success.</p></li>
<li><p>H_PARAMETER   if <code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> is invalid.</p></li>
<li><p>H_P2          if <code class="docutils literal notranslate"><span class="pre">flags</span></code> is invalid.</p></li>
<li><p>H_P3          if <code class="docutils literal notranslate"><span class="pre">order</span></code> is invalid.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</section>
<section id="id63">
<h5>Description<a class="headerlink" href="#id63" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>Move the contents of the page identified by <code class="docutils literal notranslate"><span class="pre">guest_pa</span></code> to normal
memory.</p>
<p>Currently <code class="docutils literal notranslate"><span class="pre">flags</span></code> is unused and must be set to 0. The <code class="docutils literal notranslate"><span class="pre">order</span></code>
parameter must correspond to the configured page size.</p>
</div></blockquote>
</section>
<section id="id64">
<h5>Use cases<a class="headerlink" href="#id64" title="Link to this heading">¶</a></h5>
<blockquote>
<div><ol class="arabic simple">
<li><p>If Ultravisor is running low on secure pages, it can move the
contents of some secure pages, into normal pages using this
hypercall. The content will be encrypted.</p></li>
</ol>
</div></blockquote>
</section>
</section>
</section>
</section>
<section id="references">
<h2><a class="toc-backref" href="#id75" role="doc-backlink">References</a><a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://developer.ibm.com/articles/l-support-protected-computing/">Supporting Protected Computing on IBM Power Architecture</a></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;The kernel development community.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/arch/powerpc/ultravisor.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>