
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>1.28. Image Cropping, Insertion and Scaling -- the CROP API &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="1.29. Streaming Parameters" href="streaming-par.html" />
    <link rel="prev" title="1.27.5. Examples" href="selection-api-examples.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.8.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/development-process.html">A guide to the Kernel Development Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../driver-api/index.html">Driver implementer's API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../subsystem-apis.html">Kernel subsystem documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../locking/index.html">Locking in the kernel</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/license-rules.html">Linux kernel licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/testing-overview.html">Kernel Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livepatch/index.html">Kernel Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rust/index.html">Rust</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">The Linux kernel user's and administrator's guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kbuild/index.html">The kernel build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/index.html">User-space tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">The Linux kernel user-space API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../no_new_privs.html">No New Privileges Flag</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../seccomp_filter.html">Seccomp BPF (SECure COMPuting with filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../landlock.html">Landlock: unprivileged access control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../unshare.html">unshare system call</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../spec_ctrl.html">Speculation Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../accelerators/ocxl.html">OpenCAPI (Open Coherent Accelerator Processor Interface)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dma-buf-alloc-exchange.html">Exchanging pixel buffers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ebpf/index.html">eBPF Userspace API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ELF.html">Linux-specific ELF idiosyncrasies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ioctl/index.html">IOCTLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../iommu.html">IOMMU Userspace API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../iommufd.html">IOMMUFD</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Linux Media Infrastructure userspace API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="v4l2.html">Part I - Video for Linux API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dvb/dvbapi.html">Part II - Digital TV API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rc/remote_controllers.html">Part III - Remote Controller API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mediactl/media-controller.html">Part IV - Media Controller API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cec/cec-api.html">Part V - Consumer Electronics Control API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gen-errors.html">Generic Error Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fdl-appendix.html">GNU Free Documentation License</a></li>
<li class="toctree-l3"><a class="reference internal" href="../drivers/index.html">Video4Linux (V4L)  driver-specific documentation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../netlink/index.html">Netlink Handbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sysfs-platform_profile.html">Platform Profile Selection (e.g. /sys/firmware/acpi/platform_profile)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vduse.html">VDUSE - &quot;vDPA Device in Userspace&quot;</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../futex2.html">futex2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../lsm.html">Linux Security Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tee.html">TEE (Trusted Execution Environment) Userspace API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../isapnp.html">ISA Plug &amp; Play support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dcdbas.html">Dell Systems Management Base Driver</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arch/index.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../RAS/ras.html">Reliability, Availability and Serviceability features</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/userspace-api/media/v4l/crop.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="image-cropping-insertion-and-scaling-the-crop-api">
<span id="crop"></span><h1><span class="section-number">1.28. </span>Image Cropping, Insertion and Scaling -- the CROP API<a class="headerlink" href="#image-cropping-insertion-and-scaling-the-crop-api" title="Permalink to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The CROP API is mostly superseded by the newer <a class="reference internal" href="selection-api.html#selection-api"><span class="std std-ref">SELECTION API</span></a>. The new API should be preferred in most cases,
with the exception of pixel aspect ratio detection, which is
implemented by <a class="reference internal" href="vidioc-cropcap.html#vidioc-cropcap"><span class="std std-ref">VIDIOC_CROPCAP</span></a> and has no
equivalent in the SELECTION API. See <a class="reference internal" href="selection-api-vs-crop-api.html#selection-vs-crop"><span class="std std-ref">Comparison with old cropping API</span></a> for a
comparison of the two APIs.</p>
</div>
<p>Some video capture devices can sample a subsection of the picture and
shrink or enlarge it to an image of arbitrary size. We call these
abilities cropping and scaling. Some video output devices can scale an
image up or down and insert it at an arbitrary scan line and horizontal
offset into a video signal.</p>
<p>Applications can use the following API to select an area in the video
signal, query the default area and the hardware limits.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Despite their name, the <a class="reference internal" href="vidioc-cropcap.html#vidioc-cropcap"><span class="std std-ref">VIDIOC_CROPCAP</span></a>,
<a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_G_CROP</span></a> and <a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_S_CROP</span></a> ioctls apply to input as well as output devices.</p>
</div>
<p>Scaling requires a source and a target. On a video capture or overlay
device the source is the video signal, and the cropping ioctls determine
the area actually sampled. The target are images read by the application
or overlaid onto the graphics screen. Their size (and position for an
overlay) is negotiated with the <a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_G_FMT</span></a>
and <a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_S_FMT</span></a> ioctls.</p>
<p>On a video output device the source are the images passed in by the
application, and their size is again negotiated with the
<a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_G_FMT</span></a> and <a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_S_FMT</span></a>
ioctls, or may be encoded in a compressed video stream. The target is
the video signal, and the cropping ioctls determine the area where the
images are inserted.</p>
<p>Source and target rectangles are defined even if the device does not
support scaling or the <a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_G_CROP</span></a> and
<a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_S_CROP</span></a> ioctls. Their size (and position
where applicable) will be fixed in this case.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All capture and output devices that support the CROP or SELECTION
API will also support the <a class="reference internal" href="vidioc-cropcap.html#vidioc-cropcap"><span class="std std-ref">VIDIOC_CROPCAP</span></a>
ioctl.</p>
</div>
<section id="cropping-structures">
<h2><span class="section-number">1.28.1. </span>Cropping Structures<a class="headerlink" href="#cropping-structures" title="Permalink to this heading">¶</a></h2>
<figure class="align-center" id="id1">
<img alt="crop.svg" src="../../../_images/crop.svg" /><figcaption>
<p><span class="caption-text">Image Cropping, Insertion and Scaling</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
<div class="legend">
<p>The cropping, insertion and scaling process</p>
</div>
</figcaption>
</figure>
<p>For capture devices the coordinates of the top left corner, width and
height of the area which can be sampled is given by the <code class="docutils literal notranslate"><span class="pre">bounds</span></code>
substructure of the struct <code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_cropcap</span></code> returned
by the <a class="reference internal" href="vidioc-cropcap.html#vidioc-cropcap"><span class="std std-ref">VIDIOC_CROPCAP</span></a> ioctl. To support a wide
range of hardware this specification does not define an origin or units.
However by convention drivers should horizontally count unscaled samples
relative to 0H (the leading edge of the horizontal sync pulse, see
<a class="reference internal" href="dev-raw-vbi.html#vbi-hsync"><span class="std std-ref">Figure 4.1. Line synchronization</span></a>). Vertically ITU-R line numbers of the first field
(see ITU R-525 line numbering for <a class="reference internal" href="dev-raw-vbi.html#vbi-525"><span class="std std-ref">525 lines</span></a> and for
<a class="reference internal" href="dev-raw-vbi.html#vbi-625"><span class="std std-ref">625 lines</span></a>), multiplied by two if the driver
can capture both fields.</p>
<p>The top left corner, width and height of the source rectangle, that is
the area actually sampled, is given by struct
<code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_crop</span></code> using the same coordinate system as
struct <code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_cropcap</span></code>. Applications can use the
<a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_G_CROP</span></a> and <a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_S_CROP</span></a>
ioctls to get and set this rectangle. It must lie completely within the
capture boundaries and the driver may further adjust the requested size
and/or position according to hardware limitations.</p>
<p>Each capture device has a default source rectangle, given by the
<code class="docutils literal notranslate"><span class="pre">defrect</span></code> substructure of struct
<code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_cropcap</span></code>. The center of this rectangle
shall align with the center of the active picture area of the video
signal, and cover what the driver writer considers the complete picture.
Drivers shall reset the source rectangle to the default when the driver
is first loaded, but not later.</p>
<p>For output devices these structures and ioctls are used accordingly,
defining the <em>target</em> rectangle where the images will be inserted into
the video signal.</p>
</section>
<section id="scaling-adjustments">
<h2><span class="section-number">1.28.2. </span>Scaling Adjustments<a class="headerlink" href="#scaling-adjustments" title="Permalink to this heading">¶</a></h2>
<p>Video hardware can have various cropping, insertion and scaling
limitations. It may only scale up or down, support only discrete scaling
factors, or have different scaling abilities in horizontal and vertical
direction. Also it may not support scaling at all. At the same time the
struct <code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_crop</span></code> rectangle may have to be aligned,
and both the source and target rectangles may have arbitrary upper and
lower size limits. In particular the maximum <code class="docutils literal notranslate"><span class="pre">width</span></code> and <code class="docutils literal notranslate"><span class="pre">height</span></code> in
struct <code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_crop</span></code> may be smaller than the struct
<code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_cropcap</span></code>. <code class="docutils literal notranslate"><span class="pre">bounds</span></code> area. Therefore, as
usual, drivers are expected to adjust the requested parameters and
return the actual values selected.</p>
<p>Applications can change the source or the target rectangle first, as
they may prefer a particular image size or a certain area in the video
signal. If the driver has to adjust both to satisfy hardware
limitations, the last requested rectangle shall take priority, and the
driver should preferably adjust the opposite one. The
<a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_TRY_FMT</span></a> ioctl however shall not change
the driver state and therefore only adjust the requested rectangle.</p>
<p>Suppose scaling on a video capture device is restricted to a factor 1:1
or 2:1 in either direction and the target image size must be a multiple
of 16 × 16 pixels. The source cropping rectangle is set to defaults,
which are also the upper limit in this example, of 640 × 400 pixels at
offset 0, 0. An application requests an image size of 300 × 225 pixels,
assuming video will be scaled down from the &quot;full picture&quot; accordingly.
The driver sets the image size to the closest possible values 304 × 224,
then chooses the cropping rectangle closest to the requested size, that
is 608 × 224 (224 × 2:1 would exceed the limit 400). The offset 0, 0 is
still valid, thus unmodified. Given the default cropping rectangle
reported by <a class="reference internal" href="vidioc-cropcap.html#vidioc-cropcap"><span class="std std-ref">VIDIOC_CROPCAP</span></a> the application can
easily propose another offset to center the cropping rectangle.</p>
<p>Now the application may insist on covering an area using a picture
aspect ratio closer to the original request, so it asks for a cropping
rectangle of 608 × 456 pixels. The present scaling factors limit
cropping to 640 × 384, so the driver returns the cropping size 608 × 384
and adjusts the image size to closest possible 304 × 192.</p>
</section>
<section id="examples">
<h2><span class="section-number">1.28.3. </span>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h2>
<p>Source and target rectangles shall remain unchanged across closing and
reopening a device, such that piping data into or out of a device will
work without special preparations. More advanced applications should
ensure the parameters are suitable before starting I/O.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On the next two examples, a video capture device is assumed;
change <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_TYPE_VIDEO_CAPTURE</span></code> for other types of device.</p>
</div>
</section>
<section id="example-resetting-the-cropping-parameters">
<h2><span class="section-number">1.28.4. </span>Example: Resetting the cropping parameters<a class="headerlink" href="#example-resetting-the-cropping-parameters" title="Permalink to this heading">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_cropcap</span><span class="w"> </span><span class="n">cropcap</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_crop</span><span class="w"> </span><span class="n">crop</span><span class="p">;</span>

<span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">cropcap</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">cropcap</span><span class="p">));</span>
<span class="n">cropcap</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ioctl</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">VIDIOC_CROPCAP</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cropcap</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;VIDIOC_CROPCAP&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">crop</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">crop</span><span class="p">));</span>
<span class="n">crop</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">;</span>

<span class="cm">/* Ignore if cropping is not supported (EINVAL). */</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ioctl</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">VIDIOC_S_CROP</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">crop</span><span class="p">)</span>
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">errno</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;VIDIOC_S_CROP&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="example-simple-downscaling">
<h2><span class="section-number">1.28.5. </span>Example: Simple downscaling<a class="headerlink" href="#example-simple-downscaling" title="Permalink to this heading">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_cropcap</span><span class="w"> </span><span class="n">cropcap</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_format</span><span class="w"> </span><span class="n">format</span><span class="p">;</span>

<span class="n">reset_cropping_parameters</span><span class="w"> </span><span class="p">();</span>

<span class="cm">/* Scale down to 1/4 size of full picture. */</span>

<span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">format</span><span class="p">));</span><span class="w"> </span><span class="cm">/* defaults */</span>

<span class="n">format</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ioctl</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">VIDIOC_S_FMT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">format</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;VIDIOC_S_FORMAT&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We could check the actual image size now, the actual scaling factor</span>
<span class="cm">   or if the driver can scale at all. */</span>
</pre></div>
</div>
</section>
<section id="example-selecting-an-output-area">
<h2><span class="section-number">1.28.6. </span>Example: Selecting an output area<a class="headerlink" href="#example-selecting-an-output-area" title="Permalink to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example assumes an output device.</p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_cropcap</span><span class="w"> </span><span class="n">cropcap</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_crop</span><span class="w"> </span><span class="n">crop</span><span class="p">;</span>

<span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">cropcap</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">cropcap</span><span class="p">));</span>
<span class="n">cropcap</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ioctl</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">VIDIOC_CROPCAP</span><span class="p">;,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cropcap</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;VIDIOC_CROPCAP&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">crop</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">crop</span><span class="p">));</span>

<span class="n">crop</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">;</span>

<span class="cm">/* Scale the width and height to 50 % of their original size</span>
<span class="cm">   and center the output. */</span>

<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">left</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">top</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="cm">/* Ignore if cropping is not supported (EINVAL). */</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ioctl</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">VIDIOC_S_CROP</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">crop</span><span class="p">)</span>
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">errno</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;VIDIOC_S_CROP&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="example-current-scaling-factor-and-pixel-aspect">
<h2><span class="section-number">1.28.7. </span>Example: Current scaling factor and pixel aspect<a class="headerlink" href="#example-current-scaling-factor-and-pixel-aspect" title="Permalink to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example assumes a video capture device.</p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_cropcap</span><span class="w"> </span><span class="n">cropcap</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_crop</span><span class="w"> </span><span class="n">crop</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">v4l2_format</span><span class="w"> </span><span class="n">format</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">hscale</span><span class="p">,</span><span class="w"> </span><span class="n">vscale</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">aspect</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">dwidth</span><span class="p">,</span><span class="w"> </span><span class="n">dheight</span><span class="p">;</span>

<span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">cropcap</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">cropcap</span><span class="p">));</span>
<span class="n">cropcap</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ioctl</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">VIDIOC_CROPCAP</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cropcap</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;VIDIOC_CROPCAP&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">crop</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">crop</span><span class="p">));</span>
<span class="n">crop</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ioctl</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">VIDIOC_G_CROP</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">crop</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">errno</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">perror</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;VIDIOC_G_CROP&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* Cropping not supported. */</span>
<span class="w">    </span><span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">format</span><span class="p">));</span>
<span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ioctl</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">VIDIOC_G_FMT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">format</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;VIDIOC_G_FMT&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The scaling applied by the driver. */</span>

<span class="n">hscale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="n">vscale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

<span class="n">aspect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cropcap</span><span class="p">.</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span><span class="w"> </span><span class="o">/</span>
<span class="w">     </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">cropcap</span><span class="p">.</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span><span class="p">;</span>
<span class="n">aspect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aspect</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hscale</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">vscale</span><span class="p">;</span>

<span class="cm">/* Devices following ITU-R BT.601 do not capture</span>
<span class="cm">   square pixels. For playback on a computer monitor</span>
<span class="cm">   we should scale the images to this size. */</span>

<span class="n">dwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">aspect</span><span class="p">;</span>
<span class="n">dheight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/userspace-api/media/v4l/crop.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>