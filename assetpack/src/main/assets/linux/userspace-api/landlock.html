<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Landlock: unprivileged access control &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=a152c8ac" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Linux Security Modules" href="lsm.html" />
    <link rel="prev" title="Seccomp BPF (SECure COMPuting with filters)" href="seccomp_filter.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.14.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Userspace API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#system-calls">System calls</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#security-related-interfaces">Security-related interfaces</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="no_new_privs.html">No New Privileges Flag</a></li>
<li class="toctree-l3"><a class="reference internal" href="seccomp_filter.html">Seccomp BPF (SECure COMPuting with filters)</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Landlock: unprivileged access control</a></li>
<li class="toctree-l3"><a class="reference internal" href="lsm.html">Linux Security Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="mfd_noexec.html">Introduction of non-executable mfd</a></li>
<li class="toctree-l3"><a class="reference internal" href="spec_ctrl.html">Speculation Control</a></li>
<li class="toctree-l3"><a class="reference internal" href="tee.html">TEE (Trusted Execution Environment) Userspace API</a></li>
<li class="toctree-l3"><a class="reference internal" href="check_exec.html">Executability check</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#devices-and-i-o">Devices and I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#everything-else">Everything else</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/userspace-api/landlock.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="landlock-unprivileged-access-control">
<h1>Landlock: unprivileged access control<a class="headerlink" href="#landlock-unprivileged-access-control" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Mickaël Salaün</p>
</dd>
<dt class="field-even">Date<span class="colon">:</span></dt>
<dd class="field-even"><p>January 2025</p>
</dd>
</dl>
<p>The goal of Landlock is to enable restriction of ambient rights (e.g. global
filesystem or network access) for a set of processes.  Because Landlock
is a stackable LSM, it makes it possible to create safe security sandboxes as
new security layers in addition to the existing system-wide access-controls.
This kind of sandbox is expected to help mitigate the security impact of bugs or
unexpected/malicious behaviors in user space applications.  Landlock empowers
any process, including unprivileged ones, to securely restrict themselves.</p>
<p>We can quickly make sure that Landlock is enabled in the running system by
looking for “landlock: Up and running” in kernel logs (as root):
<code class="docutils literal notranslate"><span class="pre">dmesg</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">landlock</span> <span class="pre">||</span> <span class="pre">journalctl</span> <span class="pre">-kb</span> <span class="pre">-g</span> <span class="pre">landlock</span></code> .
Developers can also easily check for Landlock support with a
<a class="reference internal" href="#landlock-abi-versions"><span class="std std-ref">related system call</span></a>.
If Landlock is not currently supported, we need to
<a class="reference internal" href="#kernel-support"><span class="std std-ref">configure the kernel appropriately</span></a>.</p>
<section id="landlock-rules">
<h2>Landlock rules<a class="headerlink" href="#landlock-rules" title="Link to this heading">¶</a></h2>
<p>A Landlock rule describes an action on an object which the process intends to
perform.  A set of rules is aggregated in a ruleset, which can then restrict
the thread enforcing it, and its future children.</p>
<p>The two existing types of rules are:</p>
<dl class="simple">
<dt>Filesystem rules</dt><dd><p>For these rules, the object is a file hierarchy,
and the related filesystem actions are defined with
<cite>filesystem access rights</cite>.</p>
</dd>
<dt>Network rules (since ABI v4)</dt><dd><p>For these rules, the object is a TCP port,
and the related actions are defined with <cite>network access rights</cite>.</p>
</dd>
</dl>
<section id="defining-and-enforcing-a-security-policy">
<h3>Defining and enforcing a security policy<a class="headerlink" href="#defining-and-enforcing-a-security-policy" title="Link to this heading">¶</a></h3>
<p>We first need to define the ruleset that will contain our rules.</p>
<p>For this example, the ruleset will contain rules that only allow filesystem
read actions and establish a specific TCP connection. Filesystem write
actions and other TCP actions will be denied.</p>
<p>The ruleset then needs to handle both these kinds of actions.  This is
required for backward and forward compatibility (i.e. the kernel and user
space may not know each other’s supported restrictions), hence the need
to be explicit about the denied-by-default access rights.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">landlock_ruleset_attr</span><span class="w"> </span><span class="n">ruleset_attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">handled_access_fs</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_EXECUTE</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_WRITE_FILE</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_READ_FILE</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_READ_DIR</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_REMOVE_DIR</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_REMOVE_FILE</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_MAKE_CHAR</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_MAKE_DIR</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_MAKE_REG</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_MAKE_SOCK</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_MAKE_FIFO</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_MAKE_BLOCK</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_MAKE_SYM</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_REFER</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_TRUNCATE</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_IOCTL_DEV</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">handled_access_net</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_NET_BIND_TCP</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">scoped</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">LANDLOCK_SCOPE_ABSTRACT_UNIX_SOCKET</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_SCOPE_SIGNAL</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Because we may not know which kernel version an application will be executed
on, it is safer to follow a best-effort security approach.  Indeed, we
should try to protect users as much as possible whatever the kernel they are
using.</p>
<p>To be compatible with older Linux versions, we detect the available Landlock ABI
version, and only use the available subset of access rights:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">abi</span><span class="p">;</span>

<span class="n">abi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">landlock_create_ruleset</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">LANDLOCK_CREATE_RULESET_VERSION</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abi</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Degrades gracefully if Landlock is not handled. */</span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;The running kernel does not enable to use Landlock&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">abi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Removes LANDLOCK_ACCESS_FS_REFER for ABI &lt; 2 */</span>
<span class="w">    </span><span class="n">ruleset_attr</span><span class="p">.</span><span class="n">handled_access_fs</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">LANDLOCK_ACCESS_FS_REFER</span><span class="p">;</span>
<span class="w">    </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">fallthrough</span><span class="p">));</span>
<span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Removes LANDLOCK_ACCESS_FS_TRUNCATE for ABI &lt; 3 */</span>
<span class="w">    </span><span class="n">ruleset_attr</span><span class="p">.</span><span class="n">handled_access_fs</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">LANDLOCK_ACCESS_FS_TRUNCATE</span><span class="p">;</span>
<span class="w">    </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">fallthrough</span><span class="p">));</span>
<span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Removes network support for ABI &lt; 4 */</span>
<span class="w">    </span><span class="n">ruleset_attr</span><span class="p">.</span><span class="n">handled_access_net</span><span class="w"> </span><span class="o">&amp;=</span>
<span class="w">        </span><span class="o">~</span><span class="p">(</span><span class="n">LANDLOCK_ACCESS_NET_BIND_TCP</span><span class="w"> </span><span class="o">|</span>
<span class="w">          </span><span class="n">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span class="p">);</span>
<span class="w">    </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">fallthrough</span><span class="p">));</span>
<span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Removes LANDLOCK_ACCESS_FS_IOCTL_DEV for ABI &lt; 5 */</span>
<span class="w">    </span><span class="n">ruleset_attr</span><span class="p">.</span><span class="n">handled_access_fs</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">LANDLOCK_ACCESS_FS_IOCTL_DEV</span><span class="p">;</span>
<span class="w">    </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">fallthrough</span><span class="p">));</span>
<span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/* Removes LANDLOCK_SCOPE_* for ABI &lt; 6 */</span>
<span class="w">    </span><span class="n">ruleset_attr</span><span class="p">.</span><span class="n">scoped</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">LANDLOCK_SCOPE_ABSTRACT_UNIX_SOCKET</span><span class="w"> </span><span class="o">|</span>
<span class="w">                             </span><span class="n">LANDLOCK_SCOPE_SIGNAL</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This enables the creation of an inclusive ruleset that will contain our rules.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">ruleset_fd</span><span class="p">;</span>

<span class="n">ruleset_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">landlock_create_ruleset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ruleset_attr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ruleset_attr</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ruleset_fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to create a ruleset&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We can now add a new rule to this ruleset thanks to the returned file
descriptor referring to this ruleset.  The rule will only allow reading the
file hierarchy <code class="docutils literal notranslate"><span class="pre">/usr</span></code>.  Without another rule, write actions would then be
denied by the ruleset.  To add <code class="docutils literal notranslate"><span class="pre">/usr</span></code> to the ruleset, we open it with the
<code class="docutils literal notranslate"><span class="pre">O_PATH</span></code> flag and fill the &amp;<a class="reference internal" href="#c.landlock_path_beneath_attr" title="landlock_path_beneath_attr"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">landlock_path_beneath_attr</span></code></a> with this file
descriptor.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">landlock_path_beneath_attr</span><span class="w"> </span><span class="n">path_beneath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">allowed_access</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_EXECUTE</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_READ_FILE</span><span class="w"> </span><span class="o">|</span>
<span class="w">        </span><span class="n">LANDLOCK_ACCESS_FS_READ_DIR</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">path_beneath</span><span class="p">.</span><span class="n">parent_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/usr&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_PATH</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CLOEXEC</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">path_beneath</span><span class="p">.</span><span class="n">parent_fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to open file&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">landlock_add_rule</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">,</span><span class="w"> </span><span class="n">LANDLOCK_RULE_PATH_BENEATH</span><span class="p">,</span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">path_beneath</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="n">close</span><span class="p">(</span><span class="n">path_beneath</span><span class="p">.</span><span class="n">parent_fd</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to update ruleset&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It may also be required to create rules following the same logic as explained
for the ruleset creation, by filtering access rights according to the Landlock
ABI version.  In this example, this is not required because all of the requested
<code class="docutils literal notranslate"><span class="pre">allowed_access</span></code> rights are already available in ABI 1.</p>
<p>For network access-control, we can add a set of rules that allow to use a port
number for a specific action: HTTPS connections.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">landlock_net_port_attr</span><span class="w"> </span><span class="n">net_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">allowed_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">443</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">landlock_add_rule</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">,</span><span class="w"> </span><span class="n">LANDLOCK_RULE_NET_PORT</span><span class="p">,</span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">net_port</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>The next step is to restrict the current thread from gaining more privileges
(e.g. through a SUID binary).  We now have a ruleset with the first rule
allowing read access to <code class="docutils literal notranslate"><span class="pre">/usr</span></code> while denying all other handled accesses for
the filesystem, and a second rule allowing HTTPS connections.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_NO_NEW_PRIVS</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to restrict privileges&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The current thread is now ready to sandbox itself with the ruleset.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">landlock_restrict_self</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to enforce ruleset&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">);</span>
</pre></div>
</div>
<p>If the <code class="docutils literal notranslate"><span class="pre">landlock_restrict_self</span></code> system call succeeds, the current thread is
now restricted and this policy will be enforced on all its subsequently created
children as well.  Once a thread is landlocked, there is no way to remove its
security policy; only adding more restrictions is allowed.  These threads are
now in a new Landlock domain, which is a merger of their parent one (if any)
with the new ruleset.</p>
<p>Full working code can be found in <a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/samples/landlock/sandboxer.c">samples/landlock/sandboxer.c</a>.</p>
</section>
<section id="good-practices">
<h3>Good practices<a class="headerlink" href="#good-practices" title="Link to this heading">¶</a></h3>
<p>It is recommended to set access rights to file hierarchy leaves as much as
possible.  For instance, it is better to be able to have <code class="docutils literal notranslate"><span class="pre">~/doc/</span></code> as a
read-only hierarchy and <code class="docutils literal notranslate"><span class="pre">~/tmp/</span></code> as a read-write hierarchy, compared to
<code class="docutils literal notranslate"><span class="pre">~/</span></code> as a read-only hierarchy and <code class="docutils literal notranslate"><span class="pre">~/tmp/</span></code> as a read-write hierarchy.
Following this good practice leads to self-sufficient hierarchies that do not
depend on their location (i.e. parent directories).  This is particularly
relevant when we want to allow linking or renaming.  Indeed, having consistent
access rights per directory enables changing the location of such directories
without relying on the destination directory access rights (except those that
are required for this operation, see <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_REFER</span></code>
documentation).</p>
<p>Having self-sufficient hierarchies also helps to tighten the required access
rights to the minimal set of data.  This also helps avoid sinkhole directories,
i.e. directories where data can be linked to but not linked from.  However,
this depends on data organization, which might not be controlled by developers.
In this case, granting read-write access to <code class="docutils literal notranslate"><span class="pre">~/tmp/</span></code>, instead of write-only
access, would potentially allow moving <code class="docutils literal notranslate"><span class="pre">~/tmp/</span></code> to a non-readable directory
and still keep the ability to list the content of <code class="docutils literal notranslate"><span class="pre">~/tmp/</span></code>.</p>
</section>
<section id="layers-of-file-path-access-rights">
<h3>Layers of file path access rights<a class="headerlink" href="#layers-of-file-path-access-rights" title="Link to this heading">¶</a></h3>
<p>Each time a thread enforces a ruleset on itself, it updates its Landlock domain
with a new layer of policy.  This complementary policy is stacked with any
other rulesets potentially already restricting this thread.  A sandboxed thread
can then safely add more constraints to itself with a new enforced ruleset.</p>
<p>One policy layer grants access to a file path if at least one of its rules
encountered on the path grants the access.  A sandboxed thread can only access
a file path if all its enforced policy layers grant the access as well as all
the other system access controls (e.g. filesystem DAC, other LSM policies,
etc.).</p>
</section>
<section id="bind-mounts-and-overlayfs">
<h3>Bind mounts and OverlayFS<a class="headerlink" href="#bind-mounts-and-overlayfs" title="Link to this heading">¶</a></h3>
<p>Landlock enables restricting access to file hierarchies, which means that these
access rights can be propagated with bind mounts (cf.
<a class="reference internal" href="../filesystems/sharedsubtree.html"><span class="doc">Shared Subtrees</span></a>) but not with
<a class="reference internal" href="../filesystems/overlayfs.html"><span class="doc">Overlay Filesystem</span></a>.</p>
<p>A bind mount mirrors a source file hierarchy to a destination.  The destination
hierarchy is then composed of the exact same files, on which Landlock rules can
be tied, either via the source or the destination path.  These rules restrict
access when they are encountered on a path, which means that they can restrict
access to multiple file hierarchies at the same time, whether these hierarchies
are the result of bind mounts or not.</p>
<p>An OverlayFS mount point consists of upper and lower layers.  These layers are
combined in a merge directory, and that merged directory becomes available at
the mount point.  This merge hierarchy may include files from the upper and
lower layers, but modifications performed on the merge hierarchy only reflect
on the upper layer.  From a Landlock policy point of view, all OverlayFS layers
and merge hierarchies are standalone and each contains their own set of files
and directories, which is different from bind mounts.  A policy restricting an
OverlayFS layer will not restrict the resulted merged hierarchy, and vice versa.
Landlock users should then only think about file hierarchies they want to allow
access to, regardless of the underlying filesystem.</p>
</section>
<section id="inheritance">
<h3>Inheritance<a class="headerlink" href="#inheritance" title="Link to this heading">¶</a></h3>
<p>Every new thread resulting from a <em class="manpage">clone(2)</em> inherits Landlock domain
restrictions from its parent.  This is similar to seccomp inheritance (cf.
<a class="reference internal" href="seccomp_filter.html"><span class="doc">Seccomp BPF (SECure COMPuting with filters)</span></a>) or any other LSM dealing with
task’s <em class="manpage">credentials(7)</em>.  For instance, one process’s thread may apply
Landlock rules to itself, but they will not be automatically applied to other
sibling threads (unlike POSIX thread credential changes, cf.
<em class="manpage">nptl(7)</em>).</p>
<p>When a thread sandboxes itself, we have the guarantee that the related security
policy will stay enforced on all this thread’s descendants.  This allows
creating standalone and modular security policies per application, which will
automatically be composed between themselves according to their runtime parent
policies.</p>
</section>
<section id="ptrace-restrictions">
<h3>Ptrace restrictions<a class="headerlink" href="#ptrace-restrictions" title="Link to this heading">¶</a></h3>
<p>A sandboxed process has less privileges than a non-sandboxed process and must
then be subject to additional restrictions when manipulating another process.
To be allowed to use <em class="manpage">ptrace(2)</em> and related syscalls on a target
process, a sandboxed process should have a superset of the target process’s
access rights, which means the tracee must be in a sub-domain of the tracer.</p>
</section>
<section id="ipc-scoping">
<h3>IPC scoping<a class="headerlink" href="#ipc-scoping" title="Link to this heading">¶</a></h3>
<p>Similar to the implicit <a class="reference internal" href="#ptrace-restrictions">Ptrace restrictions</a>, we may want to further restrict
interactions between sandboxes. Each Landlock domain can be explicitly scoped
for a set of actions by specifying it on a ruleset.  For example, if a
sandboxed process should not be able to <em class="manpage">connect(2)</em> to a
non-sandboxed process through abstract <em class="manpage">unix(7)</em> sockets, we can
specify such a restriction with <code class="docutils literal notranslate"><span class="pre">LANDLOCK_SCOPE_ABSTRACT_UNIX_SOCKET</span></code>.
Moreover, if a sandboxed process should not be able to send a signal to a
non-sandboxed process, we can specify this restriction with
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_SCOPE_SIGNAL</span></code>.</p>
<p>A sandboxed process can connect to a non-sandboxed process when its domain is
not scoped. If a process’s domain is scoped, it can only connect to sockets
created by processes in the same scope.
Moreover, if a process is scoped to send signal to a non-scoped process, it can
only send signals to processes in the same scope.</p>
<p>A connected datagram socket behaves like a stream socket when its domain is
scoped, meaning if the domain is scoped after the socket is connected, it can
still <em class="manpage">send(2)</em> data just like a stream socket.  However, in the same
scenario, a non-connected datagram socket cannot send data (with
<em class="manpage">sendto(2)</em>) outside its scope.</p>
<p>A process with a scoped domain can inherit a socket created by a non-scoped
process. The process cannot connect to this socket since it has a scoped
domain.</p>
<p>IPC scoping does not support exceptions, so if a domain is scoped, no rules can
be added to allow access to resources or processes outside of the scope.</p>
</section>
<section id="truncating-files">
<h3>Truncating files<a class="headerlink" href="#truncating-files" title="Link to this heading">¶</a></h3>
<p>The operations covered by <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_WRITE_FILE</span></code> and
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_TRUNCATE</span></code> both change the contents of a file and sometimes
overlap in non-intuitive ways.  It is recommended to always specify both of
these together.</p>
<p>A particularly surprising example is <em class="manpage">creat(2)</em>.  The name suggests
that this system call requires the rights to create and write files.  However,
it also requires the truncate right if an existing file under the same name is
already present.</p>
<p>It should also be noted that truncating files does not require the
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_WRITE_FILE</span></code> right.  Apart from the <em class="manpage">truncate(2)</em>
system call, this can also be done through <em class="manpage">open(2)</em> with the flags
<code class="docutils literal notranslate"><span class="pre">O_RDONLY</span> <span class="pre">|</span> <span class="pre">O_TRUNC</span></code>.</p>
<p>The truncate right is associated with the opened file (see below).</p>
</section>
<section id="rights-associated-with-file-descriptors">
<h3>Rights associated with file descriptors<a class="headerlink" href="#rights-associated-with-file-descriptors" title="Link to this heading">¶</a></h3>
<p>When opening a file, the availability of the <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_TRUNCATE</span></code> and
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_IOCTL_DEV</span></code> rights is associated with the newly created
file descriptor and will be used for subsequent truncation and ioctl attempts
using <em class="manpage">ftruncate(2)</em> and <em class="manpage">ioctl(2)</em>.  The behavior is similar
to opening a file for reading or writing, where permissions are checked during
<em class="manpage">open(2)</em>, but not during the subsequent <em class="manpage">read(2)</em> and
<em class="manpage">write(2)</em> calls.</p>
<p>As a consequence, it is possible that a process has multiple open file
descriptors referring to the same file, but Landlock enforces different things
when operating with these file descriptors.  This can happen when a Landlock
ruleset gets enforced and the process keeps file descriptors which were opened
both before and after the enforcement.  It is also possible to pass such file
descriptors between processes, keeping their Landlock properties, even when some
of the involved processes do not have an enforced Landlock ruleset.</p>
</section>
</section>
<section id="compatibility">
<h2>Compatibility<a class="headerlink" href="#compatibility" title="Link to this heading">¶</a></h2>
<section id="backward-and-forward-compatibility">
<h3>Backward and forward compatibility<a class="headerlink" href="#backward-and-forward-compatibility" title="Link to this heading">¶</a></h3>
<p>Landlock is designed to be compatible with past and future versions of the
kernel.  This is achieved thanks to the system call attributes and the
associated bitflags, particularly the ruleset’s <code class="docutils literal notranslate"><span class="pre">handled_access_fs</span></code>.  Making
handled access rights explicit enables the kernel and user space to have a clear
contract with each other.  This is required to make sure sandboxing will not
get stricter with a system update, which could break applications.</p>
<p>Developers can subscribe to the <a class="reference external" href="https://subspace.kernel.org/lists.linux.dev.html">Landlock mailing list</a> to knowingly update and
test their applications with the latest available features.  In the interest of
users, and because they may use different kernel versions, it is strongly
encouraged to follow a best-effort security approach by checking the Landlock
ABI version at runtime and only enforcing the supported features.</p>
</section>
<section id="landlock-abi-versions">
<span id="id1"></span><h3>Landlock ABI versions<a class="headerlink" href="#landlock-abi-versions" title="Link to this heading">¶</a></h3>
<p>The Landlock ABI version can be read with the <a class="reference internal" href="#c.sys_landlock_create_ruleset" title="sys_landlock_create_ruleset"><code class="xref c c-func docutils literal notranslate"><span class="pre">sys_landlock_create_ruleset()</span></code></a>
system call:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">abi</span><span class="p">;</span>

<span class="n">abi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">landlock_create_ruleset</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">LANDLOCK_CREATE_RULESET_VERSION</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abi</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">errno</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ENOSYS</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Landlock is not supported by the current kernel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">EOPNOTSUPP</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Landlock is currently disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abi</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Landlock supports LANDLOCK_ACCESS_FS_REFER.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following kernel interfaces are implicitly supported by the first ABI
version.  Features only supported from a specific version are explicitly marked
as such.</p>
</section>
</section>
<section id="kernel-interface">
<h2>Kernel interface<a class="headerlink" href="#kernel-interface" title="Link to this heading">¶</a></h2>
<section id="access-rights">
<h3>Access rights<a class="headerlink" href="#access-rights" title="Link to this heading">¶</a></h3>
<p>A set of actions on kernel objects may be defined by an attribute (e.g.
<a class="reference internal" href="#c.landlock_path_beneath_attr" title="landlock_path_beneath_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">landlock_path_beneath_attr</span></code></a>) including a bitmask of access.</p>
<section id="filesystem-flags">
<h4>Filesystem flags<a class="headerlink" href="#filesystem-flags" title="Link to this heading">¶</a></h4>
<p>These flags enable to restrict a sandboxed process to a set of actions on
files and directories.  Files or directories opened before the sandboxing
are not subject to these restrictions.</p>
<p>The following access rights apply only to files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_EXECUTE</span></code>: Execute a file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_WRITE_FILE</span></code>: Open a file with write access.  When
opening files for writing, you will often additionally need the
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_TRUNCATE</span></code> right.  In many cases, these system calls
truncate existing files when overwriting them (e.g., <em class="manpage">creat(2)</em>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_READ_FILE</span></code>: Open a file with read access.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_TRUNCATE</span></code>: Truncate a file with <em class="manpage">truncate(2)</em>,
<em class="manpage">ftruncate(2)</em>, <em class="manpage">creat(2)</em>, or <em class="manpage">open(2)</em> with
<code class="docutils literal notranslate"><span class="pre">O_TRUNC</span></code>.  This access right is available since the third version of the
Landlock ABI.</p></li>
</ul>
<p>Whether an opened file can be truncated with <em class="manpage">ftruncate(2)</em> or used
with <cite>ioctl(2)</cite> is determined during <em class="manpage">open(2)</em>, in the same way as
read and write permissions are checked during <em class="manpage">open(2)</em> using
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_READ_FILE</span></code> and <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_WRITE_FILE</span></code>.</p>
<p>A directory can receive access rights related to files or directories.  The
following access right is applied to the directory itself, and the
directories beneath it:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_READ_DIR</span></code>: Open a directory or list its content.</p></li>
</ul>
<p>However, the following access rights only apply to the content of a
directory, not the directory itself:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_REMOVE_DIR</span></code>: Remove an empty directory or rename one.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_REMOVE_FILE</span></code>: Unlink (or rename) a file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_MAKE_CHAR</span></code>: Create (or rename or link) a character
device.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_MAKE_DIR</span></code>: Create (or rename) a directory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_MAKE_REG</span></code>: Create (or rename or link) a regular file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_MAKE_SOCK</span></code>: Create (or rename or link) a UNIX domain
socket.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_MAKE_FIFO</span></code>: Create (or rename or link) a named pipe.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_MAKE_BLOCK</span></code>: Create (or rename or link) a block device.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_MAKE_SYM</span></code>: Create (or rename or link) a symbolic link.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_REFER</span></code>: Link or rename a file from or to a different
directory (i.e. reparent a file hierarchy).</p>
<p>This access right is available since the second version of the Landlock
ABI.</p>
<p>This is the only access right which is denied by default by any ruleset,
even if the right is not specified as handled at ruleset creation time.
The only way to make a ruleset grant this right is to explicitly allow it
for a specific directory by adding a matching rule to the ruleset.</p>
<p>In particular, when using the first Landlock ABI version, Landlock will
always deny attempts to reparent files between different directories.</p>
<p>In addition to the source and destination directories having the
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_REFER</span></code> access right, the attempted link or rename
operation must meet the following constraints:</p>
<ul class="simple">
<li><p>The reparented file may not gain more access rights in the destination
directory than it previously had in the source directory.  If this is
attempted, the operation results in an <code class="docutils literal notranslate"><span class="pre">EXDEV</span></code> error.</p></li>
<li><p>When linking or renaming, the <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_MAKE_*</span></code> right for the
respective file type must be granted for the destination directory.
Otherwise, the operation results in an <code class="docutils literal notranslate"><span class="pre">EACCES</span></code> error.</p></li>
<li><p>When renaming, the <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_REMOVE_*</span></code> right for the
respective file type must be granted for the source directory.  Otherwise,
the operation results in an <code class="docutils literal notranslate"><span class="pre">EACCES</span></code> error.</p></li>
</ul>
<p>If multiple requirements are not met, the <code class="docutils literal notranslate"><span class="pre">EACCES</span></code> error code takes
precedence over <code class="docutils literal notranslate"><span class="pre">EXDEV</span></code>.</p>
</li>
</ul>
<p>The following access right applies both to files and directories:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_IOCTL_DEV</span></code>: Invoke <em class="manpage">ioctl(2)</em> commands on an opened
character or block device.</p>
<p>This access right applies to all <cite>ioctl(2)</cite> commands implemented by device
drivers.  However, the following common IOCTL commands continue to be
invokable independent of the <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_IOCTL_DEV</span></code> right:</p>
<ul class="simple">
<li><p>IOCTL commands targeting file descriptors (<code class="docutils literal notranslate"><span class="pre">FIOCLEX</span></code>, <code class="docutils literal notranslate"><span class="pre">FIONCLEX</span></code>),</p></li>
<li><p>IOCTL commands targeting file descriptions (<code class="docutils literal notranslate"><span class="pre">FIONBIO</span></code>, <code class="docutils literal notranslate"><span class="pre">FIOASYNC</span></code>),</p></li>
<li><p>IOCTL commands targeting file systems (<code class="docutils literal notranslate"><span class="pre">FIFREEZE</span></code>, <code class="docutils literal notranslate"><span class="pre">FITHAW</span></code>,
<code class="docutils literal notranslate"><span class="pre">FIGETBSZ</span></code>, <code class="docutils literal notranslate"><span class="pre">FS_IOC_GETFSUUID</span></code>, <code class="docutils literal notranslate"><span class="pre">FS_IOC_GETFSSYSFSPATH</span></code>)</p></li>
<li><p>Some IOCTL commands which do not make sense when used with devices, but
whose implementations are safe and return the right error codes
(<code class="docutils literal notranslate"><span class="pre">FS_IOC_FIEMAP</span></code>, <code class="docutils literal notranslate"><span class="pre">FICLONE</span></code>, <code class="docutils literal notranslate"><span class="pre">FICLONERANGE</span></code>, <code class="docutils literal notranslate"><span class="pre">FIDEDUPERANGE</span></code>)</p></li>
</ul>
<p>This access right is available since the fifth version of the Landlock
ABI.</p>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is currently not possible to restrict some file-related actions
accessible through these syscall families: <em class="manpage">chdir(2)</em>,
<em class="manpage">stat(2)</em>, <em class="manpage">flock(2)</em>, <em class="manpage">chmod(2)</em>,
<em class="manpage">chown(2)</em>, <em class="manpage">setxattr(2)</em>, <em class="manpage">utime(2)</em>,
<em class="manpage">fcntl(2)</em>, <em class="manpage">access(2)</em>.
Future Landlock evolutions will enable to restrict them.</p>
</div>
</section>
<section id="network-flags">
<h4>Network flags<a class="headerlink" href="#network-flags" title="Link to this heading">¶</a></h4>
<p>These flags enable to restrict a sandboxed process to a set of network
actions.</p>
<p>This is supported since Landlock ABI version 4.</p>
<p>The following access rights apply to TCP port numbers:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_NET_BIND_TCP</span></code>: Bind a TCP socket to a local port.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_NET_CONNECT_TCP</span></code>: Connect an active TCP socket to
a remote port.</p></li>
</ul>
</section>
<section id="scope-flags">
<h4>Scope flags<a class="headerlink" href="#scope-flags" title="Link to this heading">¶</a></h4>
<p>These flags enable to isolate a sandboxed process from a set of IPC actions.
Setting a flag for a ruleset will isolate the Landlock domain to forbid
connections to resources outside the domain.</p>
<p>This is supported since Landlock ABI version 6.</p>
<p>Scopes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_SCOPE_ABSTRACT_UNIX_SOCKET</span></code>: Restrict a sandboxed process from
connecting to an abstract UNIX socket created by a process outside the
related Landlock domain (e.g., a parent domain or a non-sandboxed process).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LANDLOCK_SCOPE_SIGNAL</span></code>: Restrict a sandboxed process from sending a signal
to another process outside the domain.</p></li>
</ul>
</section>
</section>
<section id="creating-a-new-ruleset">
<h3>Creating a new ruleset<a class="headerlink" href="#creating-a-new-ruleset" title="Link to this heading">¶</a></h3>
<dl class="c function">
<dt class="sig sig-object c" id="c.sys_landlock_create_ruleset">
<span class="kt"><span class="pre">long</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">sys_landlock_create_ruleset</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.landlock_ruleset_attr" title="landlock_ruleset_attr"><span class="n"><span class="pre">landlock_ruleset_attr</span></span></a><span class="w"> </span><span class="pre">__user</span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">attr</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">size</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">__u32</span></span><span class="w"> </span><span class="n"><span class="pre">flags</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.sys_landlock_create_ruleset" title="Link to this definition">¶</a><br /></dt>
<dd><p>Create a new ruleset</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">landlock_ruleset_attr</span> <span class="pre">__user</span> <span class="pre">*const</span> <span class="pre">attr</span></code></dt><dd><p>Pointer to a <a class="reference internal" href="#c.landlock_ruleset_attr" title="landlock_ruleset_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">landlock_ruleset_attr</span></code></a> identifying the scope of
the new ruleset.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">size_t</span> <span class="pre">size</span></code></dt><dd><p>Size of the pointed <a class="reference internal" href="#c.landlock_ruleset_attr" title="landlock_ruleset_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">landlock_ruleset_attr</span></code></a> (needed for
backward and forward compatibility).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">__u32</span> <span class="pre">flags</span></code></dt><dd><p>Supported value: <code class="docutils literal notranslate"><span class="pre">LANDLOCK_CREATE_RULESET_VERSION</span></code>.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This system call enables to create a new Landlock ruleset, and returns the
related file descriptor on success.</p>
<p>If <strong>flags</strong> is <code class="docutils literal notranslate"><span class="pre">LANDLOCK_CREATE_RULESET_VERSION</span></code> and <strong>attr</strong> is NULL and <strong>size</strong> is
0, then the returned value is the highest supported Landlock ABI version
(starting at 1).</p>
<p>Possible returned errors are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">EOPNOTSUPP</span></code>: Landlock is supported by the kernel but disabled at boot time;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EINVAL</span></code>: unknown <strong>flags</strong>, or unknown access, or unknown scope, or too small <strong>size</strong>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">E2BIG</span></code>: <strong>attr</strong> or <strong>size</strong> inconsistencies;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EFAULT</span></code>: <strong>attr</strong> or <strong>size</strong> inconsistencies;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ENOMSG</span></code>: empty <a class="reference internal" href="#c.landlock_ruleset_attr" title="landlock_ruleset_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">landlock_ruleset_attr.handled_access_fs</span></code></a>.</p></li>
</ul>
</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.landlock_ruleset_attr">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">landlock_ruleset_attr</span></span></span><a class="headerlink" href="#c.landlock_ruleset_attr" title="Link to this definition">¶</a><br /></dt>
<dd><p>Ruleset definition.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct landlock_ruleset_attr {
    __u64 handled_access_fs;
    __u64 handled_access_net;
    __u64 scoped;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">handled_access_fs</span></code></dt><dd><p>Bitmask of handled filesystem actions
(cf. <a class="reference internal" href="#filesystem-flags">Filesystem flags</a>).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">handled_access_net</span></code></dt><dd><p>Bitmask of handled network actions (cf. <a class="reference internal" href="#network-flags">Network
flags</a>).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">scoped</span></code></dt><dd><p>Bitmask of scopes (cf. <a class="reference internal" href="#scope-flags">Scope flags</a>)
restricting a Landlock domain from accessing outside
resources (e.g. IPCs).</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>Argument of <a class="reference internal" href="#c.sys_landlock_create_ruleset" title="sys_landlock_create_ruleset"><code class="xref c c-func docutils literal notranslate"><span class="pre">sys_landlock_create_ruleset()</span></code></a>.</p>
<p>This structure defines a set of <em>handled access rights</em>, a set of actions on
different object types, which should be denied by default when the ruleset is
enacted.  Vice versa, access rights that are not specifically listed here are
not going to be denied by this ruleset when it is enacted.</p>
<p>For historical reasons, the <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_REFER</span></code> right is always denied
by default, even when its bit is not set in <strong>handled_access_fs</strong>.  In order to
add new rules with this access right, the bit must still be set explicitly
(cf. <a class="reference internal" href="#filesystem-flags">Filesystem flags</a>).</p>
<p>The explicit listing of <em>handled access rights</em> is required for backwards
compatibility reasons.  In most use cases, processes that use Landlock will
<em>handle</em> a wide range or all access rights that they know about at build time
(and that they have tested with a kernel that supported them all).</p>
<p>This structure can grow in future Landlock versions.</p>
</section>
<section id="extending-a-ruleset">
<h3>Extending a ruleset<a class="headerlink" href="#extending-a-ruleset" title="Link to this heading">¶</a></h3>
<dl class="c function">
<dt class="sig sig-object c" id="c.sys_landlock_add_rule">
<span class="kt"><span class="pre">long</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">sys_landlock_add_rule</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">ruleset_fd</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">enum</span></span><span class="w"> </span><a class="reference internal" href="#c.landlock_rule_type" title="landlock_rule_type"><span class="n"><span class="pre">landlock_rule_type</span></span></a><span class="w"> </span><span class="n"><span class="pre">rule_type</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="pre">__user</span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">rule_attr</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">__u32</span></span><span class="w"> </span><span class="n"><span class="pre">flags</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.sys_landlock_add_rule" title="Link to this definition">¶</a><br /></dt>
<dd><p>Add a new rule to a ruleset</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">int</span> <span class="pre">ruleset_fd</span></code></dt><dd><p>File descriptor tied to the ruleset that should be extended
with the new rule.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">enum</span> <span class="pre">landlock_rule_type</span> <span class="pre">rule_type</span></code></dt><dd><p>Identify the structure type pointed to by <strong>rule_attr</strong>:
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_RULE_PATH_BENEATH</span></code> or <code class="docutils literal notranslate"><span class="pre">LANDLOCK_RULE_NET_PORT</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">void</span> <span class="pre">__user</span> <span class="pre">*const</span> <span class="pre">rule_attr</span></code></dt><dd><p>Pointer to a rule (matching the <strong>rule_type</strong>).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">__u32</span> <span class="pre">flags</span></code></dt><dd><p>Must be 0.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This system call enables to define a new rule and add it to an existing
ruleset.</p>
<p>Possible returned errors are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">EOPNOTSUPP</span></code>: Landlock is supported by the kernel but disabled at boot time;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EAFNOSUPPORT</span></code>: <strong>rule_type</strong> is <code class="docutils literal notranslate"><span class="pre">LANDLOCK_RULE_NET_PORT</span></code> but TCP/IP is not
supported by the running kernel;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EINVAL</span></code>: <strong>flags</strong> is not 0;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EINVAL</span></code>: The rule accesses are inconsistent (i.e.
<a class="reference internal" href="#c.landlock_path_beneath_attr" title="landlock_path_beneath_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">landlock_path_beneath_attr.allowed_access</span></code></a> or
<a class="reference internal" href="#c.landlock_net_port_attr" title="landlock_net_port_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">landlock_net_port_attr.allowed_access</span></code></a> is not a subset of the ruleset
handled accesses)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EINVAL</span></code>: <a class="reference internal" href="#c.landlock_net_port_attr" title="landlock_net_port_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">landlock_net_port_attr.port</span></code></a> is greater than 65535;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ENOMSG</span></code>: Empty accesses (e.g. <a class="reference internal" href="#c.landlock_path_beneath_attr" title="landlock_path_beneath_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">landlock_path_beneath_attr.allowed_access</span></code></a> is
0);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EBADF</span></code>: <strong>ruleset_fd</strong> is not a file descriptor for the current thread, or a
member of <strong>rule_attr</strong> is not a file descriptor as expected;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EBADFD</span></code>: <strong>ruleset_fd</strong> is not a ruleset file descriptor, or a member of
<strong>rule_attr</strong> is not the expected file descriptor type;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EPERM</span></code>: <strong>ruleset_fd</strong> has no write access to the underlying ruleset;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EFAULT</span></code>: <strong>rule_attr</strong> was not a valid address.</p></li>
</ul>
</div>
<dl class="c enum">
<dt class="sig sig-object c" id="c.landlock_rule_type">
<span class="k"><span class="pre">enum</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">landlock_rule_type</span></span></span><a class="headerlink" href="#c.landlock_rule_type" title="Link to this definition">¶</a><br /></dt>
<dd><p>Landlock rule type</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">LANDLOCK_RULE_PATH_BENEATH</span></code></dt><dd><p>Type of a <a class="reference internal" href="#c.landlock_path_beneath_attr" title="landlock_path_beneath_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span>
<span class="pre">landlock_path_beneath_attr</span></code></a> .</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">LANDLOCK_RULE_NET_PORT</span></code></dt><dd><p>Type of a <a class="reference internal" href="#c.landlock_net_port_attr" title="landlock_net_port_attr"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span>
<span class="pre">landlock_net_port_attr</span></code></a> .</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>Argument of <a class="reference internal" href="#c.sys_landlock_add_rule" title="sys_landlock_add_rule"><code class="xref c c-func docutils literal notranslate"><span class="pre">sys_landlock_add_rule()</span></code></a>.</p>
<dl class="c struct">
<dt class="sig sig-object c" id="c.landlock_path_beneath_attr">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">landlock_path_beneath_attr</span></span></span><a class="headerlink" href="#c.landlock_path_beneath_attr" title="Link to this definition">¶</a><br /></dt>
<dd><p>Path hierarchy definition</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct landlock_path_beneath_attr {
    __u64 allowed_access;
    __s32 parent_fd;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">allowed_access</span></code></dt><dd><p>Bitmask of allowed actions for this file hierarchy
(cf. <a class="reference internal" href="#filesystem-flags">Filesystem flags</a>).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">parent_fd</span></code></dt><dd><p>File descriptor, preferably opened with <code class="docutils literal notranslate"><span class="pre">O_PATH</span></code>,
which identifies the parent directory of a file hierarchy, or just a
file.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>Argument of <a class="reference internal" href="#c.sys_landlock_add_rule" title="sys_landlock_add_rule"><code class="xref c c-func docutils literal notranslate"><span class="pre">sys_landlock_add_rule()</span></code></a>.</p>
<dl class="c struct">
<dt class="sig sig-object c" id="c.landlock_net_port_attr">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">landlock_net_port_attr</span></span></span><a class="headerlink" href="#c.landlock_net_port_attr" title="Link to this definition">¶</a><br /></dt>
<dd><p>Network port definition</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct landlock_net_port_attr {
    __u64 allowed_access;
    __u64 port;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">allowed_access</span></code></dt><dd><p>Bitmask of allowed network actions for a port
(cf. <a class="reference internal" href="#network-flags">Network flags</a>).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">port</span></code></dt><dd><p>Network port in host endianness.</p>
<p>It should be noted that port 0 passed to <em class="manpage">bind(2)</em> will bind
to an available port from the ephemeral port range.  This can be
configured with the <code class="docutils literal notranslate"><span class="pre">/proc/sys/net/ipv4/ip_local_port_range</span></code> sysctl
(also used for IPv6).</p>
<p>A Landlock rule with port 0 and the <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_NET_BIND_TCP</span></code>
right means that requesting to bind on port 0 is allowed and it will
automatically translate to binding on the related port range.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>Argument of <a class="reference internal" href="#c.sys_landlock_add_rule" title="sys_landlock_add_rule"><code class="xref c c-func docutils literal notranslate"><span class="pre">sys_landlock_add_rule()</span></code></a>.</p>
</section>
<section id="enforcing-a-ruleset">
<h3>Enforcing a ruleset<a class="headerlink" href="#enforcing-a-ruleset" title="Link to this heading">¶</a></h3>
<dl class="c function">
<dt class="sig sig-object c" id="c.sys_landlock_restrict_self">
<span class="kt"><span class="pre">long</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">sys_landlock_restrict_self</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">ruleset_fd</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">__u32</span></span><span class="w"> </span><span class="n"><span class="pre">flags</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.sys_landlock_restrict_self" title="Link to this definition">¶</a><br /></dt>
<dd><p>Enforce a ruleset on the calling thread</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">int</span> <span class="pre">ruleset_fd</span></code></dt><dd><p>File descriptor tied to the ruleset to merge with the target.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">__u32</span> <span class="pre">flags</span></code></dt><dd><p>Must be 0.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This system call enables to enforce a Landlock ruleset on the current
thread.  Enforcing a ruleset requires that the task has <code class="docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code> in its
namespace or is running with no_new_privs.  This avoids scenarios where
unprivileged tasks can affect the behavior of privileged children.</p>
<p>Possible returned errors are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">EOPNOTSUPP</span></code>: Landlock is supported by the kernel but disabled at boot time;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EINVAL</span></code>: <strong>flags</strong> is not 0.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EBADF</span></code>: <strong>ruleset_fd</strong> is not a file descriptor for the current thread;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EBADFD</span></code>: <strong>ruleset_fd</strong> is not a ruleset file descriptor;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EPERM</span></code>: <strong>ruleset_fd</strong> has no read access to the underlying ruleset, or the
current thread is not running with no_new_privs, or it doesn’t have
<code class="docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code> in its namespace.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">E2BIG</span></code>: The maximum number of stacked rulesets is reached for the current
thread.</p></li>
</ul>
</div>
</section>
</section>
<section id="current-limitations">
<h2>Current limitations<a class="headerlink" href="#current-limitations" title="Link to this heading">¶</a></h2>
<section id="filesystem-topology-modification">
<h3>Filesystem topology modification<a class="headerlink" href="#filesystem-topology-modification" title="Link to this heading">¶</a></h3>
<p>Threads sandboxed with filesystem restrictions cannot modify filesystem
topology, whether via <em class="manpage">mount(2)</em> or <em class="manpage">pivot_root(2)</em>.
However, <em class="manpage">chroot(2)</em> calls are not denied.</p>
</section>
<section id="special-filesystems">
<h3>Special filesystems<a class="headerlink" href="#special-filesystems" title="Link to this heading">¶</a></h3>
<p>Access to regular files and directories can be restricted by Landlock,
according to the handled accesses of a ruleset.  However, files that do not
come from a user-visible filesystem (e.g. pipe, socket), but can still be
accessed through <code class="docutils literal notranslate"><span class="pre">/proc/&lt;pid&gt;/fd/*</span></code>, cannot currently be explicitly
restricted.  Likewise, some special kernel filesystems such as nsfs, which can
be accessed through <code class="docutils literal notranslate"><span class="pre">/proc/&lt;pid&gt;/ns/*</span></code>, cannot currently be explicitly
restricted.  However, thanks to the <a class="reference internal" href="#ptrace-restrictions">ptrace restrictions</a>, access to such
sensitive <code class="docutils literal notranslate"><span class="pre">/proc</span></code> files are automatically restricted according to domain
hierarchies.  Future Landlock evolutions could still enable to explicitly
restrict such paths with dedicated ruleset flags.</p>
</section>
<section id="ruleset-layers">
<h3>Ruleset layers<a class="headerlink" href="#ruleset-layers" title="Link to this heading">¶</a></h3>
<p>There is a limit of 16 layers of stacked rulesets.  This can be an issue for a
task willing to enforce a new ruleset in complement to its 16 inherited
rulesets.  Once this limit is reached, <a class="reference internal" href="#c.sys_landlock_restrict_self" title="sys_landlock_restrict_self"><code class="xref c c-func docutils literal notranslate"><span class="pre">sys_landlock_restrict_self()</span></code></a> returns
E2BIG.  It is then strongly suggested to carefully build rulesets once in the
life of a thread, especially for applications able to launch other applications
that may also want to sandbox themselves (e.g. shells, container managers,
etc.).</p>
</section>
<section id="memory-usage">
<h3>Memory usage<a class="headerlink" href="#memory-usage" title="Link to this heading">¶</a></h3>
<p>Kernel memory allocated to create rulesets is accounted and can be restricted
by the <a class="reference internal" href="../admin-guide/cgroup-v1/memory.html"><span class="doc">Memory Resource Controller</span></a>.</p>
</section>
<section id="ioctl-support">
<h3>IOCTL support<a class="headerlink" href="#ioctl-support" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_IOCTL_DEV</span></code> right restricts the use of
<em class="manpage">ioctl(2)</em>, but it only applies to <em>newly opened</em> device files.  This
means specifically that pre-existing file descriptors like stdin, stdout and
stderr are unaffected.</p>
<p>Users should be aware that TTY devices have traditionally permitted to control
other processes on the same TTY through the <code class="docutils literal notranslate"><span class="pre">TIOCSTI</span></code> and <code class="docutils literal notranslate"><span class="pre">TIOCLINUX</span></code> IOCTL
commands.  Both of these require <code class="docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code> on modern Linux systems, but
the behavior is configurable for <code class="docutils literal notranslate"><span class="pre">TIOCSTI</span></code>.</p>
<p>On older systems, it is therefore recommended to close inherited TTY file
descriptors, or to reopen them from <code class="docutils literal notranslate"><span class="pre">/proc/self/fd/*</span></code> without the
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_IOCTL_DEV</span></code> right, if possible.</p>
<p>Landlock’s IOCTL support is coarse-grained at the moment, but may become more
fine-grained in the future.  Until then, users are advised to establish the
guarantees that they need through the file hierarchy, by only allowing the
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_IOCTL_DEV</span></code> right on files where it is really required.</p>
</section>
</section>
<section id="previous-limitations">
<h2>Previous limitations<a class="headerlink" href="#previous-limitations" title="Link to this heading">¶</a></h2>
<section id="file-renaming-and-linking-abi-2">
<h3>File renaming and linking (ABI &lt; 2)<a class="headerlink" href="#file-renaming-and-linking-abi-2" title="Link to this heading">¶</a></h3>
<p>Because Landlock targets unprivileged access controls, it needs to properly
handle composition of rules.  Such property also implies rules nesting.
Properly handling multiple layers of rulesets, each one of them able to
restrict access to files, also implies inheritance of the ruleset restrictions
from a parent to its hierarchy.  Because files are identified and restricted by
their hierarchy, moving or linking a file from one directory to another implies
propagation of the hierarchy constraints, or restriction of these actions
according to the potentially lost constraints.  To protect against privilege
escalations through renaming or linking, and for the sake of simplicity,
Landlock previously limited linking and renaming to the same directory.
Starting with the Landlock ABI version 2, it is now possible to securely
control renaming and linking thanks to the new <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_REFER</span></code>
access right.</p>
</section>
<section id="file-truncation-abi-3">
<h3>File truncation (ABI &lt; 3)<a class="headerlink" href="#file-truncation-abi-3" title="Link to this heading">¶</a></h3>
<p>File truncation could not be denied before the third Landlock ABI, so it is
always allowed when using a kernel that only supports the first or second ABI.</p>
<p>Starting with the Landlock ABI version 3, it is now possible to securely control
truncation thanks to the new <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_TRUNCATE</span></code> access right.</p>
</section>
<section id="tcp-bind-and-connect-abi-4">
<h3>TCP bind and connect (ABI &lt; 4)<a class="headerlink" href="#tcp-bind-and-connect-abi-4" title="Link to this heading">¶</a></h3>
<p>Starting with the Landlock ABI version 4, it is now possible to restrict TCP
bind and connect actions to only a set of allowed ports thanks to the new
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_NET_BIND_TCP</span></code> and <code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_NET_CONNECT_TCP</span></code>
access rights.</p>
</section>
<section id="device-ioctl-abi-5">
<h3>Device IOCTL (ABI &lt; 5)<a class="headerlink" href="#device-ioctl-abi-5" title="Link to this heading">¶</a></h3>
<p>IOCTL operations could not be denied before the fifth Landlock ABI, so
<em class="manpage">ioctl(2)</em> is always allowed when using a kernel that only supports an
earlier ABI.</p>
<p>Starting with the Landlock ABI version 5, it is possible to restrict the use of
<em class="manpage">ioctl(2)</em> on character and block devices using the new
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_FS_IOCTL_DEV</span></code> right.</p>
</section>
<section id="abstract-unix-socket-abi-6">
<h3>Abstract UNIX socket (ABI &lt; 6)<a class="headerlink" href="#abstract-unix-socket-abi-6" title="Link to this heading">¶</a></h3>
<p>Starting with the Landlock ABI version 6, it is possible to restrict
connections to an abstract <em class="manpage">unix(7)</em> socket by setting
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_SCOPE_ABSTRACT_UNIX_SOCKET</span></code> to the <code class="docutils literal notranslate"><span class="pre">scoped</span></code> ruleset attribute.</p>
</section>
<section id="signal-abi-6">
<h3>Signal (ABI &lt; 6)<a class="headerlink" href="#signal-abi-6" title="Link to this heading">¶</a></h3>
<p>Starting with the Landlock ABI version 6, it is possible to restrict
<em class="manpage">signal(7)</em> sending by setting <code class="docutils literal notranslate"><span class="pre">LANDLOCK_SCOPE_SIGNAL</span></code> to the
<code class="docutils literal notranslate"><span class="pre">scoped</span></code> ruleset attribute.</p>
</section>
</section>
<section id="kernel-support">
<span id="id2"></span><h2>Kernel support<a class="headerlink" href="#kernel-support" title="Link to this heading">¶</a></h2>
<section id="build-time-configuration">
<h3>Build time configuration<a class="headerlink" href="#build-time-configuration" title="Link to this heading">¶</a></h3>
<p>Landlock was first introduced in Linux 5.13 but it must be configured at build
time with <code class="docutils literal notranslate"><span class="pre">CONFIG_SECURITY_LANDLOCK=y</span></code>.  Landlock must also be enabled at boot
time like other security modules.  The list of security modules enabled by
default is set with <code class="docutils literal notranslate"><span class="pre">CONFIG_LSM</span></code>.  The kernel configuration should then
contain <code class="docutils literal notranslate"><span class="pre">CONFIG_LSM=landlock,[...]</span></code> with <code class="docutils literal notranslate"><span class="pre">[...]</span></code>  as the list of other
potentially useful security modules for the running system (see the
<code class="docutils literal notranslate"><span class="pre">CONFIG_LSM</span></code> help).</p>
</section>
<section id="boot-time-configuration">
<h3>Boot time configuration<a class="headerlink" href="#boot-time-configuration" title="Link to this heading">¶</a></h3>
<p>If the running kernel does not have <code class="docutils literal notranslate"><span class="pre">landlock</span></code> in <code class="docutils literal notranslate"><span class="pre">CONFIG_LSM</span></code>, then we can
enable Landlock by adding <code class="docutils literal notranslate"><span class="pre">lsm=landlock,[...]</span></code> to
<a class="reference internal" href="../admin-guide/kernel-parameters.html"><span class="doc">The kernel’s command-line parameters</span></a> in the boot loader
configuration.</p>
<p>For example, if the current built-in configuration is:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>zgrep<span class="w"> </span>-h<span class="w"> </span><span class="s2">&quot;^CONFIG_LSM=&quot;</span><span class="w"> </span><span class="s2">&quot;/boot/config-</span><span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>/proc/config.gz<span class="w"> </span><span class="m">2</span>&gt;/dev/null
<span class="go">CONFIG_LSM=&quot;lockdown,yama,integrity,apparmor&quot;</span>
</pre></div>
</div>
<p>...and if the cmdline doesn’t contain <code class="docutils literal notranslate"><span class="pre">landlock</span></code> either:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sed<span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;s/.*\(\&lt;lsm=\S\+\).*/\1/p&#39;</span><span class="w"> </span>/proc/cmdline
<span class="go">lsm=lockdown,yama,integrity,apparmor</span>
</pre></div>
</div>
<p>...we should configure the boot loader to set a cmdline extending the <code class="docutils literal notranslate"><span class="pre">lsm</span></code>
list with the <code class="docutils literal notranslate"><span class="pre">landlock,</span></code> prefix:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>lsm=landlock,lockdown,yama,integrity,apparmor
</pre></div>
</div>
<p>After a reboot, we can check that Landlock is up and running by looking at
kernel logs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>landlock<span class="w"> </span><span class="o">||</span><span class="w"> </span>journalctl<span class="w"> </span>-kb<span class="w"> </span>-g<span class="w"> </span>landlock
<span class="go">[    0.000000] Command line: [...] lsm=landlock,lockdown,yama,integrity,apparmor</span>
<span class="go">[    0.000000] Kernel command line: [...] lsm=landlock,lockdown,yama,integrity,apparmor</span>
<span class="go">[    0.000000] LSM: initializing lsm=lockdown,capability,landlock,yama,integrity,apparmor</span>
<span class="go">[    0.000000] landlock: Up and running.</span>
</pre></div>
</div>
<p>The kernel may be configured at build time to always load the <code class="docutils literal notranslate"><span class="pre">lockdown</span></code> and
<code class="docutils literal notranslate"><span class="pre">capability</span></code> LSMs.  In that case, these LSMs will appear at the beginning of
the <code class="docutils literal notranslate"><span class="pre">LSM:</span> <span class="pre">initializing</span></code> log line as well, even if they are not configured in
the boot loader.</p>
</section>
<section id="network-support">
<h3>Network support<a class="headerlink" href="#network-support" title="Link to this heading">¶</a></h3>
<p>To be able to explicitly allow TCP operations (e.g., adding a network rule with
<code class="docutils literal notranslate"><span class="pre">LANDLOCK_ACCESS_NET_BIND_TCP</span></code>), the kernel must support TCP
(<code class="docutils literal notranslate"><span class="pre">CONFIG_INET=y</span></code>).  Otherwise, <a class="reference internal" href="#c.sys_landlock_add_rule" title="sys_landlock_add_rule"><code class="xref c c-func docutils literal notranslate"><span class="pre">sys_landlock_add_rule()</span></code></a> returns an
<code class="docutils literal notranslate"><span class="pre">EAFNOSUPPORT</span></code> error, which can safely be ignored because this kind of TCP
operation is already not possible.</p>
</section>
</section>
<section id="questions-and-answers">
<h2>Questions and answers<a class="headerlink" href="#questions-and-answers" title="Link to this heading">¶</a></h2>
<section id="what-about-user-space-sandbox-managers">
<h3>What about user space sandbox managers?<a class="headerlink" href="#what-about-user-space-sandbox-managers" title="Link to this heading">¶</a></h3>
<p>Using user space processes to enforce restrictions on kernel resources can lead
to race conditions or inconsistent evaluations (i.e. <a class="reference external" href="https://www.ndss-symposium.org/ndss2003/traps-and-pitfalls-practical-problems-system-call-interposition-based-security-tools/">Incorrect mirroring of
the OS code and state</a>).</p>
</section>
<section id="what-about-namespaces-and-containers">
<h3>What about namespaces and containers?<a class="headerlink" href="#what-about-namespaces-and-containers" title="Link to this heading">¶</a></h3>
<p>Namespaces can help create sandboxes but they are not designed for
access-control and then miss useful features for such use case (e.g. no
fine-grained restrictions).  Moreover, their complexity can lead to security
issues, especially when untrusted processes can manipulate them (cf.
<a class="reference external" href="https://lwn.net/Articles/673597/">Controlling access to user namespaces</a>).</p>
</section>
</section>
<section id="additional-documentation">
<h2>Additional documentation<a class="headerlink" href="#additional-documentation" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../security/landlock.html"><span class="doc">Landlock LSM: kernel documentation</span></a></p></li>
<li><p><a class="reference external" href="https://landlock.io">https://landlock.io</a></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/userspace-api/landlock.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>