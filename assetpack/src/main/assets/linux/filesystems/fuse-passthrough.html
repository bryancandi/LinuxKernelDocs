<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>FUSE Passthrough &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=a152c8ac" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Inotify - A Powerful yet Simple File Change Notification System" href="inotify.html" />
    <link rel="prev" title="FUSE-over-io-uring design documentation" href="fuse-io-uring.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.16.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../subsystem-apis.html#storage-interfaces">Storage interfaces</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cdrom/index.html">CD-ROM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scsi/index.html">SCSI Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nvme/index.html">NVMe Subsystem</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/filesystems/fuse-passthrough.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="fuse-passthrough">
<h1>FUSE Passthrough<a class="headerlink" href="#fuse-passthrough" title="Link to this heading">¶</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>FUSE (Filesystem in Userspace) passthrough is a feature designed to improve the
performance of FUSE filesystems for I/O operations. Typically, FUSE operations
involve communication between the kernel and a userspace FUSE daemon, which can
incur overhead. Passthrough allows certain operations on a FUSE file to bypass
the userspace daemon and be executed directly by the kernel on an underlying
“backing file”.</p>
<p>This is achieved by the FUSE daemon registering a file descriptor (pointing to
the backing file on a lower filesystem) with the FUSE kernel module. The kernel
then receives an identifier (<code class="docutils literal notranslate"><span class="pre">backing_id</span></code>) for this registered backing file.
When a FUSE file is subsequently opened, the FUSE daemon can, in its response to
the <code class="docutils literal notranslate"><span class="pre">OPEN</span></code> request, include this <code class="docutils literal notranslate"><span class="pre">backing_id</span></code> and set the
<code class="docutils literal notranslate"><span class="pre">FOPEN_PASSTHROUGH</span></code> flag. This establishes a direct link for specific
operations.</p>
<p>Currently, passthrough is supported for operations like <code class="docutils literal notranslate"><span class="pre">read(2)</span></code>/<code class="docutils literal notranslate"><span class="pre">write(2)</span></code>
(via <code class="docutils literal notranslate"><span class="pre">read_iter</span></code>/<code class="docutils literal notranslate"><span class="pre">write_iter</span></code>), <code class="docutils literal notranslate"><span class="pre">splice(2)</span></code>, and <code class="docutils literal notranslate"><span class="pre">mmap(2)</span></code>.</p>
</section>
<section id="enabling-passthrough">
<h2>Enabling Passthrough<a class="headerlink" href="#enabling-passthrough" title="Link to this heading">¶</a></h2>
<p>To use FUSE passthrough:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The FUSE filesystem must be compiled with <code class="docutils literal notranslate"><span class="pre">CONFIG_FUSE_PASSTHROUGH</span></code>
enabled.</p></li>
<li><p>The FUSE daemon, during the <code class="docutils literal notranslate"><span class="pre">FUSE_INIT</span></code> handshake, must negotiate the
<code class="docutils literal notranslate"><span class="pre">FUSE_PASSTHROUGH</span></code> capability and specify its desired
<code class="docutils literal notranslate"><span class="pre">max_stack_depth</span></code>.</p></li>
<li><p>The (privileged) FUSE daemon uses the <code class="docutils literal notranslate"><span class="pre">FUSE_DEV_IOC_BACKING_OPEN</span></code> ioctl
on its connection file descriptor (e.g., <code class="docutils literal notranslate"><span class="pre">/dev/fuse</span></code>) to register a
backing file descriptor and obtain a <code class="docutils literal notranslate"><span class="pre">backing_id</span></code>.</p></li>
<li><p>When handling an <code class="docutils literal notranslate"><span class="pre">OPEN</span></code> or <code class="docutils literal notranslate"><span class="pre">CREATE</span></code> request for a FUSE file, the daemon
replies with the <code class="docutils literal notranslate"><span class="pre">FOPEN_PASSTHROUGH</span></code> flag set in
<code class="docutils literal notranslate"><span class="pre">fuse_open_out::open_flags</span></code> and provides the corresponding <code class="docutils literal notranslate"><span class="pre">backing_id</span></code>
in <code class="docutils literal notranslate"><span class="pre">fuse_open_out::backing_id</span></code>.</p></li>
<li><p>The FUSE daemon should eventually call <code class="docutils literal notranslate"><span class="pre">FUSE_DEV_IOC_BACKING_CLOSE</span></code> with
the <code class="docutils literal notranslate"><span class="pre">backing_id</span></code> to release the kernel’s reference to the backing file
when it’s no longer needed for passthrough setups.</p></li>
</ol>
</div></blockquote>
</section>
<section id="privilege-requirements">
<h2>Privilege Requirements<a class="headerlink" href="#privilege-requirements" title="Link to this heading">¶</a></h2>
<p>Setting up passthrough functionality currently requires the FUSE daemon to
possess the <code class="docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code> capability. This requirement stems from several
security and resource management considerations that are actively being
discussed and worked on. The primary reasons for this restriction are detailed
below.</p>
<section id="resource-accounting-and-visibility">
<h3>Resource Accounting and Visibility<a class="headerlink" href="#resource-accounting-and-visibility" title="Link to this heading">¶</a></h3>
<p>The core mechanism for passthrough involves the FUSE daemon opening a file
descriptor to a backing file and registering it with the FUSE kernel module via
the <code class="docutils literal notranslate"><span class="pre">FUSE_DEV_IOC_BACKING_OPEN</span></code> ioctl. This ioctl returns a <code class="docutils literal notranslate"><span class="pre">backing_id</span></code>
associated with a kernel-internal <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fuse_backing</span></code> object, which holds a
reference to the backing <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file</span></code>.</p>
<p>A significant concern arises because the FUSE daemon can close its own file
descriptor to the backing file after registration. The kernel, however, will
still hold a reference to the <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file</span></code> via the <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fuse_backing</span></code>
object as long as it’s associated with a <code class="docutils literal notranslate"><span class="pre">backing_id</span></code> (or subsequently, with
an open FUSE file in passthrough mode).</p>
<p>This behavior leads to two main issues for unprivileged FUSE daemons:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><strong>Invisibility to lsof and other inspection tools</strong>: Once the FUSE
daemon closes its file descriptor, the open backing file held by the kernel
becomes “hidden.” Standard tools like <code class="docutils literal notranslate"><span class="pre">lsof</span></code>, which typically inspect
process file descriptor tables, would not be able to identify that this
file is still open by the system on behalf of the FUSE filesystem. This
makes it difficult for system administrators to track resource usage or
debug issues related to open files (e.g., preventing unmounts).</p></li>
<li><p><strong>Bypassing RLIMIT_NOFILE</strong>: The FUSE daemon process is subject to
resource limits, including the maximum number of open file descriptors
(<code class="docutils literal notranslate"><span class="pre">RLIMIT_NOFILE</span></code>). If an unprivileged daemon could register backing files
and then close its own FDs, it could potentially cause the kernel to hold
an unlimited number of open <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file</span></code> references without these being
accounted against the daemon’s <code class="docutils literal notranslate"><span class="pre">RLIMIT_NOFILE</span></code>. This could lead to a
denial-of-service (DoS) by exhausting system-wide file resources.</p></li>
</ol>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code> requirement acts as a safeguard against these issues,
restricting this powerful capability to trusted processes.</p>
<p><strong>NOTE</strong>: <code class="docutils literal notranslate"><span class="pre">io_uring</span></code> solves this similar issue by exposing its “fixed files”,
which are visible via <code class="docutils literal notranslate"><span class="pre">fdinfo</span></code> and accounted under the registering user’s
<code class="docutils literal notranslate"><span class="pre">RLIMIT_NOFILE</span></code>.</p>
</section>
<section id="filesystem-stacking-and-shutdown-loops">
<h3>Filesystem Stacking and Shutdown Loops<a class="headerlink" href="#filesystem-stacking-and-shutdown-loops" title="Link to this heading">¶</a></h3>
<p>Another concern relates to the potential for creating complex and problematic
filesystem stacking scenarios if unprivileged users could set up passthrough.
A FUSE passthrough filesystem might use a backing file that resides:</p>
<blockquote>
<div><ul class="simple">
<li><p>On the <em>same</em> FUSE filesystem.</p></li>
<li><p>On another filesystem (like OverlayFS) which itself might have an upper or
lower layer that is a FUSE filesystem.</p></li>
</ul>
</div></blockquote>
<p>These configurations could create dependency loops, particularly during
filesystem shutdown or unmount sequences, leading to deadlocks or system
instability. This is conceptually similar to the risks associated with the
<code class="docutils literal notranslate"><span class="pre">LOOP_SET_FD</span></code> ioctl, which also requires <code class="docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code>.</p>
<p>To mitigate this, FUSE passthrough already incorporates checks based on
filesystem stacking depth (<code class="docutils literal notranslate"><span class="pre">sb-&gt;s_stack_depth</span></code> and <code class="docutils literal notranslate"><span class="pre">fc-&gt;max_stack_depth</span></code>).
For example, during the <code class="docutils literal notranslate"><span class="pre">FUSE_INIT</span></code> handshake, the FUSE daemon can negotiate
the <code class="docutils literal notranslate"><span class="pre">max_stack_depth</span></code> it supports. When a backing file is registered via
<code class="docutils literal notranslate"><span class="pre">FUSE_DEV_IOC_BACKING_OPEN</span></code>, the kernel checks if the backing file’s
filesystem stack depth is within the allowed limit.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code> requirement provides an additional layer of security,
ensuring that only privileged users can create these potentially complex
stacking arrangements.</p>
</section>
<section id="general-security-posture">
<h3>General Security Posture<a class="headerlink" href="#general-security-posture" title="Link to this heading">¶</a></h3>
<p>As a general principle for new kernel features that allow userspace to instruct
the kernel to perform direct operations on its behalf based on user-provided
file descriptors, starting with a higher privilege requirement (like
<code class="docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code>) is a conservative and common security practice. This allows
the feature to be used and tested while further security implications are
evaluated and addressed.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/filesystems/fuse-passthrough.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>