<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>DRM Internals &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=a152c8ac" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="DRM Memory Management" href="drm-mm.html" />
    <link rel="prev" title="Introduction" href="introduction.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.16.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../subsystem-apis.html#human-interfaces">Human interfaces</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../input/index.html">Input Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sound/index.html">Sound Subsystem Documentation</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">GPU Driver Developer’s Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#networking-interfaces">Networking interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/gpu/drm-internals.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="drm-internals">
<h1>DRM Internals<a class="headerlink" href="#drm-internals" title="Link to this heading">¶</a></h1>
<p>This chapter documents DRM internals relevant to driver authors and
developers working to add support for the latest features to existing
drivers.</p>
<p>First, we go over some typical driver initialization requirements, like
setting up command buffers, creating an initial output configuration,
and initializing core services. Subsequent sections cover core internals
in more detail, providing implementation notes and examples.</p>
<p>The DRM layer provides several services to graphics drivers, many of
them driven by the application interfaces it provides through libdrm,
the library that wraps most of the DRM ioctls. These include vblank
event handling, memory management, output management, framebuffer
management, command submission &amp; fencing, suspend/resume support, and
DMA services.</p>
<section id="driver-initialization">
<h2>Driver Initialization<a class="headerlink" href="#driver-initialization" title="Link to this heading">¶</a></h2>
<p>At the core of every DRM driver is a <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_driver</span></code></a> structure. Drivers typically statically initialize
a drm_driver structure, and then pass it to
<a class="reference internal" href="#c.drm_dev_alloc" title="drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_alloc()</span></code></a> to allocate a device instance. After the
device instance is fully initialized it can be registered (which makes
it accessible from userspace) using <a class="reference internal" href="#c.drm_dev_register" title="drm_dev_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_register()</span></code></a>.</p>
<p>The <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_driver</span></code></a> structure
contains static information that describes the driver and features it
supports, and pointers to methods that the DRM core will call to
implement the DRM API. We will first go through the <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span>
<span class="pre">drm_driver</span></code></a> static information fields, and will
then describe individual operations in details as they get used in later
sections.</p>
<section id="driver-information">
<h3>Driver Information<a class="headerlink" href="#driver-information" title="Link to this heading">¶</a></h3>
<section id="major-minor-and-patchlevel">
<h4>Major, Minor and Patchlevel<a class="headerlink" href="#major-minor-and-patchlevel" title="Link to this heading">¶</a></h4>
<p>int major; int minor; int patchlevel;
The DRM core identifies driver versions by a major, minor and patch
level triplet. The information is printed to the kernel log at
initialization time and passed to userspace through the
DRM_IOCTL_VERSION ioctl.</p>
<p>The major and minor numbers are also used to verify the requested driver
API version passed to DRM_IOCTL_SET_VERSION. When the driver API
changes between minor versions, applications can call
DRM_IOCTL_SET_VERSION to select a specific version of the API. If the
requested major isn’t equal to the driver major, or the requested minor
is larger than the driver minor, the DRM_IOCTL_SET_VERSION call will
return an error. Otherwise the driver’s set_version() method will be
called with the requested version.</p>
</section>
<section id="name-and-description">
<h4>Name and Description<a class="headerlink" href="#name-and-description" title="Link to this heading">¶</a></h4>
<p>char *name; char *desc; char *date;
The driver name is printed to the kernel log at initialization time,
used for IRQ registration and passed to userspace through
DRM_IOCTL_VERSION.</p>
<p>The driver description is a purely informative string passed to
userspace through the DRM_IOCTL_VERSION ioctl and otherwise unused by
the kernel.</p>
</section>
</section>
<section id="module-initialization">
<h3>Module Initialization<a class="headerlink" href="#module-initialization" title="Link to this heading">¶</a></h3>
<p>This library provides helpers registering DRM drivers during module
initialization and shutdown. The provided helpers act like bus-specific
module helpers, such as module_pci_driver(), but respect additional
parameters that control DRM driver registration.</p>
<p>Below is an example of initializing a DRM driver for a device on the
PCI bus.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">pci_driver</span><span class="w"> </span><span class="n">my_pci_drv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="p">};</span>

<span class="n">drm_module_pci_driver</span><span class="p">(</span><span class="n">my_pci_drv</span><span class="p">);</span>
</pre></div>
</div>
<p>The generated code will test if DRM drivers are enabled and register
the PCI driver my_pci_drv. For more complex module initialization, you
can still use <a class="reference internal" href="../driver-api/basics.html#c.module_init" title="module_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_init()</span></code></a> and <a class="reference internal" href="../driver-api/basics.html#c.module_exit" title="module_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_exit()</span></code></a> in your driver.</p>
</section>
<section id="device-instance-and-driver-handling">
<h3>Device Instance and Driver Handling<a class="headerlink" href="#device-instance-and-driver-handling" title="Link to this heading">¶</a></h3>
<p>A device instance for a drm driver is represented by <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a>. This
is allocated and initialized with <a class="reference internal" href="#c.devm_drm_dev_alloc" title="devm_drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_drm_dev_alloc()</span></code></a>, usually from
bus-specific -&gt;probe() callbacks implemented by the driver. The driver then
needs to initialize all the various subsystems for the drm device like memory
management, vblank handling, modesetting support and initial output
configuration plus obviously initialize all the corresponding hardware bits.
Finally when everything is up and running and ready for userspace the device
instance can be published using <a class="reference internal" href="#c.drm_dev_register" title="drm_dev_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_register()</span></code></a>.</p>
<p>There is also deprecated support for initializing device instances using
bus-specific helpers and the <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.load</span></code></a> callback. But due to
backwards-compatibility needs the device instance have to be published too
early, which requires unpretty global locking to make safe and is therefore
only support for existing drivers not yet converted to the new scheme.</p>
<p>When cleaning up a device instance everything needs to be done in reverse:
First unpublish the device instance with <a class="reference internal" href="#c.drm_dev_unregister" title="drm_dev_unregister"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unregister()</span></code></a>. Then clean up
any other resources allocated at device initialization and drop the driver’s
reference to <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> using <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a>.</p>
<p>Note that any allocation or resource which is visible to userspace must be
released only when the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> is called, and not when the
driver is unbound from the underlying physical struct <a class="reference internal" href="../driver-api/infrastructure.html#c.device" title="device"><code class="xref c c-type docutils literal notranslate"><span class="pre">device</span></code></a>. Best to use
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed resources with <a class="reference internal" href="#c.drmm_add_action" title="drmm_add_action"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_add_action()</span></code></a>, <a class="reference internal" href="#c.drmm_kmalloc" title="drmm_kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kmalloc()</span></code></a> and
related functions.</p>
<p>devres managed resources like <a class="reference internal" href="../driver-api/basics.html#c.devm_kmalloc" title="devm_kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_kmalloc()</span></code></a> can only be used for resources
directly related to the underlying hardware device, and only used in code
paths fully protected by <a class="reference internal" href="#c.drm_dev_enter" title="drm_dev_enter"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_enter()</span></code></a> and <a class="reference internal" href="#c.drm_dev_exit" title="drm_dev_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_exit()</span></code></a>.</p>
<section id="display-driver-example">
<h4>Display driver example<a class="headerlink" href="#display-driver-example" title="Link to this heading">¶</a></h4>
<p>The following example shows a typical structure of a DRM display driver.
The example focus on the probe() function and the other functions that is
almost always present and serves as a demonstration of <a class="reference internal" href="#c.devm_drm_dev_alloc" title="devm_drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_drm_dev_alloc()</span></code></a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">driver_device</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">drm_device</span><span class="w"> </span><span class="n">drm</span><span class="p">;</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">userspace_facing</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">clk</span><span class="w"> </span><span class="o">*</span><span class="n">pclk</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">drm_driver</span><span class="w"> </span><span class="n">driver_drm_driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">[...]</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">driver_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">driver_device</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">drm_device</span><span class="w"> </span><span class="o">*</span><span class="n">drm</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">        </span><span class="n">priv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_drm_dev_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">driver_drm_driver</span><span class="p">,</span>
<span class="w">                                  </span><span class="k">struct</span><span class="w"> </span><span class="nc">driver_device</span><span class="p">,</span><span class="w"> </span><span class="n">drm</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="w">        </span><span class="n">drm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">drm</span><span class="p">;</span>

<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drmm_mode_config_init</span><span class="p">(</span><span class="n">drm</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">        </span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">userspace_facing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drmm_kzalloc</span><span class="p">(...,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">userspace_facing</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="w">        </span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pclk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devm_clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PCLK&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pclk</span><span class="p">))</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pclk</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Further setup, display pipeline etc</span>

<span class="w">        </span><span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="n">drm</span><span class="p">);</span>

<span class="w">        </span><span class="n">drm_mode_config_reset</span><span class="p">(</span><span class="n">drm</span><span class="p">);</span>

<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drm_dev_register</span><span class="p">(</span><span class="n">drm</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">        </span><span class="n">drm_fbdev_</span><span class="p">{...}</span><span class="n">_setup</span><span class="p">(</span><span class="n">drm</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// This function is called before the devm_ resources are released</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">driver_remove</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">drm_device</span><span class="w"> </span><span class="o">*</span><span class="n">drm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="w">        </span><span class="n">drm_dev_unregister</span><span class="p">(</span><span class="n">drm</span><span class="p">);</span>
<span class="w">        </span><span class="n">drm_atomic_helper_shutdown</span><span class="p">(</span><span class="n">drm</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// This function is called on kernel restart and shutdown</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">driver_shutdown</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="n">drm_atomic_helper_shutdown</span><span class="p">(</span><span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="w"> </span><span class="nf">driver_pm_suspend</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">drm_mode_config_helper_suspend</span><span class="p">(</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="w"> </span><span class="nf">driver_pm_resume</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="n">drm_mode_config_helper_resume</span><span class="p">(</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">dev_pm_ops</span><span class="w"> </span><span class="n">driver_pm_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SET_SYSTEM_SLEEP_PM_OPS</span><span class="p">(</span><span class="n">driver_pm_suspend</span><span class="p">,</span><span class="w"> </span><span class="n">driver_pm_resume</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_driver</span><span class="w"> </span><span class="n">driver_driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="p">[...]</span>
<span class="w">                </span><span class="p">.</span><span class="n">pm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">driver_pm_ops</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">.</span><span class="n">probe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">driver_probe</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">remove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">driver_remove</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">shutdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">driver_shutdown</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">driver_driver</span><span class="p">);</span>
</pre></div>
</div>
<p>Drivers that want to support device unplugging (USB, DT overlay unload) should
use <a class="reference internal" href="#c.drm_dev_unplug" title="drm_dev_unplug"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unplug()</span></code></a> instead of <a class="reference internal" href="#c.drm_dev_unregister" title="drm_dev_unregister"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unregister()</span></code></a>. The driver must protect
regions that is accessing device resources to prevent use after they’re
released. This is done using <a class="reference internal" href="#c.drm_dev_enter" title="drm_dev_enter"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_enter()</span></code></a> and <a class="reference internal" href="#c.drm_dev_exit" title="drm_dev_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_exit()</span></code></a>. There is one
shortcoming however, <a class="reference internal" href="#c.drm_dev_unplug" title="drm_dev_unplug"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unplug()</span></code></a> marks the drm_device as unplugged before
<a class="reference internal" href="drm-kms-helpers.html#c.drm_atomic_helper_shutdown" title="drm_atomic_helper_shutdown"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_atomic_helper_shutdown()</span></code></a> is called. This means that if the disable code
paths are protected, they will not run on regular driver module unload,
possibly leaving the hardware enabled.</p>
</section>
<dl class="c enum">
<dt class="sig sig-object c" id="c.switch_power_state">
<span class="k"><span class="pre">enum</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">switch_power_state</span></span></span><a class="headerlink" href="#c.switch_power_state" title="Link to this definition">¶</a><br /></dt>
<dd><p>power state of drm device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">DRM_SWITCH_POWER_ON</span></code></dt><dd><p>Power state is ON</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_SWITCH_POWER_OFF</span></code></dt><dd><p>Power state is OFF</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_SWITCH_POWER_CHANGING</span></code></dt><dd><p>Power state is changing</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_SWITCH_POWER_DYNAMIC_OFF</span></code></dt><dd><p>Suspended</p>
</dd>
</dl>
</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.drm_device">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_device</span></span></span><a class="headerlink" href="#c.drm_device" title="Link to this definition">¶</a><br /></dt>
<dd><p>DRM device structure</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct drm_device {
    int if_version;
    struct kref ref;
    struct device *dev;
    struct device *dma_dev;
    struct {
        struct list_head resources;
        void *final_kfree;
        spinlock_t lock;
    } managed;
    const struct drm_driver *driver;
    void *dev_private;
    struct drm_minor *primary;
    struct drm_minor *render;
    struct drm_minor *accel;
    bool registered;
    struct drm_master *master;
    u32 driver_features;
    bool unplugged;
    struct inode *anon_inode;
    char *unique;
    struct mutex struct_mutex;
    struct mutex master_mutex;
    atomic_t open_count;
    struct mutex filelist_mutex;
    struct list_head filelist;
    struct list_head filelist_internal;
    struct mutex clientlist_mutex;
    struct list_head clientlist;
    bool vblank_disable_immediate;
    struct drm_vblank_crtc *vblank;
    spinlock_t vblank_time_lock;
    spinlock_t vbl_lock;
    u32 max_vblank_count;
    struct list_head vblank_event_list;
    spinlock_t event_lock;
    unsigned int num_crtcs;
    struct drm_mode_config mode_config;
    struct mutex object_name_lock;
    struct idr object_name_idr;
    struct drm_vma_offset_manager *vma_offset_manager;
    struct drm_vram_mm *vram_mm;
    enum switch_power_state switch_power_state;
    struct drm_fb_helper *fb_helper;
    struct dentry *debugfs_root;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">if_version</span></code></dt><dd><p>Highest interface version set</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ref</span></code></dt><dd><p>Object ref-count</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>Device structure of bus-device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dma_dev</span></code></dt><dd><p>Device for DMA operations. Only required if the device <strong>dev</strong>
cannot perform DMA by itself. Should be NULL otherwise. Call
<a class="reference internal" href="#c.drm_dev_dma_dev" title="drm_dev_dma_dev"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_dma_dev()</span></code></a> to get the DMA device instead of using this
field directly. Call <a class="reference internal" href="#c.drm_dev_set_dma_dev" title="drm_dev_set_dma_dev"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_set_dma_dev()</span></code></a> to set this field.</p>
<p>DRM devices are sometimes bound to virtual devices that cannot
perform DMA by themselves. Drivers should set this field to the
respective DMA controller.</p>
<p>Devices on USB and other peripheral busses also cannot perform
DMA by themselves. The <strong>dma_dev</strong> field should point the bus
controller that does DMA on behalve of such a device. Required
for importing buffers via dma-buf.</p>
<p>If set, the DRM core automatically releases the reference on the
device.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">managed</span></code></dt><dd><p>Managed resources linked to the lifetime of this <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> as
tracked by <strong>ref</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">driver</span></code></dt><dd><p>DRM driver managing the device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dev_private</span></code></dt><dd><p>DRM driver private data. This is deprecated and should be left set to
NULL.</p>
<p>Instead of using this pointer it is recommended that drivers use
<a class="reference internal" href="#c.devm_drm_dev_alloc" title="devm_drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_drm_dev_alloc()</span></code></a> and embed struct <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> in their larger
per-device structure.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">primary</span></code></dt><dd><p>Primary node. Drivers should not interact with this
directly. debugfs interfaces can be registered with
<a class="reference internal" href="drm-uapi.html#c.drm_debugfs_add_file" title="drm_debugfs_add_file"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_debugfs_add_file()</span></code></a>, and sysfs should be directly added on the
hardware (and not character device node) <a class="reference internal" href="../driver-api/infrastructure.html#c.device" title="device"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span></code></a> <strong>dev</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">render</span></code></dt><dd><p>Render node. Drivers should not interact with this directly ever.
Drivers should not expose any additional interfaces in debugfs or
sysfs on this node.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">accel</span></code></dt><dd><p>Compute Acceleration node</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">registered</span></code></dt><dd><p>Internally used by <a class="reference internal" href="#c.drm_dev_register" title="drm_dev_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_register()</span></code></a> and <a class="reference internal" href="drm-kms.html#c.drm_connector_register" title="drm_connector_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_connector_register()</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">master</span></code></dt><dd><p>Currently active master for this device.
Protected by <code class="xref c c-type docutils literal notranslate"><span class="pre">master_mutex</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">driver_features</span></code></dt><dd><p>per-device driver features</p>
<p>Drivers can clear specific flags here to disallow
certain features on a per-device basis while still
sharing a single <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_driver</span></code></a> instance across
all devices.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unplugged</span></code></dt><dd><p>Flag to tell if the device has been unplugged.
See <a class="reference internal" href="#c.drm_dev_enter" title="drm_dev_enter"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_enter()</span></code></a> and <a class="reference internal" href="#c.drm_dev_is_unplugged" title="drm_dev_is_unplugged"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_is_unplugged()</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">anon_inode</span></code></dt><dd><p>inode for private address-space</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unique</span></code></dt><dd><p>Unique name of the device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct_mutex</span></code></dt><dd><p>Lock for others (not <a class="reference internal" href="#c.drm_minor" title="drm_minor"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_minor.master</span></code></a> and <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_file.is_master</span></code></a>)</p>
<dl class="simple">
<dt>TODO: This lock used to be the BKL of the DRM subsystem. Move the</dt><dd><p>lock into i915, which is the only remaining user.</p>
</dd>
</dl>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">master_mutex</span></code></dt><dd><p>Lock for <a class="reference internal" href="#c.drm_minor" title="drm_minor"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_minor.master</span></code></a> and <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_file.is_master</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">open_count</span></code></dt><dd><p>Usage counter for outstanding files open,
protected by drm_global_mutex</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">filelist_mutex</span></code></dt><dd><p>Protects <strong>filelist</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">filelist</span></code></dt><dd><p>List of userspace clients, linked through <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_file.lhead</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">filelist_internal</span></code></dt><dd><p>List of open DRM files for in-kernel clients.
Protected by <code class="xref c c-type docutils literal notranslate"><span class="pre">filelist_mutex</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">clientlist_mutex</span></code></dt><dd><p>Protects <code class="xref c c-type docutils literal notranslate"><span class="pre">clientlist</span></code> access.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">clientlist</span></code></dt><dd><p>List of in-kernel clients. Protected by <code class="xref c c-type docutils literal notranslate"><span class="pre">clientlist_mutex</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vblank_disable_immediate</span></code></dt><dd><p>If true, vblank interrupt will be disabled immediately when the
refcount drops to zero, as opposed to via the vblank disable
timer.</p>
<p>This can be set to true it the hardware has a working vblank counter
with high-precision timestamping (otherwise there are races) and the
driver uses <a class="reference internal" href="drm-kms.html#c.drm_crtc_vblank_on" title="drm_crtc_vblank_on"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_crtc_vblank_on()</span></code></a> and <a class="reference internal" href="drm-kms.html#c.drm_crtc_vblank_off" title="drm_crtc_vblank_off"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_crtc_vblank_off()</span></code></a>
appropriately. Also, see <strong>max_vblank_count</strong>,
<a class="reference internal" href="drm-kms.html#c.drm_crtc_funcs" title="drm_crtc_funcs"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_crtc_funcs.get_vblank_counter</span></code></a> and
<a class="reference internal" href="drm-kms.html#c.drm_vblank_crtc_config" title="drm_vblank_crtc_config"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_vblank_crtc_config.disable_immediate</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vblank</span></code></dt><dd><p>Array of vblank tracking structures, one per <a class="reference internal" href="drm-kms.html#c.drm_crtc" title="drm_crtc"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_crtc</span></code></a>. For
historical reasons (vblank support predates kernel modesetting) this
is free-standing and not part of <a class="reference internal" href="drm-kms.html#c.drm_crtc" title="drm_crtc"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_crtc</span></code></a> itself. It must be
initialized explicitly by calling <a class="reference internal" href="drm-kms.html#c.drm_vblank_init" title="drm_vblank_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_vblank_init()</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vblank_time_lock</span></code></dt><dd><p>Protects vblank count and time updates during vblank enable/disable</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vbl_lock</span></code></dt><dd><p>Top-level vblank references lock, wraps the low-level
<strong>vblank_time_lock</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">max_vblank_count</span></code></dt><dd><p>Maximum value of the vblank registers. This value +1 will result in a
wrap-around of the vblank register. It is used by the vblank core to
handle wrap-arounds.</p>
<p>If set to zero the vblank core will try to guess the elapsed vblanks
between times when the vblank interrupt is disabled through
high-precision timestamps. That approach is suffering from small
races and imprecision over longer time periods, hence exposing a
hardware vblank counter is always recommended.</p>
<p>This is the statically configured device wide maximum. The driver
can instead choose to use a runtime configurable per-crtc value
<a class="reference internal" href="drm-kms.html#c.drm_vblank_crtc" title="drm_vblank_crtc"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_vblank_crtc.max_vblank_count</span></code></a>, in which case <strong>max_vblank_count</strong>
must be left at zero. See <a class="reference internal" href="drm-kms.html#c.drm_crtc_set_max_vblank_count" title="drm_crtc_set_max_vblank_count"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_crtc_set_max_vblank_count()</span></code></a> on how
to use the per-crtc value.</p>
<p>If non-zero, <a class="reference internal" href="drm-kms.html#c.drm_crtc_funcs" title="drm_crtc_funcs"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_crtc_funcs.get_vblank_counter</span></code></a> must be set.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vblank_event_list</span></code></dt><dd><p>List of vblank events</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event_lock</span></code></dt><dd><p>Protects <strong>vblank_event_list</strong> and event delivery in
general. See <a class="reference internal" href="#c.drm_send_event" title="drm_send_event"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event()</span></code></a> and <a class="reference internal" href="#c.drm_send_event_locked" title="drm_send_event_locked"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event_locked()</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_crtcs</span></code></dt><dd><p>Number of CRTCs on this device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">mode_config</span></code></dt><dd><p>Current mode config</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">object_name_lock</span></code></dt><dd><p>GEM information</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">object_name_idr</span></code></dt><dd><p>GEM information</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vma_offset_manager</span></code></dt><dd><p>GEM information</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vram_mm</span></code></dt><dd><p>VRAM MM memory manager</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">switch_power_state</span></code></dt><dd><p>Power state of the client.
Used by drivers supporting the switcheroo driver.
The state is maintained in the
<a class="reference internal" href="vga-switcheroo.html#c.vga_switcheroo_client_ops" title="vga_switcheroo_client_ops"><code class="xref c c-type docutils literal notranslate"><span class="pre">vga_switcheroo_client_ops.set_gpu_state</span></code></a> callback</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fb_helper</span></code></dt><dd><p>Pointer to the fbdev emulation structure.
Set by <a class="reference internal" href="drm-kms-helpers.html#c.drm_fb_helper_init" title="drm_fb_helper_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_fb_helper_init()</span></code></a> and cleared by <a class="reference internal" href="drm-kms-helpers.html#c.drm_fb_helper_fini" title="drm_fb_helper_fini"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_fb_helper_fini()</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">debugfs_root</span></code></dt><dd><p>Root directory for debugfs files.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>This structure represent a complete card that
may contain multiple heads.</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_dma_dev">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../driver-api/infrastructure.html#c.device" title="device"><span class="n"><span class="pre">device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_dma_dev</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_dma_dev" title="Link to this definition">¶</a><br /></dt>
<dd><p>returns the DMA device for a DRM device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns the DMA device of the given DRM device. By default, this
the DRM device’s parent. See <a class="reference internal" href="#c.drm_dev_set_dma_dev" title="drm_dev_set_dma_dev"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_set_dma_dev()</span></code></a>.</p>
<p><strong>Return</strong></p>
<p>A DMA-capable device for the DRM device.</p>
</div>
<dl class="c enum">
<dt class="sig sig-object c" id="c.drm_driver_feature">
<span class="k"><span class="pre">enum</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_driver_feature</span></span></span><a class="headerlink" href="#c.drm_driver_feature" title="Link to this definition">¶</a><br /></dt>
<dd><p>feature flags</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_GEM</span></code></dt><dd><p>Driver use the GEM memory manager. This should be set for all modern
drivers.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_MODESET</span></code></dt><dd><p>Driver supports mode setting interfaces (KMS).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_RENDER</span></code></dt><dd><p>Driver supports dedicated render nodes. See also the <a class="reference internal" href="drm-uapi.html#drm-render-node"><span class="std std-ref">section on
render nodes</span></a> for details.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_ATOMIC</span></code></dt><dd><p>Driver supports the full atomic modesetting userspace API. Drivers
which only use atomic internally, but do not support the full
userspace API (e.g. not all properties converted to atomic, or
multi-plane updates are not guaranteed to be tear-free) should not
set this flag.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_SYNCOBJ</span></code></dt><dd><p>Driver supports <a class="reference internal" href="drm-mm.html#c.drm_syncobj" title="drm_syncobj"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_syncobj</span></code></a> for explicit synchronization of command
submission.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_SYNCOBJ_TIMELINE</span></code></dt><dd><p>Driver supports the timeline flavor of <a class="reference internal" href="drm-mm.html#c.drm_syncobj" title="drm_syncobj"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_syncobj</span></code></a> for explicit
synchronization of command submission.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_COMPUTE_ACCEL</span></code></dt><dd><p>Driver supports compute acceleration devices. This flag is mutually exclusive with
<strong>DRIVER_RENDER</strong> and <strong>DRIVER_MODESET</strong>. Devices that support both graphics and compute
acceleration should be handled by two drivers that are connected using auxiliary bus.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_GEM_GPUVA</span></code></dt><dd><p>Driver supports user defined GPU VA bindings for GEM objects.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_CURSOR_HOTSPOT</span></code></dt><dd><p>Driver supports and requires cursor hotspot information in the
cursor plane (e.g. cursor plane has to actually track the mouse
cursor and the clients are required to set hotspot in order for
the cursor planes to work correctly).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_USE_AGP</span></code></dt><dd><p>Set up DRM AGP support, see drm_agp_init(), the DRM core will manage
AGP resources. New drivers don’t need this.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_LEGACY</span></code></dt><dd><p>Denote a legacy driver using shadow attach. Do not use.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_PCI_DMA</span></code></dt><dd><p>Driver is capable of PCI DMA, mapping of PCI DMA buffers to userspace
will be enabled. Only for legacy drivers. Do not use.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_SG</span></code></dt><dd><p>Driver can perform scatter/gather DMA, allocation and mapping of
scatter/gather buffers will be enabled. Only for legacy drivers. Do
not use.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_HAVE_DMA</span></code></dt><dd><p>Driver supports DMA, the userspace DMA API will be supported. Only
for legacy drivers. Do not use.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRIVER_HAVE_IRQ</span></code></dt><dd><p>Legacy irq support. Only for legacy drivers. Do not use.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>See <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.driver_features</span></code></a>, drm_device.driver_features and
<a class="reference internal" href="#c.drm_core_check_feature" title="drm_core_check_feature"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_core_check_feature()</span></code></a>.</p>
<dl class="c struct">
<dt class="sig sig-object c" id="c.drm_driver">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_driver</span></span></span><a class="headerlink" href="#c.drm_driver" title="Link to this definition">¶</a><br /></dt>
<dd><p>DRM driver structure</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct drm_driver {
    int (*load) (struct drm_device *, unsigned long flags);
    int (*open) (struct drm_device *, struct drm_file *);
    void (*postclose) (struct drm_device *, struct drm_file *);
    void (*unload) (struct drm_device *);
    void (*release) (struct drm_device *);
    void (*master_set)(struct drm_device *dev, struct drm_file *file_priv, bool from_open);
    void (*master_drop)(struct drm_device *dev, struct drm_file *file_priv);
    void (*debugfs_init)(struct drm_minor *minor);
    struct drm_gem_object *(*gem_create_object)(struct drm_device *dev, size_t size);
    int (*prime_handle_to_fd)(struct drm_device *dev, struct drm_file *file_priv, uint32_t handle, uint32_t flags, int *prime_fd);
    int (*prime_fd_to_handle)(struct drm_device *dev, struct drm_file *file_priv, int prime_fd, uint32_t *handle);
    struct drm_gem_object * (*gem_prime_import)(struct drm_device *dev, struct dma_buf *dma_buf);
    struct drm_gem_object *(*gem_prime_import_sg_table)(struct drm_device *dev,struct dma_buf_attachment *attach, struct sg_table *sgt);
    int (*dumb_create)(struct drm_file *file_priv,struct drm_device *dev, struct drm_mode_create_dumb *args);
    int (*dumb_map_offset)(struct drm_file *file_priv,struct drm_device *dev, uint32_t handle, uint64_t *offset);
    int (*fbdev_probe)(struct drm_fb_helper *fbdev_helper, struct drm_fb_helper_surface_size *sizes);
    void (*show_fdinfo)(struct drm_printer *p, struct drm_file *f);
    int major;
    int minor;
    int patchlevel;
    char *name;
    char *desc;
    u32 driver_features;
    const struct drm_ioctl_desc *ioctls;
    int num_ioctls;
    const struct file_operations *fops;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">load</span></code></dt><dd><p>Backward-compatible driver callback to complete initialization steps
after the driver is registered.  For this reason, may suffer from
race conditions and its use is deprecated for new drivers.  It is
therefore only supported for existing drivers not yet converted to
the new scheme.  See <a class="reference internal" href="#c.devm_drm_dev_alloc" title="devm_drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_drm_dev_alloc()</span></code></a> and <a class="reference internal" href="#c.drm_dev_register" title="drm_dev_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_register()</span></code></a> for
proper and race-free way to set up a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a>.</p>
<p>This is deprecated, do not use!</p>
<p>Returns:</p>
<p>Zero on success, non-zero value on failure.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">open</span></code></dt><dd><p>Driver callback when a new <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span></code></a> is opened. Useful for
setting up driver-private data structures like buffer allocators,
execution contexts or similar things. Such driver-private resources
must be released again in <strong>postclose</strong>.</p>
<p>Since the display/modeset side of DRM can only be owned by exactly
one <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span></code></a> (see <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_file.is_master</span></code></a> and <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.master</span></code></a>)
there should never be a need to set up any modeset related resources
in this callback. Doing so would be a driver design bug.</p>
<p>Returns:</p>
<p>0 on success, a negative error code on failure, which will be
promoted to userspace as the result of the open() system call.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">postclose</span></code></dt><dd><p>One of the driver callbacks when a new <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span></code></a> is closed.
Useful for tearing down driver-private data structures allocated in
<strong>open</strong> like buffer allocators, execution contexts or similar things.</p>
<p>Since the display/modeset side of DRM can only be owned by exactly
one <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span></code></a> (see <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_file.is_master</span></code></a> and <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.master</span></code></a>)
there should never be a need to tear down any modeset related
resources in this callback. Doing so would be a driver design bug.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unload</span></code></dt><dd><p>Reverse the effects of the driver load callback.  Ideally,
the clean up performed by the driver should happen in the
reverse order of the initialization.  Similarly to the load
hook, this handler is deprecated and its usage should be
dropped in favor of an open-coded teardown function at the
driver layer.  See <a class="reference internal" href="#c.drm_dev_unregister" title="drm_dev_unregister"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unregister()</span></code></a> and <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a>
for the proper way to remove a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a>.</p>
<p>The unload() hook is called right after unregistering
the device.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">release</span></code></dt><dd><p>Optional callback for destroying device data after the final
reference is released, i.e. the device is being destroyed.</p>
<p>This is deprecated, clean up all memory allocations associated with a
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> using <a class="reference internal" href="#c.drmm_add_action" title="drmm_add_action"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_add_action()</span></code></a>, <a class="reference internal" href="#c.drmm_kmalloc" title="drmm_kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kmalloc()</span></code></a> and related
managed resources functions.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">master_set</span></code></dt><dd><p>Called whenever the minor master is set. Only used by vmwgfx.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">master_drop</span></code></dt><dd><p>Called whenever the minor master is dropped. Only used by vmwgfx.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">debugfs_init</span></code></dt><dd><p>Allows drivers to create driver-specific debugfs files.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gem_create_object</span></code></dt><dd><p>constructor for gem objects</p>
<p>Hook for allocating the GEM object struct, for use by the CMA
and SHMEM GEM helpers. Returns a GEM object on success, or an
<a class="reference internal" href="../core-api/kernel-api.html#c.ERR_PTR" title="ERR_PTR"><code class="xref c c-func docutils literal notranslate"><span class="pre">ERR_PTR()</span></code></a>-encoded error code otherwise.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">prime_handle_to_fd</span></code></dt><dd><p>PRIME export function. Only used by vmwgfx.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">prime_fd_to_handle</span></code></dt><dd><p>PRIME import function. Only used by vmwgfx.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gem_prime_import</span></code></dt><dd><p>Import hook for GEM drivers.</p>
<p>This defaults to <a class="reference internal" href="drm-mm.html#c.drm_gem_prime_import" title="drm_gem_prime_import"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_gem_prime_import()</span></code></a> if not set.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gem_prime_import_sg_table</span></code></dt><dd><p>Optional hook used by the PRIME helper functions
<a class="reference internal" href="drm-mm.html#c.drm_gem_prime_import" title="drm_gem_prime_import"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_gem_prime_import()</span></code></a> respectively <a class="reference internal" href="drm-mm.html#c.drm_gem_prime_import_dev" title="drm_gem_prime_import_dev"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_gem_prime_import_dev()</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dumb_create</span></code></dt><dd><p>This creates a new dumb buffer in the driver’s backing storage manager (GEM,
TTM or something else entirely) and returns the resulting buffer handle. This
handle can then be wrapped up into a framebuffer modeset object.</p>
<p>Note that userspace is not allowed to use such objects for render
acceleration - drivers must create their own private ioctls for such a use
case.</p>
<p>Width, height and depth are specified in the <a class="reference internal" href="drm-uapi.html#c.drm_mode_create_dumb" title="drm_mode_create_dumb"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_mode_create_dumb</span></code></a>
argument. The callback needs to fill the handle, pitch and size for
the created buffer.</p>
<p>Called by the user via ioctl.</p>
<p>Returns:</p>
<p>Zero on success, negative errno on failure.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dumb_map_offset</span></code></dt><dd><p>Allocate an offset in the drm device node’s address space to be able to
memory map a dumb buffer.</p>
<p>The default implementation is <a class="reference internal" href="drm-mm.html#c.drm_gem_create_mmap_offset" title="drm_gem_create_mmap_offset"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_gem_create_mmap_offset()</span></code></a>. GEM based
drivers must not overwrite this.</p>
<p>Called by the user via ioctl.</p>
<p>Returns:</p>
<p>Zero on success, negative errno on failure.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fbdev_probe</span></code></dt><dd><p>Allocates and initialize the fb_info structure for fbdev emulation.
Furthermore it also needs to allocate the DRM framebuffer used to
back the fbdev.</p>
<p>This callback is mandatory for fbdev support.</p>
<p>Returns:</p>
<p>0 on success ot a negative error code otherwise.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">show_fdinfo</span></code></dt><dd><p>Print device specific fdinfo.  See <a class="reference internal" href="drm-usage-stats.html"><span class="doc">DRM client usage stats</span></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">major</span></code></dt><dd><p>driver major number</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">minor</span></code></dt><dd><p>driver minor number</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">patchlevel</span></code></dt><dd><p>driver patch level</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code></dt><dd><p>driver name</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">desc</span></code></dt><dd><p>driver description</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">driver_features</span></code></dt><dd><p>Driver features, see <a class="reference internal" href="#c.drm_driver_feature" title="drm_driver_feature"><code class="xref c c-type docutils literal notranslate"><span class="pre">enum</span> <span class="pre">drm_driver_feature</span></code></a>. Drivers can disable
some features on a per-instance basis using
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.driver_features</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ioctls</span></code></dt><dd><p>Array of driver-private IOCTL description entries. See the chapter on
<a class="reference internal" href="drm-uapi.html#drm-driver-ioctl"><span class="std std-ref">IOCTL support in the userland interfaces
chapter</span></a> for the full details.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_ioctls</span></code></dt><dd><p>Number of entries in <strong>ioctls</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fops</span></code></dt><dd><p>File operations for the DRM device node. See the discussion in
<a class="reference internal" href="#drm-driver-fops"><span class="std std-ref">file operations</span></a> for in-depth coverage and
some examples.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>This structure represent the common code for a family of cards. There will be
one <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a> for each card present in this family. It contains lots
of vfunc entries, and a pile of those probably should be moved to more
appropriate places like <a class="reference internal" href="drm-kms.html#c.drm_mode_config_funcs" title="drm_mode_config_funcs"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_mode_config_funcs</span></code></a> or into a new operations
structure for GEM drivers.</p>
<dl class="c macro">
<dt class="sig sig-object c" id="c.devm_drm_dev_alloc">
<span class="sig-name descname"><span class="n"><span class="pre">devm_drm_dev_alloc</span></span></span><a class="headerlink" href="#c.devm_drm_dev_alloc" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">devm_drm_dev_alloc</span> <span class="pre">(parent,</span> <span class="pre">driver,</span> <span class="pre">type,</span> <span class="pre">member)</span></code></p>
<blockquote>
<div><p>Resource managed allocation of a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> instance</p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">parent</span></code></dt><dd><p>Parent device object</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">driver</span></code></dt><dd><p>DRM driver</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>the type of the struct which contains struct <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">member</span></code></dt><dd><p>the name of the <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> within <strong>type</strong>.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This allocates and initialize a new DRM device. No device registration is done.
Call <a class="reference internal" href="#c.drm_dev_register" title="drm_dev_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_register()</span></code></a> to advertice the device to user space and register it
with other core subsystems. This should be done last in the device
initialization sequence to make sure userspace can’t access an inconsistent
state.</p>
<p>The initial ref-count of the object is 1. Use <a class="reference internal" href="#c.drm_dev_get" title="drm_dev_get"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_get()</span></code></a> and
<a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> to take and drop further ref-counts.</p>
<p>It is recommended that drivers embed <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a> into their own device
structure.</p>
<p>Note that this manages the lifetime of the resulting <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a>
automatically using devres. The DRM device initialized with this function is
automatically put on driver detach using <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a>.</p>
<p><strong>Return</strong></p>
<p>Pointer to new DRM device, or ERR_PTR on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_is_unplugged">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_is_unplugged</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_is_unplugged" title="Link to this definition">¶</a><br /></dt>
<dd><p>is a DRM device unplugged</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function can be called to check whether a hotpluggable is unplugged.
Unplugging itself is singalled through <a class="reference internal" href="#c.drm_dev_unplug" title="drm_dev_unplug"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unplug()</span></code></a>. If a device is
unplugged, these two functions guarantee that any store before calling
<a class="reference internal" href="#c.drm_dev_unplug" title="drm_dev_unplug"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unplug()</span></code></a> is visible to callers of this function after it completes</p>
<p>WARNING: This function fundamentally races against <a class="reference internal" href="#c.drm_dev_unplug" title="drm_dev_unplug"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unplug()</span></code></a>. It is
recommended that drivers instead use the underlying <a class="reference internal" href="#c.drm_dev_enter" title="drm_dev_enter"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_enter()</span></code></a> and
<a class="reference internal" href="#c.drm_dev_exit" title="drm_dev_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_exit()</span></code></a> function pairs.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_core_check_all_features">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_core_check_all_features</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="n"><span class="pre">u32</span></span><span class="w"> </span><span class="n"><span class="pre">features</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_core_check_all_features" title="Link to this definition">¶</a><br /></dt>
<dd><p>check driver feature flags mask</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device to check</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u32</span> <span class="pre">features</span></code></dt><dd><p>feature flag(s) mask</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This checks <strong>dev</strong> for driver features, see <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.driver_features</span></code></a>,
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.driver_features</span></code></a>, and the various <a class="reference internal" href="#c.drm_driver_feature" title="drm_driver_feature"><code class="xref c c-type docutils literal notranslate"><span class="pre">enum</span> <span class="pre">drm_driver_feature</span></code></a> flags.</p>
<p>Returns true if all features in the <strong>features</strong> mask are supported, false
otherwise.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_core_check_feature">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_core_check_feature</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">enum</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_driver_feature" title="drm_driver_feature"><span class="n"><span class="pre">drm_driver_feature</span></span></a><span class="w"> </span><span class="n"><span class="pre">feature</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_core_check_feature" title="Link to this definition">¶</a><br /></dt>
<dd><p>check driver feature flags</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device to check</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">enum</span> <span class="pre">drm_driver_feature</span> <span class="pre">feature</span></code></dt><dd><p>feature flag</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This checks <strong>dev</strong> for driver features, see <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.driver_features</span></code></a>,
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.driver_features</span></code></a>, and the various <a class="reference internal" href="#c.drm_driver_feature" title="drm_driver_feature"><code class="xref c c-type docutils literal notranslate"><span class="pre">enum</span> <span class="pre">drm_driver_feature</span></code></a> flags.</p>
<p>Returns true if the <strong>feature</strong> is supported, false otherwise.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_drv_uses_atomic_modeset">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_drv_uses_atomic_modeset</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_drv_uses_atomic_modeset" title="Link to this definition">¶</a><br /></dt>
<dd><p>check if the driver implements atomic_commit()</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This check is useful if drivers do not have DRIVER_ATOMIC set but
have atomic modesetting internally implemented.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_put_dev">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_put_dev</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_put_dev" title="Link to this definition">¶</a><br /></dt>
<dd><p>Unregister and release a DRM device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Called at module unload time or when a PCI device is unplugged.</p>
<p>Cleans up all DRM device, calling drm_lastclose().</p>
<p><strong>Note</strong></p>
<p>Use of this function is deprecated. It will eventually go away
completely.  Please use <a class="reference internal" href="#c.drm_dev_unregister" title="drm_dev_unregister"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unregister()</span></code></a> and <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> explicitly
instead to make sure that the device isn’t userspace accessible any more
while teardown is in progress, ensuring that userspace can’t access an
inconsistent state.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_enter">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_enter</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">idx</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_enter" title="Link to this definition">¶</a><br /></dt>
<dd><p>Enter device critical section</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">*idx</span></code></dt><dd><p>Pointer to index that will be passed to the matching <a class="reference internal" href="#c.drm_dev_exit" title="drm_dev_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_exit()</span></code></a></p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function marks and protects the beginning of a section that should not
be entered after the device has been unplugged. The section end is marked
with <a class="reference internal" href="#c.drm_dev_exit" title="drm_dev_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_exit()</span></code></a>. Calls to this function can be nested.</p>
<p><strong>Return</strong></p>
<p>True if it is OK to enter the section, false otherwise.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_exit">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_exit</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">idx</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_exit" title="Link to this definition">¶</a><br /></dt>
<dd><p>Exit device critical section</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">idx</span></code></dt><dd><p>index returned from <a class="reference internal" href="#c.drm_dev_enter" title="drm_dev_enter"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_enter()</span></code></a></p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function marks the end of a section that should not be entered after
the device has been unplugged.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_unplug">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_unplug</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_unplug" title="Link to this definition">¶</a><br /></dt>
<dd><p>unplug a DRM device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This unplugs a hotpluggable DRM device, which makes it inaccessible to
userspace operations. Entry-points can use <a class="reference internal" href="#c.drm_dev_enter" title="drm_dev_enter"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_enter()</span></code></a> and
<a class="reference internal" href="#c.drm_dev_exit" title="drm_dev_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_exit()</span></code></a> to protect device resources in a race free manner. This
essentially unregisters the device like <a class="reference internal" href="#c.drm_dev_unregister" title="drm_dev_unregister"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unregister()</span></code></a>, but can be
called while there are still open users of <strong>dev</strong>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_set_dma_dev">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_set_dma_dev</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../driver-api/infrastructure.html#c.device" title="device"><span class="n"><span class="pre">device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dma_dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_set_dma_dev" title="Link to this definition">¶</a><br /></dt>
<dd><p>set the DMA device for a DRM device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*dma_dev</span></code></dt><dd><p>DMA device or NULL</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Sets the DMA device of the given DRM device. Only required if
the DMA device is different from the DRM device’s parent. After
calling this function, the DRM device holds a reference on
<strong>dma_dev</strong>. Pass NULL to clear the DMA device.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_wedged_event">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_wedged_event</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">long</span></span><span class="w"> </span><span class="n"><span class="pre">method</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_wedged_event" title="Link to this definition">¶</a><br /></dt>
<dd><p>generate a device wedged uevent</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span> <span class="pre">method</span></code></dt><dd><p>method(s) to be used for recovery</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This generates a device wedged uevent for the DRM device specified by <strong>dev</strong>.
Recovery <strong>method</strong>(s) of choice will be sent in the uevent environment as
<code class="docutils literal notranslate"><span class="pre">WEDGED=&lt;method1&gt;[,..,&lt;methodN&gt;]</span></code> in order of less to more side-effects.
If caller is unsure about recovery or <strong>method</strong> is unknown (0),
<code class="docutils literal notranslate"><span class="pre">WEDGED=unknown</span></code> will be sent instead.</p>
<p>Refer to “Device Wedging” chapter in <a class="reference internal" href="drm-uapi.html"><span class="doc">Userland interfaces</span></a> for more
details.</p>
<p><strong>Return</strong></p>
<p>0 on success, negative error code otherwise.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.__drm_dev_alloc">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">__drm_dev_alloc</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../driver-api/infrastructure.html#c.device" title="device"><span class="n"><span class="pre">device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">parent</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_driver" title="drm_driver"><span class="n"><span class="pre">drm_driver</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">driver</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">size</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">offset</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.__drm_dev_alloc" title="Link to this definition">¶</a><br /></dt>
<dd><p>Allocation of a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> instance</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*parent</span></code></dt><dd><p>Parent device object</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">drm_driver</span> <span class="pre">*driver</span></code></dt><dd><p>DRM driver</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">size</span></code></dt><dd><p>the size of the struct which contains <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">offset</span></code></dt><dd><p>the offset of the <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> within the container.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This should <em>NOT</em> be by any drivers, but is a dedicated interface for the
corresponding Rust abstraction.</p>
<p>This is the same as <a class="reference internal" href="#c.devm_drm_dev_alloc" title="devm_drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_drm_dev_alloc()</span></code></a>, but without the corresponding
resource management through the parent device, but not the same as
<a class="reference internal" href="#c.drm_dev_alloc" title="drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_alloc()</span></code></a>, since the latter is the deprecated version, which does not
support subclassing.</p>
<p><strong>Return</strong></p>
<p>A pointer to new DRM device, or an ERR_PTR on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_alloc">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_alloc</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_driver" title="drm_driver"><span class="n"><span class="pre">drm_driver</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">driver</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../driver-api/infrastructure.html#c.device" title="device"><span class="n"><span class="pre">device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">parent</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_alloc" title="Link to this definition">¶</a><br /></dt>
<dd><p>Allocate new DRM device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">drm_driver</span> <span class="pre">*driver</span></code></dt><dd><p>DRM driver to allocate device for</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*parent</span></code></dt><dd><p>Parent device object</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is the deprecated version of <a class="reference internal" href="#c.devm_drm_dev_alloc" title="devm_drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_drm_dev_alloc()</span></code></a>, which does not support
subclassing through embedding the struct <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> in a driver private
structure, and which does not support automatic cleanup through devres.</p>
<p><strong>Return</strong></p>
<p>Pointer to new DRM device, or ERR_PTR on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_get">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_get</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_get" title="Link to this definition">¶</a><br /></dt>
<dd><p>Take reference of a DRM device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>device to take reference of or NULL</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This increases the ref-count of <strong>dev</strong> by one. You <em>must</em> already own a
reference when calling this. Use <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> to drop this reference
again.</p>
<p>This function never fails. However, this function does not provide <em>any</em>
guarantee whether the device is alive or running. It only provides a
reference to the object and the memory associated with it.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_put">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_put</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_put" title="Link to this definition">¶</a><br /></dt>
<dd><p>Drop reference of a DRM device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>device to drop reference of or NULL</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This decreases the ref-count of <strong>dev</strong> by one. The device is destroyed if the
ref-count drops to zero.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drmm_cgroup_register_region">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">dmem_cgroup_region</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">drmm_cgroup_register_region</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">region_name</span></span>, <span class="n"><span class="pre">u64</span></span><span class="w"> </span><span class="n"><span class="pre">size</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drmm_cgroup_register_region" title="Link to this definition">¶</a><br /></dt>
<dd><p>Register a region of a DRM device to cgroups</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>device for region</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*region_name</span></code></dt><dd><p>Region name for registering</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u64</span> <span class="pre">size</span></code></dt><dd><p>Size of region in bytes</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This decreases the ref-count of <strong>dev</strong> by one. The device is destroyed if the
ref-count drops to zero.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_register">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_register</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">long</span></span><span class="w"> </span><span class="n"><span class="pre">flags</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_register" title="Link to this definition">¶</a><br /></dt>
<dd><p>Register DRM device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>Device to register</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span> <span class="pre">flags</span></code></dt><dd><p>Flags passed to the driver’s .load() function</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Register the DRM device <strong>dev</strong> with the system, advertise device to user-space
and start normal device operation. <strong>dev</strong> must be initialized via drm_dev_init()
previously.</p>
<p>Never call this twice on any device!</p>
<p><strong>NOTE</strong></p>
<p>To ensure backward compatibility with existing drivers method this
function calls the <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.load</span></code></a> method after registering the device
nodes, creating race conditions. Usage of the <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.load</span></code></a> methods is
therefore deprecated, drivers must perform all initialization before calling
<a class="reference internal" href="#c.drm_dev_register" title="drm_dev_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_register()</span></code></a>.</p>
<p><strong>Return</strong></p>
<p>0 on success, negative error code on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dev_unregister">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dev_unregister</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dev_unregister" title="Link to this definition">¶</a><br /></dt>
<dd><p>Unregister DRM device</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>Device to unregister</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Unregister the DRM device from the system. This does the reverse of
<a class="reference internal" href="#c.drm_dev_register" title="drm_dev_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_register()</span></code></a> but does not deallocate the device. The caller must call
<a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> to drop their final reference, unless it is managed with devres
(as devices allocated with <a class="reference internal" href="#c.devm_drm_dev_alloc" title="devm_drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_drm_dev_alloc()</span></code></a> are), in which case there is
already an unwind action registered.</p>
<p>A special form of unregistering for hotpluggable devices is <a class="reference internal" href="#c.drm_dev_unplug" title="drm_dev_unplug"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_unplug()</span></code></a>,
which can be called while there are still open users of <strong>dev</strong>.</p>
<p>This should be called first in the device teardown code to make sure
userspace can’t access the device instance any more.</p>
</div>
</section>
<section id="driver-load">
<h3>Driver Load<a class="headerlink" href="#driver-load" title="Link to this heading">¶</a></h3>
<section id="component-helper-usage">
<h4>Component Helper Usage<a class="headerlink" href="#component-helper-usage" title="Link to this heading">¶</a></h4>
<p>DRM drivers that drive hardware where a logical device consists of a pile of
independent hardware blocks are recommended to use the <a class="reference internal" href="../driver-api/component.html#component"><span class="std std-ref">component helper
library</span></a>. For consistency and better options for code reuse the
following guidelines apply:</p>
<blockquote>
<div><ul class="simple">
<li><p>The entire device initialization procedure should be run from the
<a class="reference internal" href="../driver-api/component.html#c.component_master_ops" title="component_master_ops"><code class="xref c c-type docutils literal notranslate"><span class="pre">component_master_ops.master_bind</span></code></a> callback, starting with
<a class="reference internal" href="#c.devm_drm_dev_alloc" title="devm_drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_drm_dev_alloc()</span></code></a>, then binding all components with
<a class="reference internal" href="../driver-api/component.html#c.component_bind_all" title="component_bind_all"><code class="xref c c-func docutils literal notranslate"><span class="pre">component_bind_all()</span></code></a> and finishing with <a class="reference internal" href="#c.drm_dev_register" title="drm_dev_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_register()</span></code></a>.</p></li>
<li><p>The opaque pointer passed to all components through <a class="reference internal" href="../driver-api/component.html#c.component_bind_all" title="component_bind_all"><code class="xref c c-func docutils literal notranslate"><span class="pre">component_bind_all()</span></code></a>
should point at <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a> of the device instance, not some driver
specific private structure.</p></li>
<li><p>The component helper fills the niche where further standardization of
interfaces is not practical. When there already is, or will be, a
standardized interface like <a class="reference internal" href="drm-kms-helpers.html#c.drm_bridge" title="drm_bridge"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_bridge</span></code></a> or <a class="reference internal" href="drm-kms-helpers.html#c.drm_panel" title="drm_panel"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_panel</span></code></a>, providing its own
functions to find such components at driver load time, like
<a class="reference internal" href="drm-kms-helpers.html#c.drm_of_find_panel_or_bridge" title="drm_of_find_panel_or_bridge"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_of_find_panel_or_bridge()</span></code></a>, then the component helper should not be
used.</p></li>
</ul>
</div></blockquote>
</section>
<section id="memory-manager-initialization">
<h4>Memory Manager Initialization<a class="headerlink" href="#memory-manager-initialization" title="Link to this heading">¶</a></h4>
<p>Every DRM driver requires a memory manager which must be initialized at
load time. DRM currently contains two memory managers, the Translation
Table Manager (TTM) and the Graphics Execution Manager (GEM). This
document describes the use of the GEM memory manager only. See ? for
details.</p>
</section>
<section id="miscellaneous-device-configuration">
<h4>Miscellaneous Device Configuration<a class="headerlink" href="#miscellaneous-device-configuration" title="Link to this heading">¶</a></h4>
<p>Another task that may be necessary for PCI devices during configuration
is mapping the video BIOS. On many devices, the VBIOS describes device
configuration, LCD panel timings (if any), and contains flags indicating
device state. Mapping the BIOS can be done using the <a class="reference internal" href="../driver-api/pci/pci.html#c.pci_map_rom" title="pci_map_rom"><code class="xref c c-func docutils literal notranslate"><span class="pre">pci_map_rom()</span></code></a>
call, a convenience function that takes care of mapping the actual ROM,
whether it has been shadowed into memory (typically at address 0xc0000)
or exists on the PCI device in the ROM BAR. Note that after the ROM has
been mapped and any necessary information has been extracted, it should
be unmapped; on many devices, the ROM address decoder is shared with
other BARs, so leaving it mapped could cause undesired behaviour like
hangs or memory corruption.</p>
</section>
</section>
<section id="managed-resources">
<h3>Managed Resources<a class="headerlink" href="#managed-resources" title="Link to this heading">¶</a></h3>
<p>Inspired by struct <a class="reference internal" href="../driver-api/infrastructure.html#c.device" title="device"><code class="xref c c-type docutils literal notranslate"><span class="pre">device</span></code></a> managed resources, but tied to the lifetime of
struct <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a>, which can outlive the underlying physical device, usually
when userspace has some open files and other handles to resources still open.</p>
<p>Release actions can be added with <a class="reference internal" href="#c.drmm_add_action" title="drmm_add_action"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_add_action()</span></code></a>, memory allocations can
be done directly with <a class="reference internal" href="#c.drmm_kmalloc" title="drmm_kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kmalloc()</span></code></a> and the related functions. Everything
will be released on the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> in reverse order of how the
release actions have been added and memory has been allocated since driver
loading started with <a class="reference internal" href="#c.devm_drm_dev_alloc" title="devm_drm_dev_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">devm_drm_dev_alloc()</span></code></a>.</p>
<p>Note that release actions and managed memory can also be added and removed
during the lifetime of the driver, all the functions are fully concurrent
safe. But it is recommended to use managed resources only for resources that
change rarely, if ever, during the lifetime of the <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> instance.</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.drmm_release_action">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drmm_release_action</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="n"><span class="pre">drmres_release_t</span></span><span class="w"> </span><span class="n"><span class="pre">action</span></span>, <span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">data</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drmm_release_action" title="Link to this definition">¶</a><br /></dt>
<dd><p>release a managed action from a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a></p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">drmres_release_t</span> <span class="pre">action</span></code></dt><dd><p>function which would be called when <strong>dev</strong> is released</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*data</span></code></dt><dd><p>opaque pointer, passed to <strong>action</strong></p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function calls the <strong>action</strong> previously added by <a class="reference internal" href="#c.drmm_add_action" title="drmm_add_action"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_add_action()</span></code></a>
immediately.
The <strong>action</strong> is removed from the list of cleanup actions for <strong>dev</strong>,
which means that it won’t be called in the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drmm_kmalloc">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">drmm_kmalloc</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">size</span></span>, <span class="n"><span class="pre">gfp_t</span></span><span class="w"> </span><span class="n"><span class="pre">gfp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drmm_kmalloc" title="Link to this definition">¶</a><br /></dt>
<dd><p><a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed <a class="reference internal" href="../core-api/mm-api.html#c.kmalloc" title="kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc()</span></code></a></p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">size</span></code></dt><dd><p>size of the memory allocation</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gfp_t</span> <span class="pre">gfp</span></code></dt><dd><p>GFP allocation flags</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed version of <a class="reference internal" href="../core-api/mm-api.html#c.kmalloc" title="kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc()</span></code></a>. The allocated memory is
automatically freed on the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a>. Memory can also be freed
before the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> by calling <a class="reference internal" href="#c.drmm_kfree" title="drmm_kfree"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kfree()</span></code></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drmm_kstrdup">
<span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">drmm_kstrdup</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">s</span></span>, <span class="n"><span class="pre">gfp_t</span></span><span class="w"> </span><span class="n"><span class="pre">gfp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drmm_kstrdup" title="Link to this definition">¶</a><br /></dt>
<dd><p><a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed <a class="reference internal" href="../core-api/kernel-api.html#c.kstrdup" title="kstrdup"><code class="xref c c-func docutils literal notranslate"><span class="pre">kstrdup()</span></code></a></p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*s</span></code></dt><dd><p>0-terminated string to be duplicated</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gfp_t</span> <span class="pre">gfp</span></code></dt><dd><p>GFP allocation flags</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed version of <a class="reference internal" href="../core-api/kernel-api.html#c.kstrdup" title="kstrdup"><code class="xref c c-func docutils literal notranslate"><span class="pre">kstrdup()</span></code></a>. The allocated memory is
automatically freed on the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> and works exactly like a
memory allocation obtained by <a class="reference internal" href="#c.drmm_kmalloc" title="drmm_kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kmalloc()</span></code></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drmm_kfree">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drmm_kfree</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">data</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drmm_kfree" title="Link to this definition">¶</a><br /></dt>
<dd><p><a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed <a class="reference internal" href="../core-api/mm-api.html#c.kfree" title="kfree"><code class="xref c c-func docutils literal notranslate"><span class="pre">kfree()</span></code></a></p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*data</span></code></dt><dd><p>memory allocation to be freed</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed version of <a class="reference internal" href="../core-api/mm-api.html#c.kfree" title="kfree"><code class="xref c c-func docutils literal notranslate"><span class="pre">kfree()</span></code></a> which can be used to
release memory allocated through <a class="reference internal" href="#c.drmm_kmalloc" title="drmm_kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kmalloc()</span></code></a> or any of its related
functions before the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> of <strong>dev</strong>.</p>
</div>
<dl class="c macro">
<dt class="sig sig-object c" id="c.drmm_add_action">
<span class="sig-name descname"><span class="n"><span class="pre">drmm_add_action</span></span></span><a class="headerlink" href="#c.drmm_add_action" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">drmm_add_action</span> <span class="pre">(dev,</span> <span class="pre">action,</span> <span class="pre">data)</span></code></p>
<blockquote>
<div><p>add a managed release action to a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a></p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">action</span></code></dt><dd><p>function which should be called when <strong>dev</strong> is released</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">data</span></code></dt><dd><p>opaque pointer, passed to <strong>action</strong></p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function adds the <strong>release</strong> action with optional parameter <strong>data</strong> to the
list of cleanup actions for <strong>dev</strong>. The cleanup actions will be run in reverse
order in the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> call for <strong>dev</strong>.</p>
</div>
<dl class="c macro">
<dt class="sig sig-object c" id="c.drmm_add_action_or_reset">
<span class="sig-name descname"><span class="n"><span class="pre">drmm_add_action_or_reset</span></span></span><a class="headerlink" href="#c.drmm_add_action_or_reset" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">drmm_add_action_or_reset</span> <span class="pre">(dev,</span> <span class="pre">action,</span> <span class="pre">data)</span></code></p>
<blockquote>
<div><p>add a managed release action to a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a></p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">action</span></code></dt><dd><p>function which should be called when <strong>dev</strong> is released</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">data</span></code></dt><dd><p>opaque pointer, passed to <strong>action</strong></p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Similar to <a class="reference internal" href="#c.drmm_add_action" title="drmm_add_action"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_add_action()</span></code></a>, with the only difference that upon failure
<strong>action</strong> is directly called for any cleanup work necessary on failures.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drmm_kzalloc">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">drmm_kzalloc</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">size</span></span>, <span class="n"><span class="pre">gfp_t</span></span><span class="w"> </span><span class="n"><span class="pre">gfp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drmm_kzalloc" title="Link to this definition">¶</a><br /></dt>
<dd><p><a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed <a class="reference internal" href="../core-api/mm-api.html#c.kzalloc" title="kzalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kzalloc()</span></code></a></p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">size</span></code></dt><dd><p>size of the memory allocation</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gfp_t</span> <span class="pre">gfp</span></code></dt><dd><p>GFP allocation flags</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed version of <a class="reference internal" href="../core-api/mm-api.html#c.kzalloc" title="kzalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kzalloc()</span></code></a>. The allocated memory is
automatically freed on the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a>. Memory can also be freed
before the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> by calling <a class="reference internal" href="#c.drmm_kfree" title="drmm_kfree"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kfree()</span></code></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drmm_kmalloc_array">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">drmm_kmalloc_array</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">n</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">size</span></span>, <span class="n"><span class="pre">gfp_t</span></span><span class="w"> </span><span class="n"><span class="pre">flags</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drmm_kmalloc_array" title="Link to this definition">¶</a><br /></dt>
<dd><p><a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed <a class="reference internal" href="../core-api/mm-api.html#c.kmalloc_array" title="kmalloc_array"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc_array()</span></code></a></p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">n</span></code></dt><dd><p>number of array elements to allocate</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">size</span></code></dt><dd><p>size of array member</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gfp_t</span> <span class="pre">flags</span></code></dt><dd><p>GFP allocation flags</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed version of <a class="reference internal" href="../core-api/mm-api.html#c.kmalloc_array" title="kmalloc_array"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc_array()</span></code></a>. The allocated
memory is automatically freed on the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> and works exactly
like a memory allocation obtained by <a class="reference internal" href="#c.drmm_kmalloc" title="drmm_kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kmalloc()</span></code></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drmm_kcalloc">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">drmm_kcalloc</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">n</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">size</span></span>, <span class="n"><span class="pre">gfp_t</span></span><span class="w"> </span><span class="n"><span class="pre">flags</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drmm_kcalloc" title="Link to this definition">¶</a><br /></dt>
<dd><p><a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed <a class="reference internal" href="../core-api/mm-api.html#c.kcalloc" title="kcalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kcalloc()</span></code></a></p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">n</span></code></dt><dd><p>number of array elements to allocate</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">size</span></code></dt><dd><p>size of array member</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gfp_t</span> <span class="pre">flags</span></code></dt><dd><p>GFP allocation flags</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a> managed version of <a class="reference internal" href="../core-api/mm-api.html#c.kcalloc" title="kcalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kcalloc()</span></code></a>. The allocated memory is
automatically freed on the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a> and works exactly like a
memory allocation obtained by <a class="reference internal" href="#c.drmm_kmalloc" title="drmm_kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kmalloc()</span></code></a>.</p>
</div>
<dl class="c macro">
<dt class="sig sig-object c" id="c.drmm_mutex_init">
<span class="sig-name descname"><span class="n"><span class="pre">drmm_mutex_init</span></span></span><a class="headerlink" href="#c.drmm_mutex_init" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">drmm_mutex_init</span> <span class="pre">(dev,</span> <span class="pre">lock)</span></code></p>
<blockquote>
<div><p><a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a>-managed <a class="reference internal" href="../kernel-hacking/locking.html#c.mutex_init" title="mutex_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">mutex_init()</span></code></a></p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">lock</span></code></dt><dd><p>lock to be initialized</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>0 on success, or a negative errno code otherwise.</p>
<p><strong>Description</strong></p>
<p>This is a <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device</span></code></a>-managed version of <a class="reference internal" href="../kernel-hacking/locking.html#c.mutex_init" title="mutex_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">mutex_init()</span></code></a>. The initialized
lock is automatically destroyed on the final <a class="reference internal" href="#c.drm_dev_put" title="drm_dev_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_put()</span></code></a>.</p>
</div>
</section>
</section>
<section id="open-close-file-operations-and-ioctls">
<h2>Open/Close, File Operations and IOCTLs<a class="headerlink" href="#open-close-file-operations-and-ioctls" title="Link to this heading">¶</a></h2>
<section id="file-operations">
<span id="drm-driver-fops"></span><h3>File Operations<a class="headerlink" href="#file-operations" title="Link to this heading">¶</a></h3>
<p>Drivers must define the file operations structure that forms the DRM
userspace API entry point, even though most of those operations are
implemented in the DRM core. The resulting <code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file_operations</span></code> must be
stored in the <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.fops</span></code></a> field. The mandatory functions are <a class="reference internal" href="#c.drm_open" title="drm_open"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_open()</span></code></a>,
<a class="reference internal" href="#c.drm_read" title="drm_read"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_read()</span></code></a>, <a class="reference internal" href="drm-uapi.html#c.drm_ioctl" title="drm_ioctl"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_ioctl()</span></code></a> and <a class="reference internal" href="drm-uapi.html#c.drm_compat_ioctl" title="drm_compat_ioctl"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_compat_ioctl()</span></code></a> if CONFIG_COMPAT is enabled
Note that drm_compat_ioctl will be NULL if CONFIG_COMPAT=n, so there’s no
need to sprinkle #ifdef into the code. Drivers which implement private ioctls
that require 32/64 bit compatibility support must provide their own
<code class="xref c c-type docutils literal notranslate"><span class="pre">file_operations.compat_ioctl</span></code> handler that processes private ioctls and calls
<a class="reference internal" href="drm-uapi.html#c.drm_compat_ioctl" title="drm_compat_ioctl"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_compat_ioctl()</span></code></a> for core ioctls.</p>
<p>In addition <a class="reference internal" href="#c.drm_read" title="drm_read"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_read()</span></code></a> and <a class="reference internal" href="#c.drm_poll" title="drm_poll"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_poll()</span></code></a> provide support for DRM events. DRM
events are a generic and extensible means to send asynchronous events to
userspace through the file descriptor. They are used to send vblank event and
page flip completions by the KMS API. But drivers can also use it for their
own needs, e.g. to signal completion of rendering.</p>
<p>For the driver-side event interface see <a class="reference internal" href="#c.drm_event_reserve_init" title="drm_event_reserve_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_event_reserve_init()</span></code></a> and
<a class="reference internal" href="#c.drm_send_event" title="drm_send_event"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event()</span></code></a> as the main starting points.</p>
<p>The memory mapping implementation will vary depending on how the driver
manages memory. For GEM-based drivers this is <a class="reference internal" href="drm-mm.html#c.drm_gem_mmap" title="drm_gem_mmap"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_gem_mmap()</span></code></a>.</p>
<p>No other file operations are supported by the DRM userspace API. Overall the
following is an example <code class="xref c c-type docutils literal notranslate"><span class="pre">file_operations</span></code> structure:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static const example_drm_fops = {
        .owner = THIS_MODULE,
        .open = drm_open,
        .release = drm_release,
        .unlocked_ioctl = drm_ioctl,
        .compat_ioctl = drm_compat_ioctl, // NULL if CONFIG_COMPAT=n
        .poll = drm_poll,
        .read = drm_read,
        .mmap = drm_gem_mmap,
};
</pre></div>
</div>
<p>For plain GEM based drivers there is the <a class="reference internal" href="drm-mm.html#c.DEFINE_DRM_GEM_FOPS" title="DEFINE_DRM_GEM_FOPS"><code class="xref c c-func docutils literal notranslate"><span class="pre">DEFINE_DRM_GEM_FOPS()</span></code></a> macro, and for
DMA based drivers there is the <a class="reference internal" href="drm-mm.html#c.DEFINE_DRM_GEM_DMA_FOPS" title="DEFINE_DRM_GEM_DMA_FOPS"><code class="xref c c-func docutils literal notranslate"><span class="pre">DEFINE_DRM_GEM_DMA_FOPS()</span></code></a> macro to make this
simpler.</p>
<p>The driver’s <code class="xref c c-type docutils literal notranslate"><span class="pre">file_operations</span></code> must be stored in <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.fops</span></code></a>.</p>
<p>For driver-private IOCTL handling see the more detailed discussion in
<a class="reference internal" href="drm-uapi.html#drm-driver-ioctl"><span class="std std-ref">IOCTL support in the userland interfaces chapter</span></a>.</p>
<dl class="c struct">
<dt class="sig sig-object c" id="c.drm_minor">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_minor</span></span></span><a class="headerlink" href="#c.drm_minor" title="Link to this definition">¶</a><br /></dt>
<dd><p>DRM device minor structure</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct drm_minor {
};
</pre></div>
</div>
<p><strong>Members</strong></p>
</div>
<p><strong>Description</strong></p>
<p>This structure represents a DRM minor number for device nodes in /dev.
Entirely opaque to drivers and should never be inspected directly by drivers.
Drivers instead should only interact with <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span></code></a> and of course
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a>, which is also where driver-private data and resources can
be attached to.</p>
<dl class="c struct">
<dt class="sig sig-object c" id="c.drm_pending_event">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_pending_event</span></span></span><a class="headerlink" href="#c.drm_pending_event" title="Link to this definition">¶</a><br /></dt>
<dd><p>Event queued up for userspace to read</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct drm_pending_event {
    struct completion *completion;
    void (*completion_release)(struct completion *completion);
    struct drm_event *event;
    struct dma_fence *fence;
    struct drm_file *file_priv;
    struct list_head link;
    struct list_head pending_link;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">completion</span></code></dt><dd><p>Optional pointer to a kernel internal completion signalled when
<a class="reference internal" href="#c.drm_send_event" title="drm_send_event"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event()</span></code></a> is called, useful to internally synchronize with
nonblocking operations.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">completion_release</span></code></dt><dd><p>Optional callback currently only used by the atomic modeset helpers
to clean up the reference count for the structure <strong>completion</strong> is
stored in.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event</span></code></dt><dd><p>Pointer to the actual event that should be sent to userspace to be
read using <a class="reference internal" href="#c.drm_read" title="drm_read"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_read()</span></code></a>. Can be optional, since nowadays events are
also used to signal kernel internal threads with <strong>completion</strong> or DMA
transactions using <strong>fence</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fence</span></code></dt><dd><p>Optional DMA fence to unblock other hardware transactions which
depend upon the nonblocking DRM operation this event represents.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">file_priv</span></code></dt><dd><p><a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span></code></a> where <strong>event</strong> should be delivered to. Only set when
<strong>event</strong> is set.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">link</span></code></dt><dd><p>Double-linked list to keep track of this event. Can be used by the
driver up to the point when it calls <a class="reference internal" href="#c.drm_send_event" title="drm_send_event"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event()</span></code></a>, after that
this list entry is owned by the core for its own book-keeping.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending_link</span></code></dt><dd><p>Entry on <a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_file.pending_event_list</span></code></a>, to keep track of all pending
events for <strong>file_priv</strong>, to allow correct unwinding of them when
userspace closes the file before the event is delivered.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>This represents a DRM event. Drivers can use this as a generic completion
mechanism, which supports kernel-internal <code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">completion</span></code>, <a class="reference internal" href="../driver-api/dma-buf.html#c.dma_fence" title="dma_fence"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dma_fence</span></code></a>
and also the DRM-specific <a class="reference internal" href="drm-uapi.html#c.drm_event" title="drm_event"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_event</span></code></a> delivery mechanism.</p>
<dl class="c struct">
<dt class="sig sig-object c" id="c.drm_file">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_file</span></span></span><a class="headerlink" href="#c.drm_file" title="Link to this definition">¶</a><br /></dt>
<dd><p>DRM file private data</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct drm_file {
    bool authenticated;
    bool stereo_allowed;
    bool universal_planes;
    bool atomic;
    bool aspect_ratio_allowed;
    bool writeback_connectors;
    bool was_master;
    bool is_master;
    bool supports_virtualized_cursor_plane;
    struct drm_master *master;
    spinlock_t master_lookup_lock;
    struct pid __rcu *pid;
    u64 client_id;
    drm_magic_t magic;
    struct list_head lhead;
    struct drm_minor *minor;
    struct idr object_idr;
    spinlock_t table_lock;
    struct idr syncobj_idr;
    spinlock_t syncobj_table_lock;
    struct file *filp;
    void *driver_priv;
    struct list_head fbs;
    struct mutex fbs_lock;
    struct list_head blobs;
    wait_queue_head_t event_wait;
    struct list_head pending_event_list;
    struct list_head event_list;
    int event_space;
    struct mutex event_read_lock;
    struct drm_prime_file_private prime;
    const char *client_name;
    struct mutex client_name_lock;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">authenticated</span></code></dt><dd><p>Whether the client is allowed to submit rendering, which for legacy
nodes means it must be authenticated.</p>
<p>See also the <a class="reference internal" href="drm-uapi.html#drm-primary-node"><span class="std std-ref">section on primary nodes and authentication</span></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">stereo_allowed</span></code></dt><dd><p>True when the client has asked us to expose stereo 3D mode flags.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">universal_planes</span></code></dt><dd><p>True if client understands CRTC primary planes and cursor planes
in the plane list. Automatically set when <strong>atomic</strong> is set.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">atomic</span></code></dt><dd><p>True if client understands atomic properties.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">aspect_ratio_allowed</span></code></dt><dd><p>True, if client can handle picture aspect ratios, and has requested
to pass this information along with the mode.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">writeback_connectors</span></code></dt><dd><p>True if client understands writeback connectors</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">was_master</span></code></dt><dd><p>This client has or had, master capability. Protected by struct
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.master_mutex</span></code></a>.</p>
<p>This is used to ensure that CAP_SYS_ADMIN is not enforced, if the
client is or was master in the past.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">is_master</span></code></dt><dd><p>This client is the creator of <strong>master</strong>. Protected by struct
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.master_mutex</span></code></a>.</p>
<p>See also the <a class="reference internal" href="drm-uapi.html#drm-primary-node"><span class="std std-ref">section on primary nodes and authentication</span></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">supports_virtualized_cursor_plane</span></code></dt><dd><p>This client is capable of handling the cursor plane with the
restrictions imposed on it by the virtualized drivers.</p>
<p>This implies that the cursor plane has to behave like a cursor
i.e. track cursor movement. It also requires setting of the
hotspot properties by the client on the cursor plane.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">master</span></code></dt><dd><p>Master this node is currently associated with. Protected by struct
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.master_mutex</span></code></a>, and serialized by <strong>master_lookup_lock</strong>.</p>
<p>Only relevant if <a class="reference internal" href="#c.drm_is_primary_client" title="drm_is_primary_client"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_is_primary_client()</span></code></a> returns true. Note that
this only matches <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.master</span></code></a> if the master is the currently
active one.</p>
<p>To update <strong>master</strong>, both <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.master_mutex</span></code></a> and
<strong>master_lookup_lock</strong> need to be held, therefore holding either of
them is safe and enough for the read side.</p>
<p>When dereferencing this pointer, either hold struct
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.master_mutex</span></code></a> for the duration of the pointer’s use, or
use <a class="reference internal" href="drm-uapi.html#c.drm_file_get_master" title="drm_file_get_master"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_file_get_master()</span></code></a> if struct <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.master_mutex</span></code></a> is not
currently held and there is no other need to hold it. This prevents
<strong>master</strong> from being freed during use.</p>
<p>See also <strong>authentication</strong> and <strong>is_master</strong> and the <a class="reference internal" href="drm-uapi.html#drm-primary-node"><span class="std std-ref">section on
primary nodes and authentication</span></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">master_lookup_lock</span></code></dt><dd><p>Serializes <strong>master</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pid</span></code></dt><dd><p>Process that is using this file.</p>
<p>Must only be dereferenced under a rcu_read_lock or equivalent.</p>
<p>Updates are guarded with dev-&gt;filelist_mutex and reference must be
dropped after a RCU grace period to accommodate lockless readers.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">client_id</span></code></dt><dd><p>A unique id for fdinfo</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">magic</span></code></dt><dd><p>Authentication magic, see <strong>authenticated</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">lhead</span></code></dt><dd><p>List of all open files of a DRM device, linked into
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.filelist</span></code></a>. Protected by <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.filelist_mutex</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">minor</span></code></dt><dd><p><a class="reference internal" href="#c.drm_minor" title="drm_minor"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_minor</span></code></a> for this file.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">object_idr</span></code></dt><dd><p>Mapping of mm object handles to object pointers. Used by the GEM
subsystem. Protected by <strong>table_lock</strong>.</p>
<p>Note that allocated entries might be NULL as a transient state when
creating or deleting a handle.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">table_lock</span></code></dt><dd><p>Protects <strong>object_idr</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">syncobj_idr</span></code></dt><dd><p>Mapping of sync object handles to object pointers.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">syncobj_table_lock</span></code></dt><dd><p>Protects <strong>syncobj_idr</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">filp</span></code></dt><dd><p>Pointer to the core file structure.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">driver_priv</span></code></dt><dd><p>Optional pointer for driver private data. Can be allocated in
<a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.open</span></code></a> and should be freed in <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.postclose</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fbs</span></code></dt><dd><p>List of <a class="reference internal" href="drm-kms.html#c.drm_framebuffer" title="drm_framebuffer"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_framebuffer</span></code></a> associated with this file, using the
<a class="reference internal" href="drm-kms.html#c.drm_framebuffer" title="drm_framebuffer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_framebuffer.filp_head</span></code></a> entry.</p>
<p>Protected by <strong>fbs_lock</strong>. Note that the <strong>fbs</strong> list holds a reference on
the framebuffer object to prevent it from untimely disappearing.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fbs_lock</span></code></dt><dd><p>Protects <strong>fbs</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">blobs</span></code></dt><dd><p>User-created blob properties; this retains a reference on the
property.</p>
<p>Protected by <strong>drm_mode_config.blob_lock</strong>;</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event_wait</span></code></dt><dd><p>Waitqueue for new events added to <strong>event_list</strong>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending_event_list</span></code></dt><dd><p>List of pending <a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_pending_event</span></code></a>, used to clean up pending
events in case this file gets closed before the event is signalled.
Uses the <a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_pending_event.pending_link</span></code></a> entry.</p>
<p>Protect by <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.event_lock</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event_list</span></code></dt><dd><p>List of <a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_pending_event</span></code></a>, ready for delivery to userspace
through <a class="reference internal" href="#c.drm_read" title="drm_read"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_read()</span></code></a>. Uses the <a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_pending_event.link</span></code></a> entry.</p>
<p>Protect by <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.event_lock</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event_space</span></code></dt><dd><p>Available event space to prevent userspace from
exhausting kernel memory. Currently limited to the fairly arbitrary
value of 4KB.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event_read_lock</span></code></dt><dd><p>Serializes <a class="reference internal" href="#c.drm_read" title="drm_read"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_read()</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">prime</span></code></dt><dd><p>Per-file buffer caches used by the PRIME buffer sharing code.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">client_name</span></code></dt><dd><p>Userspace-provided name; useful for accounting and debugging.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">client_name_lock</span></code></dt><dd><p>Protects <strong>client_name</strong>.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>This structure tracks DRM state per open file descriptor.</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_is_primary_client">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_is_primary_client</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_file" title="drm_file"><span class="n"><span class="pre">drm_file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">file_priv</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_is_primary_client" title="Link to this definition">¶</a><br /></dt>
<dd><p>is this an open file of the primary node</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">drm_file</span> <span class="pre">*file_priv</span></code></dt><dd><p>DRM file</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns true if this is an open file of the primary node, i.e.
<a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_file.minor</span></code></a> of <strong>file_priv</strong> is a primary minor.</p>
<p>See also the <a class="reference internal" href="drm-uapi.html#drm-primary-node"><span class="std std-ref">section on primary nodes and authentication</span></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_is_render_client">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_is_render_client</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_file" title="drm_file"><span class="n"><span class="pre">drm_file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">file_priv</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_is_render_client" title="Link to this definition">¶</a><br /></dt>
<dd><p>is this an open file of the render node</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">drm_file</span> <span class="pre">*file_priv</span></code></dt><dd><p>DRM file</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns true if this is an open file of the render node, i.e.
<a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_file.minor</span></code></a> of <strong>file_priv</strong> is a render minor.</p>
<p>See also the <a class="reference internal" href="drm-uapi.html#drm-render-node"><span class="std std-ref">section on render nodes</span></a>.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_is_accel_client">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_is_accel_client</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_file" title="drm_file"><span class="n"><span class="pre">drm_file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">file_priv</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_is_accel_client" title="Link to this definition">¶</a><br /></dt>
<dd><p>is this an open file of the compute acceleration node</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">drm_file</span> <span class="pre">*file_priv</span></code></dt><dd><p>DRM file</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns true if this is an open file of the compute acceleration node, i.e.
<a class="reference internal" href="#c.drm_file" title="drm_file"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_file.minor</span></code></a> of <strong>file_priv</strong> is a accel minor.</p>
<p>See also <a class="reference internal" href="../accel/introduction.html"><span class="doc">Introduction to compute accelerators subsystem</span></a>.</p>
</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.drm_memory_stats">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_memory_stats</span></span></span><a class="headerlink" href="#c.drm_memory_stats" title="Link to this definition">¶</a><br /></dt>
<dd><p>GEM object stats associated</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct drm_memory_stats {
    u64 shared;
    u64 private;
    u64 resident;
    u64 purgeable;
    u64 active;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">shared</span></code></dt><dd><p>Total size of GEM objects shared between processes</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">private</span></code></dt><dd><p>Total size of GEM objects</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">resident</span></code></dt><dd><p>Total size of GEM objects backing pages</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">purgeable</span></code></dt><dd><p>Total size of GEM objects that can be purged (resident and not active)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">active</span></code></dt><dd><p>Total size of GEM objects active on one or more engines</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>Used by <a class="reference internal" href="#c.drm_print_memory_stats" title="drm_print_memory_stats"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_print_memory_stats()</span></code></a></p>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_open">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_open</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_open" title="inode"><span class="n"><span class="pre">inode</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">inode</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../filesystems/api-summary.html#c.file" title="file"><span class="n"><span class="pre">file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">filp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_open" title="Link to this definition">¶</a><br /></dt>
<dd><p>open method for DRM file</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">inode</span> <span class="pre">*inode</span></code></dt><dd><p>device inode</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file</span> <span class="pre">*filp</span></code></dt><dd><p>file pointer.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function must be used by drivers as their <code class="xref c c-type docutils literal notranslate"><span class="pre">file_operations.open</span></code> method.
It looks up the correct DRM device and instantiates all the per-file
resources for it. It also calls the <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.open</span></code></a> driver callback.</p>
<p><strong>Return</strong></p>
<p>0 on success or negative errno value on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_release">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_release</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_release" title="inode"><span class="n"><span class="pre">inode</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">inode</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../filesystems/api-summary.html#c.file" title="file"><span class="n"><span class="pre">file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">filp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_release" title="Link to this definition">¶</a><br /></dt>
<dd><p>release method for DRM file</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">inode</span> <span class="pre">*inode</span></code></dt><dd><p>device inode</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file</span> <span class="pre">*filp</span></code></dt><dd><p>file pointer.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function must be used by drivers as their <code class="xref c c-type docutils literal notranslate"><span class="pre">file_operations.release</span></code>
method. It frees any resources associated with the open file. If this
is the last open file for the DRM device, it also restores the active
in-kernel DRM client.</p>
<p><strong>Return</strong></p>
<p>Always succeeds and returns 0.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_release_noglobal">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_release_noglobal</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_release_noglobal" title="inode"><span class="n"><span class="pre">inode</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">inode</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../filesystems/api-summary.html#c.file" title="file"><span class="n"><span class="pre">file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">filp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_release_noglobal" title="Link to this definition">¶</a><br /></dt>
<dd><p>release method for DRM file</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">inode</span> <span class="pre">*inode</span></code></dt><dd><p>device inode</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file</span> <span class="pre">*filp</span></code></dt><dd><p>file pointer.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function may be used by drivers as their <code class="xref c c-type docutils literal notranslate"><span class="pre">file_operations.release</span></code>
method. It frees any resources associated with the open file prior to taking
the drm_global_mutex. If this is the last open file for the DRM device, it
then restores the active in-kernel DRM client.</p>
<p><strong>Return</strong></p>
<p>Always succeeds and returns 0.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_read">
<span class="n"><span class="pre">ssize_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_read</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../filesystems/api-summary.html#c.file" title="file"><span class="n"><span class="pre">file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">filp</span></span>, <span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="pre">__user</span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">buffer</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">count</span></span>, <span class="n"><span class="pre">loff_t</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">offset</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_read" title="Link to this definition">¶</a><br /></dt>
<dd><p>read method for DRM file</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file</span> <span class="pre">*filp</span></code></dt><dd><p>file pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">__user</span> <span class="pre">*buffer</span></code></dt><dd><p>userspace destination pointer for the read</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">count</span></code></dt><dd><p>count in bytes to read</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">loff_t</span> <span class="pre">*offset</span></code></dt><dd><p>offset to read</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function must be used by drivers as their <code class="xref c c-type docutils literal notranslate"><span class="pre">file_operations.read</span></code>
method if they use DRM events for asynchronous signalling to userspace.
Since events are used by the KMS API for vblank and page flip completion this
means all modern display drivers must use it.</p>
<p><strong>offset</strong> is ignored, DRM events are read like a pipe. Polling support is
provided by <a class="reference internal" href="#c.drm_poll" title="drm_poll"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_poll()</span></code></a>.</p>
<p>This function will only ever read a full event. Therefore userspace must
supply a big enough buffer to fit any event to ensure forward progress. Since
the maximum event space is currently 4K it’s recommended to just use that for
safety.</p>
<p><strong>Return</strong></p>
<p>Number of bytes read (always aligned to full events, and can be 0) or a
negative error code on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_poll">
<span class="n"><span class="pre">__poll_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_poll</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../filesystems/api-summary.html#c.file" title="file"><span class="n"><span class="pre">file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">filp</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">poll_table_struct</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">wait</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_poll" title="Link to this definition">¶</a><br /></dt>
<dd><p>poll method for DRM file</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file</span> <span class="pre">*filp</span></code></dt><dd><p>file pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">poll_table_struct</span> <span class="pre">*wait</span></code></dt><dd><p>poll waiter table</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function must be used by drivers as their <code class="xref c c-type docutils literal notranslate"><span class="pre">file_operations.read</span></code> method
if they use DRM events for asynchronous signalling to userspace.  Since
events are used by the KMS API for vblank and page flip completion this means
all modern display drivers must use it.</p>
<p>See also <a class="reference internal" href="#c.drm_read" title="drm_read"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_read()</span></code></a>.</p>
<p><strong>Return</strong></p>
<p>Mask of POLL flags indicating the current status of the file.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_event_reserve_init_locked">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_event_reserve_init_locked</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_file" title="drm_file"><span class="n"><span class="pre">drm_file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">file_priv</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><span class="n"><span class="pre">drm_pending_event</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="drm-uapi.html#c.drm_event" title="drm_event"><span class="n"><span class="pre">drm_event</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">e</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_event_reserve_init_locked" title="Link to this definition">¶</a><br /></dt>
<dd><p>init a DRM event and reserve space for it</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span> <span class="pre">*file_priv</span></code></dt><dd><p>DRM file private data</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_pending_event</span> <span class="pre">*p</span></code></dt><dd><p>tracking structure for the pending event</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_event</span> <span class="pre">*e</span></code></dt><dd><p>actual event data to deliver to userspace</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function prepares the passed in event for eventual delivery. If the event
doesn’t get delivered (because the IOCTL fails later on, before queuing up
anything) then the even must be cancelled and freed using
<a class="reference internal" href="#c.drm_event_cancel_free" title="drm_event_cancel_free"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_event_cancel_free()</span></code></a>. Successfully initialized events should be sent out
using <a class="reference internal" href="#c.drm_send_event" title="drm_send_event"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event()</span></code></a> or <a class="reference internal" href="#c.drm_send_event_locked" title="drm_send_event_locked"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event_locked()</span></code></a> to signal completion of the
asynchronous event to userspace.</p>
<p>If callers embedded <strong>p</strong> into a larger structure it must be allocated with
kmalloc and <strong>p</strong> must be the first member element.</p>
<p>This is the locked version of <a class="reference internal" href="#c.drm_event_reserve_init" title="drm_event_reserve_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_event_reserve_init()</span></code></a> for callers which
already hold <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.event_lock</span></code></a>.</p>
<p><strong>Return</strong></p>
<p>0 on success or a negative error code on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_event_reserve_init">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_event_reserve_init</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_file" title="drm_file"><span class="n"><span class="pre">drm_file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">file_priv</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><span class="n"><span class="pre">drm_pending_event</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="drm-uapi.html#c.drm_event" title="drm_event"><span class="n"><span class="pre">drm_event</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">e</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_event_reserve_init" title="Link to this definition">¶</a><br /></dt>
<dd><p>init a DRM event and reserve space for it</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span> <span class="pre">*file_priv</span></code></dt><dd><p>DRM file private data</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_pending_event</span> <span class="pre">*p</span></code></dt><dd><p>tracking structure for the pending event</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_event</span> <span class="pre">*e</span></code></dt><dd><p>actual event data to deliver to userspace</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function prepares the passed in event for eventual delivery. If the event
doesn’t get delivered (because the IOCTL fails later on, before queuing up
anything) then the even must be cancelled and freed using
<a class="reference internal" href="#c.drm_event_cancel_free" title="drm_event_cancel_free"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_event_cancel_free()</span></code></a>. Successfully initialized events should be sent out
using <a class="reference internal" href="#c.drm_send_event" title="drm_send_event"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event()</span></code></a> or <a class="reference internal" href="#c.drm_send_event_locked" title="drm_send_event_locked"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event_locked()</span></code></a> to signal completion of the
asynchronous event to userspace.</p>
<p>If callers embedded <strong>p</strong> into a larger structure it must be allocated with
kmalloc and <strong>p</strong> must be the first member element.</p>
<p>Callers which already hold <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.event_lock</span></code></a> should use
<a class="reference internal" href="#c.drm_event_reserve_init_locked" title="drm_event_reserve_init_locked"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_event_reserve_init_locked()</span></code></a> instead.</p>
<p><strong>Return</strong></p>
<p>0 on success or a negative error code on failure.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_event_cancel_free">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_event_cancel_free</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><span class="n"><span class="pre">drm_pending_event</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_event_cancel_free" title="Link to this definition">¶</a><br /></dt>
<dd><p>free a DRM event and release its space</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_pending_event</span> <span class="pre">*p</span></code></dt><dd><p>tracking structure for the pending event</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function frees the event <strong>p</strong> initialized with <a class="reference internal" href="#c.drm_event_reserve_init" title="drm_event_reserve_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_event_reserve_init()</span></code></a>
and releases any allocated space. It is used to cancel an event when the
nonblocking operation could not be submitted and needed to be aborted.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_send_event_timestamp_locked">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_send_event_timestamp_locked</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><span class="n"><span class="pre">drm_pending_event</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">e</span></span>, <span class="n"><span class="pre">ktime_t</span></span><span class="w"> </span><span class="n"><span class="pre">timestamp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_send_event_timestamp_locked" title="Link to this definition">¶</a><br /></dt>
<dd><p>send DRM event to file descriptor</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_pending_event</span> <span class="pre">*e</span></code></dt><dd><p>DRM event to deliver</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ktime_t</span> <span class="pre">timestamp</span></code></dt><dd><p>timestamp to set for the fence event in kernel’s CLOCK_MONOTONIC
time domain</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function sends the event <strong>e</strong>, initialized with <a class="reference internal" href="#c.drm_event_reserve_init" title="drm_event_reserve_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_event_reserve_init()</span></code></a>,
to its associated userspace DRM file. Callers must already hold
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.event_lock</span></code></a>.</p>
<p>Note that the core will take care of unlinking and disarming events when the
corresponding DRM file is closed. Drivers need not worry about whether the
DRM file for this event still exists and can call this function upon
completion of the asynchronous work unconditionally.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_send_event_locked">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_send_event_locked</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><span class="n"><span class="pre">drm_pending_event</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">e</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_send_event_locked" title="Link to this definition">¶</a><br /></dt>
<dd><p>send DRM event to file descriptor</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_pending_event</span> <span class="pre">*e</span></code></dt><dd><p>DRM event to deliver</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function sends the event <strong>e</strong>, initialized with <a class="reference internal" href="#c.drm_event_reserve_init" title="drm_event_reserve_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_event_reserve_init()</span></code></a>,
to its associated userspace DRM file. Callers must already hold
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.event_lock</span></code></a>, see <a class="reference internal" href="#c.drm_send_event" title="drm_send_event"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event()</span></code></a> for the unlocked version.</p>
<p>Note that the core will take care of unlinking and disarming events when the
corresponding DRM file is closed. Drivers need not worry about whether the
DRM file for this event still exists and can call this function upon
completion of the asynchronous work unconditionally.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_send_event">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_send_event</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_pending_event" title="drm_pending_event"><span class="n"><span class="pre">drm_pending_event</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">e</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_send_event" title="Link to this definition">¶</a><br /></dt>
<dd><p>send DRM event to file descriptor</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*dev</span></code></dt><dd><p>DRM device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_pending_event</span> <span class="pre">*e</span></code></dt><dd><p>DRM event to deliver</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function sends the event <strong>e</strong>, initialized with <a class="reference internal" href="#c.drm_event_reserve_init" title="drm_event_reserve_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_event_reserve_init()</span></code></a>,
to its associated userspace DRM file. This function acquires
<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_device.event_lock</span></code></a>, see <a class="reference internal" href="#c.drm_send_event_locked" title="drm_send_event_locked"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_send_event_locked()</span></code></a> for callers which already
hold this lock.</p>
<p>Note that the core will take care of unlinking and disarming events when the
corresponding DRM file is closed. Drivers need not worry about whether the
DRM file for this event still exists and can call this function upon
completion of the asynchronous work unconditionally.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_print_memory_stats">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_print_memory_stats</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_memory_stats" title="drm_memory_stats"><span class="n"><span class="pre">drm_memory_stats</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">stats</span></span>, <span class="k"><span class="pre">enum</span></span><span class="w"> </span><a class="reference internal" href="drm-mm.html#c.drm_gem_object_status" title="drm_gem_object_status"><span class="n"><span class="pre">drm_gem_object_status</span></span></a><span class="w"> </span><span class="n"><span class="pre">supported_status</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">region</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_print_memory_stats" title="Link to this definition">¶</a><br /></dt>
<dd><p>A helper to print memory stats</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>The printer to print output to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">drm_memory_stats</span> <span class="pre">*stats</span></code></dt><dd><p>The collected memory stats</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">enum</span> <span class="pre">drm_gem_object_status</span> <span class="pre">supported_status</span></code></dt><dd><p>Bitmask of optional stats which are available</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*region</span></code></dt><dd><p>The memory region</p>
</dd>
</dl>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_show_memory_stats">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_show_memory_stats</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_file" title="drm_file"><span class="n"><span class="pre">drm_file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">file</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_show_memory_stats" title="Link to this definition">¶</a><br /></dt>
<dd><p>Helper to collect and show standard fdinfo memory stats</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>the printer to print output to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span> <span class="pre">*file</span></code></dt><dd><p>the DRM file</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Helper to iterate over GEM objects with a handle allocated in the specified
file.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_show_fdinfo">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_show_fdinfo</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">seq_file</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">m</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../filesystems/api-summary.html#c.file" title="file"><span class="n"><span class="pre">file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">f</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_show_fdinfo" title="Link to this definition">¶</a><br /></dt>
<dd><p>helper for drm file fops</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">seq_file</span> <span class="pre">*m</span></code></dt><dd><p>output stream</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file</span> <span class="pre">*f</span></code></dt><dd><p>the device file instance</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Helper to implement fdinfo, for userspace to query usage stats, etc, of a
process using the GPU.  See also <a class="reference internal" href="#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_driver.show_fdinfo</span></code></a>.</p>
<p>For text output format description please see <a class="reference internal" href="drm-usage-stats.html"><span class="doc">DRM client usage stats</span></a></p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_file_err">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_file_err</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_file" title="drm_file"><span class="n"><span class="pre">drm_file</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">file_priv</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">fmt</span></span>, <span class="p"><span class="pre">...</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_file_err" title="Link to this definition">¶</a><br /></dt>
<dd><p>log process name, pid and client_name associated with a drm_file</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_file</span> <span class="pre">*file_priv</span></code></dt><dd><p>context of interest for process name and pid</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*fmt</span></code></dt><dd><p>printf() like format string</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">...</span></code></dt><dd><p>variable arguments</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Helper function for clients which needs to log process details such
as name and pid etc along with user logs.</p>
</div>
</section>
</section>
<section id="misc-utilities">
<h2>Misc Utilities<a class="headerlink" href="#misc-utilities" title="Link to this heading">¶</a></h2>
<section id="printer">
<h3>Printer<a class="headerlink" href="#printer" title="Link to this heading">¶</a></h3>
<p>A simple wrapper for dev_printk(), seq_printf(), etc.  Allows same
debug code to be used for both debugfs and printk logging.</p>
<p>For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void log_some_info(struct drm_printer *p)
{
        drm_printf(p, &quot;foo=%d\n&quot;, foo);
        drm_printf(p, &quot;bar=%d\n&quot;, bar);
}

#ifdef CONFIG_DEBUG_FS
void debugfs_show(struct seq_file *f)
{
        struct drm_printer p = drm_seq_file_printer(f);
        log_some_info(&amp;p);
}
#endif

void some_other_function(...)
{
        struct drm_printer p = drm_info_printer(drm-&gt;dev);
        log_some_info(&amp;p);
}
</pre></div>
</div>
<dl class="c enum">
<dt class="sig sig-object c" id="c.drm_debug_category">
<span class="k"><span class="pre">enum</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_debug_category</span></span></span><a class="headerlink" href="#c.drm_debug_category" title="Link to this definition">¶</a><br /></dt>
<dd><p>The DRM debug categories</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_CORE</span></code></dt><dd><p>Used in the generic drm code: drm_ioctl.c, drm_mm.c,
drm_memory.c, ...</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_DRIVER</span></code></dt><dd><p>Used in the vendor specific part of the driver: i915,
radeon, ... macro.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_KMS</span></code></dt><dd><p>Used in the modesetting code.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_PRIME</span></code></dt><dd><p>Used in the prime code.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_ATOMIC</span></code></dt><dd><p>Used in the atomic code.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_VBL</span></code></dt><dd><p>Used for verbose debug message in the vblank code.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_STATE</span></code></dt><dd><p>Used for verbose atomic state debugging.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_LEASE</span></code></dt><dd><p>Used in the lease code.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_DP</span></code></dt><dd><p>Used in the DP code.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DRM_UT_DRMRES</span></code></dt><dd><p>Used in the drm managed resources code.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>Each of the DRM debug logging macros use a specific category, and the logging
is filtered by the drm.debug module parameter. This enum specifies the values
for the interface.</p>
<p>Each DRM_DEBUG_&lt;CATEGORY&gt; macro logs to DRM_UT_&lt;CATEGORY&gt; category, except
DRM_DEBUG() logs to DRM_UT_CORE.</p>
<p>Enabling verbose debug messages is done through the drm.debug parameter, each
category being enabled by a bit:</p>
<blockquote>
<div><ul class="simple">
<li><p>drm.debug=0x1 will enable CORE messages</p></li>
<li><p>drm.debug=0x2 will enable DRIVER messages</p></li>
<li><p>drm.debug=0x3 will enable CORE and DRIVER messages</p></li>
<li><p>...</p></li>
<li><p>drm.debug=0x1ff will enable all messages</p></li>
</ul>
</div></blockquote>
<p>An interesting feature is that it’s possible to enable verbose logging at
run-time by echoing the debug value in its sysfs node:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo 0xf &gt; /sys/module/drm/parameters/debug
</pre></div>
</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.drm_printer">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_printer</span></span></span><a class="headerlink" href="#c.drm_printer" title="Link to this definition">¶</a><br /></dt>
<dd><p>drm output “stream”</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct drm_printer {
};
</pre></div>
</div>
<p><strong>Members</strong></p>
</div>
<p><strong>Description</strong></p>
<p>Do not use struct members directly.  Use drm_printer_seq_file(),
drm_printer_info(), etc to initialize.  And <a class="reference internal" href="#c.drm_printf" title="drm_printf"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_printf()</span></code></a> for output.</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_vprintf">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_vprintf</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">fmt</span></span>, <span class="n"><span class="pre">va_list</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">va</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_vprintf" title="Link to this definition">¶</a><br /></dt>
<dd><p>print to a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> stream</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>the <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*fmt</span></code></dt><dd><p>format string</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">va_list</span> <span class="pre">*va</span></code></dt><dd><p>the va_list</p>
</dd>
</dl>
</div>
<dl class="c macro">
<dt class="sig sig-object c" id="c.drm_printf_indent">
<span class="sig-name descname"><span class="n"><span class="pre">drm_printf_indent</span></span></span><a class="headerlink" href="#c.drm_printf_indent" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">drm_printf_indent</span> <span class="pre">(printer,</span> <span class="pre">indent,</span> <span class="pre">fmt,</span> <span class="pre">...)</span></code></p>
<blockquote>
<div><p>Print to a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> stream with indentation</p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">printer</span></code></dt><dd><p>DRM printer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">indent</span></code></dt><dd><p>Tab indentation level (max 5)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fmt</span></code></dt><dd><p>Format string</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">...</span></code></dt><dd><p>variable arguments</p>
</dd>
</dl>
</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.drm_print_iterator">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_print_iterator</span></span></span><a class="headerlink" href="#c.drm_print_iterator" title="Link to this definition">¶</a><br /></dt>
<dd><p>local struct used with drm_printer_coredump</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct drm_print_iterator {
    void *data;
    ssize_t start;
    ssize_t remain;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">data</span></code></dt><dd><p>Pointer to the devcoredump output buffer, can be NULL if using
drm_printer_coredump to determine size of devcoredump</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">start</span></code></dt><dd><p>The offset within the buffer to start writing</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">remain</span></code></dt><dd><p>The number of bytes to write for this iteration</p>
</dd>
</dl>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_coredump_printer">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_coredump_printer</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_print_iterator" title="drm_print_iterator"><span class="n"><span class="pre">drm_print_iterator</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">iter</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_coredump_printer" title="Link to this definition">¶</a><br /></dt>
<dd><p>construct a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> that can output to a buffer from the read function for devcoredump</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_print_iterator</span> <span class="pre">*iter</span></code></dt><dd><p>A pointer to a <a class="reference internal" href="#c.drm_print_iterator" title="drm_print_iterator"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_print_iterator</span></code></a> for the read instance</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This wrapper extends <a class="reference internal" href="#c.drm_printf" title="drm_printf"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_printf()</span></code></a> to work with a <a class="reference internal" href="../process/debugging/driver_development_debugging_guide.html#c.dev_coredumpm" title="dev_coredumpm"><code class="xref c c-func docutils literal notranslate"><span class="pre">dev_coredumpm()</span></code></a> callback
function. The passed in drm_print_iterator struct contains the buffer
pointer, size and offset as passed in from devcoredump.</p>
<p>For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void coredump_read(char *buffer, loff_t offset, size_t count,
        void *data, size_t datalen)
{
        struct drm_print_iterator iter;
        struct drm_printer p;

        iter.data = buffer;
        iter.start = offset;
        iter.remain = count;

        p = drm_coredump_printer(&amp;iter);

        drm_printf(p, &quot;foo=%d\n&quot;, foo);
}

void makecoredump(...)
{
        ...
        dev_coredumpm(dev, THIS_MODULE, data, 0, GFP_KERNEL,
                coredump_read, ...)
}
</pre></div>
</div>
<p>The above example has a time complexity of O(N^2), where N is the size of the
devcoredump. This is acceptable for small devcoredumps but scales poorly for
larger ones.</p>
<p>Another use case for drm_coredump_printer is to capture the devcoredump into
a saved buffer before the dev_coredump() callback. This involves two passes:
one to determine the size of the devcoredump and another to print it to a
buffer. Then, in dev_coredump(), copy from the saved buffer into the
devcoredump read buffer.</p>
<p>For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>char *devcoredump_saved_buffer;

ssize_t __coredump_print(char *buffer, ssize_t count, ...)
{
        struct drm_print_iterator iter;
        struct drm_printer p;

        iter.data = buffer;
        iter.start = 0;
        iter.remain = count;

        p = drm_coredump_printer(&amp;iter);

        drm_printf(p, &quot;foo=%d\n&quot;, foo);
        ...
        return count - iter.remain;
}

void coredump_print(...)
{
        ssize_t count;

        count = __coredump_print(NULL, INT_MAX, ...);
        devcoredump_saved_buffer = kvmalloc(count, GFP_KERNEL);
        __coredump_print(devcoredump_saved_buffer, count, ...);
}

void coredump_read(char *buffer, loff_t offset, size_t count,
                   void *data, size_t datalen)
{
        ...
        memcpy(buffer, devcoredump_saved_buffer + offset, count);
        ...
}
</pre></div>
</div>
<p>The above example has a time complexity of O(N*2), where N is the size of the
devcoredump. This scales better than the previous example for larger
devcoredumps.</p>
<p><strong>Return</strong></p>
<p>The <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> object</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_coredump_printer_is_full">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_coredump_printer_is_full</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_coredump_printer_is_full" title="Link to this definition">¶</a><br /></dt>
<dd><p>DRM coredump printer output is full</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>DRM coredump printer</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>DRM printer output is full, useful to short circuit coredump printing once
printer is full.</p>
<p><strong>Return</strong></p>
<p>True if DRM coredump printer output buffer is full, False otherwise</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_seq_file_printer">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_seq_file_printer</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">seq_file</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">f</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_seq_file_printer" title="Link to this definition">¶</a><br /></dt>
<dd><p>construct a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> that outputs to <code class="xref c c-type docutils literal notranslate"><span class="pre">seq_file</span></code></p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">seq_file</span> <span class="pre">*f</span></code></dt><dd><p>the <code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">seq_file</span></code> to output to</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>The <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> object</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_info_printer">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_info_printer</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../driver-api/infrastructure.html#c.device" title="device"><span class="n"><span class="pre">device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_info_printer" title="Link to this definition">¶</a><br /></dt>
<dd><p>construct a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> that outputs to dev_printk()</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*dev</span></code></dt><dd><p>the <a class="reference internal" href="../driver-api/infrastructure.html#c.device" title="device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span></code></a> pointer</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>The <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> object</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_dbg_printer">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_dbg_printer</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">drm</span></span>, <span class="k"><span class="pre">enum</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_debug_category" title="drm_debug_category"><span class="n"><span class="pre">drm_debug_category</span></span></a><span class="w"> </span><span class="n"><span class="pre">category</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">prefix</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_dbg_printer" title="Link to this definition">¶</a><br /></dt>
<dd><p>construct a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> for drm device specific output</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*drm</span></code></dt><dd><p>the <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a> pointer, or NULL</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">enum</span> <span class="pre">drm_debug_category</span> <span class="pre">category</span></code></dt><dd><p>the debug category to use</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*prefix</span></code></dt><dd><p>debug output prefix, or NULL for no prefix</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>The <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> object</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_err_printer">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_err_printer</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_device" title="drm_device"><span class="n"><span class="pre">drm_device</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">drm</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">prefix</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_err_printer" title="Link to this definition">¶</a><br /></dt>
<dd><p>construct a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> that outputs to drm_err()</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span> <span class="pre">*drm</span></code></dt><dd><p>the <a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a> pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*prefix</span></code></dt><dd><p>debug output prefix, or NULL for no prefix</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>The <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> object</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_line_printer">
<span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_line_printer</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">prefix</span></span>, <span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">series</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_line_printer" title="Link to this definition">¶</a><br /></dt>
<dd><p>construct a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> that prefixes outputs with line numbers</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>the <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span></code></a> which actually generates the output</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*prefix</span></code></dt><dd><p>optional output prefix, or NULL for no prefix</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">series</span></code></dt><dd><p>optional unique series identifier, or 0 to omit identifier in the output</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This printer can be used to increase the robustness of the captured output
to make sure we didn’t lost any intermediate lines of the output. Helpful
while capturing some crash data.</p>
<p>Example 1:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void crash_dump(struct drm_device *drm)
{
        static unsigned int id;
        struct drm_printer p = drm_err_printer(drm, &quot;crash&quot;);
        struct drm_printer lp = drm_line_printer(&amp;p, &quot;dump&quot;, ++id);

        drm_printf(&amp;lp, &quot;foo&quot;);
        drm_printf(&amp;lp, &quot;bar&quot;);
}
</pre></div>
</div>
<p>Above code will print into the dmesg something like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[ ] 0000:00:00.0: [drm] *ERROR* crash dump 1.1: foo
[ ] 0000:00:00.0: [drm] *ERROR* crash dump 1.2: bar
</pre></div>
</div>
<p>Example 2:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void line_dump(struct device *dev)
{
        struct drm_printer p = drm_info_printer(dev);
        struct drm_printer lp = drm_line_printer(&amp;p, NULL, 0);

        drm_printf(&amp;lp, &quot;foo&quot;);
        drm_printf(&amp;lp, &quot;bar&quot;);
}
</pre></div>
</div>
<p>Above code will print:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[ ] 0000:00:00.0: [drm] 1: foo
[ ] 0000:00:00.0: [drm] 2: bar
</pre></div>
</div>
<p><strong>Return</strong></p>
<p>The <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> object</p>
</div>
<dl class="c macro">
<dt class="sig sig-object c" id="c.DRM_DEV_ERROR">
<span class="sig-name descname"><span class="n"><span class="pre">DRM_DEV_ERROR</span></span></span><a class="headerlink" href="#c.DRM_DEV_ERROR" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">DRM_DEV_ERROR</span> <span class="pre">(dev,</span> <span class="pre">fmt,</span> <span class="pre">...)</span></code></p>
<blockquote>
<div><p>Error output.</p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>device pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fmt</span></code></dt><dd><p>printf() like format string.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">...</span></code></dt><dd><p>variable arguments</p>
</dd>
</dl>
<p><strong>NOTE</strong></p>
<p>this is deprecated in favor of drm_err() or dev_err().</p>
</div>
<dl class="c macro">
<dt class="sig sig-object c" id="c.DRM_DEV_ERROR_RATELIMITED">
<span class="sig-name descname"><span class="n"><span class="pre">DRM_DEV_ERROR_RATELIMITED</span></span></span><a class="headerlink" href="#c.DRM_DEV_ERROR_RATELIMITED" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">DRM_DEV_ERROR_RATELIMITED</span> <span class="pre">(dev,</span> <span class="pre">fmt,</span> <span class="pre">...)</span></code></p>
<blockquote>
<div><p>Rate limited error output.</p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>device pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fmt</span></code></dt><dd><p>printf() like format string.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">...</span></code></dt><dd><p>variable arguments</p>
</dd>
</dl>
<p><strong>NOTE</strong></p>
<p>this is deprecated in favor of drm_err_ratelimited() or
dev_err_ratelimited().</p>
<p><strong>Description</strong></p>
<p>Like DRM_ERROR() but won’t flood the log.</p>
</div>
<dl class="c macro">
<dt class="sig sig-object c" id="c.DRM_DEV_DEBUG">
<span class="sig-name descname"><span class="n"><span class="pre">DRM_DEV_DEBUG</span></span></span><a class="headerlink" href="#c.DRM_DEV_DEBUG" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">DRM_DEV_DEBUG</span> <span class="pre">(dev,</span> <span class="pre">fmt,</span> <span class="pre">...)</span></code></p>
<blockquote>
<div><p>Debug output for generic drm code</p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>device pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fmt</span></code></dt><dd><p>printf() like format string.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">...</span></code></dt><dd><p>variable arguments</p>
</dd>
</dl>
<p><strong>NOTE</strong></p>
<p>this is deprecated in favor of drm_dbg_core().</p>
</div>
<dl class="c macro">
<dt class="sig sig-object c" id="c.DRM_DEV_DEBUG_DRIVER">
<span class="sig-name descname"><span class="n"><span class="pre">DRM_DEV_DEBUG_DRIVER</span></span></span><a class="headerlink" href="#c.DRM_DEV_DEBUG_DRIVER" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">DRM_DEV_DEBUG_DRIVER</span> <span class="pre">(dev,</span> <span class="pre">fmt,</span> <span class="pre">...)</span></code></p>
<blockquote>
<div><p>Debug output for vendor specific part of the driver</p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>device pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fmt</span></code></dt><dd><p>printf() like format string.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">...</span></code></dt><dd><p>variable arguments</p>
</dd>
</dl>
<p><strong>NOTE</strong></p>
<p>this is deprecated in favor of drm_dbg() or dev_dbg().</p>
</div>
<dl class="c macro">
<dt class="sig sig-object c" id="c.DRM_DEV_DEBUG_KMS">
<span class="sig-name descname"><span class="n"><span class="pre">DRM_DEV_DEBUG_KMS</span></span></span><a class="headerlink" href="#c.DRM_DEV_DEBUG_KMS" title="Link to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">DRM_DEV_DEBUG_KMS</span> <span class="pre">(dev,</span> <span class="pre">fmt,</span> <span class="pre">...)</span></code></p>
<blockquote>
<div><p>Debug output for modesetting code</p>
</div></blockquote>
<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>device pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fmt</span></code></dt><dd><p>printf() like format string.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">...</span></code></dt><dd><p>variable arguments</p>
</dd>
</dl>
<p><strong>NOTE</strong></p>
<p>this is deprecated in favor of drm_dbg_kms().</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_puts">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_puts</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">str</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_puts" title="Link to this definition">¶</a><br /></dt>
<dd><p>print a const string to a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> stream</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>the <code class="xref c c-type docutils literal notranslate"><span class="pre">drm</span></code> printer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*str</span></code></dt><dd><p>const string</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Allow <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> types that have a constant string
option to use it.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_printf">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_printf</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">f</span></span>, <span class="p"><span class="pre">...</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_printf" title="Link to this definition">¶</a><br /></dt>
<dd><p>print to a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> stream</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>the <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*f</span></code></dt><dd><p>format string</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">...</span></code></dt><dd><p>variable arguments</p>
</dd>
</dl>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_print_bits">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_print_bits</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">long</span></span><span class="w"> </span><span class="n"><span class="pre">value</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">bits</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">]</span></span>, <span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">nbits</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_print_bits" title="Link to this definition">¶</a><br /></dt>
<dd><p>print bits to a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> stream</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>the <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span> <span class="pre">value</span></code></dt><dd><p>field value.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*</span> <span class="pre">const</span> <span class="pre">bits[]</span></code></dt><dd><p>Array with bit names.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">nbits</span></code></dt><dd><p>Size of bit names array.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Print bits (in flag fields for example) in human readable form.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_print_regset32">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_print_regset32</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">debugfs_regset32</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">regset</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_print_regset32" title="Link to this definition">¶</a><br /></dt>
<dd><p>print the contents of registers to a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> stream.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>the <code class="xref c c-type docutils literal notranslate"><span class="pre">drm</span></code> printer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">debugfs_regset32</span> <span class="pre">*regset</span></code></dt><dd><p>the list of registers to print.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Often in driver debug, it’s useful to be able to either capture the
contents of registers in the steady state using debugfs or at
specific points during operation.  This lets the driver have a
single list of registers for both.</p>
</div>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_print_hex_dump">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_print_hex_dump</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.drm_printer" title="drm_printer"><span class="n"><span class="pre">drm_printer</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">p</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">prefix</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="n"><span class="pre">u8</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">buf</span></span>, <span class="n"><span class="pre">size_t</span></span><span class="w"> </span><span class="n"><span class="pre">len</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_print_hex_dump" title="Link to this definition">¶</a><br /></dt>
<dd><p>print a hex dump to a <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a> stream</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_printer</span> <span class="pre">*p</span></code></dt><dd><p>The <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*prefix</span></code></dt><dd><p>Prefix for each line, may be NULL for no prefix</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">u8</span> <span class="pre">*buf</span></code></dt><dd><p>Buffer to dump</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">len</span></code></dt><dd><p>Length of buffer</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Print hex dump to <a class="reference internal" href="#c.drm_printer" title="drm_printer"><code class="xref c c-type docutils literal notranslate"><span class="pre">drm_printer</span></code></a>, with 16 space-separated hex bytes per line,
optionally with a prefix on each line. No separator is added after prefix.</p>
</div>
</section>
<section id="utilities">
<h3>Utilities<a class="headerlink" href="#utilities" title="Link to this heading">¶</a></h3>
<p>Macros and inline functions that does not naturally belong in other places</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.drm_can_sleep">
<span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">drm_can_sleep</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">void</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.drm_can_sleep" title="Link to this definition">¶</a><br /></dt>
<dd><p>returns true if currently okay to sleep</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt><dd><p>no arguments</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function shall not be used in new code.
The check for running in atomic context may not work - see linux/preempt.h.</p>
<p>FIXME: All users of drm_can_sleep should be removed (see <a class="reference internal" href="todo.html"><span class="doc">TODO list</span></a>)</p>
<p><strong>Return</strong></p>
<p>False if kgdb is active, we are in atomic context or irqs are disabled.</p>
</div>
</section>
</section>
<section id="unit-testing">
<h2>Unit testing<a class="headerlink" href="#unit-testing" title="Link to this heading">¶</a></h2>
<section id="kunit">
<h3>KUnit<a class="headerlink" href="#kunit" title="Link to this heading">¶</a></h3>
<p>KUnit (Kernel unit testing framework) provides a common framework for unit tests
within the Linux kernel.</p>
<p>This section covers the specifics for the DRM subsystem. For general information
about KUnit, please refer to <a class="reference internal" href="../dev-tools/kunit/start.html"><span class="doc">Getting Started</span></a>.</p>
<section id="how-to-run-the-tests">
<h4>How to run the tests?<a class="headerlink" href="#how-to-run-the-tests" title="Link to this heading">¶</a></h4>
<p>In order to facilitate running the test suite, a configuration file is present
in <code class="docutils literal notranslate"><span class="pre">drivers/gpu/drm/tests/.kunitconfig</span></code>. It can be used by <code class="docutils literal notranslate"><span class="pre">kunit.py</span></code> as
follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./tools/testing/kunit/kunit.py<span class="w"> </span>run<span class="w"> </span>--kunitconfig<span class="o">=</span>drivers/gpu/drm/tests<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--kconfig_add<span class="w"> </span><span class="nv">CONFIG_VIRTIO_UML</span><span class="o">=</span>y<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--kconfig_add<span class="w"> </span><span class="nv">CONFIG_UML_PCI_OVER_VIRTIO</span><span class="o">=</span>y
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The configuration included in <code class="docutils literal notranslate"><span class="pre">.kunitconfig</span></code> should be as generic as
possible.
<code class="docutils literal notranslate"><span class="pre">CONFIG_VIRTIO_UML</span></code> and <code class="docutils literal notranslate"><span class="pre">CONFIG_UML_PCI_OVER_VIRTIO</span></code> are not
included in it because they are only required for User Mode Linux.</p>
</div>
</section>
<section id="kunit-coverage-rules">
<h4>KUnit Coverage Rules<a class="headerlink" href="#kunit-coverage-rules" title="Link to this heading">¶</a></h4>
<p>KUnit support is gradually added to the DRM framework and helpers. There’s no
general requirement for the framework and helpers to have KUnit tests at the
moment. However, patches that are affecting a function or helper already
covered by KUnit tests must provide tests if the change calls for one.</p>
</section>
</section>
</section>
<section id="legacy-support-code">
<h2>Legacy Support Code<a class="headerlink" href="#legacy-support-code" title="Link to this heading">¶</a></h2>
<p>The section very briefly covers some of the old legacy support code
which is only used by old DRM drivers which have done a so-called
shadow-attach to the underlying device instead of registering as a real
driver. This also includes some of the old generic buffer management and
command submission code. Do not use any of this in new and modern
drivers.</p>
<section id="legacy-suspend-resume">
<h3>Legacy Suspend/Resume<a class="headerlink" href="#legacy-suspend-resume" title="Link to this heading">¶</a></h3>
<p>The DRM core provides some suspend/resume code, but drivers wanting full
suspend/resume support should provide save() and restore() functions.
These are called at suspend, hibernate, or resume time, and should
perform any state save or restore required by your device across suspend
or hibernate states.</p>
<p>int (*suspend) (<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a> *, pm_message_t state); int
(*resume) (<a class="reference internal" href="#c.drm_device" title="drm_device"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_device</span></code></a> *);
Those are legacy suspend and resume methods which <em>only</em> work with the
legacy shadow-attach driver registration functions. New driver should
use the power management interface provided by their bus type (usually
through the <a class="reference internal" href="../driver-api/infrastructure.html#c.device_driver" title="device_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device_driver</span></code></a>
dev_pm_ops) and set these methods to NULL.</p>
</section>
<section id="legacy-dma-services">
<h3>Legacy DMA Services<a class="headerlink" href="#legacy-dma-services" title="Link to this heading">¶</a></h3>
<p>This should cover how DMA mapping etc. is supported by the core. These
functions are deprecated and should not be used.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/gpu/drm-internals.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>