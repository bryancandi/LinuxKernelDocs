<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Zoned Loop Block Device &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="zram: Compressed RAM-based block devices" href="zram.html" />
    <link rel="prev" title="Using the RAM disk block device with Linux" href="ramdisk.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.16.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Administration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#general-guides-to-kernel-administration">General guides to kernel administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#booting-the-kernel">Booting the kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tracking-down-and-identifying-problems">Tracking down and identifying problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#core-kernel-subsystems">Core-kernel subsystems</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#block-layer-and-filesystem-administration">Block-layer and filesystem administration</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../bcache.html">A block layer cache (bcache)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../binderfs.html">The Android binderfs Filesystem</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Block Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cifs/index.html">CIFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../device-mapper/index.html">Device Mapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext4.html">ext4 General Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="../filesystem-monitoring.html">File system Monitoring with fanotify</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nfs/index.html">NFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../iostats.html">I/O statistics fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jfs.html">IBM’s Journaled File System (JFS) for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../md.html">RAID arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ufs.html">Using UFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../xfs.html">The SGI XFS Filesystem</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#device-specific-guides">Device-specific guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#workload-analysis">Workload analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#everything-else">Everything else</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/blockdev/zoned_loop.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="zoned-loop-block-device">
<h1>Zoned Loop Block Device<a class="headerlink" href="#zoned-loop-block-device" title="Link to this heading">¶</a></h1>
<section id="overview">
<h2>1) Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>The zoned loop block device driver (zloop) allows a user to create a zoned block
device using one regular file per zone as backing storage. This driver does not
directly control any hardware and uses read, write and truncate operations to
regular files of a file system to emulate a zoned block device.</p>
<p>Using zloop, zoned block devices with a configurable capacity, zone size and
number of conventional zones can be created. The storage for each zone of the
device is implemented using a regular file with a maximum size equal to the zone
size. The size of a file backing a conventional zone is always equal to the zone
size. The size of a file backing a sequential zone indicates the amount of data
sequentially written to the file, that is, the size of the file directly
indicates the position of the write pointer of the zone.</p>
<p>When resetting a sequential zone, its backing file size is truncated to zero.
Conversely, for a zone finish operation, the backing file is truncated to the
zone size. With this, the maximum capacity of a zloop zoned block device created
can be larger configured to be larger than the storage space available on the
backing file system. Of course, for such configuration, writing more data than
the storage space available on the backing file system will result in write
errors.</p>
<p>The zoned loop block device driver implements a complete zone transition state
machine. That is, zones can be empty, implicitly opened, explicitly opened,
closed or full. The current implementation does not support any limits on the
maximum number of open and active zones.</p>
<p>No user tools are necessary to create and delete zloop devices.</p>
</section>
<section id="creating-a-zoned-device">
<h2>2) Creating a Zoned Device<a class="headerlink" href="#creating-a-zoned-device" title="Link to this heading">¶</a></h2>
<p>Once the zloop module is loaded (or if zloop is compiled in the kernel), the
character device file /dev/zloop-control can be used to add a zloop device.
This is done by writing an “add” command directly to the /dev/zloop-control
device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ modprobe zloop
$ ls -l /dev/zloop*
crw-------. 1 root root 10, 123 Jan  6 19:18 /dev/zloop-control

$ mkdir -p &lt;base directory/&lt;device ID&gt;
$ echo &quot;add [options]&quot; &gt; /dev/zloop-control
</pre></div>
</div>
<p>The options available for the add command can be listed by reading the
/dev/zloop-control device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cat /dev/zloop-control
add id=%d,capacity_mb=%u,zone_size_mb=%u,zone_capacity_mb=%u,conv_zones=%u,base_dir=%s,nr_queues=%u,queue_depth=%u,buffered_io
remove id=%d
</pre></div>
</div>
<p>In more details, the options that can be used with the “add” command are as
follows.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>id</p></td>
<td><p>Device number (the X in /dev/zloopX).
Default: automatically assigned.</p></td>
</tr>
<tr class="row-even"><td><p>capacity_mb</p></td>
<td><p>Device total capacity in MiB. This is always rounded up to
the nearest higher multiple of the zone size.
Default: 16384 MiB (16 GiB).</p></td>
</tr>
<tr class="row-odd"><td><p>zone_size_mb</p></td>
<td><p>Device zone size in MiB. Default: 256 MiB.</p></td>
</tr>
<tr class="row-even"><td><p>zone_capacity_mb</p></td>
<td><p>Device zone capacity (must always be equal to or lower than
the zone size. Default: zone size.</p></td>
</tr>
<tr class="row-odd"><td><p>conv_zones</p></td>
<td><p>Total number of conventioanl zones starting from sector 0.
Default: 8.</p></td>
</tr>
<tr class="row-even"><td><p>base_dir</p></td>
<td><p>Path to the base directoy where to create the directory
containing the zone files of the device.
Default=/var/local/zloop.
The device directory containing the zone files is always
named with the device ID. E.g. the default zone file
directory for /dev/zloop0 is /var/local/zloop/0.</p></td>
</tr>
<tr class="row-odd"><td><p>nr_queues</p></td>
<td><p>Number of I/O queues of the zoned block device. This value is
always capped by the number of online CPUs
Default: 1</p></td>
</tr>
<tr class="row-even"><td><p>queue_depth</p></td>
<td><p>Maximum I/O queue depth per I/O queue.
Default: 64</p></td>
</tr>
<tr class="row-odd"><td><p>buffered_io</p></td>
<td><p>Do buffered IOs instead of direct IOs (default: false)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="deleting-a-zoned-device">
<h2>3) Deleting a Zoned Device<a class="headerlink" href="#deleting-a-zoned-device" title="Link to this heading">¶</a></h2>
<p>Deleting an unused zoned loop block device is done by issuing the “remove”
command to /dev/zloop-control, specifying the ID of the device to remove:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo &quot;remove id=X&quot; &gt; /dev/zloop-control
</pre></div>
</div>
<p>The remove command does not have any option.</p>
<p>A zoned device that was removed can be re-added again without any change to the
state of the device zones: the device zones are restored to their last state
before the device was removed. Adding again a zoned device after it was removed
must always be done using the same configuration as when the device was first
added. If a zone configuration change is detected, an error will be returned and
the zoned device will not be created.</p>
<p>To fully delete a zoned device, after executing the remove operation, the device
base directory containing the backing files of the device zones must be deleted.</p>
</section>
<section id="example">
<h2>4) Example<a class="headerlink" href="#example" title="Link to this heading">¶</a></h2>
<p>The following sequence of commands creates a 2GB zoned device with zones of 64
MB and a zone capacity of 63 MB:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ modprobe zloop
$ mkdir -p /var/local/zloop/0
$ echo &quot;add capacity_mb=2048,zone_size_mb=64,zone_capacity=63MB&quot; &gt; /dev/zloop-control
</pre></div>
</div>
<p>For the device created (/dev/zloop0), the zone backing files are all created
under the default base directory (/var/local/zloop):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ls -l /var/local/zloop/0
total 0
-rw-------. 1 root root 67108864 Jan  6 22:23 cnv-000000
-rw-------. 1 root root 67108864 Jan  6 22:23 cnv-000001
-rw-------. 1 root root 67108864 Jan  6 22:23 cnv-000002
-rw-------. 1 root root 67108864 Jan  6 22:23 cnv-000003
-rw-------. 1 root root 67108864 Jan  6 22:23 cnv-000004
-rw-------. 1 root root 67108864 Jan  6 22:23 cnv-000005
-rw-------. 1 root root 67108864 Jan  6 22:23 cnv-000006
-rw-------. 1 root root 67108864 Jan  6 22:23 cnv-000007
-rw-------. 1 root root        0 Jan  6 22:23 seq-000008
-rw-------. 1 root root        0 Jan  6 22:23 seq-000009
...
</pre></div>
</div>
<p>The zoned device created (/dev/zloop0) can then be used normally:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ lsblk -z
NAME   ZONED        ZONE-SZ ZONE-NR ZONE-AMAX ZONE-OMAX ZONE-APP ZONE-WGRAN
zloop0 host-managed     64M      32         0         0       1M         4K
$ blkzone report /dev/zloop0
  start: 0x000000000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000020000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000040000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000060000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000080000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x0000a0000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x0000c0000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x0000e0000, len 0x020000, cap 0x020000, wptr 0x000000 reset:0 non-seq:0, zcond: 0(nw) [type: 1(CONVENTIONAL)]
  start: 0x000100000, len 0x020000, cap 0x01f800, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  start: 0x000120000, len 0x020000, cap 0x01f800, wptr 0x000000 reset:0 non-seq:0, zcond: 1(em) [type: 2(SEQ_WRITE_REQUIRED)]
  ...
</pre></div>
</div>
<p>Deleting this device is done using the command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo &quot;remove id=0&quot; &gt; /dev/zloop-control
</pre></div>
</div>
<p>The removed device can be re-added again using the same “add” command as when
the device was first created. To fully delete a zoned device, its backing files
should also be deleted after executing the remove command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ rm -r /var/local/zloop/0
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/blockdev/zoned_loop.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>