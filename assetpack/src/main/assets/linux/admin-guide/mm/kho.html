<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Kexec Handover Usage &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Kernel module signing facility" href="../module-signing.html" />
    <link rel="prev" title="zswap" href="zswap.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.16.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Administration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#general-guides-to-kernel-administration">General guides to kernel administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#booting-the-kernel">Booting the kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tracking-down-and-identifying-problems">Tracking down and identifying problems</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#core-kernel-subsystems">Core-kernel subsystems</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../cgroup-v2.html">Control Group v2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cgroup-v1/index.html">Control Groups version 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cpu-load.html">CPU load</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Memory Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../module-signing.html">Kernel module signing facility</a></li>
<li class="toctree-l3"><a class="reference internal" href="../namespaces/index.html">Namespaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../numastat.html">Numa policy hit/miss statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pm/index.html">Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../syscall-user-dispatch.html">Syscall User Dispatch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../binfmt-misc.html">Kernel Support for miscellaneous Binary Formats (binfmt_misc)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../java.html">Java(tm) Binary Kernel Support for Linux v1.03</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mono.html">Mono(tm) Binary Kernel Support for Linux</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#block-layer-and-filesystem-administration">Block-layer and filesystem administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#device-specific-guides">Device-specific guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#workload-analysis">Workload analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#everything-else">Everything else</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/mm/kho.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="kexec-handover-usage">
<h1>Kexec Handover Usage<a class="headerlink" href="#kexec-handover-usage" title="Link to this heading">¶</a></h1>
<p>Kexec HandOver (KHO) is a mechanism that allows Linux to preserve memory
regions, which could contain serialized system states, across kexec.</p>
<p>This document expects that you are familiar with the base KHO
<a class="reference internal" href="../../core-api/kho/concepts.html#kho-concepts"><span class="std std-ref">concepts</span></a>. If you have not read
them yet, please do so now.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h2>
<p>KHO is available when the kernel is compiled with <code class="docutils literal notranslate"><span class="pre">CONFIG_KEXEC_HANDOVER</span></code>
set to y. Every KHO producer may have its own config option that you
need to enable if you would like to preserve their respective state across
kexec.</p>
<p>To use KHO, please boot the kernel with the <code class="docutils literal notranslate"><span class="pre">kho=on</span></code> command line
parameter. You may use <code class="docutils literal notranslate"><span class="pre">kho_scratch</span></code> parameter to define size of the
scratch regions. For example <code class="docutils literal notranslate"><span class="pre">kho_scratch=16M,512M,256M</span></code> will reserve a
16 MiB low memory scratch area, a 512 MiB global scratch region, and 256 MiB
per NUMA node scratch regions on boot.</p>
</section>
<section id="perform-a-kho-kexec">
<h2>Perform a KHO kexec<a class="headerlink" href="#perform-a-kho-kexec" title="Link to this heading">¶</a></h2>
<p>First, before you perform a KHO kexec, you need to move the system into
the <a class="reference internal" href="../../core-api/kho/concepts.html#kho-finalization-phase"><span class="std std-ref">KHO finalization phase</span></a></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 1 &gt; /sys/kernel/debug/kho/out/finalize
</pre></div>
</div>
<p>After this command, the KHO FDT is available in
<code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/out/fdt</span></code>. Other subsystems may also register
their own preserved sub FDTs under
<code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/out/sub_fdts/</span></code>.</p>
<p>Next, load the target payload and kexec into it. It is important that you
use the <code class="docutils literal notranslate"><span class="pre">-s</span></code> parameter to use the in-kernel kexec file loader, as user
space kexec tooling currently has no support for KHO with the user space
based file loader</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># kexec -l /path/to/bzImage --initrd /path/to/initrd -s
# kexec -e
</pre></div>
</div>
<p>The new kernel will boot up and contain some of the previous kernel’s state.</p>
<p>For example, if you used <code class="docutils literal notranslate"><span class="pre">reserve_mem</span></code> command line parameter to create
an early memory reservation, the new kernel will have that memory at the
same physical address as the old kernel.</p>
</section>
<section id="abort-a-kho-exec">
<h2>Abort a KHO exec<a class="headerlink" href="#abort-a-kho-exec" title="Link to this heading">¶</a></h2>
<p>You can move the system out of KHO finalization phase again by calling</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 0 &gt; /sys/kernel/debug/kho/out/active
</pre></div>
</div>
<p>After this command, the KHO FDT is no longer available in
<code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/out/fdt</span></code>.</p>
</section>
<section id="debugfs-interfaces">
<h2>debugfs Interfaces<a class="headerlink" href="#debugfs-interfaces" title="Link to this heading">¶</a></h2>
<p>Currently KHO creates the following debugfs interfaces. Notice that these
interfaces may change in the future. They will be moved to sysfs once KHO is
stabilized.</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/out/finalize</span></code></dt><dd><p>Kexec HandOver (KHO) allows Linux to transition the state of
compatible drivers into the next kexec’ed kernel. To do so,
device drivers will instruct KHO to preserve memory regions,
which could contain serialized kernel state.
While the state is serialized, they are unable to perform
any modifications to state that was serialized, such as
handed over memory allocations.</p>
<p>When this file contains “1”, the system is in the transition
state. When contains “0”, it is not. To switch between the
two states, echo the respective number into this file.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/out/fdt</span></code></dt><dd><p>When KHO state tree is finalized, the kernel exposes the
flattened device tree blob that carries its current KHO
state in this file. Kexec user space tooling can use this
as input file for the KHO payload image.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/out/scratch_len</span></code></dt><dd><p>Lengths of KHO scratch regions, which are physically contiguous
memory regions that will always stay available for future kexec
allocations. Kexec user space tools can use this file to determine
where it should place its payload images.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/out/scratch_phys</span></code></dt><dd><p>Physical locations of KHO scratch regions. Kexec user space tools
can use this file in conjunction to scratch_phys to determine where
it should place its payload images.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/out/sub_fdts/</span></code></dt><dd><p>In the KHO finalization phase, KHO producers register their own
FDT blob under this directory.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/in/fdt</span></code></dt><dd><p>When the kernel was booted with Kexec HandOver (KHO),
the state tree that carries metadata about the previous
kernel’s state is in this file in the format of flattened
device tree. This file may disappear when all consumers of
it finished to interpret their metadata.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/kho/in/sub_fdts/</span></code></dt><dd><p>Similar to <code class="docutils literal notranslate"><span class="pre">kho/out/sub_fdts/</span></code>, but contains sub FDT blobs
of KHO producers passed from the old kernel.</p>
</dd>
</dl>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/mm/kho.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>