<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>18. Debugging AMD Zen systems &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="19. AMD Memory Encryption" href="amd-memory-encryption.html" />
    <link rel="prev" title="17. Intel(R) TXT Overview" href="intel_txt.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.16.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">CPU architectures</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../arc/index.html">ARC architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../loongarch/index.html">LoongArch Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">x86-specific Documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="boot.html">1. The Linux/x86 Boot Protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="booting-dt.html">2. DeviceTree Booting</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpuinfo.html">3. x86 Feature Flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="topology.html">4. x86 Topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="exception-tables.html">5. Kernel level exception handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="kernel-stacks.html">6. Kernel Stacks</a></li>
<li class="toctree-l3"><a class="reference internal" href="entry_64.html">7. Kernel Entries</a></li>
<li class="toctree-l3"><a class="reference internal" href="earlyprintk.html">8. Early Printk</a></li>
<li class="toctree-l3"><a class="reference internal" href="orc-unwinder.html">9. ORC unwinder</a></li>
<li class="toctree-l3"><a class="reference internal" href="zero-page.html">10. Zero Page</a></li>
<li class="toctree-l3"><a class="reference internal" href="tlb.html">11. The TLB</a></li>
<li class="toctree-l3"><a class="reference internal" href="mtrr.html">12. MTRR (Memory Type Range Register) control</a></li>
<li class="toctree-l3"><a class="reference internal" href="pat.html">13. PAT (Page Attribute Table)</a></li>
<li class="toctree-l3"><a class="reference internal" href="intel-hfi.html">14. Hardware-Feedback Interface for scheduling on Intel Hardware</a></li>
<li class="toctree-l3"><a class="reference internal" href="shstk.html">15. Control-flow Enforcement Technology (CET) Shadow Stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="iommu.html">16. x86 IOMMU Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="intel_txt.html">17. Intel(R) TXT Overview</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">18. Debugging AMD Zen systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="amd-memory-encryption.html">19. AMD Memory Encryption</a></li>
<li class="toctree-l3"><a class="reference internal" href="amd_hsmp.html">20. AMD HSMP interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="tdx.html">21. Intel Trust Domain Extensions (TDX)</a></li>
<li class="toctree-l3"><a class="reference internal" href="pti.html">22. Page Table Isolation (PTI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="mds.html">23. Microarchitectural Data Sampling (MDS) mitigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="microcode.html">24. The Linux Microcode Loader</a></li>
<li class="toctree-l3"><a class="reference internal" href="tsx_async_abort.html">25. TSX Async Abort (TAA) mitigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="buslock.html">26. Bus lock detection and handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="usb-legacy-support.html">27. USB Legacy support</a></li>
<li class="toctree-l3"><a class="reference internal" href="i386/index.html">28. i386 Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="x86_64/index.html">29. x86_64 Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="ifs.html">30. In-Field Scan</a></li>
<li class="toctree-l3"><a class="reference internal" href="sva.html">31. Shared Virtual Addressing (SVA) with ENQCMD</a></li>
<li class="toctree-l3"><a class="reference internal" href="sgx.html">32. Software Guard eXtensions (SGX)</a></li>
<li class="toctree-l3"><a class="reference internal" href="features.html">33. Feature status on x86 architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="elf_auxvec.html">34. x86-specific ELF Auxiliary Vectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="xstate.html">35. Using XSTATE features in user space applications</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/arch/x86/amd-debugging.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="debugging-amd-zen-systems">
<h1><span class="section-number">18. </span>Debugging AMD Zen systems<a class="headerlink" href="#debugging-amd-zen-systems" title="Link to this heading">¶</a></h1>
<section id="introduction">
<h2><span class="section-number">18.1. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>This document describes techniques that are useful for debugging issues with
AMD Zen systems.  It is intended for use by developers and technical users
to help identify and resolve issues.</p>
</section>
<section id="s3-vs-s2idle">
<h2><span class="section-number">18.2. </span>S3 vs s2idle<a class="headerlink" href="#s3-vs-s2idle" title="Link to this heading">¶</a></h2>
<p>On AMD systems, it’s not possible to simultaneously support suspend-to-RAM (S3)
and suspend-to-idle (s2idle).  To confirm which mode your system supports you
can look at <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/sys/power/mem_sleep</span></code>.  If it shows <code class="docutils literal notranslate"><span class="pre">s2idle</span> <span class="pre">[deep]</span></code> then
<em>S3</em> is supported.  If it shows <code class="docutils literal notranslate"><span class="pre">[s2idle]</span></code> then <em>s2idle</em> is
supported.</p>
<p>On systems that support <em>S3</em>, the firmware will be utilized to put all hardware into
the appropriate low power state.</p>
<p>On systems that support <em>s2idle</em>, the kernel will be responsible for transitioning devices
into the appropriate low power state. When all devices are in the appropriate low
power state, the hardware will transition into a hardware sleep state.</p>
<p>After a suspend cycle you can tell how much time was spent in a hardware sleep
state by looking at <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/sys/power/suspend_stats/last_hw_sleep</span></code>.</p>
<p>This flowchart explains how the AMD s2idle suspend flow works.</p>
<figure class="align-default">
<img alt="../../_images/suspend.svg" src="../../_images/suspend.svg" /></figure>
<p>This flowchart explains how the amd s2idle resume flow works.</p>
<figure class="align-default">
<img alt="../../_images/resume.svg" src="../../_images/resume.svg" /></figure>
</section>
<section id="s2idle-debugging-tool">
<h2><span class="section-number">18.3. </span>s2idle debugging tool<a class="headerlink" href="#s2idle-debugging-tool" title="Link to this heading">¶</a></h2>
<p>As there are a lot of places that problems can occur, a debugging tool has been
created at
<a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/superm1/amd-debug-tools.git/about/">amd-debug-tools</a>
that can help test for common problems and offer suggestions.</p>
<p>If you have an s2idle issue, it’s best to start with this and follow instructions
from its findings.  If you continue to have an issue, raise a bug with the
report generated from this script to
<a class="reference external" href="https://gitlab.freedesktop.org/drm/amd/-/issues/new?issuable_template=s2idle_BUG_TEMPLATE">drm/amd gitlab</a>.</p>
</section>
<section id="spurious-s2idle-wakeups-from-an-irq">
<h2><span class="section-number">18.4. </span>Spurious s2idle wakeups from an IRQ<a class="headerlink" href="#spurious-s2idle-wakeups-from-an-irq" title="Link to this heading">¶</a></h2>
<p>Spurious wakeups will generally have an IRQ set to <code class="docutils literal notranslate"><span class="pre">/sys/power/pm_wakeup_irq</span></code>.
This can be matched to <code class="docutils literal notranslate"><span class="pre">/proc/interrupts</span></code> to determine what device woke the system.</p>
<p>If this isn’t enough to debug the problem, then the following sysfs files
can be set to add more verbosity to the wakeup process:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo 1 | sudo tee /sys/power/pm_debug_messages
# echo 1 | sudo tee /sys/power/pm_print_times
</pre></div>
</div>
<p>After making those changes, the kernel will display messages that can
be traced back to kernel s2idle loop code as well as display any active
GPIO sources while waking up.</p>
<p>If the wakeup is caused by the ACPI SCI, additional ACPI debugging may be
needed.  These commands can enable additional trace data:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo enable | sudo tee /sys/module/acpi/parameters/trace_state
# echo 1 | sudo tee /sys/module/acpi/parameters/aml_debug_output
# echo 0x0800000f | sudo tee /sys/module/acpi/parameters/debug_level
# echo 0xffff0000 | sudo tee /sys/module/acpi/parameters/debug_layer
</pre></div>
</div>
</section>
<section id="spurious-s2idle-wakeups-from-a-gpio">
<h2><span class="section-number">18.5. </span>Spurious s2idle wakeups from a GPIO<a class="headerlink" href="#spurious-s2idle-wakeups-from-a-gpio" title="Link to this heading">¶</a></h2>
<p>If a GPIO is active when waking up the system ideally you would look at the
schematic to determine what device it is associated with. If the schematic
is not available, another tactic is to look at the ACPI _EVT() entry
to determine what device is notified when that GPIO is active.</p>
<p>For a hypothetical example, say that GPIO 59 woke up the system.  You can
look at the SSDT to determine what device is notified when GPIO 59 is active.</p>
<p>First convert the GPIO number into hex.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 -c &quot;print(hex(59))&quot;
0x3b
</pre></div>
</div>
<p>Next determine which ACPI table has the <code class="docutils literal notranslate"><span class="pre">_EVT</span></code> entry. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo grep EVT /sys/firmware/acpi/tables/SSDT*
grep: /sys/firmware/acpi/tables/SSDT27: binary file matches
</pre></div>
</div>
<p>Decode this table:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo cp /sys/firmware/acpi/tables/SSDT27 .
$ sudo iasl -d SSDT27
</pre></div>
</div>
<p>Then look at the table and find the matching entry for GPIO 0x3b.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Case (0x3B)
{
    M000 (0x393B)
    M460 (&quot;    Notify (\\_SB.PCI0.GP17.XHC1, 0x02)\n&quot;, Zero, Zero, Zero, Zero, Zero, Zero)
    Notify (\_SB.PCI0.GP17.XHC1, 0x02) // Device Wake
}
</pre></div>
</div>
<p>You can see in this case that the device <code class="docutils literal notranslate"><span class="pre">\_SB.PCI0.GP17.XHC1</span></code> is notified
when GPIO 59 is active. It’s obvious this is an XHCI controller, but to go a
step further you can figure out which XHCI controller it is by matching it to
ACPI.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ grep &quot;PCI0.GP17.XHC1&quot; /sys/bus/acpi/devices/*/path
/sys/bus/acpi/devices/device:2d/path:\_SB_.PCI0.GP17.XHC1
/sys/bus/acpi/devices/device:2e/path:\_SB_.PCI0.GP17.XHC1.RHUB
/sys/bus/acpi/devices/device:2f/path:\_SB_.PCI0.GP17.XHC1.RHUB.PRT1
/sys/bus/acpi/devices/device:30/path:\_SB_.PCI0.GP17.XHC1.RHUB.PRT1.CAM0
/sys/bus/acpi/devices/device:31/path:\_SB_.PCI0.GP17.XHC1.RHUB.PRT1.CAM1
/sys/bus/acpi/devices/device:32/path:\_SB_.PCI0.GP17.XHC1.RHUB.PRT2
/sys/bus/acpi/devices/LNXPOWER:0d/path:\_SB_.PCI0.GP17.XHC1.PWRS
</pre></div>
</div>
<p>Here you can see it matches to <code class="docutils literal notranslate"><span class="pre">device:2d</span></code>. Look at the <code class="docutils literal notranslate"><span class="pre">physical_node</span></code>
to determine what PCI device that actually is.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ls -l /sys/bus/acpi/devices/device:2d/physical_node
lrwxrwxrwx 1 root root 0 Feb 12 13:22 /sys/bus/acpi/devices/device:2d/physical_node -&gt; ../../../../../pci0000:00/0000:00:08.1/0000:c2:00.4
</pre></div>
</div>
<p>So there you have it: the PCI device associated with this GPIO wakeup was <code class="docutils literal notranslate"><span class="pre">0000:c2:00.4</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">amd_s2idle.py</span></code> script will capture most of these artifacts for you.</p>
</section>
<section id="s2idle-pm-debug-messages">
<h2><span class="section-number">18.6. </span>s2idle PM debug messages<a class="headerlink" href="#s2idle-pm-debug-messages" title="Link to this heading">¶</a></h2>
<p>During the s2idle flow on AMD systems, the ACPI LPS0 driver is responsible
to check all uPEP constraints.  Failing uPEP constraints does not prevent
s0i3 entry.  This means that if some constraints are not met, it is possible
the kernel may attempt to enter s2idle even if there are some known issues.</p>
<p>To activate PM debugging, either specify <code class="docutils literal notranslate"><span class="pre">pm_debug_messagess</span></code> kernel
command-line option at boot or write to <code class="docutils literal notranslate"><span class="pre">/sys/power/pm_debug_messages</span></code>.
Unmet constraints will be displayed in the kernel log and can be
viewed by logging tools that process kernel ring buffer like <code class="docutils literal notranslate"><span class="pre">dmesg</span></code> or
<code class="docutils literal notranslate"><span class="pre">journalctl</span></code>.”</p>
<p>If the system freezes on entry/exit before these messages are flushed, a
useful debugging tactic is to unbind the <code class="docutils literal notranslate"><span class="pre">amd_pmc</span></code> driver to prevent
notification to the platform to start s0i3 entry.  This will stop the
system from freezing on entry or exit and let you view all the failed
constraints.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd /sys/bus/platform/drivers/amd_pmc
ls | grep AMD | sudo tee unbind
</pre></div>
</div>
<p>After doing this, run the suspend cycle and look specifically for errors around:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ACPI: LPI: Constraint not met; min power state:%s current power state:%s
</pre></div>
</div>
</section>
<section id="historical-examples-of-s2idle-issues">
<h2><span class="section-number">18.7. </span>Historical examples of s2idle issues<a class="headerlink" href="#historical-examples-of-s2idle-issues" title="Link to this heading">¶</a></h2>
<p>To help understand the types of issues that can occur and how to debug them,
here are some historical examples of s2idle issues that have been resolved.</p>
<section id="core-offlining">
<h3><span class="section-number">18.7.1. </span>Core offlining<a class="headerlink" href="#core-offlining" title="Link to this heading">¶</a></h3>
<p>An end user had reported that taking a core offline would prevent the system
from properly entering s0i3.  This was debugged using internal AMD tools
to capture and display a stream of metrics from the hardware showing what changed
when a core was offlined.  It was determined that the hardware didn’t get
notification the offline cores were in the deepest state, and so it prevented
CPU from going into the deepest state. The issue was debugged to a missing
command to put cores into C3 upon offline.</p>
<p><a class="reference external" href="https://git.kernel.org/torvalds/c/d6b88ce2eb9d2">commit d6b88ce2eb9d2 (“ACPI: processor idle: Allow playing dead in C3 state”)</a></p>
</section>
<section id="corruption-after-resume">
<h3><span class="section-number">18.7.2. </span>Corruption after resume<a class="headerlink" href="#corruption-after-resume" title="Link to this heading">¶</a></h3>
<p>A big problem that occurred with Rembrandt was that there was graphical
corruption after resume.  This happened because of a misalignment of PSP
and driver responsibility.  The PSP will save and restore DMCUB, but the
driver assumed it needed to reset DMCUB on resume.
This actually was a misalignment for earlier silicon as well, but was not
observed.</p>
<p><a class="reference external" href="https://git.kernel.org/torvalds/c/79d6b9351f086">commit 79d6b9351f086 (“drm/amd/display: Don’t reinitialize DMCUB on s0ix resume”)</a></p>
</section>
<section id="back-to-back-suspends-fail">
<h3><span class="section-number">18.7.3. </span>Back to Back suspends fail<a class="headerlink" href="#back-to-back-suspends-fail" title="Link to this heading">¶</a></h3>
<p>When using a wakeup source that triggers the IRQ to wakeup, a bug in the
pinctrl-amd driver may capture the wrong state of the IRQ and prevent the
system going back to sleep properly.</p>
<p><a class="reference external" href="https://git.kernel.org/torvalds/c/b8c824a869f22">commit b8c824a869f22 (“pinctrl: amd: Don’t save/restore interrupt status and wake status bits”)</a></p>
</section>
<section id="spurious-timer-based-wakeup-after-5-minutes">
<h3><span class="section-number">18.7.4. </span>Spurious timer based wakeup after 5 minutes<a class="headerlink" href="#spurious-timer-based-wakeup-after-5-minutes" title="Link to this heading">¶</a></h3>
<p>The HPET was being used to program the wakeup source for the system, however
this was causing a spurious wakeup after 5 minutes.  The correct alarm to use
was the ACPI alarm.</p>
<p><a class="reference external" href="https://git.kernel.org/torvalds/c/3d762e21d5637">commit 3d762e21d5637 (“rtc: cmos: Use ACPI alarm for non-Intel x86 systems too”)</a></p>
</section>
<section id="disk-disappears-after-resume">
<h3><span class="section-number">18.7.5. </span>Disk disappears after resume<a class="headerlink" href="#disk-disappears-after-resume" title="Link to this heading">¶</a></h3>
<p>After resuming from s2idle, the NVME disk would disappear.  This was due to the
BIOS not specifying the _DSD StorageD3Enable property.  This caused the NVME
driver not to put the disk into the expected state at suspend and to fail
on resume.</p>
<p><a class="reference external" href="https://git.kernel.org/torvalds/c/e79a10652bbd3">commit e79a10652bbd3 (“ACPI: x86: Force StorageD3Enable on more products”)</a></p>
</section>
<section id="spurious-irq1">
<h3><span class="section-number">18.7.6. </span>Spurious IRQ1<a class="headerlink" href="#spurious-irq1" title="Link to this heading">¶</a></h3>
<p>A number of Renoir, Lucienne, Cezanne, &amp; Barcelo platforms have a
platform firmware bug where IRQ1 is triggered during s0i3 resume.</p>
<p>This was fixed in the platform firmware, but a number of systems didn’t
receive any more platform firmware updates.</p>
<p><a class="reference external" href="https://git.kernel.org/torvalds/c/8e60615e89321">commit 8e60615e89321 (“platform/x86/amd: pmc: Disable IRQ1 wakeup for RN/CZN”)</a></p>
</section>
<section id="hardware-timeout">
<h3><span class="section-number">18.7.7. </span>Hardware timeout<a class="headerlink" href="#hardware-timeout" title="Link to this heading">¶</a></h3>
<p>The hardware performs many actions besides accepting the values from
amd-pmc driver.  As the communication path with the hardware is a mailbox,
it’s possible that it might not respond quickly enough.
This issue manifested as a failure to suspend:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>PM: dpm_run_callback(): acpi_subsys_suspend_noirq+0x0/0x50 returns -110
amd_pmc AMDI0005:00: PM: failed to suspend noirq: error -110
</pre></div>
</div>
<p>The timing problem was identified by comparing the values of the idle mask.</p>
<p><a class="reference external" href="https://git.kernel.org/torvalds/c/3c3c8e88c8712">commit 3c3c8e88c8712 (“platform/x86: amd-pmc: Increase the response register timeout”)</a></p>
</section>
<section id="failed-to-reach-hardware-sleep-state-with-panel-on">
<h3><span class="section-number">18.7.8. </span>Failed to reach hardware sleep state with panel on<a class="headerlink" href="#failed-to-reach-hardware-sleep-state-with-panel-on" title="Link to this heading">¶</a></h3>
<p>On some Strix systems certain panels were observed to block the system from
entering a hardware sleep state if the internal panel was on during the sequence.</p>
<p>Even though the panel got turned off during suspend it exposed a timing problem
where an interrupt caused the display hardware to wake up and block low power
state entry.</p>
<p><a class="reference external" href="https://git.kernel.org/torvalds/c/40b8c14936bd2">commit 40b8c14936bd2 (“drm/amd/display: Disable unneeded hpd interrupts during dm_init”)</a></p>
</section>
</section>
<section id="runtime-power-consumption-issues">
<h2><span class="section-number">18.8. </span>Runtime power consumption issues<a class="headerlink" href="#runtime-power-consumption-issues" title="Link to this heading">¶</a></h2>
<p>Runtime power consumption is influenced by many factors, including but not
limited to the configuration of the PCIe Active State Power Management (ASPM),
the display brightness, the EPP policy of the CPU, and the power management
of the devices.</p>
<section id="aspm">
<h3><span class="section-number">18.8.1. </span>ASPM<a class="headerlink" href="#aspm" title="Link to this heading">¶</a></h3>
<p>For the best runtime power consumption, ASPM should be programmed as intended
by the BIOS from the hardware vendor.  To accomplish this the Linux kernel
should be compiled with <code class="docutils literal notranslate"><span class="pre">CONFIG_PCIEASPM_DEFAULT</span></code> set to <code class="docutils literal notranslate"><span class="pre">y</span></code> and the
sysfs file <code class="docutils literal notranslate"><span class="pre">/sys/module/pcie_aspm/parameters/policy</span></code> should not be modified.</p>
<p>Most notably, if L1.2 is not configured properly for any devices, the SoC
will not be able to enter the deepest idle state.</p>
</section>
<section id="epp-policy">
<h3><span class="section-number">18.8.2. </span>EPP Policy<a class="headerlink" href="#epp-policy" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">energy_performance_preference</span></code> sysfs file can be used to set a bias
of efficiency or performance for a CPU.  This has a direct relationship on
the battery life when more heavily biased towards performance.</p>
</section>
</section>
<section id="bios-debug-messages">
<h2><span class="section-number">18.9. </span>BIOS debug messages<a class="headerlink" href="#bios-debug-messages" title="Link to this heading">¶</a></h2>
<p>Most OEM machines don’t have a serial UART for outputting kernel or BIOS
debug messages. However BIOS debug messages are useful for understanding
both BIOS bugs and bugs with the Linux kernel drivers that call BIOS AML.</p>
<p>As the BIOS on most OEM AMD systems are based off an AMD reference BIOS,
the infrastructure used for exporting debugging messages is often the same
as AMD reference BIOS.</p>
<section id="manually-parsing">
<h3><span class="section-number">18.9.1. </span>Manually Parsing<a class="headerlink" href="#manually-parsing" title="Link to this heading">¶</a></h3>
<p>There is generally an ACPI method <code class="docutils literal notranslate"><span class="pre">\M460</span></code> that different paths of the AML
will call to emit a message to the BIOS serial log. This method takes
7 arguments, with the first being a string and the rest being optional
integers:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Method (M460, 7, Serialized)
</pre></div>
</div>
<p>Here is an example of a string that BIOS AML may call out using <code class="docutils literal notranslate"><span class="pre">\M460</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>M460 (&quot;  OEM-ASL-PCIe Address (0x%X)._REG (%d %d)  PCSA = %d\n&quot;, DADR, Arg0, Arg1, PCSA, Zero, Zero)
</pre></div>
</div>
<p>Normally when executed, the <code class="docutils literal notranslate"><span class="pre">\M460</span></code> method would populate the additional
arguments into the string.  In order to get these messages from the Linux
kernel a hook has been added into ACPICA that can capture the <em>arguments</em>
sent to <code class="docutils literal notranslate"><span class="pre">\M460</span></code> and print them to the kernel ring buffer.
For example the following message could be emitted into kernel ring buffer:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>extrace-0174 ex_trace_args         :  &quot;  OEM-ASL-PCIe Address (0x%X)._REG (%d %d)  PCSA = %d\n&quot;, ec106000, 2, 1, 1, 0, 0
</pre></div>
</div>
<p>In order to get these messages, you need to compile with <code class="docutils literal notranslate"><span class="pre">CONFIG_ACPI_DEBUG</span></code>
and then turn on the following ACPICA tracing parameters.
This can be done either on the kernel command line or at runtime:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">acpi.trace_method_name=\M460</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acpi.trace_state=method</span></code></p></li>
</ul>
<p>NOTE: These can be very noisy at bootup. If you turn these parameters on
the kernel command, please also consider turning up <code class="docutils literal notranslate"><span class="pre">CONFIG_LOG_BUF_SHIFT</span></code>
to a larger size such as 17 to avoid losing early boot messages.</p>
</section>
<section id="tool-assisted-parsing">
<h3><span class="section-number">18.9.2. </span>Tool assisted Parsing<a class="headerlink" href="#tool-assisted-parsing" title="Link to this heading">¶</a></h3>
<p>As mentioned above, parsing by hand can be tedious, especially with a lot of
messages.  To help with this, a tool has been created at
<a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/superm1/amd-debug-tools.git/about/">amd-debug-tools</a>
to help parse the messages.</p>
</section>
</section>
<section id="random-reboot-issues">
<h2><span class="section-number">18.10. </span>Random reboot issues<a class="headerlink" href="#random-reboot-issues" title="Link to this heading">¶</a></h2>
<p>When a random reboot occurs, the high-level reason for the reboot is stored
in a register that will persist onto the next boot.</p>
<dl class="simple">
<dt>There are 6 classes of reasons for the reboot:</dt><dd><ul class="simple">
<li><p>Software induced</p></li>
<li><p>Power state transition</p></li>
<li><p>Pin induced</p></li>
<li><p>Hardware induced</p></li>
<li><p>Remote reset</p></li>
<li><p>Internal CPU event</p></li>
</ul>
</dd>
</dl>
<table class="docutils align-left">
<thead>
<tr class="row-odd"><th class="head"><p>Bit</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Reason</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Pin</p></td>
<td><p>thermal pin BP_THERMTRIP_L was tripped</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Pin</p></td>
<td><p>power button was pressed for 4 seconds</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Pin</p></td>
<td><p>shutdown pin was tripped</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>Remote</p></td>
<td><p>remote ASF power off command was received</p></td>
</tr>
<tr class="row-even"><td><p>9</p></td>
<td><p>Internal</p></td>
<td><p>internal CPU thermal limit was tripped</p></td>
</tr>
<tr class="row-odd"><td><p>16</p></td>
<td><p>Pin</p></td>
<td><p>system reset pin BP_SYS_RST_L was tripped</p></td>
</tr>
<tr class="row-even"><td><p>17</p></td>
<td><p>Software</p></td>
<td><p>software issued PCI reset</p></td>
</tr>
<tr class="row-odd"><td><p>18</p></td>
<td><p>Software</p></td>
<td><p>software wrote 0x4 to reset control register 0xCF9</p></td>
</tr>
<tr class="row-even"><td><p>19</p></td>
<td><p>Software</p></td>
<td><p>software wrote 0x6 to reset control register 0xCF9</p></td>
</tr>
<tr class="row-odd"><td><p>20</p></td>
<td><p>Software</p></td>
<td><p>software wrote 0xE to reset control register 0xCF9</p></td>
</tr>
<tr class="row-even"><td><p>21</p></td>
<td><p>ACPI-state</p></td>
<td><p>ACPI power state transition occurred</p></td>
</tr>
<tr class="row-odd"><td><p>22</p></td>
<td><p>Pin</p></td>
<td><p>keyboard reset pin KB_RST_L was tripped</p></td>
</tr>
<tr class="row-even"><td><p>23</p></td>
<td><p>Internal</p></td>
<td><p>internal CPU shutdown event occurred</p></td>
</tr>
<tr class="row-odd"><td><p>24</p></td>
<td><p>Hardware</p></td>
<td><p>system failed to boot before failed boot timer expired</p></td>
</tr>
<tr class="row-even"><td><p>25</p></td>
<td><p>Hardware</p></td>
<td><p>hardware watchdog timer expired</p></td>
</tr>
<tr class="row-odd"><td><p>26</p></td>
<td><p>Remote</p></td>
<td><p>remote ASF reset command was received</p></td>
</tr>
<tr class="row-even"><td><p>27</p></td>
<td><p>Internal</p></td>
<td><p>an uncorrected error caused a data fabric sync flood event</p></td>
</tr>
<tr class="row-odd"><td><p>29</p></td>
<td><p>Internal</p></td>
<td><p>FCH and MP1 failed warm reset handshake</p></td>
</tr>
<tr class="row-even"><td><p>30</p></td>
<td><p>Internal</p></td>
<td><p>a parity error occurred</p></td>
</tr>
<tr class="row-odd"><td><p>31</p></td>
<td><p>Internal</p></td>
<td><p>a software sync flood event occurred</p></td>
</tr>
</tbody>
</table>
<p>This information is read by the kernel at bootup and printed into
the syslog. When a random reboot occurs this message can be helpful
to determine the next component to debug.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/arch/x86/amd-debugging.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>