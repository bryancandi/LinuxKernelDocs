<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Linux Init (Early Boot) &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="CXL Driver Operation" href="cxl-driver.html" />
    <link rel="prev" title="Overview" href="overview.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.16.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Driver APIs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../index.html#general-information-for-driver-authors">General information for driver authors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#useful-support-libraries">Useful support libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html#bus-level-documentation">Bus-level documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../auxiliary_bus.html">Auxiliary Bus</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Compute Express Link</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../eisa.html">EISA bus support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../firewire.html">Firewire (IEEE 1394) driver Interface Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../i3c/index.html">I3C subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../isa.html">ISA Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../men-chameleon-bus.html">MEN Chameleon Bus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pci/index.html">The Linux PCI driver implementer’s API guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../rapidio/index.html">The Linux RapidIO Subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../slimbus.html">Linux kernel SLIMbus support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../usb/index.html">Linux USB API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../virtio/index.html">Virtio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../vme.html">VME Device Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../w1.html">W1: Dallas’ 1-wire bus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../xillybus.html">Xillybus driver for generic FPGA interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#subsystem-specific-apis">Subsystem-specific APIs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../subsystem-apis.html">Subsystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/driver-api/cxl/linux/early-boot.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="linux-init-early-boot">
<h1>Linux Init (Early Boot)<a class="headerlink" href="#linux-init-early-boot" title="Link to this heading">¶</a></h1>
<p>Linux configuration is split into two major steps: Early-Boot and everything else.</p>
<p>During early boot, Linux sets up immutable resources (such as numa nodes), while
later operations include things like driver probe and memory hotplug.  Linux may
read EFI and ACPI information throughout this process to configure logical
representations of the devices.</p>
<p>During Linux Early Boot stage (functions in the kernel that have the __init
decorator), the system takes the resources created by EFI/BIOS
(<a class="reference internal" href="../platform/acpi.html"><span class="doc">ACPI tables</span></a>) and turns them into resources that the
kernel can consume.</p>
<section id="bios-build-and-boot-options">
<h2>BIOS, Build and Boot Options<a class="headerlink" href="#bios-build-and-boot-options" title="Link to this heading">¶</a></h2>
<p>There are 4 pre-boot options that need to be considered during kernel build
which dictate how memory will be managed by Linux during early boot.</p>
<ul class="simple">
<li><p>EFI_MEMORY_SP</p>
<ul>
<li><p>BIOS/EFI Option that dictates whether memory is SystemRAM or
Specific Purpose.  Specific Purpose memory will be deferred to
drivers to manage - and not immediately exposed as system RAM.</p></li>
</ul>
</li>
<li><p>CONFIG_EFI_SOFT_RESERVE</p>
<ul>
<li><p>Linux Build config option that dictates whether the kernel supports
Specific Purpose memory.</p></li>
</ul>
</li>
<li><p>CONFIG_MHP_DEFAULT_ONLINE_TYPE</p>
<ul>
<li><p>Linux Build config that dictates whether and how Specific Purpose memory
converted to a dax device should be managed (left as DAX or onlined as
SystemRAM in ZONE_NORMAL or ZONE_MOVABLE).</p></li>
</ul>
</li>
<li><p>nosoftreserve</p>
<ul>
<li><p>Linux kernel boot option that dictates whether Soft Reserve should be
supported.  Similar to CONFIG_EFI_SOFT_RESERVE.</p></li>
</ul>
</li>
</ul>
</section>
<section id="memory-map-creation">
<h2>Memory Map Creation<a class="headerlink" href="#memory-map-creation" title="Link to this heading">¶</a></h2>
<p>While the kernel parses the EFI memory map, if <code class="code docutils literal notranslate"><span class="pre">Specific</span> <span class="pre">Purpose</span></code> memory
is supported and detected, it will set this region aside as
<code class="code docutils literal notranslate"><span class="pre">SOFT_RESERVED</span></code>.</p>
<p>If <code class="code docutils literal notranslate"><span class="pre">EFI_MEMORY_SP=0</span></code>, <code class="code docutils literal notranslate"><span class="pre">CONFIG_EFI_SOFT_RESERVE=n</span></code>, or
<code class="code docutils literal notranslate"><span class="pre">nosoftreserve=y</span></code> - Linux will default a CXL device memory region to
SystemRAM.  This will expose the memory to the kernel page allocator in
<code class="code docutils literal notranslate"><span class="pre">ZONE_NORMAL</span></code>, making it available for use for most allocations (including
<code class="code docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span></code> and page tables).</p>
<p>If <cite>Specific Purpose</cite> is set and supported, <code class="code docutils literal notranslate"><span class="pre">CONFIG_MHP_DEFAULT_ONLINE_TYPE_*</span></code>
dictates whether the memory is onlined by default (<code class="code docutils literal notranslate"><span class="pre">_OFFLINE</span></code> or
<code class="code docutils literal notranslate"><span class="pre">_ONLINE_*</span></code>), and if online which zone to online this memory to by default
(<code class="code docutils literal notranslate"><span class="pre">_NORMAL</span></code> or <code class="code docutils literal notranslate"><span class="pre">_MOVABLE</span></code>).</p>
<p>If placed in <code class="code docutils literal notranslate"><span class="pre">ZONE_MOVABLE</span></code>, the memory will not be available for most
kernel allocations (such as <code class="code docutils literal notranslate"><span class="pre">struct</span> <span class="pre">page</span></code> or page tables).  This may
significant impact performance depending on the memory capacity of the system.</p>
</section>
<section id="numa-node-reservation">
<h2>NUMA Node Reservation<a class="headerlink" href="#numa-node-reservation" title="Link to this heading">¶</a></h2>
<p>Linux refers to the proximity domains (<code class="code docutils literal notranslate"><span class="pre">PXM</span></code>) defined in the <a class="reference internal" href="../platform/acpi/srat.html"><span class="doc">SRAT</span></a> to create NUMA nodes in <code class="code docutils literal notranslate"><span class="pre">acpi_numa_init</span></code>.
Typically, there is a 1:1 relation between <code class="code docutils literal notranslate"><span class="pre">PXM</span></code> and NUMA node IDs.</p>
<p>The SRAT is the only ACPI defined way of defining Proximity Domains. Linux
chooses to, at most, map those 1:1 with NUMA nodes.
<a class="reference internal" href="../platform/acpi/cedt.html"><span class="doc">CEDT</span></a> adds a description of SPA ranges which
Linux may map to one or more NUMA nodes.</p>
<p>If there are CXL ranges in the CFMWS but not in SRAT, then a fake <code class="code docutils literal notranslate"><span class="pre">PXM</span></code>
is created (as of v6.15). In the future, Linux may reject CFMWS not described
by SRAT due to the ambiguity of proximity domain association.</p>
<p>It is important to note that NUMA node creation cannot be done at runtime. All
possible NUMA nodes are identified at <code class="code docutils literal notranslate"><span class="pre">__init</span></code> time, more specifically
during <code class="code docutils literal notranslate"><span class="pre">mm_init</span></code>. The CEDT and SRAT must contain sufficient <code class="code docutils literal notranslate"><span class="pre">PXM</span></code>
data for Linux to identify NUMA nodes their associated memory regions.</p>
<p>The relevant code exists in: <code class="code docutils literal notranslate"><span class="pre">linux/drivers/acpi/numa/srat.c</span></code>.</p>
<p>See <a class="reference internal" href="../platform/example-configs.html"><span class="doc">Example Platform Configurations</span></a>
for more info.</p>
</section>
<section id="memory-tiers-creation">
<h2>Memory Tiers Creation<a class="headerlink" href="#memory-tiers-creation" title="Link to this heading">¶</a></h2>
<p>Memory tiers are a collection of NUMA nodes grouped by performance characteristics.
During <code class="code docutils literal notranslate"><span class="pre">__init</span></code>, Linux initializes the system with a default memory tier that
contains all nodes marked <code class="code docutils literal notranslate"><span class="pre">N_MEMORY</span></code>.</p>
<p><code class="code docutils literal notranslate"><span class="pre">memory_tier_init</span></code> is called at boot for all nodes with memory online by
default. <code class="code docutils literal notranslate"><span class="pre">memory_tier_late_init</span></code> is called during late-init for nodes setup
during driver configuration.</p>
<p>Nodes are only marked <code class="code docutils literal notranslate"><span class="pre">N_MEMORY</span></code> if they have <em>online</em> memory.</p>
<p>Tier membership can be inspected in</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/sys/devices/virtual/memory_tiering/memory_tierN/nodelist
0-1
</pre></div>
</div>
<p>If nodes are grouped which have clear difference in performance, check the
<a class="reference internal" href="../platform/acpi/hmat.html"><span class="doc">HMAT</span></a> and CDAT information for the CXL nodes. All
nodes default to the DRAM tier, unless HMAT/CDAT information is reported to the
memory_tier component via <cite>access_coordinates</cite>.</p>
<p>For more, see <a class="reference internal" href="access-coordinates.html"><span class="doc">CXL access coordinates documentation</span></a>.</p>
</section>
<section id="contiguous-memory-allocation">
<h2>Contiguous Memory Allocation<a class="headerlink" href="#contiguous-memory-allocation" title="Link to this heading">¶</a></h2>
<p>The contiguous memory allocator (CMA) enables reservation of contiguous memory
regions on NUMA nodes during early boot.  However, CMA cannot reserve memory
on NUMA nodes that are not online during early boot.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void __init hugetlb_cma_reserve(int order) {
  if (!node_online(nid))
    /* do not allow reservations */
}
</pre></div>
</div>
<p>This means if users intend to defer management of CXL memory to the driver, CMA
cannot be used to guarantee huge page allocations.  If enabling CXL memory as
SystemRAM in <cite>ZONE_NORMAL</cite> during early boot, CMA reservations per-node can be
made with the <code class="code docutils literal notranslate"><span class="pre">cma_pernuma</span></code> or <code class="code docutils literal notranslate"><span class="pre">numa_cma</span></code> kernel command line
parameters.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/driver-api/cxl/linux/early-boot.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>