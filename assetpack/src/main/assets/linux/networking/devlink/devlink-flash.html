<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Devlink Flash &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Devlink Params" href="devlink-params.html" />
    <link rel="prev" title="Devlink Info" href="devlink-info.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.15.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../subsystem-apis.html#networking-interfaces">Networking interfaces</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/networking/devlink/devlink-flash.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="devlink-flash">
<span id="id1"></span><h1>Devlink Flash<a class="headerlink" href="#devlink-flash" title="Link to this heading">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">devlink-flash</span></code> API allows updating device firmware. It replaces the
older <code class="docutils literal notranslate"><span class="pre">ethtool-flash</span></code> mechanism, and doesn’t require taking any
networking locks in the kernel to perform the flash update. Example use:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ devlink dev flash pci/0000:05:00.0 file flash-boot.bin
</pre></div>
</div>
<p>Note that the file name is a path relative to the firmware loading path
(usually <code class="docutils literal notranslate"><span class="pre">/lib/firmware/</span></code>). Drivers may send status updates to inform
user space about the progress of the update operation.</p>
<section id="overwrite-mask">
<h2>Overwrite Mask<a class="headerlink" href="#overwrite-mask" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">devlink-flash</span></code> command allows optionally specifying a mask indicating
how the device should handle subsections of flash components when updating.
This mask indicates the set of sections which are allowed to be overwritten.</p>
<table class="docutils align-default" id="id2">
<caption><span class="caption-text">List of overwrite mask bits</span><a class="headerlink" href="#id2" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 5.0%" />
<col style="width: 95.0%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_FLASH_OVERWRITE_SETTINGS</span></code></p></td>
<td><p>Indicates that the device should overwrite settings in the components
being updated with the settings found in the provided image.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_FLASH_OVERWRITE_IDENTIFIERS</span></code></p></td>
<td><p>Indicates that the device should overwrite identifiers in the
components being updated with the identifiers found in the provided
image. This includes MAC addresses, serial IDs, and similar device
identifiers.</p></td>
</tr>
</tbody>
</table>
<p>Multiple overwrite bits may be combined and requested together. If no bits
are provided, it is expected that the device only update firmware binaries
in the components being updated. Settings and identifiers are expected to be
preserved across the update. A device may not support every combination and
the driver for such a device must reject any combination which cannot be
faithfully implemented.</p>
</section>
<section id="firmware-loading">
<h2>Firmware Loading<a class="headerlink" href="#firmware-loading" title="Link to this heading">¶</a></h2>
<p>Devices which require firmware to operate usually store it in non-volatile
memory on the board, e.g. flash. Some devices store only basic firmware on
the board, and the driver loads the rest from disk during probing.
<code class="docutils literal notranslate"><span class="pre">devlink-info</span></code> allows users to query firmware information (loaded
components and versions).</p>
<p>In other cases the device can both store the image on the board, load from
disk, or automatically flash a new image from disk. The <code class="docutils literal notranslate"><span class="pre">fw_load_policy</span></code>
devlink parameter can be used to control this behavior
(<a class="reference internal" href="devlink-params.html#devlink-params-generic"><span class="std std-ref">Documentation/networking/devlink/devlink-params.rst</span></a>).</p>
<p>On-disk firmware files are usually stored in <code class="docutils literal notranslate"><span class="pre">/lib/firmware/</span></code>.</p>
</section>
<section id="firmware-version-management">
<h2>Firmware Version Management<a class="headerlink" href="#firmware-version-management" title="Link to this heading">¶</a></h2>
<p>Drivers are expected to implement <code class="docutils literal notranslate"><span class="pre">devlink-flash</span></code> and <code class="docutils literal notranslate"><span class="pre">devlink-info</span></code>
functionality, which together allow for implementing vendor-independent
automated firmware update facilities.</p>
<p><code class="docutils literal notranslate"><span class="pre">devlink-info</span></code> exposes the <code class="docutils literal notranslate"><span class="pre">driver</span></code> name and three version groups
(<code class="docutils literal notranslate"><span class="pre">fixed</span></code>, <code class="docutils literal notranslate"><span class="pre">running</span></code>, <code class="docutils literal notranslate"><span class="pre">stored</span></code>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">driver</span></code> attribute and <code class="docutils literal notranslate"><span class="pre">fixed</span></code> group identify the specific device
design, e.g. for looking up applicable firmware updates. This is why
<code class="docutils literal notranslate"><span class="pre">serial_number</span></code> is not part of the <code class="docutils literal notranslate"><span class="pre">fixed</span></code> versions (even though it
is fixed) - <code class="docutils literal notranslate"><span class="pre">fixed</span></code> versions should identify the design, not a single
device.</p>
<p><code class="docutils literal notranslate"><span class="pre">running</span></code> and <code class="docutils literal notranslate"><span class="pre">stored</span></code> firmware versions identify the firmware running
on the device, and firmware which will be activated after reboot or device
reset.</p>
<p>The firmware update agent is supposed to be able to follow this simple
algorithm to update firmware contents, regardless of the device vendor:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get unique HW design identifier</span>
<span class="nv">$hw_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>devlink-dev-info<span class="o">[</span><span class="s1">&#39;fixed&#39;</span><span class="o">]</span>

<span class="c1"># Find out which FW flash we want to use for this NIC</span>
<span class="nv">$want_flash_vers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>some-db-backed.lookup<span class="o">(</span><span class="nv">$hw_id</span>,<span class="w"> </span><span class="s1">&#39;flash&#39;</span><span class="o">)</span>

<span class="c1"># Update flash if necessary</span>
<span class="k">if</span><span class="w"> </span><span class="nv">$want_flash_vers</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>devlink-dev-info<span class="o">[</span><span class="s1">&#39;stored&#39;</span><span class="o">]</span>:
<span class="w">    </span><span class="nv">$file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>some-db-backed.download<span class="o">(</span><span class="nv">$hw_id</span>,<span class="w"> </span><span class="s1">&#39;flash&#39;</span><span class="o">)</span>
<span class="w">    </span>devlink-dev-flash<span class="o">(</span><span class="nv">$file</span><span class="o">)</span>

<span class="c1"># Find out the expected overall firmware versions</span>
<span class="nv">$want_fw_vers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>some-db-backed.lookup<span class="o">(</span><span class="nv">$hw_id</span>,<span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="o">)</span>

<span class="c1"># Update on-disk file if necessary</span>
<span class="k">if</span><span class="w"> </span><span class="nv">$want_fw_vers</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>devlink-dev-info<span class="o">[</span><span class="s1">&#39;running&#39;</span><span class="o">]</span>:
<span class="w">    </span><span class="nv">$file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>some-db-backed.download<span class="o">(</span><span class="nv">$hw_id</span>,<span class="w"> </span><span class="s1">&#39;disk&#39;</span><span class="o">)</span>
<span class="w">    </span>write<span class="o">(</span><span class="nv">$file</span>,<span class="w"> </span><span class="s1">&#39;/lib/firmware/&#39;</span><span class="o">)</span>

<span class="c1"># Try device reset, if available</span>
<span class="k">if</span><span class="w"> </span><span class="nv">$want_fw_vers</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>devlink-dev-info<span class="o">[</span><span class="s1">&#39;running&#39;</span><span class="o">]</span>:
<span class="w">   </span>devlink-reset<span class="o">()</span>

<span class="c1"># Reboot, if reset wasn&#39;t enough</span>
<span class="k">if</span><span class="w"> </span><span class="nv">$want_fw_vers</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>devlink-dev-info<span class="o">[</span><span class="s1">&#39;running&#39;</span><span class="o">]</span>:
<span class="w">   </span>reboot<span class="o">()</span>
</pre></div>
</div>
<p>Note that each reference to <code class="docutils literal notranslate"><span class="pre">devlink-dev-info</span></code> in this pseudo-code
is expected to fetch up-to-date information from the kernel.</p>
<p>For the convenience of identifying firmware files some vendors add
<code class="docutils literal notranslate"><span class="pre">bundle_id</span></code> information to the firmware versions. This meta-version covers
multiple per-component versions and can be used e.g. in firmware file names
(all component versions could get rather long.)</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/networking/devlink/devlink-flash.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>