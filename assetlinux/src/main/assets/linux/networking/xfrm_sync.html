<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>XFRM &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=a152c8ac" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="XFRM Syscall" href="xfrm_sysctl.html" />
    <link rel="prev" title="XFRM proc - /proc/net/xfrm_* files" href="xfrm_proc.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.14.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../subsystem-apis.html#networking-interfaces">Networking interfaces</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/networking/xfrm_sync.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="xfrm">
<h1>XFRM<a class="headerlink" href="#xfrm" title="Link to this heading">¶</a></h1>
<p>The sync patches work is based on initial patches from
Krisztian &lt;<a class="reference external" href="mailto:hidden&#37;&#52;&#48;balabit&#46;hu">hidden<span>&#64;</span>balabit<span>&#46;</span>hu</a>&gt; and others and additional patches
from Jamal &lt;<a class="reference external" href="mailto:hadi&#37;&#52;&#48;cyberus&#46;ca">hadi<span>&#64;</span>cyberus<span>&#46;</span>ca</a>&gt;.</p>
<p>The end goal for syncing is to be able to insert attributes + generate
events so that the SA can be safely moved from one machine to another
for HA purposes.
The idea is to synchronize the SA so that the takeover machine can do
the processing of the SA as accurate as possible if it has access to it.</p>
<p>We already have the ability to generate SA add/del/upd events.
These patches add ability to sync and have accurate lifetime byte (to
ensure proper decay of SAs) and replay counters to avoid replay attacks
with as minimal loss at failover time.
This way a backup stays as closely up-to-date as an active member.</p>
<p>Because the above items change for every packet the SA receives,
it is possible for a lot of the events to be generated.
For this reason, we also add a nagle-like algorithm to restrict
the events. i.e we are going to set thresholds to say “let me
know if the replay sequence threshold is reached or 10 secs have passed”
These thresholds are set system-wide via sysctls or can be updated
per SA.</p>
<p>The identified items that need to be synchronized are:
- the lifetime byte counter
note that: lifetime time limit is not important if you assume the failover
machine is known ahead of time since the decay of the time countdown
is not driven by packet arrival.
- the replay sequence for both inbound and outbound</p>
<section id="message-structure">
<h2>1) Message Structure<a class="headerlink" href="#message-structure" title="Link to this heading">¶</a></h2>
<p>nlmsghdr:aevent_id:optional-TLVs.</p>
<p>The netlink message types are:</p>
<p>XFRM_MSG_NEWAE and XFRM_MSG_GETAE.</p>
<p>A XFRM_MSG_GETAE does not have TLVs.</p>
<p>A XFRM_MSG_NEWAE will have at least two TLVs (as is
discussed further below).</p>
<p>aevent_id structure looks like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct xfrm_aevent_id {
          struct xfrm_usersa_id           sa_id;
          xfrm_address_t                  saddr;
          __u32                           flags;
          __u32                           reqid;
};
</pre></div>
</div>
<p>The unique SA is identified by the combination of xfrm_usersa_id,
reqid and saddr.</p>
<p>flags are used to indicate different things. The possible
flags are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>XFRM_AE_RTHR=1, /* replay threshold*/
XFRM_AE_RVAL=2, /* replay value */
XFRM_AE_LVAL=4, /* lifetime value */
XFRM_AE_ETHR=8, /* expiry timer threshold */
XFRM_AE_CR=16, /* Event cause is replay update */
XFRM_AE_CE=32, /* Event cause is timer expiry */
XFRM_AE_CU=64, /* Event cause is policy update */
</pre></div>
</div>
<p>How these flags are used is dependent on the direction of the
message (kernel&lt;-&gt;user) as well the cause (config, query or event).
This is described below in the different messages.</p>
<p>The pid will be set appropriately in netlink to recognize direction
(0 to the kernel and pid = processid that created the event
when going from kernel to user space)</p>
<p>A program needs to subscribe to multicast group XFRMNLGRP_AEVENTS
to get notified of these events.</p>
</section>
<section id="tlvs-reflect-the-different-parameters">
<h2>2) TLVS reflect the different parameters:<a class="headerlink" href="#tlvs-reflect-the-different-parameters" title="Link to this heading">¶</a></h2>
<ol class="loweralpha simple">
<li><p>byte value (XFRMA_LTIME_VAL)</p></li>
</ol>
<p>This TLV carries the running/current counter for byte lifetime since
last event.</p>
<p>b)replay value (XFRMA_REPLAY_VAL)</p>
<p>This TLV carries the running/current counter for replay sequence since
last event.</p>
<p>c)replay threshold (XFRMA_REPLAY_THRESH)</p>
<p>This TLV carries the threshold being used by the kernel to trigger events
when the replay sequence is exceeded.</p>
<ol class="loweralpha simple" start="4">
<li><p>expiry timer (XFRMA_ETIMER_THRESH)</p></li>
</ol>
<p>This is a timer value in milliseconds which is used as the nagle
value to rate limit the events.</p>
</section>
<section id="default-configurations-for-the-parameters">
<h2>3) Default configurations for the parameters:<a class="headerlink" href="#default-configurations-for-the-parameters" title="Link to this heading">¶</a></h2>
<p>By default these events should be turned off unless there is
at least one listener registered to listen to the multicast
group XFRMNLGRP_AEVENTS.</p>
<p>Programs installing SAs will need to specify the two thresholds, however,
in order to not change existing applications such as racoon
we also provide default threshold values for these different parameters
in case they are not specified.</p>
<p>the two sysctls/proc entries are:</p>
<p>a) /proc/sys/net/core/sysctl_xfrm_aevent_etime
used to provide default values for the XFRMA_ETIMER_THRESH in incremental
units of time of 100ms. The default is 10 (1 second)</p>
<p>b) /proc/sys/net/core/sysctl_xfrm_aevent_rseqth
used to provide default values for XFRMA_REPLAY_THRESH parameter
in incremental packet count. The default is two packets.</p>
</section>
<section id="message-types">
<h2>4) Message types<a class="headerlink" href="#message-types" title="Link to this heading">¶</a></h2>
<ol class="loweralpha simple">
<li><p>XFRM_MSG_GETAE issued by user--&gt;kernel.
XFRM_MSG_GETAE does not carry any TLVs.</p></li>
</ol>
<p>The response is a XFRM_MSG_NEWAE which is formatted based on what
XFRM_MSG_GETAE queried for.</p>
<p>The response will always have XFRMA_LTIME_VAL and XFRMA_REPLAY_VAL TLVs.
* if XFRM_AE_RTHR flag is set, then XFRMA_REPLAY_THRESH is also retrieved
* if XFRM_AE_ETHR flag is set, then XFRMA_ETIMER_THRESH is also retrieved</p>
<ol class="loweralpha simple" start="2">
<li><p>XFRM_MSG_NEWAE is issued by either user space to configure
or kernel to announce events or respond to a XFRM_MSG_GETAE.</p></li>
</ol>
<ol class="lowerroman simple">
<li><p>user --&gt; kernel to configure a specific SA.</p></li>
</ol>
<p>any of the values or threshold parameters can be updated by passing the
appropriate TLV.</p>
<p>A response is issued back to the sender in user space to indicate success
or failure.</p>
<p>In the case of success, additionally an event with
XFRM_MSG_NEWAE is also issued to any listeners as described in iii).</p>
<ol class="lowerroman simple" start="2">
<li><p>kernel-&gt;user direction as a response to XFRM_MSG_GETAE</p></li>
</ol>
<p>The response will always have XFRMA_LTIME_VAL and XFRMA_REPLAY_VAL TLVs.</p>
<p>The threshold TLVs will be included if explicitly requested in
the XFRM_MSG_GETAE message.</p>
<ol class="lowerroman simple" start="3">
<li><p>kernel-&gt;user to report as event if someone sets any values or
thresholds for an SA using XFRM_MSG_NEWAE (as described in #i above).
In such a case XFRM_AE_CU flag is set to inform the user that
the change happened as a result of an update.
The message will always have XFRMA_LTIME_VAL and XFRMA_REPLAY_VAL TLVs.</p></li>
<li><p>kernel-&gt;user to report event when replay threshold or a timeout
is exceeded.</p></li>
</ol>
<p>In such a case either XFRM_AE_CR (replay exceeded) or XFRM_AE_CE (timeout
happened) is set to inform the user what happened.
Note the two flags are mutually exclusive.
The message will always have XFRMA_LTIME_VAL and XFRMA_REPLAY_VAL TLVs.</p>
</section>
<section id="exceptions-to-threshold-settings">
<h2>Exceptions to threshold settings<a class="headerlink" href="#exceptions-to-threshold-settings" title="Link to this heading">¶</a></h2>
<p>If you have an SA that is getting hit by traffic in bursts such that
there is a period where the timer threshold expires with no packets
seen, then an odd behavior is seen as follows:
The first packet arrival after a timer expiry will trigger a timeout
event; i.e we don’t wait for a timeout period or a packet threshold
to be reached. This is done for simplicity and efficiency reasons.</p>
<p>-JHS</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/networking/xfrm_sync.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>