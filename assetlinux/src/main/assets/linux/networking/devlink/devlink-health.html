<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Devlink Health &#8212; The Linux Kernel  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=a152c8ac" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Devlink Info" href="devlink-info.html" />
    <link rel="prev" title="Devlink DPIPE" href="devlink-dpipe.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.14.0</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><!-- SPDX-License-Identifier: GPL-2.0 -->

<p>
<h3 class="kernel-toc-contents">Contents</h3>
<input type="checkbox" class="kernel-toc-toggle" id = "kernel-toc-toggle" checked>
<label class="kernel-toc-title" for="kernel-toc-toggle"></label>

<div class="kerneltoc" id="kerneltoc">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">Development process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Maintainer handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">Driver APIs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../subsystem-apis.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#core-subsystems">Core subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#human-interfaces">Human interfaces</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../subsystem-apis.html#networking-interfaces">Networking interfaces</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#storage-interfaces">Storage interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subsystem-apis.html#other-subsystems">Other subsystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Testing guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Hacking guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">Fault injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Userspace tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">Userspace API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">CPU architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

</div>

<script type="text/javascript"> <!--
  var sbar = document.getElementsByClassName("sphinxsidebar")[0];
  let currents = document.getElementsByClassName("current")
  if (currents.length) {
    sbar.scrollTop = currents[currents.length - 1].offsetTop;
  }
  --> </script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/networking/devlink/devlink-health.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- SPDX-License-Identifier: GPL-2.0 -->
<!-- Copyright © 2023, Oracle and/or its affiliates. -->


<section id="devlink-health">
<h1>Devlink Health<a class="headerlink" href="#devlink-health" title="Link to this heading">¶</a></h1>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">devlink</span></code> health mechanism is targeted for Real Time Alerting, in
order to know when something bad happened to a PCI device.</p>
<blockquote>
<div><ul class="simple">
<li><p>Provide alert debug information.</p></li>
<li><p>Self healing.</p></li>
<li><p>If problem needs vendor support, provide a way to gather all needed
debugging information.</p></li>
</ul>
</div></blockquote>
</section>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>The main idea is to unify and centralize driver health reports in the
generic <code class="docutils literal notranslate"><span class="pre">devlink</span></code> instance and allow the user to set different
attributes of the health reporting and recovery procedures.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">devlink</span></code> health reporter:
Device driver creates a “health reporter” per each error/health type.
Error/Health type can be a known/generic (e.g. PCI error, fw error, rx/tx error)
or unknown (driver specific).
For each registered health reporter a driver can issue error/health reports
asynchronously. All health reports handling is done by <code class="docutils literal notranslate"><span class="pre">devlink</span></code>.
Device driver can provide specific callbacks for each “health reporter”, e.g.:</p>
<blockquote>
<div><ul class="simple">
<li><p>Recovery procedures</p></li>
<li><p>Diagnostics procedures</p></li>
<li><p>Object dump procedures</p></li>
<li><p>Out Of Box initial parameters</p></li>
</ul>
</div></blockquote>
<p>Different parts of the driver can register different types of health reporters
with different handlers.</p>
</section>
<section id="actions">
<h2>Actions<a class="headerlink" href="#actions" title="Link to this heading">¶</a></h2>
<p>Once an error is reported, devlink health will perform the following actions:</p>
<blockquote>
<div><ul class="simple">
<li><p>A log is being send to the kernel trace events buffer</p></li>
<li><p>Health status and statistics are being updated for the reporter instance</p></li>
<li><p>Object dump is being taken and saved at the reporter instance (as long as
auto-dump is set and there is no other dump which is already stored)</p></li>
<li><p>Auto recovery attempt is being done. Depends on:</p>
<ul>
<li><p>Auto-recovery configuration</p></li>
<li><p>Grace period vs. time passed since last recover</p></li>
</ul>
</li>
</ul>
</div></blockquote>
</section>
<section id="devlink-formatted-message">
<h2>Devlink formatted message<a class="headerlink" href="#devlink-formatted-message" title="Link to this heading">¶</a></h2>
<p>To handle devlink health diagnose and health dump requests, devlink creates a
formatted message structure <code class="docutils literal notranslate"><span class="pre">devlink_fmsg</span></code> and send it to the driver’s callback
to fill the data in using the devlink fmsg API.</p>
<p>Devlink fmsg is a mechanism to pass descriptors between drivers and devlink, in
json-like format. The API allows the driver to add nested attributes such as
object, object pair and value array, in addition to attributes such as name and
value.</p>
<p>Driver should use this API to fill the fmsg context in a format which will be
translated by the devlink to the netlink message later. When it needs to send
the data using SKBs to the netlink layer, it fragments the data between
different SKBs. In order to do this fragmentation, it uses virtual nests
attributes, to avoid actual nesting use which cannot be divided between
different SKBs.</p>
</section>
<section id="user-interface">
<h2>User Interface<a class="headerlink" href="#user-interface" title="Link to this heading">¶</a></h2>
<p>User can access/change each reporter’s parameters and driver specific callbacks
via <code class="docutils literal notranslate"><span class="pre">devlink</span></code>, e.g per error type (per health reporter):</p>
<blockquote>
<div><ul class="simple">
<li><p>Configure reporter’s generic parameters (like: disable/enable auto recovery)</p></li>
<li><p>Invoke recovery procedure</p></li>
<li><p>Run diagnostics</p></li>
<li><p>Object dump</p></li>
</ul>
</div></blockquote>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">List of devlink health interfaces</span><a class="headerlink" href="#id1" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 10.0%" />
<col style="width: 90.0%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Name</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_CMD_HEALTH_REPORTER_GET</span></code></p></td>
<td><p>Retrieves status and configuration info per DEV and reporter.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_CMD_HEALTH_REPORTER_SET</span></code></p></td>
<td><p>Allows reporter-related configuration setting.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_CMD_HEALTH_REPORTER_RECOVER</span></code></p></td>
<td><p>Triggers reporter’s recovery procedure.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_CMD_HEALTH_REPORTER_TEST</span></code></p></td>
<td><p>Triggers a fake health event on the reporter. The effects of the test
event in terms of recovery flow should follow closely that of a real
event.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_CMD_HEALTH_REPORTER_DIAGNOSE</span></code></p></td>
<td><p>Retrieves current device state related to the reporter.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_CMD_HEALTH_REPORTER_DUMP_GET</span></code></p></td>
<td><p>Retrieves the last stored dump. Devlink health
saves a single dump. If an dump is not already stored by devlink
for this reporter, devlink generates a new dump.
Dump output is defined by the reporter.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DEVLINK_CMD_HEALTH_REPORTER_DUMP_CLEAR</span></code></p></td>
<td><p>Clears the last saved dump file for the specified reporter.</p></td>
</tr>
</tbody>
</table>
<p>The following diagram provides a general overview of <code class="docutils literal notranslate"><span class="pre">devlink-health</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                                               netlink
                                      +--------------------------+
                                      |                          |
                                      |            +             |
                                      |            |             |
                                      +--------------------------+
                                                   |request for ops
                                                   |(diagnose,
  driver                               devlink     |recover,
                                                   |dump)
+--------+                            +--------------------------+
|        |                            |    reporter|             |
|        |                            |  +---------v----------+  |
|        |   ops execution            |  |                    |  |
|     &lt;----------------------------------+                    |  |
|        |                            |  |                    |  |
|        |                            |  + ^------------------+  |
|        |                            |    | request for ops     |
|        |                            |    | (recover, dump)     |
|        |                            |    |                     |
|        |                            |  +-+------------------+  |
|        |     health report          |  | health handler     |  |
|        +-------------------------------&gt;                    |  |
|        |                            |  +--------------------+  |
|        |     health reporter create |                          |
|        +----------------------------&gt;                          |
+--------+                            +--------------------------+
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/networking/devlink/devlink-health.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>